<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>pcalc API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#the-presence-calculus-toolkit">The Presence Calculus Toolkit</a>
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#the-toolkit">The Toolkit</a></li>
    <li><a href="#reading-these-docs">Reading these docs</a></li>
  </ul></li>
</ul>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="pcalc/entity.html">entity</a></li>
                    <li><a href="pcalc/presence.html">presence</a></li>
                    <li><a href="pcalc/time_model.html">time_model</a></li>
                    <li><a href="pcalc/basis_topology.html">basis_topology</a></li>
                    <li><a href="pcalc/time_scale.html">time_scale</a></li>
                    <li><a href="pcalc/presence_map.html">presence_map</a></li>
                    <li><a href="pcalc/presence_matrix.html">presence_matrix</a></li>
                    <li><a href="pcalc/presence_invariant.html">presence_invariant</a></li>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Entity">Entity</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Entity.__init__">Entity</a>
                        </li>
                        <li>
                                <a class="variable" href="#Entity.id">id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Entity.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#Entity.metadata">metadata</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Presence">Presence</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Presence.__init__">Presence</a>
                        </li>
                        <li>
                                <a class="variable" href="#Presence.element">element</a>
                        </li>
                        <li>
                                <a class="variable" href="#Presence.boundary">boundary</a>
                        </li>
                        <li>
                                <a class="variable" href="#Presence.onset_time">onset_time</a>
                        </li>
                        <li>
                                <a class="variable" href="#Presence.reset_time">reset_time</a>
                        </li>
                        <li>
                                <a class="variable" href="#Presence.provenance">provenance</a>
                        </li>
                        <li>
                                <a class="function" href="#Presence.overlaps">overlaps</a>
                        </li>
                        <li>
                                <a class="function" href="#Presence.duration">duration</a>
                        </li>
                        <li>
                                <a class="function" href="#Presence.residence_time">residence_time</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TimeModel">TimeModel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TimeModel.__init__">TimeModel</a>
                        </li>
                        <li>
                                <a class="variable" href="#TimeModel.origin">origin</a>
                        </li>
                        <li>
                                <a class="variable" href="#TimeModel.unit">unit</a>
                        </li>
                        <li>
                                <a class="function" href="#TimeModel.to_float">to_float</a>
                        </li>
                        <li>
                                <a class="function" href="#TimeModel.from_float">from_float</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BasisTopology">BasisTopology</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BasisTopology.__init__">BasisTopology</a>
                        </li>
                        <li>
                                <a class="variable" href="#BasisTopology.cover_index">cover_index</a>
                        </li>
                        <li>
                                <a class="function" href="#BasisTopology.get_cover">get_cover</a>
                        </li>
                        <li>
                                <a class="function" href="#BasisTopology.join">join</a>
                        </li>
                        <li>
                                <a class="function" href="#BasisTopology.closure">closure</a>
                        </li>
                        <li>
                                <a class="function" href="#BasisTopology.find_overlapping">find_overlapping</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Timescale">Timescale</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Timescale.__init__">Timescale</a>
                        </li>
                        <li>
                                <a class="variable" href="#Timescale.t0">t0</a>
                        </li>
                        <li>
                                <a class="variable" href="#Timescale.t1">t1</a>
                        </li>
                        <li>
                                <a class="variable" href="#Timescale.bin_width">bin_width</a>
                        </li>
                        <li>
                                <a class="variable" href="#Timescale.num_bins">num_bins</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.bin_index">bin_index</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.bin_slice">bin_slice</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.fractional_overlap">fractional_overlap</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.bin_start">bin_start</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.bin_end">bin_end</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.bin_edges">bin_edges</a>
                        </li>
                        <li>
                                <a class="function" href="#Timescale.time_range">time_range</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PresenceMap">PresenceMap</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PresenceMap.__init__">PresenceMap</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.presence">presence</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.time_scale">time_scale</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.is_mapped">is_mapped</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.start_bin">start_bin</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.end_bin">end_bin</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.start_value">start_value</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.end_value">end_value</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.bin_range">bin_range</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.duration">duration</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceMap.is_active">is_active</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceMap.presence_value_in">presence_value_in</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMap.presence_value">presence_value</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PresenceMatrix">PresenceMatrix</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PresenceMatrix.__init__">PresenceMatrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMatrix.presence_matrix">presence_matrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMatrix.time_scale">time_scale</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMatrix.presence_map">presence_map</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMatrix.shape">shape</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceMatrix.init_presence_map">init_presence_map</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceMatrix.is_materialized">is_materialized</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceMatrix.materialize">materialize</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceMatrix.drop_materialization">drop_materialization</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceMatrix.presences">presences</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PresenceInvariant">PresenceInvariant</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PresenceInvariant.__init__">PresenceInvariant</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.matrix">matrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.presences">presences</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.presence_map">presence_map</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.ts">ts</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.flow_rate">flow_rate</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.avg_residence_time">avg_residence_time</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.avg_presence_per_unit_time">avg_presence_per_unit_time</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.get_presence_summary">get_presence_summary</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.get_presence_metrics">get_presence_metrics</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.starting_presence_count">starting_presence_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.ending_presence_count">ending_presence_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.arrival_count">arrival_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.departure_count">departure_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.foo">foo</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
pcalc    </h1>

                        <div class="docstring"><h1 id="the-presence-calculus-toolkit">The Presence Calculus Toolkit</h1>

<p>© 2025 Dr. Krishna Kumar
SPDX-License-Identifier: MIT</p>

<h2 id="introduction">Introduction</h2>

<p>The Presence Calculus provides a mathematical formalism for reasoning about
the relationship between <em>things</em> and <em>places</em> over <em>time</em>.</p>

<p>It begins with a <a href="./pcalc/presence.html"><em>Presence</em></a>—an <em>assertion</em> that a
particular <em>Element</em> (thing) was <em>continuously</em> present
within a <em>Boundary</em> (place) over an interval
of <em>time</em>. Both Elements and Boundaries come from some underlying domain $D$
that we are studying.</p>

<p>Given a set of presence assertions over a domain $D$, the presence calculus provides
rigorously defined  primitives and constructs for analyzing element timelines and trajectories,
presence-induced topologies on $D$, and the
effects of co-presence - simultaneous element presence - within and across
boundaries.</p>

<p>Further, by extending the notion of presences to <em>functions over presences</em>, it gives
a general mechanism for representing the <em>effects</em> of presence, This helps
model concepts such value, impact, delays, cost, revenues, user experience etc, as well
as reason rigorously about concepts like time value, delayed value and option value of presence.</p>

<p>These techniques can be applied consistently across a wide range of domains, including
stochastic, non-linear, adaptive, and complex systems.</p>

<div style="text-align: center; margin:2em">
  <img src="./assets/pcalc/presence_calculus.svg" width="600px" />
  <div style="font-size: 0.9em; color: #555; margin-top: 1em; margin-bottom: 1em;">
    Figure 1: Key constructs—presences, element paths, presence matrix, and co-presence topology
  </div>
</div>

<h2 id="motivation">Motivation</h2>

<p>Our main goal in developing the presence calculus is to provide better tools
for rigorous modeling and principled decision-making in messy, real-world domains.
Our focus is on ensuring that the way data is used in those decisions rests on a
linguistically precise, logically sound and mathematically grounded foundation.</p>

<p>The world of measurement, particularly in messy, complex, real-world domains, is sorely lacking in all these
three areas, and the presence calculus evolved from a search for better solutions here.</p>

<p>The presence calculus builds on ideas from stochastic process dynamics,
queueing theory, topology, and complex systems science—yet remains
philosophically distinct from each of them. It allows us to connect these fields while
re-framing their perspectives through the common epistemic lens of presence.</p>

<p>The foundational concepts of Presence Calculus allow us to <em>define</em>
derived notions such as flow, stability, equilibrium, and coherence precisely, and to
relate them to practically useful measures like delay, cost, revenue, and user
experience when interpreted within the semantics of the domain being modeled.</p>

<p>In messy real-world domains, relationships between elements, boundaries, flows, and
effects often emerge from complex, higher-dimensional interactions among
many parameters. These patterns are often more amenable to machine analysis
in high-dimensional representations than through the simplified, low-dimensional
models we typically use to make decisions. The presence calculus provides a precise and structured way to
build such representations starting from simple, declarative models of presence.</p>

<p>Although we will motivate most ideas we introduce with real-world decision
problems, we are less focused on <em>what</em> decisions to make or prescribing <em>how</em> to make decisions. This is the
 application domain for the presence calculus.</p>

<p>We believe it is vast and hope to make it accessible for more people to build applications without requiring a deep
understanding of the underlying mathematics.</p>

<h2 id="the-toolkit">The Toolkit</h2>

<p>The Presence Calculus Toolkit is a computationally efficient implementation of the core concepts and
calculations in Presence Calculus.</p>

<p>This <code><a href="">pcalc</a></code> module in particular, is an elementary and accessible entry point to some of the more abstract
concepts in the presence calculus. It is a computational model for the calculus
capable of powering real-time analysis and simulation of complex systems. The module is designed as a lightweight,
easy-to-integrate analytical middleware library that connects real-time event streams, simulation models,
and static datasets from a domain to rich visualization and analysis tools.</p>

<p>While we'll provide several examples of end-to-end integrations, the library is
open source under the MIT license, and you are encouraged to create models and
applications—both commercial and non-commercial—that build on the concepts.</p>

<p>If you are comfortable learning by
reading code and implementing models and don't mind just a tiny bit of
formal mathematical notation, this is a better entry point to the presence calculus for you.</p>

<p>More background and general, informal discussion around these topics
can be found on <a href="https://wwww.polaris-flow-dispatch.com">The Polaris Flow Dispatch.</a></p>

<h2 id="reading-these-docs">Reading these docs</h2>

<p>The documentation is organized so that you can get a very good idea of the
scope of the presence calculus and it's implementation by reading the
topics listed on the "submodules" left hand menu, in order.</p>

<p>Each module
links to detailed API documentation that is also directly accessible from this page.
The index is also searchable once you get familiar with the concepts.</p>

<p>The presence calculus builds on an intuitive and elementary foundation, even as
it remains mathematically rigorous. We believe the space of potential
applications is vast, and invite you to explore it—and to reach out if you
have questions or would like to collaborate.</p>

<p><a href="https://www.linkedin.com/in/krishnaku1/">Dr. Krishna Kumar</a>,
<br> <a href="https://github.com/polarisadvisor">The Polaris Advisor Program</a></p>
</div>

                        <input id="mod-pcalc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-pcalc-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1"># Copyright (c) 2025 Krishna Kumar</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="c1"># SPDX-License-Identifier: MIT</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">#The Presence Calculus Toolkit</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">© 2025 Dr. Krishna Kumar</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">SPDX-License-Identifier: MIT</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">## Introduction</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">The Presence Calculus provides a mathematical formalism for reasoning about</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">the relationship between *things* and *places* over *time*.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">It begins with a [*Presence*](./pcalc/presence.html)—an *assertion* that a</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">particular *Element* (thing) was *continuously* present</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">within a *Boundary* (place) over an interval</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">of *time*. Both Elements and Boundaries come from some underlying domain $D$</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">that we are studying.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">Given a set of presence assertions over a domain $D$, the presence calculus provides</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">rigorously defined  primitives and constructs for analyzing element timelines and trajectories,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">presence-induced topologies on $D$, and the</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">effects of co-presence - simultaneous element presence - within and across</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">boundaries.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">Further, by extending the notion of presences to *functions over presences*, it gives</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">a general mechanism for representing the *effects* of presence, This helps</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">model concepts such value, impact, delays, cost, revenues, user experience etc, as well</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">as reason rigorously about concepts like time value, delayed value and option value of presence.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">These techniques can be applied consistently across a wide range of domains, including</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">stochastic, non-linear, adaptive, and complex systems.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">&lt;div style=&quot;text-align: center; margin:2em&quot;&gt;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">  &lt;img src=&quot;./assets/pcalc/presence_calculus.svg&quot; width=&quot;600px&quot; /&gt;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">  &lt;div style=&quot;font-size: 0.9em; color: #555; margin-top: 1em; margin-bottom: 1em;&quot;&gt;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    Figure 1: Key constructs—presences, element paths, presence matrix, and co-presence topology</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">  &lt;/div&gt;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">&lt;/div&gt;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">## Motivation</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">Our main goal in developing the presence calculus is to provide better tools</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">for rigorous modeling and principled decision-making in messy, real-world domains.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">Our focus is on ensuring that the way data is used in those decisions rests on a</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">linguistically precise, logically sound and mathematically grounded foundation.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">The world of measurement, particularly in messy, complex, real-world domains, is sorely lacking in all these</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">three areas, and the presence calculus evolved from a search for better solutions here.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">The presence calculus builds on ideas from stochastic process dynamics,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">queueing theory, topology, and complex systems science—yet remains</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">philosophically distinct from each of them. It allows us to connect these fields while</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">re-framing their perspectives through the common epistemic lens of presence.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">The foundational concepts of Presence Calculus allow us to *define*</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">derived notions such as flow, stability, equilibrium, and coherence precisely, and to</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">relate them to practically useful measures like delay, cost, revenue, and user</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">experience when interpreted within the semantics of the domain being modeled.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">In messy real-world domains, relationships between elements, boundaries, flows, and</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">effects often emerge from complex, higher-dimensional interactions among</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">many parameters. These patterns are often more amenable to machine analysis</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">in high-dimensional representations than through the simplified, low-dimensional</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">models we typically use to make decisions. The presence calculus provides a precise and structured way to</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">build such representations starting from simple, declarative models of presence.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">Although we will motivate most ideas we introduce with real-world decision</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">problems, we are less focused on *what* decisions to make or prescribing *how* to make decisions. This is the</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd"> application domain for the presence calculus.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd"> We believe it is vast and hope to make it accessible for more people to build applications without requiring a deep</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">understanding of the underlying mathematics.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">## The Toolkit</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">The Presence Calculus Toolkit is a computationally efficient implementation of the core concepts and</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">calculations in Presence Calculus.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">This `pcalc` module in particular, is an elementary and accessible entry point to some of the more abstract</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">concepts in the presence calculus. It is a computational model for the calculus</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">capable of powering real-time analysis and simulation of complex systems. The module is designed as a lightweight,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">easy-to-integrate analytical middleware library that connects real-time event streams, simulation models,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">and static datasets from a domain to rich visualization and analysis tools.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">While we&#39;ll provide several examples of end-to-end integrations, the library is</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">open source under the MIT license, and you are encouraged to create models and</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">applications—both commercial and non-commercial—that build on the concepts.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">If you are comfortable learning by</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">reading code and implementing models and don&#39;t mind just a tiny bit of</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">formal mathematical notation, this is a better entry point to the presence calculus for you.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">More background and general, informal discussion around these topics</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">can be found on [The Polaris Flow Dispatch.](https://wwww.polaris-flow-dispatch.com)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">## Reading these docs</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">The documentation is organized so that you can get a very good idea of the</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">scope of the presence calculus and it&#39;s implementation by reading the</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">topics listed on the &quot;submodules&quot; left hand menu, in order.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">Each module</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">links to detailed API documentation that is also directly accessible from this page.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">The index is also searchable once you get familiar with the concepts.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">The presence calculus builds on an intuitive and elementary foundation, even as</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">it remains mathematically rigorous. We believe the space of potential</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">applications is vast, and invite you to explore it—and to reach out if you</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">have questions or would like to collaborate.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">[Dr. Krishna Kumar](https://www.linkedin.com/in/krishnaku1/),</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">&lt;br&gt; [The Polaris Advisor Program](https://github.com/polarisadvisor)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">Entity</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.presence</span><span class="w"> </span><span class="kn">import</span> <span class="n">Presence</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.time_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeModel</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.basis_topology</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasisTopology</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.presence_matrix</span><span class="w"> </span><span class="kn">import</span> <span class="n">PresenceMatrix</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.time_scale</span><span class="w"> </span><span class="kn">import</span> <span class="n">Timescale</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.presence_map</span><span class="w"> </span><span class="kn">import</span> <span class="n">PresenceMap</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.presence_invariant</span><span class="w"> </span><span class="kn">import</span> <span class="n">PresenceInvariant</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="s2">&quot;entity&quot;</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="n">Entity</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="s2">&quot;presence&quot;</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="n">Presence</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="s2">&quot;time_model&quot;</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="n">TimeModel</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="s2">&quot;basis_topology&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="n">BasisTopology</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="s2">&quot;time_scale&quot;</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="n">Timescale</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="s2">&quot;presence_map&quot;</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="n">PresenceMap</span><span class="p">,</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="s2">&quot;presence_matrix&quot;</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="n">PresenceMatrix</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="s2">&quot;presence_invariant&quot;</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    <span class="n">PresenceInvariant</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="Entity">
                            <input id="Entity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Entity</span><wbr>(<span class="base"><a href="pcalc/entity.html#EntityMixin">pcalc.entity.EntityMixin</a></span>, <span class="base"><a href="pcalc/entity.html#EntityProtocol">pcalc.entity.EntityProtocol</a></span>):

                <label class="view-source-button" for="Entity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Entity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Entity-200"><a href="#Entity-200"><span class="linenos">200</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Entity</span><span class="p">(</span><span class="n">EntityMixin</span><span class="p">,</span> <span class="n">EntityProtocol</span><span class="p">):</span>
</span><span id="Entity-201"><a href="#Entity-201"><span class="linenos">201</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A default implementation of fully functional entity.</span>
</span><span id="Entity-202"><a href="#Entity-202"><span class="linenos">202</span></a>
</span><span id="Entity-203"><a href="#Entity-203"><span class="linenos">203</span></a><span class="sd">    ```python</span>
</span><span id="Entity-204"><a href="#Entity-204"><span class="linenos">204</span></a><span class="sd">    elements = [</span>
</span><span id="Entity-205"><a href="#Entity-205"><span class="linenos">205</span></a><span class="sd">        Entity(id=&quot;cust-001&quot;, name=&quot;Alice Chen&quot;, metadata={&quot;type&quot;: &quot;customer&quot;}),</span>
</span><span id="Entity-206"><a href="#Entity-206"><span class="linenos">206</span></a><span class="sd">        Entity(id=&quot;cust-002&quot;, name=&quot;Bob Gupta&quot;, metadata={&quot;type&quot;: &quot;customer&quot;}),</span>
</span><span id="Entity-207"><a href="#Entity-207"><span class="linenos">207</span></a><span class="sd">        Entity(id=&quot;pros-003&quot;, name=&quot;Dana Rivera&quot;, metadata={&quot;type&quot;: &quot;prospect&quot;}),</span>
</span><span id="Entity-208"><a href="#Entity-208"><span class="linenos">208</span></a><span class="sd">    ]</span>
</span><span id="Entity-209"><a href="#Entity-209"><span class="linenos">209</span></a><span class="sd">    boundaries = [</span>
</span><span id="Entity-210"><a href="#Entity-210"><span class="linenos">210</span></a><span class="sd">        Entity(id=&quot;seg-enterprise&quot;, name=&quot;Enterprise Segment&quot;, metadata={&quot;region&quot;: &quot;NA&quot;}),</span>
</span><span id="Entity-211"><a href="#Entity-211"><span class="linenos">211</span></a><span class="sd">        Entity(id=&quot;seg-smb&quot;, name=&quot;SMB Segment&quot;, metadata={&quot;region&quot;: &quot;EMEA&quot;}),</span>
</span><span id="Entity-212"><a href="#Entity-212"><span class="linenos">212</span></a><span class="sd">        Entity(id=&quot;seg-dormant&quot;, name=&quot;Flight Risk&quot;, metadata={&quot;status&quot;: &quot;inactive&quot;, &quot;last login&quot;: &quot;2024-06-01&quot;}),</span>
</span><span id="Entity-213"><a href="#Entity-213"><span class="linenos">213</span></a><span class="sd">        Entity(id=&quot;seg-prospect&quot;, name=&quot;Active Prospects&quot;, metadata={&quot;status&quot;: &quot;demo given&quot;})</span>
</span><span id="Entity-214"><a href="#Entity-214"><span class="linenos">214</span></a><span class="sd">    ]</span>
</span><span id="Entity-215"><a href="#Entity-215"><span class="linenos">215</span></a>
</span><span id="Entity-216"><a href="#Entity-216"><span class="linenos">216</span></a><span class="sd">    for e in elements:</span>
</span><span id="Entity-217"><a href="#Entity-217"><span class="linenos">217</span></a><span class="sd">        print(f&quot;Element: {e.summary()}&quot;)</span>
</span><span id="Entity-218"><a href="#Entity-218"><span class="linenos">218</span></a>
</span><span id="Entity-219"><a href="#Entity-219"><span class="linenos">219</span></a><span class="sd">    for b in boundaries:</span>
</span><span id="Entity-220"><a href="#Entity-220"><span class="linenos">220</span></a><span class="sd">        print(f&quot;Boundary: {b.summary()}&quot;)</span>
</span><span id="Entity-221"><a href="#Entity-221"><span class="linenos">221</span></a><span class="sd">    ```</span>
</span><span id="Entity-222"><a href="#Entity-222"><span class="linenos">222</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Entity-223"><a href="#Entity-223"><span class="linenos">223</span></a>    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;_name&quot;</span><span class="p">,</span> <span class="s2">&quot;_metadata&quot;</span><span class="p">)</span>
</span><span id="Entity-224"><a href="#Entity-224"><span class="linenos">224</span></a>
</span><span id="Entity-225"><a href="#Entity-225"><span class="linenos">225</span></a>    <span class="c1"># noinspection PyProtocol</span>
</span><span id="Entity-226"><a href="#Entity-226"><span class="linenos">226</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Entity-227"><a href="#Entity-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Entity-228"><a href="#Entity-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</span><span id="Entity-229"><a href="#Entity-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="Entity-230"><a href="#Entity-230"><span class="linenos">230</span></a>
</span><span id="Entity-231"><a href="#Entity-231"><span class="linenos">231</span></a>    <span class="nd">@property</span>
</span><span id="Entity-232"><a href="#Entity-232"><span class="linenos">232</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Entity-233"><a href="#Entity-233"><span class="linenos">233</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
</span><span id="Entity-234"><a href="#Entity-234"><span class="linenos">234</span></a>
</span><span id="Entity-235"><a href="#Entity-235"><span class="linenos">235</span></a>    <span class="c1"># noinspection PyProtocol</span>
</span><span id="Entity-236"><a href="#Entity-236"><span class="linenos">236</span></a>    <span class="nd">@property</span>
</span><span id="Entity-237"><a href="#Entity-237"><span class="linenos">237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Entity-238"><a href="#Entity-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</span><span id="Entity-239"><a href="#Entity-239"><span class="linenos">239</span></a>
</span><span id="Entity-240"><a href="#Entity-240"><span class="linenos">240</span></a>    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
</span><span id="Entity-241"><a href="#Entity-241"><span class="linenos">241</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Entity-242"><a href="#Entity-242"><span class="linenos">242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Entity-243"><a href="#Entity-243"><span class="linenos">243</span></a>
</span><span id="Entity-244"><a href="#Entity-244"><span class="linenos">244</span></a>    <span class="nd">@property</span>
</span><span id="Entity-245"><a href="#Entity-245"><span class="linenos">245</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Entity-246"><a href="#Entity-246"><span class="linenos">246</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
</span><span id="Entity-247"><a href="#Entity-247"><span class="linenos">247</span></a>
</span><span id="Entity-248"><a href="#Entity-248"><span class="linenos">248</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Entity-249"><a href="#Entity-249"><span class="linenos">249</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>A default implementation of fully functional entity.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">elements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;cust-001&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alice Chen&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;customer&quot;</span><span class="p">}),</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;cust-002&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob Gupta&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;customer&quot;</span><span class="p">}),</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;pros-003&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Dana Rivera&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;prospect&quot;</span><span class="p">}),</span>
<span class="p">]</span>
<span class="n">boundaries</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;seg-enterprise&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Enterprise Segment&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">}),</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;seg-smb&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SMB Segment&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;EMEA&quot;</span><span class="p">}),</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;seg-dormant&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Flight Risk&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;inactive&quot;</span><span class="p">,</span> <span class="s2">&quot;last login&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">}),</span>
    <span class="n">Entity</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;seg-prospect&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Active Prospects&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;demo given&quot;</span><span class="p">})</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Element: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">boundaries</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boundary: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
</div>


                            <div id="Entity.__init__" class="classattr">
                                        <input id="Entity.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Entity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Entity.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Entity.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Entity.__init__-226"><a href="#Entity.__init__-226"><span class="linenos">226</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Entity.__init__-227"><a href="#Entity.__init__-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Entity.__init__-228"><a href="#Entity.__init__-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</span><span id="Entity.__init__-229"><a href="#Entity.__init__-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
</span></pre></div>


    

                            </div>
                            <div id="Entity.id" class="classattr">
                                        <input id="Entity.id-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">id</span><span class="annotation">: str</span>

                <label class="view-source-button" for="Entity.id-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Entity.id"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Entity.id-231"><a href="#Entity.id-231"><span class="linenos">231</span></a>    <span class="nd">@property</span>
</span><span id="Entity.id-232"><a href="#Entity.id-232"><span class="linenos">232</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Entity.id-233"><a href="#Entity.id-233"><span class="linenos">233</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
</span></pre></div>


            <div class="docstring"><p>A stable, unique identifier for the entity.
Used for indexing and identity.
Defaults to a uuid.uuid4().</p>
</div>


                            </div>
                            <div id="Entity.name" class="classattr">
                                        <input id="Entity.name-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">name</span><span class="annotation">: str</span>

                <label class="view-source-button" for="Entity.name-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Entity.name"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Entity.name-236"><a href="#Entity.name-236"><span class="linenos">236</span></a>    <span class="nd">@property</span>
</span><span id="Entity.name-237"><a href="#Entity.name-237"><span class="linenos">237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Entity.name-238"><a href="#Entity.name-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</span></pre></div>


            <div class="docstring"><p>A user facing name for the entity, defaults to the id if None.</p>
</div>


                            </div>
                            <div id="Entity.metadata" class="classattr">
                                        <input id="Entity.metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">metadata</span><span class="annotation">: Dict[str, Any]</span>

                <label class="view-source-button" for="Entity.metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Entity.metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Entity.metadata-244"><a href="#Entity.metadata-244"><span class="linenos">244</span></a>    <span class="nd">@property</span>
</span><span id="Entity.metadata-245"><a href="#Entity.metadata-245"><span class="linenos">245</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Entity.metadata-246"><a href="#Entity.metadata-246"><span class="linenos">246</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
</span></pre></div>


            <div class="docstring"><p>Optional extensible key-value metadata.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="pcalc/entity.html#EntityMixin">pcalc.entity.EntityMixin</a></dt>
                                <dd id="Entity.summary" class="function"><a href="pcalc/entity.html#EntityMixin.summary">summary</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Presence">
                            <input id="Presence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass(frozen=True)</div>

    <span class="def">class</span>
    <span class="name">Presence</span>:

                <label class="view-source-button" for="Presence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Presence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Presence-143"><a href="#Presence-143"><span class="linenos">143</span></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Presence-144"><a href="#Presence-144"><span class="linenos">144</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Presence</span><span class="p">:</span>
</span><span id="Presence-145"><a href="#Presence-145"><span class="linenos">145</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Presence-146"><a href="#Presence-146"><span class="linenos">146</span></a><span class="sd">    A presence assertion in the Presence Calculus.</span>
</span><span id="Presence-147"><a href="#Presence-147"><span class="linenos">147</span></a>
</span><span id="Presence-148"><a href="#Presence-148"><span class="linenos">148</span></a><span class="sd">    This is a fundamental, immutable construct representing the presence of an</span>
</span><span id="Presence-149"><a href="#Presence-149"><span class="linenos">149</span></a><span class="sd">    element at a boundary over a continuous interval of time.</span>
</span><span id="Presence-150"><a href="#Presence-150"><span class="linenos">150</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Presence-151"><a href="#Presence-151"><span class="linenos">151</span></a>    <span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EntityProtocol</span><span class="p">]</span>
</span><span id="Presence-152"><a href="#Presence-152"><span class="linenos">152</span></a>    <span class="n">boundary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EntityProtocol</span><span class="p">]</span>
</span><span id="Presence-153"><a href="#Presence-153"><span class="linenos">153</span></a>    <span class="n">onset_time</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Presence-154"><a href="#Presence-154"><span class="linenos">154</span></a>    <span class="n">reset_time</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Presence-155"><a href="#Presence-155"><span class="linenos">155</span></a>    <span class="n">provenance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;observed&quot;</span>
</span><span id="Presence-156"><a href="#Presence-156"><span class="linenos">156</span></a>
</span><span id="Presence-157"><a href="#Presence-157"><span class="linenos">157</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Presence-158"><a href="#Presence-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&gt;</span> <span class="n">t0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">&lt;</span> <span class="n">t1</span>
</span><span id="Presence-159"><a href="#Presence-159"><span class="linenos">159</span></a>
</span><span id="Presence-160"><a href="#Presence-160"><span class="linenos">160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Presence-161"><a href="#Presence-161"><span class="linenos">161</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span><span class="p">)</span>
</span><span id="Presence-162"><a href="#Presence-162"><span class="linenos">162</span></a>
</span><span id="Presence-163"><a href="#Presence-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">residence_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Presence-164"><a href="#Presence-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="n">t0</span> <span class="o">&gt;=</span> <span class="n">t1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
</span><span id="Presence-165"><a href="#Presence-165"><span class="linenos">165</span></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="Presence-166"><a href="#Presence-166"><span class="linenos">166</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
</span><span id="Presence-167"><a href="#Presence-167"><span class="linenos">167</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="Presence-168"><a href="#Presence-168"><span class="linenos">168</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span><span id="Presence-169"><a href="#Presence-169"><span class="linenos">169</span></a>
</span><span id="Presence-170"><a href="#Presence-170"><span class="linenos">170</span></a>
</span><span id="Presence-171"><a href="#Presence-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Presence-172"><a href="#Presence-172"><span class="linenos">172</span></a>        <span class="n">element_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
</span><span id="Presence-173"><a href="#Presence-173"><span class="linenos">173</span></a>        <span class="n">boundary_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
</span><span id="Presence-174"><a href="#Presence-174"><span class="linenos">174</span></a>        <span class="n">interval_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Presence-175"><a href="#Presence-175"><span class="linenos">175</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Presence-176"><a href="#Presence-176"><span class="linenos">176</span></a>            <span class="sa">f</span><span class="s2">&quot;Presence(element=</span><span class="si">{</span><span class="n">element_str</span><span class="si">}</span><span class="s2">, boundary=</span><span class="si">{</span><span class="n">boundary_str</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="Presence-177"><a href="#Presence-177"><span class="linenos">177</span></a>            <span class="sa">f</span><span class="s2">&quot;interval=</span><span class="si">{</span><span class="n">interval_str</span><span class="si">}</span><span class="s2">, provenance=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Presence-178"><a href="#Presence-178"><span class="linenos">178</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A presence assertion in the Presence Calculus.</p>

<p>This is a fundamental, immutable construct representing the presence of an
element at a boundary over a continuous interval of time.</p>
</div>


                            <div id="Presence.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Presence</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="pcalc/entity.html#EntityProtocol">pcalc.entity.EntityProtocol</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">boundary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="pcalc/entity.html#EntityProtocol">pcalc.entity.EntityProtocol</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">onset_time</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">reset_time</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">provenance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;observed&#39;</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Presence.__init__"></a>
    
    

                            </div>
                            <div id="Presence.element" class="classattr">
                                <div class="attr variable">
            <span class="name">element</span><span class="annotation">: Optional[<a href="pcalc/entity.html#EntityProtocol">pcalc.entity.EntityProtocol</a>]</span>

        
    </div>
    <a class="headerlink" href="#Presence.element"></a>
    
    

                            </div>
                            <div id="Presence.boundary" class="classattr">
                                <div class="attr variable">
            <span class="name">boundary</span><span class="annotation">: Optional[<a href="pcalc/entity.html#EntityProtocol">pcalc.entity.EntityProtocol</a>]</span>

        
    </div>
    <a class="headerlink" href="#Presence.boundary"></a>
    
    

                            </div>
                            <div id="Presence.onset_time" class="classattr">
                                <div class="attr variable">
            <span class="name">onset_time</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Presence.onset_time"></a>
    
    

                            </div>
                            <div id="Presence.reset_time" class="classattr">
                                <div class="attr variable">
            <span class="name">reset_time</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Presence.reset_time"></a>
    
    

                            </div>
                            <div id="Presence.provenance" class="classattr">
                                <div class="attr variable">
            <span class="name">provenance</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;observed&#39;</span>

        
    </div>
    <a class="headerlink" href="#Presence.provenance"></a>
    
    

                            </div>
                            <div id="Presence.overlaps" class="classattr">
                                        <input id="Presence.overlaps-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">overlaps</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">t0</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">t1</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Presence.overlaps-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Presence.overlaps"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Presence.overlaps-157"><a href="#Presence.overlaps-157"><span class="linenos">157</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Presence.overlaps-158"><a href="#Presence.overlaps-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&gt;</span> <span class="n">t0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">&lt;</span> <span class="n">t1</span>
</span></pre></div>


    

                            </div>
                            <div id="Presence.duration" class="classattr">
                                        <input id="Presence.duration-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">duration</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Presence.duration-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Presence.duration"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Presence.duration-160"><a href="#Presence.duration-160"><span class="linenos">160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Presence.duration-161"><a href="#Presence.duration-161"><span class="linenos">161</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Presence.residence_time" class="classattr">
                                        <input id="Presence.residence_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">residence_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">t0</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">t1</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Presence.residence_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Presence.residence_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Presence.residence_time-163"><a href="#Presence.residence_time-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">residence_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Presence.residence_time-164"><a href="#Presence.residence_time-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="n">t0</span> <span class="o">&gt;=</span> <span class="n">t1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">):</span>
</span><span id="Presence.residence_time-165"><a href="#Presence.residence_time-165"><span class="linenos">165</span></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="Presence.residence_time-166"><a href="#Presence.residence_time-166"><span class="linenos">166</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
</span><span id="Presence.residence_time-167"><a href="#Presence.residence_time-167"><span class="linenos">167</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="Presence.residence_time-168"><a href="#Presence.residence_time-168"><span class="linenos">168</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="TimeModel">
                            <input id="TimeModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TimeModel</span>:

                <label class="view-source-button" for="TimeModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeModel-76"><a href="#TimeModel-76"><span class="linenos"> 76</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TimeModel</span><span class="p">:</span>
</span><span id="TimeModel-77"><a href="#TimeModel-77"><span class="linenos"> 77</span></a>
</span><span id="TimeModel-78"><a href="#TimeModel-78"><span class="linenos"> 78</span></a>
</span><span id="TimeModel-79"><a href="#TimeModel-79"><span class="linenos"> 79</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="n">CalendarUnit</span> <span class="o">=</span> <span class="s2">&quot;seconds&quot;</span><span class="p">):</span>
</span><span id="TimeModel-80"><a href="#TimeModel-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
</span><span id="TimeModel-81"><a href="#TimeModel-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
</span><span id="TimeModel-82"><a href="#TimeModel-82"><span class="linenos"> 82</span></a>
</span><span id="TimeModel-83"><a href="#TimeModel-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="TimeModel-84"><a href="#TimeModel-84"><span class="linenos"> 84</span></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
</span><span id="TimeModel-85"><a href="#TimeModel-85"><span class="linenos"> 85</span></a>        <span class="n">seconds</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="TimeModel-86"><a href="#TimeModel-86"><span class="linenos"> 86</span></a>
</span><span id="TimeModel-87"><a href="#TimeModel-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;seconds&quot;</span><span class="p">:</span>
</span><span id="TimeModel-88"><a href="#TimeModel-88"><span class="linenos"> 88</span></a>            <span class="k">return</span> <span class="n">seconds</span>
</span><span id="TimeModel-89"><a href="#TimeModel-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;minutes&quot;</span><span class="p">:</span>
</span><span id="TimeModel-90"><a href="#TimeModel-90"><span class="linenos"> 90</span></a>            <span class="k">return</span> <span class="n">seconds</span> <span class="o">/</span> <span class="mf">60.0</span>
</span><span id="TimeModel-91"><a href="#TimeModel-91"><span class="linenos"> 91</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;hours&quot;</span><span class="p">:</span>
</span><span id="TimeModel-92"><a href="#TimeModel-92"><span class="linenos"> 92</span></a>            <span class="k">return</span> <span class="n">seconds</span> <span class="o">/</span> <span class="mf">3600.0</span>
</span><span id="TimeModel-93"><a href="#TimeModel-93"><span class="linenos"> 93</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;days&quot;</span><span class="p">:</span>
</span><span id="TimeModel-94"><a href="#TimeModel-94"><span class="linenos"> 94</span></a>            <span class="k">return</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mf">86400.0</span><span class="p">)</span>
</span><span id="TimeModel-95"><a href="#TimeModel-95"><span class="linenos"> 95</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;months&quot;</span><span class="p">:</span>
</span><span id="TimeModel-96"><a href="#TimeModel-96"><span class="linenos"> 96</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel-97"><a href="#TimeModel-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;quarters&quot;</span><span class="p">:</span>
</span><span id="TimeModel-98"><a href="#TimeModel-98"><span class="linenos"> 98</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>
</span><span id="TimeModel-99"><a href="#TimeModel-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;years&quot;</span><span class="p">:</span>
</span><span id="TimeModel-100"><a href="#TimeModel-100"><span class="linenos">100</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
</span><span id="TimeModel-101"><a href="#TimeModel-101"><span class="linenos">101</span></a>
</span><span id="TimeModel-102"><a href="#TimeModel-102"><span class="linenos">102</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported time unit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TimeModel-103"><a href="#TimeModel-103"><span class="linenos">103</span></a>
</span><span id="TimeModel-104"><a href="#TimeModel-104"><span class="linenos">104</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
</span><span id="TimeModel-105"><a href="#TimeModel-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;seconds&quot;</span><span class="p">:</span>
</span><span id="TimeModel-106"><a href="#TimeModel-106"><span class="linenos">106</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel-107"><a href="#TimeModel-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;minutes&quot;</span><span class="p">:</span>
</span><span id="TimeModel-108"><a href="#TimeModel-108"><span class="linenos">108</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel-109"><a href="#TimeModel-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;hours&quot;</span><span class="p">:</span>
</span><span id="TimeModel-110"><a href="#TimeModel-110"><span class="linenos">110</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel-111"><a href="#TimeModel-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;days&quot;</span><span class="p">:</span>
</span><span id="TimeModel-112"><a href="#TimeModel-112"><span class="linenos">112</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel-113"><a href="#TimeModel-113"><span class="linenos">113</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;months&quot;</span><span class="p">,</span> <span class="s2">&quot;quarters&quot;</span><span class="p">,</span> <span class="s2">&quot;years&quot;</span><span class="p">}:</span>
</span><span id="TimeModel-114"><a href="#TimeModel-114"><span class="linenos">114</span></a>            <span class="n">months</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TimeModel-115"><a href="#TimeModel-115"><span class="linenos">115</span></a>                <span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
</span><span id="TimeModel-116"><a href="#TimeModel-116"><span class="linenos">116</span></a>                <span class="s2">&quot;quarters&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)),</span>
</span><span id="TimeModel-117"><a href="#TimeModel-117"><span class="linenos">117</span></a>                <span class="s2">&quot;years&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)),</span>
</span><span id="TimeModel-118"><a href="#TimeModel-118"><span class="linenos">118</span></a>            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span>
</span><span id="TimeModel-119"><a href="#TimeModel-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=+</span><span class="n">months</span><span class="p">)</span>
</span><span id="TimeModel-120"><a href="#TimeModel-120"><span class="linenos">120</span></a>
</span><span id="TimeModel-121"><a href="#TimeModel-121"><span class="linenos">121</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported time unit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TimeModel-122"><a href="#TimeModel-122"><span class="linenos">122</span></a>
</span><span id="TimeModel-123"><a href="#TimeModel-123"><span class="linenos">123</span></a>    <span class="nd">@staticmethod</span>
</span><span id="TimeModel-124"><a href="#TimeModel-124"><span class="linenos">124</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_months_between</span><span class="p">(</span><span class="n">d1</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">d2</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="TimeModel-125"><a href="#TimeModel-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of calendar months between two dates, fractional.&quot;&quot;&quot;</span>
</span><span id="TimeModel-126"><a href="#TimeModel-126"><span class="linenos">126</span></a>        <span class="n">rd</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">d1</span><span class="p">)</span>
</span><span id="TimeModel-127"><a href="#TimeModel-127"><span class="linenos">127</span></a>        <span class="k">return</span> <span class="n">rd</span><span class="o">.</span><span class="n">years</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">rd</span><span class="o">.</span><span class="n">months</span> <span class="o">+</span> <span class="p">(</span><span class="n">rd</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mf">30.0</span><span class="p">)</span>
</span></pre></div>


    

                            <div id="TimeModel.__init__" class="classattr">
                                        <input id="TimeModel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TimeModel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">origin</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">unit</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;seconds&#39;</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">,</span> <span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="s1">&#39;months&#39;</span><span class="p">,</span> <span class="s1">&#39;quarters&#39;</span><span class="p">,</span> <span class="s1">&#39;years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seconds&#39;</span></span>)</span>

                <label class="view-source-button" for="TimeModel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeModel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeModel.__init__-79"><a href="#TimeModel.__init__-79"><span class="linenos">79</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="n">CalendarUnit</span> <span class="o">=</span> <span class="s2">&quot;seconds&quot;</span><span class="p">):</span>
</span><span id="TimeModel.__init__-80"><a href="#TimeModel.__init__-80"><span class="linenos">80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
</span><span id="TimeModel.__init__-81"><a href="#TimeModel.__init__-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
</span></pre></div>


    

                            </div>
                            <div id="TimeModel.origin" class="classattr">
                                <div class="attr variable">
            <span class="name">origin</span>

        
    </div>
    <a class="headerlink" href="#TimeModel.origin"></a>
    
    

                            </div>
                            <div id="TimeModel.unit" class="classattr">
                                <div class="attr variable">
            <span class="name">unit</span>

        
    </div>
    <a class="headerlink" href="#TimeModel.unit"></a>
    
    

                            </div>
                            <div id="TimeModel.to_float" class="classattr">
                                        <input id="TimeModel.to_float-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_float</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="TimeModel.to_float-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeModel.to_float"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeModel.to_float-83"><a href="#TimeModel.to_float-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="TimeModel.to_float-84"><a href="#TimeModel.to_float-84"><span class="linenos"> 84</span></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
</span><span id="TimeModel.to_float-85"><a href="#TimeModel.to_float-85"><span class="linenos"> 85</span></a>        <span class="n">seconds</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="TimeModel.to_float-86"><a href="#TimeModel.to_float-86"><span class="linenos"> 86</span></a>
</span><span id="TimeModel.to_float-87"><a href="#TimeModel.to_float-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;seconds&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-88"><a href="#TimeModel.to_float-88"><span class="linenos"> 88</span></a>            <span class="k">return</span> <span class="n">seconds</span>
</span><span id="TimeModel.to_float-89"><a href="#TimeModel.to_float-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;minutes&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-90"><a href="#TimeModel.to_float-90"><span class="linenos"> 90</span></a>            <span class="k">return</span> <span class="n">seconds</span> <span class="o">/</span> <span class="mf">60.0</span>
</span><span id="TimeModel.to_float-91"><a href="#TimeModel.to_float-91"><span class="linenos"> 91</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;hours&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-92"><a href="#TimeModel.to_float-92"><span class="linenos"> 92</span></a>            <span class="k">return</span> <span class="n">seconds</span> <span class="o">/</span> <span class="mf">3600.0</span>
</span><span id="TimeModel.to_float-93"><a href="#TimeModel.to_float-93"><span class="linenos"> 93</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;days&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-94"><a href="#TimeModel.to_float-94"><span class="linenos"> 94</span></a>            <span class="k">return</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mf">86400.0</span><span class="p">)</span>
</span><span id="TimeModel.to_float-95"><a href="#TimeModel.to_float-95"><span class="linenos"> 95</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;months&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-96"><a href="#TimeModel.to_float-96"><span class="linenos"> 96</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel.to_float-97"><a href="#TimeModel.to_float-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;quarters&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-98"><a href="#TimeModel.to_float-98"><span class="linenos"> 98</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>
</span><span id="TimeModel.to_float-99"><a href="#TimeModel.to_float-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;years&quot;</span><span class="p">:</span>
</span><span id="TimeModel.to_float-100"><a href="#TimeModel.to_float-100"><span class="linenos">100</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
</span><span id="TimeModel.to_float-101"><a href="#TimeModel.to_float-101"><span class="linenos">101</span></a>
</span><span id="TimeModel.to_float-102"><a href="#TimeModel.to_float-102"><span class="linenos">102</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported time unit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="TimeModel.from_float" class="classattr">
                                        <input id="TimeModel.from_float-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">from_float</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">t</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>:</span></span>

                <label class="view-source-button" for="TimeModel.from_float-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimeModel.from_float"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimeModel.from_float-104"><a href="#TimeModel.from_float-104"><span class="linenos">104</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
</span><span id="TimeModel.from_float-105"><a href="#TimeModel.from_float-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;seconds&quot;</span><span class="p">:</span>
</span><span id="TimeModel.from_float-106"><a href="#TimeModel.from_float-106"><span class="linenos">106</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel.from_float-107"><a href="#TimeModel.from_float-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;minutes&quot;</span><span class="p">:</span>
</span><span id="TimeModel.from_float-108"><a href="#TimeModel.from_float-108"><span class="linenos">108</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel.from_float-109"><a href="#TimeModel.from_float-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;hours&quot;</span><span class="p">:</span>
</span><span id="TimeModel.from_float-110"><a href="#TimeModel.from_float-110"><span class="linenos">110</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel.from_float-111"><a href="#TimeModel.from_float-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;days&quot;</span><span class="p">:</span>
</span><span id="TimeModel.from_float-112"><a href="#TimeModel.from_float-112"><span class="linenos">112</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
</span><span id="TimeModel.from_float-113"><a href="#TimeModel.from_float-113"><span class="linenos">113</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;months&quot;</span><span class="p">,</span> <span class="s2">&quot;quarters&quot;</span><span class="p">,</span> <span class="s2">&quot;years&quot;</span><span class="p">}:</span>
</span><span id="TimeModel.from_float-114"><a href="#TimeModel.from_float-114"><span class="linenos">114</span></a>            <span class="n">months</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TimeModel.from_float-115"><a href="#TimeModel.from_float-115"><span class="linenos">115</span></a>                <span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
</span><span id="TimeModel.from_float-116"><a href="#TimeModel.from_float-116"><span class="linenos">116</span></a>                <span class="s2">&quot;quarters&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)),</span>
</span><span id="TimeModel.from_float-117"><a href="#TimeModel.from_float-117"><span class="linenos">117</span></a>                <span class="s2">&quot;years&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)),</span>
</span><span id="TimeModel.from_float-118"><a href="#TimeModel.from_float-118"><span class="linenos">118</span></a>            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span>
</span><span id="TimeModel.from_float-119"><a href="#TimeModel.from_float-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=+</span><span class="n">months</span><span class="p">)</span>
</span><span id="TimeModel.from_float-120"><a href="#TimeModel.from_float-120"><span class="linenos">120</span></a>
</span><span id="TimeModel.from_float-121"><a href="#TimeModel.from_float-121"><span class="linenos">121</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported time unit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="BasisTopology">
                            <input id="BasisTopology-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BasisTopology</span>:

                <label class="view-source-button" for="BasisTopology-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasisTopology"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasisTopology-79"><a href="#BasisTopology-79"><span class="linenos"> 79</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BasisTopology</span><span class="p">:</span>
</span><span id="BasisTopology-80"><a href="#BasisTopology-80"><span class="linenos"> 80</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology-81"><a href="#BasisTopology-81"><span class="linenos"> 81</span></a><span class="sd">    The foundational topology generated by a set of presence assertions.</span>
</span><span id="BasisTopology-82"><a href="#BasisTopology-82"><span class="linenos"> 82</span></a>
</span><span id="BasisTopology-83"><a href="#BasisTopology-83"><span class="linenos"> 83</span></a><span class="sd">    Presences are treated as basis elements defining basic open sets.</span>
</span><span id="BasisTopology-84"><a href="#BasisTopology-84"><span class="linenos"> 84</span></a><span class="sd">    Internally, presences are grouped into sorted open covers per (element, boundary)</span>
</span><span id="BasisTopology-85"><a href="#BasisTopology-85"><span class="linenos"> 85</span></a><span class="sd">    and exposed through join, closure, and overlap operations.</span>
</span><span id="BasisTopology-86"><a href="#BasisTopology-86"><span class="linenos"> 86</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BasisTopology-87"><a href="#BasisTopology-87"><span class="linenos"> 87</span></a>
</span><span id="BasisTopology-88"><a href="#BasisTopology-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presences</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Presence</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BasisTopology-89"><a href="#BasisTopology-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology-90"><a href="#BasisTopology-90"><span class="linenos"> 90</span></a><span class="sd">        Initializes the topology from a set of presences.</span>
</span><span id="BasisTopology-91"><a href="#BasisTopology-91"><span class="linenos"> 91</span></a>
</span><span id="BasisTopology-92"><a href="#BasisTopology-92"><span class="linenos"> 92</span></a><span class="sd">        Internally maintains a SortedSet for each (element, boundary) pair,</span>
</span><span id="BasisTopology-93"><a href="#BasisTopology-93"><span class="linenos"> 93</span></a><span class="sd">        ordered by onset_time for efficient merge and overlap operations.</span>
</span><span id="BasisTopology-94"><a href="#BasisTopology-94"><span class="linenos"> 94</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology-95"><a href="#BasisTopology-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">SortedSet</span><span class="p">[</span><span class="n">Presence</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span id="BasisTopology-96"><a href="#BasisTopology-96"><span class="linenos"> 96</span></a>            <span class="k">lambda</span><span class="p">:</span> <span class="n">SortedSet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">presence_sort_key</span><span class="p">)</span>
</span><span id="BasisTopology-97"><a href="#BasisTopology-97"><span class="linenos"> 97</span></a>        <span class="p">)</span>
</span><span id="BasisTopology-98"><a href="#BasisTopology-98"><span class="linenos"> 98</span></a>
</span><span id="BasisTopology-99"><a href="#BasisTopology-99"><span class="linenos"> 99</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">presences</span><span class="p">:</span>
</span><span id="BasisTopology-100"><a href="#BasisTopology-100"><span class="linenos">100</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span>
</span><span id="BasisTopology-101"><a href="#BasisTopology-101"><span class="linenos">101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology-102"><a href="#BasisTopology-102"><span class="linenos">102</span></a>
</span><span id="BasisTopology-103"><a href="#BasisTopology-103"><span class="linenos">103</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">boundary</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SortedSet</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="BasisTopology-104"><a href="#BasisTopology-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology-105"><a href="#BasisTopology-105"><span class="linenos">105</span></a><span class="sd">        Returns the open cover for a given (element, boundary) pair.</span>
</span><span id="BasisTopology-106"><a href="#BasisTopology-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology-107"><a href="#BasisTopology-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">element</span><span class="p">,</span> <span class="n">boundary</span><span class="p">),</span> <span class="n">SortedSet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">presence_sort_key</span><span class="p">))</span>
</span><span id="BasisTopology-108"><a href="#BasisTopology-108"><span class="linenos">108</span></a>
</span><span id="BasisTopology-109"><a href="#BasisTopology-109"><span class="linenos">109</span></a>    <span class="nd">@staticmethod</span>
</span><span id="BasisTopology-110"><a href="#BasisTopology-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="n">p1</span><span class="p">:</span> <span class="n">Presence</span><span class="p">,</span> <span class="n">p2</span><span class="p">:</span> <span class="n">Presence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Presence</span><span class="p">:</span>
</span><span id="BasisTopology-111"><a href="#BasisTopology-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology-112"><a href="#BasisTopology-112"><span class="linenos">112</span></a><span class="sd">        Returns the join of two basis elements if they overlap or touch in time.</span>
</span><span id="BasisTopology-113"><a href="#BasisTopology-113"><span class="linenos">113</span></a><span class="sd">        Returns EMPTY_PRESENCE if the presences are disjoint or incompatible.</span>
</span><span id="BasisTopology-114"><a href="#BasisTopology-114"><span class="linenos">114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology-115"><a href="#BasisTopology-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">boundary</span><span class="p">):</span>
</span><span id="BasisTopology-116"><a href="#BasisTopology-116"><span class="linenos">116</span></a>            <span class="k">return</span> <span class="n">EMPTY_PRESENCE</span>
</span><span id="BasisTopology-117"><a href="#BasisTopology-117"><span class="linenos">117</span></a>
</span><span id="BasisTopology-118"><a href="#BasisTopology-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="n">p1</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p1</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
</span><span id="BasisTopology-119"><a href="#BasisTopology-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="n">EMPTY_PRESENCE</span>
</span><span id="BasisTopology-120"><a href="#BasisTopology-120"><span class="linenos">120</span></a>        <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&lt;</span> <span class="n">p1</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p2</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
</span><span id="BasisTopology-121"><a href="#BasisTopology-121"><span class="linenos">121</span></a>            <span class="k">return</span> <span class="n">EMPTY_PRESENCE</span>
</span><span id="BasisTopology-122"><a href="#BasisTopology-122"><span class="linenos">122</span></a>
</span><span id="BasisTopology-123"><a href="#BasisTopology-123"><span class="linenos">123</span></a>        <span class="k">return</span> <span class="n">Presence</span><span class="p">(</span>
</span><span id="BasisTopology-124"><a href="#BasisTopology-124"><span class="linenos">124</span></a>            <span class="n">element</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>
</span><span id="BasisTopology-125"><a href="#BasisTopology-125"><span class="linenos">125</span></a>            <span class="n">boundary</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">boundary</span><span class="p">,</span>
</span><span id="BasisTopology-126"><a href="#BasisTopology-126"><span class="linenos">126</span></a>            <span class="n">onset_time</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">onset_time</span><span class="p">),</span>
</span><span id="BasisTopology-127"><a href="#BasisTopology-127"><span class="linenos">127</span></a>            <span class="n">reset_time</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">reset_time</span><span class="p">),</span>
</span><span id="BasisTopology-128"><a href="#BasisTopology-128"><span class="linenos">128</span></a>            <span class="n">provenance</span><span class="o">=</span><span class="s2">&quot;join&quot;</span><span class="p">,</span>
</span><span id="BasisTopology-129"><a href="#BasisTopology-129"><span class="linenos">129</span></a>        <span class="p">)</span>
</span><span id="BasisTopology-130"><a href="#BasisTopology-130"><span class="linenos">130</span></a>
</span><span id="BasisTopology-131"><a href="#BasisTopology-131"><span class="linenos">131</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="BasisTopology-132"><a href="#BasisTopology-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology-133"><a href="#BasisTopology-133"><span class="linenos">133</span></a><span class="sd">        Computes the closure under join for each cover.</span>
</span><span id="BasisTopology-134"><a href="#BasisTopology-134"><span class="linenos">134</span></a>
</span><span id="BasisTopology-135"><a href="#BasisTopology-135"><span class="linenos">135</span></a><span class="sd">        Returns a deduplicated set of merged presences that cover the same regions</span>
</span><span id="BasisTopology-136"><a href="#BasisTopology-136"><span class="linenos">136</span></a><span class="sd">        as the original topology, but without adjacent overlaps.</span>
</span><span id="BasisTopology-137"><a href="#BasisTopology-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology-138"><a href="#BasisTopology-138"><span class="linenos">138</span></a>        <span class="n">closed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="BasisTopology-139"><a href="#BasisTopology-139"><span class="linenos">139</span></a>
</span><span id="BasisTopology-140"><a href="#BasisTopology-140"><span class="linenos">140</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cover</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BasisTopology-141"><a href="#BasisTopology-141"><span class="linenos">141</span></a>            <span class="n">merged_cover</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BasisTopology-142"><a href="#BasisTopology-142"><span class="linenos">142</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cover</span><span class="p">:</span>
</span><span id="BasisTopology-143"><a href="#BasisTopology-143"><span class="linenos">143</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">merged_cover</span><span class="p">:</span>
</span><span id="BasisTopology-144"><a href="#BasisTopology-144"><span class="linenos">144</span></a>                    <span class="n">merged_cover</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology-145"><a href="#BasisTopology-145"><span class="linenos">145</span></a>                    <span class="k">continue</span>
</span><span id="BasisTopology-146"><a href="#BasisTopology-146"><span class="linenos">146</span></a>
</span><span id="BasisTopology-147"><a href="#BasisTopology-147"><span class="linenos">147</span></a>                <span class="n">last</span> <span class="o">=</span> <span class="n">merged_cover</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BasisTopology-148"><a href="#BasisTopology-148"><span class="linenos">148</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology-149"><a href="#BasisTopology-149"><span class="linenos">149</span></a>
</span><span id="BasisTopology-150"><a href="#BasisTopology-150"><span class="linenos">150</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">EMPTY_PRESENCE</span><span class="p">:</span>
</span><span id="BasisTopology-151"><a href="#BasisTopology-151"><span class="linenos">151</span></a>                    <span class="n">merged_cover</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
</span><span id="BasisTopology-152"><a href="#BasisTopology-152"><span class="linenos">152</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BasisTopology-153"><a href="#BasisTopology-153"><span class="linenos">153</span></a>                    <span class="n">merged_cover</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology-154"><a href="#BasisTopology-154"><span class="linenos">154</span></a>
</span><span id="BasisTopology-155"><a href="#BasisTopology-155"><span class="linenos">155</span></a>            <span class="n">closed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">merged_cover</span><span class="p">)</span>
</span><span id="BasisTopology-156"><a href="#BasisTopology-156"><span class="linenos">156</span></a>
</span><span id="BasisTopology-157"><a href="#BasisTopology-157"><span class="linenos">157</span></a>        <span class="k">return</span> <span class="n">closed</span>
</span><span id="BasisTopology-158"><a href="#BasisTopology-158"><span class="linenos">158</span></a>
</span><span id="BasisTopology-159"><a href="#BasisTopology-159"><span class="linenos">159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_overlapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="n">Presence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="BasisTopology-160"><a href="#BasisTopology-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology-161"><a href="#BasisTopology-161"><span class="linenos">161</span></a><span class="sd">        Finds all presences in the same cover that overlap with the given presence.</span>
</span><span id="BasisTopology-162"><a href="#BasisTopology-162"><span class="linenos">162</span></a>
</span><span id="BasisTopology-163"><a href="#BasisTopology-163"><span class="linenos">163</span></a><span class="sd">        This is a linear scan from the first potentially overlapping point onward,</span>
</span><span id="BasisTopology-164"><a href="#BasisTopology-164"><span class="linenos">164</span></a><span class="sd">        relying on the sorted order of onset_time.</span>
</span><span id="BasisTopology-165"><a href="#BasisTopology-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology-166"><a href="#BasisTopology-166"><span class="linenos">166</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">presence</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">presence</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span>
</span><span id="BasisTopology-167"><a href="#BasisTopology-167"><span class="linenos">167</span></a>        <span class="n">cover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SortedSet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">presence_sort_key</span><span class="p">))</span>
</span><span id="BasisTopology-168"><a href="#BasisTopology-168"><span class="linenos">168</span></a>        <span class="n">overlapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BasisTopology-169"><a href="#BasisTopology-169"><span class="linenos">169</span></a>
</span><span id="BasisTopology-170"><a href="#BasisTopology-170"><span class="linenos">170</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cover</span><span class="o">.</span><span class="n">irange</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="BasisTopology-171"><a href="#BasisTopology-171"><span class="linenos">171</span></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">&gt;=</span> <span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">:</span>
</span><span id="BasisTopology-172"><a href="#BasisTopology-172"><span class="linenos">172</span></a>                <span class="k">break</span>
</span><span id="BasisTopology-173"><a href="#BasisTopology-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&gt;</span> <span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">:</span>
</span><span id="BasisTopology-174"><a href="#BasisTopology-174"><span class="linenos">174</span></a>                <span class="n">overlapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology-175"><a href="#BasisTopology-175"><span class="linenos">175</span></a>
</span><span id="BasisTopology-176"><a href="#BasisTopology-176"><span class="linenos">176</span></a>        <span class="k">return</span> <span class="n">overlapping</span>
</span><span id="BasisTopology-177"><a href="#BasisTopology-177"><span class="linenos">177</span></a>
</span><span id="BasisTopology-178"><a href="#BasisTopology-178"><span class="linenos">178</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BasisTopology-179"><a href="#BasisTopology-179"><span class="linenos">179</span></a>        <span class="k">for</span> <span class="n">cover</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="BasisTopology-180"><a href="#BasisTopology-180"><span class="linenos">180</span></a>            <span class="k">yield from</span> <span class="n">cover</span>
</span></pre></div>


            <div class="docstring"><p>The foundational topology generated by a set of presence assertions.</p>

<p>Presences are treated as basis elements defining basic open sets.
Internally, presences are grouped into sorted open covers per (element, boundary)
and exposed through join, closure, and overlap operations.</p>
</div>


                            <div id="BasisTopology.__init__" class="classattr">
                                        <input id="BasisTopology.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">BasisTopology</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">presences</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="#Presence">Presence</a></span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="BasisTopology.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasisTopology.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasisTopology.__init__-88"><a href="#BasisTopology.__init__-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presences</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Presence</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BasisTopology.__init__-89"><a href="#BasisTopology.__init__-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology.__init__-90"><a href="#BasisTopology.__init__-90"><span class="linenos"> 90</span></a><span class="sd">        Initializes the topology from a set of presences.</span>
</span><span id="BasisTopology.__init__-91"><a href="#BasisTopology.__init__-91"><span class="linenos"> 91</span></a>
</span><span id="BasisTopology.__init__-92"><a href="#BasisTopology.__init__-92"><span class="linenos"> 92</span></a><span class="sd">        Internally maintains a SortedSet for each (element, boundary) pair,</span>
</span><span id="BasisTopology.__init__-93"><a href="#BasisTopology.__init__-93"><span class="linenos"> 93</span></a><span class="sd">        ordered by onset_time for efficient merge and overlap operations.</span>
</span><span id="BasisTopology.__init__-94"><a href="#BasisTopology.__init__-94"><span class="linenos"> 94</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology.__init__-95"><a href="#BasisTopology.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">SortedSet</span><span class="p">[</span><span class="n">Presence</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span id="BasisTopology.__init__-96"><a href="#BasisTopology.__init__-96"><span class="linenos"> 96</span></a>            <span class="k">lambda</span><span class="p">:</span> <span class="n">SortedSet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">presence_sort_key</span><span class="p">)</span>
</span><span id="BasisTopology.__init__-97"><a href="#BasisTopology.__init__-97"><span class="linenos"> 97</span></a>        <span class="p">)</span>
</span><span id="BasisTopology.__init__-98"><a href="#BasisTopology.__init__-98"><span class="linenos"> 98</span></a>
</span><span id="BasisTopology.__init__-99"><a href="#BasisTopology.__init__-99"><span class="linenos"> 99</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">presences</span><span class="p">:</span>
</span><span id="BasisTopology.__init__-100"><a href="#BasisTopology.__init__-100"><span class="linenos">100</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span>
</span><span id="BasisTopology.__init__-101"><a href="#BasisTopology.__init__-101"><span class="linenos">101</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the topology from a set of presences.</p>

<p>Internally maintains a SortedSet for each (element, boundary) pair,
ordered by onset_time for efficient merge and overlap operations.</p>
</div>


                            </div>
                            <div id="BasisTopology.cover_index" class="classattr">
                                <div class="attr variable">
            <span class="name">cover_index</span><span class="annotation">: dict[typing.Tuple, sortedcontainers.sortedset.SortedSet[<a href="#Presence">Presence</a>]]</span>

        
    </div>
    <a class="headerlink" href="#BasisTopology.cover_index"></a>
    
    

                            </div>
                            <div id="BasisTopology.get_cover" class="classattr">
                                        <input id="BasisTopology.get_cover-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_cover</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">element</span>,</span><span class="param">	<span class="n">boundary</span></span><span class="return-annotation">) -> <span class="n">sortedcontainers</span><span class="o">.</span><span class="n">sortedset</span><span class="o">.</span><span class="n">SortedSet</span><span class="p">[</span><span class="n"><a href="#Presence">Presence</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BasisTopology.get_cover-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasisTopology.get_cover"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasisTopology.get_cover-103"><a href="#BasisTopology.get_cover-103"><span class="linenos">103</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">boundary</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SortedSet</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="BasisTopology.get_cover-104"><a href="#BasisTopology.get_cover-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology.get_cover-105"><a href="#BasisTopology.get_cover-105"><span class="linenos">105</span></a><span class="sd">        Returns the open cover for a given (element, boundary) pair.</span>
</span><span id="BasisTopology.get_cover-106"><a href="#BasisTopology.get_cover-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology.get_cover-107"><a href="#BasisTopology.get_cover-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">element</span><span class="p">,</span> <span class="n">boundary</span><span class="p">),</span> <span class="n">SortedSet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">presence_sort_key</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Returns the open cover for a given (element, boundary) pair.</p>
</div>


                            </div>
                            <div id="BasisTopology.join" class="classattr">
                                        <input id="BasisTopology.join-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">join</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">p1</span><span class="p">:</span> <span class="n"><a href="#Presence">Presence</a></span>,</span><span class="param">	<span class="n">p2</span><span class="p">:</span> <span class="n"><a href="#Presence">Presence</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#Presence">Presence</a></span>:</span></span>

                <label class="view-source-button" for="BasisTopology.join-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasisTopology.join"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasisTopology.join-109"><a href="#BasisTopology.join-109"><span class="linenos">109</span></a>    <span class="nd">@staticmethod</span>
</span><span id="BasisTopology.join-110"><a href="#BasisTopology.join-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="n">p1</span><span class="p">:</span> <span class="n">Presence</span><span class="p">,</span> <span class="n">p2</span><span class="p">:</span> <span class="n">Presence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Presence</span><span class="p">:</span>
</span><span id="BasisTopology.join-111"><a href="#BasisTopology.join-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology.join-112"><a href="#BasisTopology.join-112"><span class="linenos">112</span></a><span class="sd">        Returns the join of two basis elements if they overlap or touch in time.</span>
</span><span id="BasisTopology.join-113"><a href="#BasisTopology.join-113"><span class="linenos">113</span></a><span class="sd">        Returns EMPTY_PRESENCE if the presences are disjoint or incompatible.</span>
</span><span id="BasisTopology.join-114"><a href="#BasisTopology.join-114"><span class="linenos">114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology.join-115"><a href="#BasisTopology.join-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">boundary</span><span class="p">):</span>
</span><span id="BasisTopology.join-116"><a href="#BasisTopology.join-116"><span class="linenos">116</span></a>            <span class="k">return</span> <span class="n">EMPTY_PRESENCE</span>
</span><span id="BasisTopology.join-117"><a href="#BasisTopology.join-117"><span class="linenos">117</span></a>
</span><span id="BasisTopology.join-118"><a href="#BasisTopology.join-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="n">p1</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p1</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
</span><span id="BasisTopology.join-119"><a href="#BasisTopology.join-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="n">EMPTY_PRESENCE</span>
</span><span id="BasisTopology.join-120"><a href="#BasisTopology.join-120"><span class="linenos">120</span></a>        <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&lt;</span> <span class="n">p1</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p2</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
</span><span id="BasisTopology.join-121"><a href="#BasisTopology.join-121"><span class="linenos">121</span></a>            <span class="k">return</span> <span class="n">EMPTY_PRESENCE</span>
</span><span id="BasisTopology.join-122"><a href="#BasisTopology.join-122"><span class="linenos">122</span></a>
</span><span id="BasisTopology.join-123"><a href="#BasisTopology.join-123"><span class="linenos">123</span></a>        <span class="k">return</span> <span class="n">Presence</span><span class="p">(</span>
</span><span id="BasisTopology.join-124"><a href="#BasisTopology.join-124"><span class="linenos">124</span></a>            <span class="n">element</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>
</span><span id="BasisTopology.join-125"><a href="#BasisTopology.join-125"><span class="linenos">125</span></a>            <span class="n">boundary</span><span class="o">=</span><span class="n">p1</span><span class="o">.</span><span class="n">boundary</span><span class="p">,</span>
</span><span id="BasisTopology.join-126"><a href="#BasisTopology.join-126"><span class="linenos">126</span></a>            <span class="n">onset_time</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">onset_time</span><span class="p">),</span>
</span><span id="BasisTopology.join-127"><a href="#BasisTopology.join-127"><span class="linenos">127</span></a>            <span class="n">reset_time</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">p2</span><span class="o">.</span><span class="n">reset_time</span><span class="p">),</span>
</span><span id="BasisTopology.join-128"><a href="#BasisTopology.join-128"><span class="linenos">128</span></a>            <span class="n">provenance</span><span class="o">=</span><span class="s2">&quot;join&quot;</span><span class="p">,</span>
</span><span id="BasisTopology.join-129"><a href="#BasisTopology.join-129"><span class="linenos">129</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns the join of two basis elements if they overlap or touch in time.
Returns EMPTY_PRESENCE if the presences are disjoint or incompatible.</p>
</div>


                            </div>
                            <div id="BasisTopology.closure" class="classattr">
                                        <input id="BasisTopology.closure-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">closure</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">set</span><span class="p">[</span><span class="n"><a href="#Presence">Presence</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BasisTopology.closure-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasisTopology.closure"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasisTopology.closure-131"><a href="#BasisTopology.closure-131"><span class="linenos">131</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="BasisTopology.closure-132"><a href="#BasisTopology.closure-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology.closure-133"><a href="#BasisTopology.closure-133"><span class="linenos">133</span></a><span class="sd">        Computes the closure under join for each cover.</span>
</span><span id="BasisTopology.closure-134"><a href="#BasisTopology.closure-134"><span class="linenos">134</span></a>
</span><span id="BasisTopology.closure-135"><a href="#BasisTopology.closure-135"><span class="linenos">135</span></a><span class="sd">        Returns a deduplicated set of merged presences that cover the same regions</span>
</span><span id="BasisTopology.closure-136"><a href="#BasisTopology.closure-136"><span class="linenos">136</span></a><span class="sd">        as the original topology, but without adjacent overlaps.</span>
</span><span id="BasisTopology.closure-137"><a href="#BasisTopology.closure-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology.closure-138"><a href="#BasisTopology.closure-138"><span class="linenos">138</span></a>        <span class="n">closed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="BasisTopology.closure-139"><a href="#BasisTopology.closure-139"><span class="linenos">139</span></a>
</span><span id="BasisTopology.closure-140"><a href="#BasisTopology.closure-140"><span class="linenos">140</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cover</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BasisTopology.closure-141"><a href="#BasisTopology.closure-141"><span class="linenos">141</span></a>            <span class="n">merged_cover</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BasisTopology.closure-142"><a href="#BasisTopology.closure-142"><span class="linenos">142</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cover</span><span class="p">:</span>
</span><span id="BasisTopology.closure-143"><a href="#BasisTopology.closure-143"><span class="linenos">143</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">merged_cover</span><span class="p">:</span>
</span><span id="BasisTopology.closure-144"><a href="#BasisTopology.closure-144"><span class="linenos">144</span></a>                    <span class="n">merged_cover</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology.closure-145"><a href="#BasisTopology.closure-145"><span class="linenos">145</span></a>                    <span class="k">continue</span>
</span><span id="BasisTopology.closure-146"><a href="#BasisTopology.closure-146"><span class="linenos">146</span></a>
</span><span id="BasisTopology.closure-147"><a href="#BasisTopology.closure-147"><span class="linenos">147</span></a>                <span class="n">last</span> <span class="o">=</span> <span class="n">merged_cover</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BasisTopology.closure-148"><a href="#BasisTopology.closure-148"><span class="linenos">148</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology.closure-149"><a href="#BasisTopology.closure-149"><span class="linenos">149</span></a>
</span><span id="BasisTopology.closure-150"><a href="#BasisTopology.closure-150"><span class="linenos">150</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">EMPTY_PRESENCE</span><span class="p">:</span>
</span><span id="BasisTopology.closure-151"><a href="#BasisTopology.closure-151"><span class="linenos">151</span></a>                    <span class="n">merged_cover</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
</span><span id="BasisTopology.closure-152"><a href="#BasisTopology.closure-152"><span class="linenos">152</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BasisTopology.closure-153"><a href="#BasisTopology.closure-153"><span class="linenos">153</span></a>                    <span class="n">merged_cover</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology.closure-154"><a href="#BasisTopology.closure-154"><span class="linenos">154</span></a>
</span><span id="BasisTopology.closure-155"><a href="#BasisTopology.closure-155"><span class="linenos">155</span></a>            <span class="n">closed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">merged_cover</span><span class="p">)</span>
</span><span id="BasisTopology.closure-156"><a href="#BasisTopology.closure-156"><span class="linenos">156</span></a>
</span><span id="BasisTopology.closure-157"><a href="#BasisTopology.closure-157"><span class="linenos">157</span></a>        <span class="k">return</span> <span class="n">closed</span>
</span></pre></div>


            <div class="docstring"><p>Computes the closure under join for each cover.</p>

<p>Returns a deduplicated set of merged presences that cover the same regions
as the original topology, but without adjacent overlaps.</p>
</div>


                            </div>
                            <div id="BasisTopology.find_overlapping" class="classattr">
                                        <input id="BasisTopology.find_overlapping-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_overlapping</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">presence</span><span class="p">:</span> <span class="n"><a href="#Presence">Presence</a></span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Presence">Presence</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BasisTopology.find_overlapping-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasisTopology.find_overlapping"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasisTopology.find_overlapping-159"><a href="#BasisTopology.find_overlapping-159"><span class="linenos">159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_overlapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="n">Presence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="BasisTopology.find_overlapping-160"><a href="#BasisTopology.find_overlapping-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BasisTopology.find_overlapping-161"><a href="#BasisTopology.find_overlapping-161"><span class="linenos">161</span></a><span class="sd">        Finds all presences in the same cover that overlap with the given presence.</span>
</span><span id="BasisTopology.find_overlapping-162"><a href="#BasisTopology.find_overlapping-162"><span class="linenos">162</span></a>
</span><span id="BasisTopology.find_overlapping-163"><a href="#BasisTopology.find_overlapping-163"><span class="linenos">163</span></a><span class="sd">        This is a linear scan from the first potentially overlapping point onward,</span>
</span><span id="BasisTopology.find_overlapping-164"><a href="#BasisTopology.find_overlapping-164"><span class="linenos">164</span></a><span class="sd">        relying on the sorted order of onset_time.</span>
</span><span id="BasisTopology.find_overlapping-165"><a href="#BasisTopology.find_overlapping-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BasisTopology.find_overlapping-166"><a href="#BasisTopology.find_overlapping-166"><span class="linenos">166</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">presence</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">presence</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span>
</span><span id="BasisTopology.find_overlapping-167"><a href="#BasisTopology.find_overlapping-167"><span class="linenos">167</span></a>        <span class="n">cover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SortedSet</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">presence_sort_key</span><span class="p">))</span>
</span><span id="BasisTopology.find_overlapping-168"><a href="#BasisTopology.find_overlapping-168"><span class="linenos">168</span></a>        <span class="n">overlapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BasisTopology.find_overlapping-169"><a href="#BasisTopology.find_overlapping-169"><span class="linenos">169</span></a>
</span><span id="BasisTopology.find_overlapping-170"><a href="#BasisTopology.find_overlapping-170"><span class="linenos">170</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cover</span><span class="o">.</span><span class="n">irange</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="BasisTopology.find_overlapping-171"><a href="#BasisTopology.find_overlapping-171"><span class="linenos">171</span></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">onset_time</span> <span class="o">&gt;=</span> <span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">:</span>
</span><span id="BasisTopology.find_overlapping-172"><a href="#BasisTopology.find_overlapping-172"><span class="linenos">172</span></a>                <span class="k">break</span>
</span><span id="BasisTopology.find_overlapping-173"><a href="#BasisTopology.find_overlapping-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">&gt;</span> <span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">:</span>
</span><span id="BasisTopology.find_overlapping-174"><a href="#BasisTopology.find_overlapping-174"><span class="linenos">174</span></a>                <span class="n">overlapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="BasisTopology.find_overlapping-175"><a href="#BasisTopology.find_overlapping-175"><span class="linenos">175</span></a>
</span><span id="BasisTopology.find_overlapping-176"><a href="#BasisTopology.find_overlapping-176"><span class="linenos">176</span></a>        <span class="k">return</span> <span class="n">overlapping</span>
</span></pre></div>


            <div class="docstring"><p>Finds all presences in the same cover that overlap with the given presence.</p>

<p>This is a linear scan from the first potentially overlapping point onward,
relying on the sorted order of onset_time.</p>
</div>


                            </div>
                </section>
                <section id="Timescale">
                            <input id="Timescale-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">Timescale</span>:

                <label class="view-source-button" for="Timescale-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale-13"><a href="#Timescale-13"><span class="linenos"> 13</span></a><span class="nd">@dataclass</span>
</span><span id="Timescale-14"><a href="#Timescale-14"><span class="linenos"> 14</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Timescale</span><span class="p">:</span>
</span><span id="Timescale-15"><a href="#Timescale-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Timescale-16"><a href="#Timescale-16"><span class="linenos"> 16</span></a><span class="sd">    Timescale represents a partitioning of a continuous time interval [t0, t1)</span>
</span><span id="Timescale-17"><a href="#Timescale-17"><span class="linenos"> 17</span></a><span class="sd">    into N = ceil((t1 - t0) / bin_width) contiguous, left-aligned, non-overlapping bins.</span>
</span><span id="Timescale-18"><a href="#Timescale-18"><span class="linenos"> 18</span></a>
</span><span id="Timescale-19"><a href="#Timescale-19"><span class="linenos"> 19</span></a><span class="sd">    Each bin has width `bin_width` and covers a half-open interval:</span>
</span><span id="Timescale-20"><a href="#Timescale-20"><span class="linenos"> 20</span></a><span class="sd">        Bin k = [t0 + k * bin_width, t0 + (k + 1) * bin_width)</span>
</span><span id="Timescale-21"><a href="#Timescale-21"><span class="linenos"> 21</span></a>
</span><span id="Timescale-22"><a href="#Timescale-22"><span class="linenos"> 22</span></a><span class="sd">    This class provides methods for:</span>
</span><span id="Timescale-23"><a href="#Timescale-23"><span class="linenos"> 23</span></a><span class="sd">    - Mapping real-valued timestamps to discrete bin indices</span>
</span><span id="Timescale-24"><a href="#Timescale-24"><span class="linenos"> 24</span></a><span class="sd">    - Extracting the time boundaries of any bin</span>
</span><span id="Timescale-25"><a href="#Timescale-25"><span class="linenos"> 25</span></a><span class="sd">    - Computing which bins an interval [start, end) overlaps</span>
</span><span id="Timescale-26"><a href="#Timescale-26"><span class="linenos"> 26</span></a><span class="sd">    - Estimating how much of a bin is covered by a given interval</span>
</span><span id="Timescale-27"><a href="#Timescale-27"><span class="linenos"> 27</span></a>
</span><span id="Timescale-28"><a href="#Timescale-28"><span class="linenos"> 28</span></a><span class="sd">    **Boundary Behavior**:</span>
</span><span id="Timescale-29"><a href="#Timescale-29"><span class="linenos"> 29</span></a><span class="sd">    - All bins lie strictly within [t0, t1)</span>
</span><span id="Timescale-30"><a href="#Timescale-30"><span class="linenos"> 30</span></a><span class="sd">    - Any time `t` where t &lt; t0 or t &gt;= t1 is considered **outside** the defined timescale</span>
</span><span id="Timescale-31"><a href="#Timescale-31"><span class="linenos"> 31</span></a><span class="sd">    - bin_index(t) may return an out-of-range index if `t &lt; t0` or `t &gt;= t1`</span>
</span><span id="Timescale-32"><a href="#Timescale-32"><span class="linenos"> 32</span></a>
</span><span id="Timescale-33"><a href="#Timescale-33"><span class="linenos"> 33</span></a><span class="sd">    This class does not perform clipping: it assumes all inputs are in-range unless explicitly clipped by the caller.</span>
</span><span id="Timescale-34"><a href="#Timescale-34"><span class="linenos"> 34</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Timescale-35"><a href="#Timescale-35"><span class="linenos"> 35</span></a>
</span><span id="Timescale-36"><a href="#Timescale-36"><span class="linenos"> 36</span></a>    <span class="n">t0</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Timescale-37"><a href="#Timescale-37"><span class="linenos"> 37</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;start time of the interval [t0, t1)&quot;&quot;&quot;</span>
</span><span id="Timescale-38"><a href="#Timescale-38"><span class="linenos"> 38</span></a>    <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Timescale-39"><a href="#Timescale-39"><span class="linenos"> 39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;end time of the interval [t0, t1)&quot;&quot;&quot;</span>
</span><span id="Timescale-40"><a href="#Timescale-40"><span class="linenos"> 40</span></a>
</span><span id="Timescale-41"><a href="#Timescale-41"><span class="linenos"> 41</span></a>    <span class="n">bin_width</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Timescale-42"><a href="#Timescale-42"><span class="linenos"> 42</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Width of each bin&quot;&quot;&quot;</span>
</span><span id="Timescale-43"><a href="#Timescale-43"><span class="linenos"> 43</span></a>
</span><span id="Timescale-44"><a href="#Timescale-44"><span class="linenos"> 44</span></a>    <span class="nd">@property</span>
</span><span id="Timescale-45"><a href="#Timescale-45"><span class="linenos"> 45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">num_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Timescale-46"><a href="#Timescale-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of bins between t0 and t1.&quot;&quot;&quot;</span>
</span><span id="Timescale-47"><a href="#Timescale-47"><span class="linenos"> 47</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span><span id="Timescale-48"><a href="#Timescale-48"><span class="linenos"> 48</span></a>
</span><span id="Timescale-49"><a href="#Timescale-49"><span class="linenos"> 49</span></a>    <span class="c1"># Mapping from continuous time to discrete bins.</span>
</span><span id="Timescale-50"><a href="#Timescale-50"><span class="linenos"> 50</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Timescale-51"><a href="#Timescale-51"><span class="linenos"> 51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Purpose:</span>
</span><span id="Timescale-52"><a href="#Timescale-52"><span class="linenos"> 52</span></a><span class="sd">            Map a real-valued timestamp to the index of the bin that contains it.</span>
</span><span id="Timescale-53"><a href="#Timescale-53"><span class="linenos"> 53</span></a>
</span><span id="Timescale-54"><a href="#Timescale-54"><span class="linenos"> 54</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale-55"><a href="#Timescale-55"><span class="linenos"> 55</span></a><span class="sd">            Returns k such that bin_start(k) ≤ time &lt; bin_end(k)</span>
</span><span id="Timescale-56"><a href="#Timescale-56"><span class="linenos"> 56</span></a><span class="sd">            Uses floor() logic — i.e., left-aligned binning</span>
</span><span id="Timescale-57"><a href="#Timescale-57"><span class="linenos"> 57</span></a><span class="sd">            No bounds check: time &lt; t0 may yield negative indices; time ≥ t1 may return out-of-bounds indices</span>
</span><span id="Timescale-58"><a href="#Timescale-58"><span class="linenos"> 58</span></a><span class="sd">            Caller is responsible for ensuring t0 ≤ time &lt; t1 if range enforcement is needed</span>
</span><span id="Timescale-59"><a href="#Timescale-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-60"><a href="#Timescale-60"><span class="linenos"> 60</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span><span id="Timescale-61"><a href="#Timescale-61"><span class="linenos"> 61</span></a>
</span><span id="Timescale-62"><a href="#Timescale-62"><span class="linenos"> 62</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="Timescale-63"><a href="#Timescale-63"><span class="linenos"> 63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the bin indices [start_bin, end_bin) that overlap the interval [start, end).</span>
</span><span id="Timescale-64"><a href="#Timescale-64"><span class="linenos"> 64</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale-65"><a href="#Timescale-65"><span class="linenos"> 65</span></a><span class="sd">            - Clips the interval [start, end) to [t0, t1) before binning</span>
</span><span id="Timescale-66"><a href="#Timescale-66"><span class="linenos"> 66</span></a><span class="sd">            - Computes:</span>
</span><span id="Timescale-67"><a href="#Timescale-67"><span class="linenos"> 67</span></a><span class="sd">                start_bin = floor((clipped_start - t0) / bin_width)</span>
</span><span id="Timescale-68"><a href="#Timescale-68"><span class="linenos"> 68</span></a><span class="sd">                end_bin   = ceil((clipped_end   - t0) / bin_width)</span>
</span><span id="Timescale-69"><a href="#Timescale-69"><span class="linenos"> 69</span></a><span class="sd">            - Resulting slice [start_bin, end_bin) may be empty if the interval does not overlap the timescale</span>
</span><span id="Timescale-70"><a href="#Timescale-70"><span class="linenos"> 70</span></a><span class="sd">            - start_bin ∈ [0, num_bins)</span>
</span><span id="Timescale-71"><a href="#Timescale-71"><span class="linenos"> 71</span></a><span class="sd">            - end_bin   ∈ [0, num_bins]</span>
</span><span id="Timescale-72"><a href="#Timescale-72"><span class="linenos"> 72</span></a>
</span><span id="Timescale-73"><a href="#Timescale-73"><span class="linenos"> 73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-74"><a href="#Timescale-74"><span class="linenos"> 74</span></a>        <span class="n">effective_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span>
</span><span id="Timescale-75"><a href="#Timescale-75"><span class="linenos"> 75</span></a>        <span class="n">effective_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
</span><span id="Timescale-76"><a href="#Timescale-76"><span class="linenos"> 76</span></a>        <span class="k">if</span> <span class="n">effective_start</span> <span class="o">&gt;=</span> <span class="n">effective_end</span><span class="p">:</span>
</span><span id="Timescale-77"><a href="#Timescale-77"><span class="linenos"> 77</span></a>            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Timescale-78"><a href="#Timescale-78"><span class="linenos"> 78</span></a>        <span class="n">start_bin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">effective_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span><span id="Timescale-79"><a href="#Timescale-79"><span class="linenos"> 79</span></a>        <span class="n">end_bin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">effective_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span><span id="Timescale-80"><a href="#Timescale-80"><span class="linenos"> 80</span></a>        <span class="k">return</span> <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span>
</span><span id="Timescale-81"><a href="#Timescale-81"><span class="linenos"> 81</span></a>
</span><span id="Timescale-82"><a href="#Timescale-82"><span class="linenos"> 82</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fractional_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Timescale-83"><a href="#Timescale-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the fraction of the bin at index `bin_idx` that is covered by the interval [start, end).</span>
</span><span id="Timescale-84"><a href="#Timescale-84"><span class="linenos"> 84</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale-85"><a href="#Timescale-85"><span class="linenos"> 85</span></a><span class="sd">            - Computes how much of bin_idx&#39;s interval is covered by [start, end)</span>
</span><span id="Timescale-86"><a href="#Timescale-86"><span class="linenos"> 86</span></a><span class="sd">            - Returns value in [0.0, 1.0] based on normalized overlap over bin width</span>
</span><span id="Timescale-87"><a href="#Timescale-87"><span class="linenos"> 87</span></a><span class="sd">            - Clipped to bin extent: overlaps outside the bin are ignored</span>
</span><span id="Timescale-88"><a href="#Timescale-88"><span class="linenos"> 88</span></a><span class="sd">            - Used to compute partial presence contribution within a bin</span>
</span><span id="Timescale-89"><a href="#Timescale-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-90"><a href="#Timescale-90"><span class="linenos"> 90</span></a>        <span class="c1"># Clip to timescale</span>
</span><span id="Timescale-91"><a href="#Timescale-91"><span class="linenos"> 91</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span>
</span><span id="Timescale-92"><a href="#Timescale-92"><span class="linenos"> 92</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
</span><span id="Timescale-93"><a href="#Timescale-93"><span class="linenos"> 93</span></a>
</span><span id="Timescale-94"><a href="#Timescale-94"><span class="linenos"> 94</span></a>        <span class="n">bin_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_start</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
</span><span id="Timescale-95"><a href="#Timescale-95"><span class="linenos"> 95</span></a>        <span class="n">bin_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_end</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
</span><span id="Timescale-96"><a href="#Timescale-96"><span class="linenos"> 96</span></a>
</span><span id="Timescale-97"><a href="#Timescale-97"><span class="linenos"> 97</span></a>        <span class="n">overlap_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">bin_start</span><span class="p">)</span>
</span><span id="Timescale-98"><a href="#Timescale-98"><span class="linenos"> 98</span></a>        <span class="n">overlap_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">bin_end</span><span class="p">)</span>
</span><span id="Timescale-99"><a href="#Timescale-99"><span class="linenos"> 99</span></a>
</span><span id="Timescale-100"><a href="#Timescale-100"><span class="linenos">100</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">overlap_end</span> <span class="o">-</span> <span class="n">overlap_start</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span>
</span><span id="Timescale-101"><a href="#Timescale-101"><span class="linenos">101</span></a>
</span><span id="Timescale-102"><a href="#Timescale-102"><span class="linenos">102</span></a>    <span class="c1"># Mapping from discrete bins back to continuous time.</span>
</span><span id="Timescale-103"><a href="#Timescale-103"><span class="linenos">103</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Timescale-104"><a href="#Timescale-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the start time of a bin given its index.</span>
</span><span id="Timescale-105"><a href="#Timescale-105"><span class="linenos">105</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale-106"><a href="#Timescale-106"><span class="linenos">106</span></a><span class="sd">            bin_start(k) = t0 + k * bin_width</span>
</span><span id="Timescale-107"><a href="#Timescale-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-108"><a href="#Timescale-108"><span class="linenos">108</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="n">bin_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span>
</span><span id="Timescale-109"><a href="#Timescale-109"><span class="linenos">109</span></a>
</span><span id="Timescale-110"><a href="#Timescale-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Timescale-111"><a href="#Timescale-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the end time of a bin given its index.</span>
</span><span id="Timescale-112"><a href="#Timescale-112"><span class="linenos">112</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale-113"><a href="#Timescale-113"><span class="linenos">113</span></a><span class="sd">            bin_end(k) = t0 + (k + 1) * bin_width</span>
</span><span id="Timescale-114"><a href="#Timescale-114"><span class="linenos">114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-115"><a href="#Timescale-115"><span class="linenos">115</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="p">(</span><span class="n">bin_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span>
</span><span id="Timescale-116"><a href="#Timescale-116"><span class="linenos">116</span></a>
</span><span id="Timescale-117"><a href="#Timescale-117"><span class="linenos">117</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Timescale-118"><a href="#Timescale-118"><span class="linenos">118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Timescale-119"><a href="#Timescale-119"><span class="linenos">119</span></a><span class="sd">        Return an array of bin edge times from t0 to t1, spaced by bin_width.</span>
</span><span id="Timescale-120"><a href="#Timescale-120"><span class="linenos">120</span></a>
</span><span id="Timescale-121"><a href="#Timescale-121"><span class="linenos">121</span></a><span class="sd">        The result has length `num_bins + 1` and is safe against floating-point rounding</span>
</span><span id="Timescale-122"><a href="#Timescale-122"><span class="linenos">122</span></a><span class="sd">        by capping the range to include exactly the number of bins implied by `num_bins()`.</span>
</span><span id="Timescale-123"><a href="#Timescale-123"><span class="linenos">123</span></a>
</span><span id="Timescale-124"><a href="#Timescale-124"><span class="linenos">124</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale-125"><a href="#Timescale-125"><span class="linenos">125</span></a><span class="sd">        - Returns `num_bins + 1` edge values such that:</span>
</span><span id="Timescale-126"><a href="#Timescale-126"><span class="linenos">126</span></a><span class="sd">            edges = [t0, t0 + bin_width, ..., t1]</span>
</span><span id="Timescale-127"><a href="#Timescale-127"><span class="linenos">127</span></a>
</span><span id="Timescale-128"><a href="#Timescale-128"><span class="linenos">128</span></a><span class="sd">        - Guarantees:</span>
</span><span id="Timescale-129"><a href="#Timescale-129"><span class="linenos">129</span></a><span class="sd">            bin_start(k) == edges[k]</span>
</span><span id="Timescale-130"><a href="#Timescale-130"><span class="linenos">130</span></a><span class="sd">            bin_end(k)   == edges[k + 1]</span>
</span><span id="Timescale-131"><a href="#Timescale-131"><span class="linenos">131</span></a>
</span><span id="Timescale-132"><a href="#Timescale-132"><span class="linenos">132</span></a><span class="sd">        - Handles floating-point rounding safely:</span>
</span><span id="Timescale-133"><a href="#Timescale-133"><span class="linenos">133</span></a><span class="sd">            If np.arange overproduces due to rounding, result is trimmed</span>
</span><span id="Timescale-134"><a href="#Timescale-134"><span class="linenos">134</span></a><span class="sd">            to ensure exactly `num_bins + 1` entries.</span>
</span><span id="Timescale-135"><a href="#Timescale-135"><span class="linenos">135</span></a>
</span><span id="Timescale-136"><a href="#Timescale-136"><span class="linenos">136</span></a><span class="sd">        This method defines the canonical bin boundaries used across</span>
</span><span id="Timescale-137"><a href="#Timescale-137"><span class="linenos">137</span></a><span class="sd">        the presence matrix and all derived metrics.</span>
</span><span id="Timescale-138"><a href="#Timescale-138"><span class="linenos">138</span></a>
</span><span id="Timescale-139"><a href="#Timescale-139"><span class="linenos">139</span></a><span class="sd">        Example:</span>
</span><span id="Timescale-140"><a href="#Timescale-140"><span class="linenos">140</span></a><span class="sd">            Timescale(t0=0.0, t1=10.0, bin_width=2.0).bin_edges()</span>
</span><span id="Timescale-141"><a href="#Timescale-141"><span class="linenos">141</span></a><span class="sd">            =&gt; array([0.0, 2.0, 4.0, 6.0, 8.0, 10.0])</span>
</span><span id="Timescale-142"><a href="#Timescale-142"><span class="linenos">142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-143"><a href="#Timescale-143"><span class="linenos">143</span></a>        <span class="n">num_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Timescale-144"><a href="#Timescale-144"><span class="linenos">144</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="n">num_edges</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">)</span>
</span><span id="Timescale-145"><a href="#Timescale-145"><span class="linenos">145</span></a>
</span><span id="Timescale-146"><a href="#Timescale-146"><span class="linenos">146</span></a>        <span class="c1"># Ensure exactly num_edges (for safety in rare floating-point cases)</span>
</span><span id="Timescale-147"><a href="#Timescale-147"><span class="linenos">147</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_edges</span><span class="p">:</span>
</span><span id="Timescale-148"><a href="#Timescale-148"><span class="linenos">148</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[:</span><span class="n">num_edges</span><span class="p">]</span>
</span><span id="Timescale-149"><a href="#Timescale-149"><span class="linenos">149</span></a>        <span class="k">return</span> <span class="n">edges</span>
</span><span id="Timescale-150"><a href="#Timescale-150"><span class="linenos">150</span></a>
</span><span id="Timescale-151"><a href="#Timescale-151"><span class="linenos">151</span></a>
</span><span id="Timescale-152"><a href="#Timescale-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Timescale-153"><a href="#Timescale-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Timescale-154"><a href="#Timescale-154"><span class="linenos">154</span></a><span class="sd">            Return the (start, end) time of a bin.</span>
</span><span id="Timescale-155"><a href="#Timescale-155"><span class="linenos">155</span></a><span class="sd">            Contract:</span>
</span><span id="Timescale-156"><a href="#Timescale-156"><span class="linenos">156</span></a><span class="sd">                Returns tuple (bin_start(k), bin_end(k))</span>
</span><span id="Timescale-157"><a href="#Timescale-157"><span class="linenos">157</span></a><span class="sd">                Matches exactly the continuous interval spanned by the bin</span>
</span><span id="Timescale-158"><a href="#Timescale-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale-159"><a href="#Timescale-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_start</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_end</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Timescale represents a partitioning of a continuous time interval [t0, t1)
into N = ceil((t1 - t0) / bin_width) contiguous, left-aligned, non-overlapping bins.</p>

<p>Each bin has width <code><a href="#Timescale.bin_width">bin_width</a></code> and covers a half-open interval:
    Bin k = [t0 + k * bin_width, t0 + (k + 1) * bin_width)</p>

<p>This class provides methods for:</p>

<ul>
<li>Mapping real-valued timestamps to discrete bin indices</li>
<li>Extracting the time boundaries of any bin</li>
<li>Computing which bins an interval [start, end) overlaps</li>
<li>Estimating how much of a bin is covered by a given interval</li>
</ul>

<p><strong>Boundary Behavior</strong>:</p>

<ul>
<li>All bins lie strictly within [t0, t1)</li>
<li>Any time <code>t</code> where t &lt; t0 or t &gt;= t1 is considered <strong>outside</strong> the defined timescale</li>
<li>bin_index(t) may return an out-of-range index if <code>t &lt; t0</code> or <code>t &gt;= t1</code></li>
</ul>

<p>This class does not perform clipping: it assumes all inputs are in-range unless explicitly clipped by the caller.</p>
</div>


                            <div id="Timescale.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Timescale</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">t0</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">t1</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">bin_width</span><span class="p">:</span> <span class="nb">float</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Timescale.__init__"></a>
    
    

                            </div>
                            <div id="Timescale.t0" class="classattr">
                                <div class="attr variable">
            <span class="name">t0</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Timescale.t0"></a>
    
            <div class="docstring"><p>start time of the interval [t0, t1)</p>
</div>


                            </div>
                            <div id="Timescale.t1" class="classattr">
                                <div class="attr variable">
            <span class="name">t1</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Timescale.t1"></a>
    
            <div class="docstring"><p>end time of the interval [t0, t1)</p>
</div>


                            </div>
                            <div id="Timescale.bin_width" class="classattr">
                                <div class="attr variable">
            <span class="name">bin_width</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Timescale.bin_width"></a>
    
            <div class="docstring"><p>Width of each bin</p>
</div>


                            </div>
                            <div id="Timescale.num_bins" class="classattr">
                                        <input id="Timescale.num_bins-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">num_bins</span><span class="annotation">: int</span>

                <label class="view-source-button" for="Timescale.num_bins-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.num_bins"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.num_bins-44"><a href="#Timescale.num_bins-44"><span class="linenos">44</span></a>    <span class="nd">@property</span>
</span><span id="Timescale.num_bins-45"><a href="#Timescale.num_bins-45"><span class="linenos">45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">num_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Timescale.num_bins-46"><a href="#Timescale.num_bins-46"><span class="linenos">46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of bins between t0 and t1.&quot;&quot;&quot;</span>
</span><span id="Timescale.num_bins-47"><a href="#Timescale.num_bins-47"><span class="linenos">47</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Return number of bins between t0 and t1.</p>
</div>


                            </div>
                            <div id="Timescale.bin_index" class="classattr">
                                        <input id="Timescale.bin_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bin_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">time</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Timescale.bin_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.bin_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.bin_index-50"><a href="#Timescale.bin_index-50"><span class="linenos">50</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Timescale.bin_index-51"><a href="#Timescale.bin_index-51"><span class="linenos">51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Purpose:</span>
</span><span id="Timescale.bin_index-52"><a href="#Timescale.bin_index-52"><span class="linenos">52</span></a><span class="sd">            Map a real-valued timestamp to the index of the bin that contains it.</span>
</span><span id="Timescale.bin_index-53"><a href="#Timescale.bin_index-53"><span class="linenos">53</span></a>
</span><span id="Timescale.bin_index-54"><a href="#Timescale.bin_index-54"><span class="linenos">54</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale.bin_index-55"><a href="#Timescale.bin_index-55"><span class="linenos">55</span></a><span class="sd">            Returns k such that bin_start(k) ≤ time &lt; bin_end(k)</span>
</span><span id="Timescale.bin_index-56"><a href="#Timescale.bin_index-56"><span class="linenos">56</span></a><span class="sd">            Uses floor() logic — i.e., left-aligned binning</span>
</span><span id="Timescale.bin_index-57"><a href="#Timescale.bin_index-57"><span class="linenos">57</span></a><span class="sd">            No bounds check: time &lt; t0 may yield negative indices; time ≥ t1 may return out-of-bounds indices</span>
</span><span id="Timescale.bin_index-58"><a href="#Timescale.bin_index-58"><span class="linenos">58</span></a><span class="sd">            Caller is responsible for ensuring t0 ≤ time &lt; t1 if range enforcement is needed</span>
</span><span id="Timescale.bin_index-59"><a href="#Timescale.bin_index-59"><span class="linenos">59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.bin_index-60"><a href="#Timescale.bin_index-60"><span class="linenos">60</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><h6 id="purpose">Purpose:</h6>

<blockquote>
  <p>Map a real-valued timestamp to the index of the bin that contains it.</p>
</blockquote>

<h6 id="contract">Contract:</h6>

<blockquote>
  <p>Returns k such that bin_start(k) ≤ time &lt; bin_end(k)
  Uses floor() logic — i.e., left-aligned binning
  No bounds check: time &lt; t0 may yield negative indices; time ≥ t1 may return out-of-bounds indices
  Caller is responsible for ensuring t0 ≤ time &lt; t1 if range enforcement is needed</p>
</blockquote>
</div>


                            </div>
                            <div id="Timescale.bin_slice" class="classattr">
                                        <input id="Timescale.bin_slice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bin_slice</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">end</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Timescale.bin_slice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.bin_slice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.bin_slice-62"><a href="#Timescale.bin_slice-62"><span class="linenos">62</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="Timescale.bin_slice-63"><a href="#Timescale.bin_slice-63"><span class="linenos">63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the bin indices [start_bin, end_bin) that overlap the interval [start, end).</span>
</span><span id="Timescale.bin_slice-64"><a href="#Timescale.bin_slice-64"><span class="linenos">64</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale.bin_slice-65"><a href="#Timescale.bin_slice-65"><span class="linenos">65</span></a><span class="sd">            - Clips the interval [start, end) to [t0, t1) before binning</span>
</span><span id="Timescale.bin_slice-66"><a href="#Timescale.bin_slice-66"><span class="linenos">66</span></a><span class="sd">            - Computes:</span>
</span><span id="Timescale.bin_slice-67"><a href="#Timescale.bin_slice-67"><span class="linenos">67</span></a><span class="sd">                start_bin = floor((clipped_start - t0) / bin_width)</span>
</span><span id="Timescale.bin_slice-68"><a href="#Timescale.bin_slice-68"><span class="linenos">68</span></a><span class="sd">                end_bin   = ceil((clipped_end   - t0) / bin_width)</span>
</span><span id="Timescale.bin_slice-69"><a href="#Timescale.bin_slice-69"><span class="linenos">69</span></a><span class="sd">            - Resulting slice [start_bin, end_bin) may be empty if the interval does not overlap the timescale</span>
</span><span id="Timescale.bin_slice-70"><a href="#Timescale.bin_slice-70"><span class="linenos">70</span></a><span class="sd">            - start_bin ∈ [0, num_bins)</span>
</span><span id="Timescale.bin_slice-71"><a href="#Timescale.bin_slice-71"><span class="linenos">71</span></a><span class="sd">            - end_bin   ∈ [0, num_bins]</span>
</span><span id="Timescale.bin_slice-72"><a href="#Timescale.bin_slice-72"><span class="linenos">72</span></a>
</span><span id="Timescale.bin_slice-73"><a href="#Timescale.bin_slice-73"><span class="linenos">73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.bin_slice-74"><a href="#Timescale.bin_slice-74"><span class="linenos">74</span></a>        <span class="n">effective_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span>
</span><span id="Timescale.bin_slice-75"><a href="#Timescale.bin_slice-75"><span class="linenos">75</span></a>        <span class="n">effective_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
</span><span id="Timescale.bin_slice-76"><a href="#Timescale.bin_slice-76"><span class="linenos">76</span></a>        <span class="k">if</span> <span class="n">effective_start</span> <span class="o">&gt;=</span> <span class="n">effective_end</span><span class="p">:</span>
</span><span id="Timescale.bin_slice-77"><a href="#Timescale.bin_slice-77"><span class="linenos">77</span></a>            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Timescale.bin_slice-78"><a href="#Timescale.bin_slice-78"><span class="linenos">78</span></a>        <span class="n">start_bin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">effective_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span><span id="Timescale.bin_slice-79"><a href="#Timescale.bin_slice-79"><span class="linenos">79</span></a>        <span class="n">end_bin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">effective_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">))</span>
</span><span id="Timescale.bin_slice-80"><a href="#Timescale.bin_slice-80"><span class="linenos">80</span></a>        <span class="k">return</span> <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span>
</span></pre></div>


            <div class="docstring"><p>Return the bin indices [start_bin, end_bin) that overlap the interval [start, end).</p>

<h6 id="contract">Contract:</h6>

<blockquote>
  <ul>
  <li>Clips the interval [start, end) to [t0, t1) before binning</li>
  <li>Computes:
  start_bin = floor((clipped_start - t0) / bin_width)
  end_bin   = ceil((clipped_end   - t0) / bin_width)</li>
  <li>Resulting slice [start_bin, end_bin) may be empty if the interval does not overlap the timescale</li>
  <li>start_bin ∈ [0, num_bins)</li>
  <li>end_bin   ∈ [0, num_bins]</li>
  </ul>
</blockquote>
</div>


                            </div>
                            <div id="Timescale.fractional_overlap" class="classattr">
                                        <input id="Timescale.fractional_overlap-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fractional_overlap</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">end</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Timescale.fractional_overlap-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.fractional_overlap"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.fractional_overlap-82"><a href="#Timescale.fractional_overlap-82"><span class="linenos"> 82</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fractional_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Timescale.fractional_overlap-83"><a href="#Timescale.fractional_overlap-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the fraction of the bin at index `bin_idx` that is covered by the interval [start, end).</span>
</span><span id="Timescale.fractional_overlap-84"><a href="#Timescale.fractional_overlap-84"><span class="linenos"> 84</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale.fractional_overlap-85"><a href="#Timescale.fractional_overlap-85"><span class="linenos"> 85</span></a><span class="sd">            - Computes how much of bin_idx&#39;s interval is covered by [start, end)</span>
</span><span id="Timescale.fractional_overlap-86"><a href="#Timescale.fractional_overlap-86"><span class="linenos"> 86</span></a><span class="sd">            - Returns value in [0.0, 1.0] based on normalized overlap over bin width</span>
</span><span id="Timescale.fractional_overlap-87"><a href="#Timescale.fractional_overlap-87"><span class="linenos"> 87</span></a><span class="sd">            - Clipped to bin extent: overlaps outside the bin are ignored</span>
</span><span id="Timescale.fractional_overlap-88"><a href="#Timescale.fractional_overlap-88"><span class="linenos"> 88</span></a><span class="sd">            - Used to compute partial presence contribution within a bin</span>
</span><span id="Timescale.fractional_overlap-89"><a href="#Timescale.fractional_overlap-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.fractional_overlap-90"><a href="#Timescale.fractional_overlap-90"><span class="linenos"> 90</span></a>        <span class="c1"># Clip to timescale</span>
</span><span id="Timescale.fractional_overlap-91"><a href="#Timescale.fractional_overlap-91"><span class="linenos"> 91</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span>
</span><span id="Timescale.fractional_overlap-92"><a href="#Timescale.fractional_overlap-92"><span class="linenos"> 92</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
</span><span id="Timescale.fractional_overlap-93"><a href="#Timescale.fractional_overlap-93"><span class="linenos"> 93</span></a>
</span><span id="Timescale.fractional_overlap-94"><a href="#Timescale.fractional_overlap-94"><span class="linenos"> 94</span></a>        <span class="n">bin_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_start</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
</span><span id="Timescale.fractional_overlap-95"><a href="#Timescale.fractional_overlap-95"><span class="linenos"> 95</span></a>        <span class="n">bin_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_end</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
</span><span id="Timescale.fractional_overlap-96"><a href="#Timescale.fractional_overlap-96"><span class="linenos"> 96</span></a>
</span><span id="Timescale.fractional_overlap-97"><a href="#Timescale.fractional_overlap-97"><span class="linenos"> 97</span></a>        <span class="n">overlap_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">bin_start</span><span class="p">)</span>
</span><span id="Timescale.fractional_overlap-98"><a href="#Timescale.fractional_overlap-98"><span class="linenos"> 98</span></a>        <span class="n">overlap_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">bin_end</span><span class="p">)</span>
</span><span id="Timescale.fractional_overlap-99"><a href="#Timescale.fractional_overlap-99"><span class="linenos"> 99</span></a>
</span><span id="Timescale.fractional_overlap-100"><a href="#Timescale.fractional_overlap-100"><span class="linenos">100</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">overlap_end</span> <span class="o">-</span> <span class="n">overlap_start</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span>
</span></pre></div>


            <div class="docstring"><p>Return the fraction of the bin at index <code>bin_idx</code> that is covered by the interval [start, end).</p>

<h6 id="contract">Contract:</h6>

<blockquote>
  <ul>
  <li>Computes how much of bin_idx's interval is covered by [start, end)</li>
  <li>Returns value in [0.0, 1.0] based on normalized overlap over bin width</li>
  <li>Clipped to bin extent: overlaps outside the bin are ignored</li>
  <li>Used to compute partial presence contribution within a bin</li>
  </ul>
</blockquote>
</div>


                            </div>
                            <div id="Timescale.bin_start" class="classattr">
                                        <input id="Timescale.bin_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bin_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Timescale.bin_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.bin_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.bin_start-103"><a href="#Timescale.bin_start-103"><span class="linenos">103</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Timescale.bin_start-104"><a href="#Timescale.bin_start-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the start time of a bin given its index.</span>
</span><span id="Timescale.bin_start-105"><a href="#Timescale.bin_start-105"><span class="linenos">105</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale.bin_start-106"><a href="#Timescale.bin_start-106"><span class="linenos">106</span></a><span class="sd">            bin_start(k) = t0 + k * bin_width</span>
</span><span id="Timescale.bin_start-107"><a href="#Timescale.bin_start-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.bin_start-108"><a href="#Timescale.bin_start-108"><span class="linenos">108</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="n">bin_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span>
</span></pre></div>


            <div class="docstring"><p>Return the start time of a bin given its index.</p>

<h6 id="contract">Contract:</h6>

<blockquote>
  <p>bin_start(k) = t0 + k * bin_width</p>
</blockquote>
</div>


                            </div>
                            <div id="Timescale.bin_end" class="classattr">
                                        <input id="Timescale.bin_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bin_end</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Timescale.bin_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.bin_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.bin_end-110"><a href="#Timescale.bin_end-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Timescale.bin_end-111"><a href="#Timescale.bin_end-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the end time of a bin given its index.</span>
</span><span id="Timescale.bin_end-112"><a href="#Timescale.bin_end-112"><span class="linenos">112</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale.bin_end-113"><a href="#Timescale.bin_end-113"><span class="linenos">113</span></a><span class="sd">            bin_end(k) = t0 + (k + 1) * bin_width</span>
</span><span id="Timescale.bin_end-114"><a href="#Timescale.bin_end-114"><span class="linenos">114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.bin_end-115"><a href="#Timescale.bin_end-115"><span class="linenos">115</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="p">(</span><span class="n">bin_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span>
</span></pre></div>


            <div class="docstring"><p>Return the end time of a bin given its index.</p>

<h6 id="contract">Contract:</h6>

<blockquote>
  <p>bin_end(k) = t0 + (k + 1) * bin_width</p>
</blockquote>
</div>


                            </div>
                            <div id="Timescale.bin_edges" class="classattr">
                                        <input id="Timescale.bin_edges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bin_edges</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="Timescale.bin_edges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.bin_edges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.bin_edges-117"><a href="#Timescale.bin_edges-117"><span class="linenos">117</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="Timescale.bin_edges-118"><a href="#Timescale.bin_edges-118"><span class="linenos">118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Timescale.bin_edges-119"><a href="#Timescale.bin_edges-119"><span class="linenos">119</span></a><span class="sd">        Return an array of bin edge times from t0 to t1, spaced by bin_width.</span>
</span><span id="Timescale.bin_edges-120"><a href="#Timescale.bin_edges-120"><span class="linenos">120</span></a>
</span><span id="Timescale.bin_edges-121"><a href="#Timescale.bin_edges-121"><span class="linenos">121</span></a><span class="sd">        The result has length `num_bins + 1` and is safe against floating-point rounding</span>
</span><span id="Timescale.bin_edges-122"><a href="#Timescale.bin_edges-122"><span class="linenos">122</span></a><span class="sd">        by capping the range to include exactly the number of bins implied by `num_bins()`.</span>
</span><span id="Timescale.bin_edges-123"><a href="#Timescale.bin_edges-123"><span class="linenos">123</span></a>
</span><span id="Timescale.bin_edges-124"><a href="#Timescale.bin_edges-124"><span class="linenos">124</span></a><span class="sd">        Contract:</span>
</span><span id="Timescale.bin_edges-125"><a href="#Timescale.bin_edges-125"><span class="linenos">125</span></a><span class="sd">        - Returns `num_bins + 1` edge values such that:</span>
</span><span id="Timescale.bin_edges-126"><a href="#Timescale.bin_edges-126"><span class="linenos">126</span></a><span class="sd">            edges = [t0, t0 + bin_width, ..., t1]</span>
</span><span id="Timescale.bin_edges-127"><a href="#Timescale.bin_edges-127"><span class="linenos">127</span></a>
</span><span id="Timescale.bin_edges-128"><a href="#Timescale.bin_edges-128"><span class="linenos">128</span></a><span class="sd">        - Guarantees:</span>
</span><span id="Timescale.bin_edges-129"><a href="#Timescale.bin_edges-129"><span class="linenos">129</span></a><span class="sd">            bin_start(k) == edges[k]</span>
</span><span id="Timescale.bin_edges-130"><a href="#Timescale.bin_edges-130"><span class="linenos">130</span></a><span class="sd">            bin_end(k)   == edges[k + 1]</span>
</span><span id="Timescale.bin_edges-131"><a href="#Timescale.bin_edges-131"><span class="linenos">131</span></a>
</span><span id="Timescale.bin_edges-132"><a href="#Timescale.bin_edges-132"><span class="linenos">132</span></a><span class="sd">        - Handles floating-point rounding safely:</span>
</span><span id="Timescale.bin_edges-133"><a href="#Timescale.bin_edges-133"><span class="linenos">133</span></a><span class="sd">            If np.arange overproduces due to rounding, result is trimmed</span>
</span><span id="Timescale.bin_edges-134"><a href="#Timescale.bin_edges-134"><span class="linenos">134</span></a><span class="sd">            to ensure exactly `num_bins + 1` entries.</span>
</span><span id="Timescale.bin_edges-135"><a href="#Timescale.bin_edges-135"><span class="linenos">135</span></a>
</span><span id="Timescale.bin_edges-136"><a href="#Timescale.bin_edges-136"><span class="linenos">136</span></a><span class="sd">        This method defines the canonical bin boundaries used across</span>
</span><span id="Timescale.bin_edges-137"><a href="#Timescale.bin_edges-137"><span class="linenos">137</span></a><span class="sd">        the presence matrix and all derived metrics.</span>
</span><span id="Timescale.bin_edges-138"><a href="#Timescale.bin_edges-138"><span class="linenos">138</span></a>
</span><span id="Timescale.bin_edges-139"><a href="#Timescale.bin_edges-139"><span class="linenos">139</span></a><span class="sd">        Example:</span>
</span><span id="Timescale.bin_edges-140"><a href="#Timescale.bin_edges-140"><span class="linenos">140</span></a><span class="sd">            Timescale(t0=0.0, t1=10.0, bin_width=2.0).bin_edges()</span>
</span><span id="Timescale.bin_edges-141"><a href="#Timescale.bin_edges-141"><span class="linenos">141</span></a><span class="sd">            =&gt; array([0.0, 2.0, 4.0, 6.0, 8.0, 10.0])</span>
</span><span id="Timescale.bin_edges-142"><a href="#Timescale.bin_edges-142"><span class="linenos">142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.bin_edges-143"><a href="#Timescale.bin_edges-143"><span class="linenos">143</span></a>        <span class="n">num_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bins</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Timescale.bin_edges-144"><a href="#Timescale.bin_edges-144"><span class="linenos">144</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="n">num_edges</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_width</span><span class="p">)</span>
</span><span id="Timescale.bin_edges-145"><a href="#Timescale.bin_edges-145"><span class="linenos">145</span></a>
</span><span id="Timescale.bin_edges-146"><a href="#Timescale.bin_edges-146"><span class="linenos">146</span></a>        <span class="c1"># Ensure exactly num_edges (for safety in rare floating-point cases)</span>
</span><span id="Timescale.bin_edges-147"><a href="#Timescale.bin_edges-147"><span class="linenos">147</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_edges</span><span class="p">:</span>
</span><span id="Timescale.bin_edges-148"><a href="#Timescale.bin_edges-148"><span class="linenos">148</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[:</span><span class="n">num_edges</span><span class="p">]</span>
</span><span id="Timescale.bin_edges-149"><a href="#Timescale.bin_edges-149"><span class="linenos">149</span></a>        <span class="k">return</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Return an array of bin edge times from t0 to t1, spaced by bin_width.</p>

<p>The result has length <code>num_bins + 1</code> and is safe against floating-point rounding
by capping the range to include exactly the number of bins implied by <code><a href="#Timescale.num_bins">num_bins()</a></code>.</p>

<p>Contract:</p>

<ul>
<li>Returns <code>num_bins + 1</code> edge values such that:
edges = [t0, t0 + bin_width, ..., t1]</li>
</ul>

<ul>
<li><p>Guarantees:
bin_start(k) == edges[k]
bin_end(k)   == edges[k + 1]</p></li>
<li><p>Handles floating-point rounding safely:
If np.arange overproduces due to rounding, result is trimmed
to ensure exactly <code>num_bins + 1</code> entries.</p></li>
</ul>

<p>This method defines the canonical bin boundaries used across
the presence matrix and all derived metrics.</p>

<h6 id="example">Example:</h6>

<blockquote>
  <p>Timescale(t0=0.0, t1=10.0, bin_width=2.0).bin_edges()
  =&gt; array([0.0, 2.0, 4.0, 6.0, 8.0, 10.0])</p>
</blockquote>
</div>


                            </div>
                            <div id="Timescale.time_range" class="classattr">
                                        <input id="Timescale.time_range-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">time_range</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Timescale.time_range-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Timescale.time_range"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Timescale.time_range-152"><a href="#Timescale.time_range-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Timescale.time_range-153"><a href="#Timescale.time_range-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Timescale.time_range-154"><a href="#Timescale.time_range-154"><span class="linenos">154</span></a><span class="sd">            Return the (start, end) time of a bin.</span>
</span><span id="Timescale.time_range-155"><a href="#Timescale.time_range-155"><span class="linenos">155</span></a><span class="sd">            Contract:</span>
</span><span id="Timescale.time_range-156"><a href="#Timescale.time_range-156"><span class="linenos">156</span></a><span class="sd">                Returns tuple (bin_start(k), bin_end(k))</span>
</span><span id="Timescale.time_range-157"><a href="#Timescale.time_range-157"><span class="linenos">157</span></a><span class="sd">                Matches exactly the continuous interval spanned by the bin</span>
</span><span id="Timescale.time_range-158"><a href="#Timescale.time_range-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Timescale.time_range-159"><a href="#Timescale.time_range-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_start</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_end</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return the (start, end) time of a bin.</p>

<h6 id="contract">Contract:</h6>

<blockquote>
  <p>Returns tuple (bin_start(k), bin_end(k))
  Matches exactly the continuous interval spanned by the bin</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="PresenceMap">
                            <input id="PresenceMap-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">PresenceMap</span>:

                <label class="view-source-button" for="PresenceMap-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap-15"><a href="#PresenceMap-15"><span class="linenos"> 15</span></a><span class="nd">@dataclass</span>
</span><span id="PresenceMap-16"><a href="#PresenceMap-16"><span class="linenos"> 16</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PresenceMap</span><span class="p">:</span>
</span><span id="PresenceMap-17"><a href="#PresenceMap-17"><span class="linenos"> 17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMap-18"><a href="#PresenceMap-18"><span class="linenos"> 18</span></a><span class="sd">        A PresenceMap maps a continuous presence interval [start, end)</span>
</span><span id="PresenceMap-19"><a href="#PresenceMap-19"><span class="linenos"> 19</span></a><span class="sd">        onto a discrete time grid defined by a Timescale.</span>
</span><span id="PresenceMap-20"><a href="#PresenceMap-20"><span class="linenos"> 20</span></a>
</span><span id="PresenceMap-21"><a href="#PresenceMap-21"><span class="linenos"> 21</span></a><span class="sd">        The result is a bin-aligned representation:</span>
</span><span id="PresenceMap-22"><a href="#PresenceMap-22"><span class="linenos"> 22</span></a><span class="sd">        - `start_bin` is the index of the first bin touched</span>
</span><span id="PresenceMap-23"><a href="#PresenceMap-23"><span class="linenos"> 23</span></a><span class="sd">        - `end_bin` is the exclusive upper bound (i.e., first bin not touched)</span>
</span><span id="PresenceMap-24"><a href="#PresenceMap-24"><span class="linenos"> 24</span></a><span class="sd">        - `start_value` and `end_value` represent fractional presence at the edges</span>
</span><span id="PresenceMap-25"><a href="#PresenceMap-25"><span class="linenos"> 25</span></a><span class="sd">        - Bins between `start_bin` and `end_bin` are fully or partially covered</span>
</span><span id="PresenceMap-26"><a href="#PresenceMap-26"><span class="linenos"> 26</span></a>
</span><span id="PresenceMap-27"><a href="#PresenceMap-27"><span class="linenos"> 27</span></a><span class="sd">        Contract:</span>
</span><span id="PresenceMap-28"><a href="#PresenceMap-28"><span class="linenos"> 28</span></a><span class="sd">        - A presence is considered &quot;mapped&quot; if it overlaps the timescale [t0, t1)</span>
</span><span id="PresenceMap-29"><a href="#PresenceMap-29"><span class="linenos"> 29</span></a><span class="sd">        - Mapped presences always produce:</span>
</span><span id="PresenceMap-30"><a href="#PresenceMap-30"><span class="linenos"> 30</span></a><span class="sd">            start_bin ∈ [0, num_bins)</span>
</span><span id="PresenceMap-31"><a href="#PresenceMap-31"><span class="linenos"> 31</span></a><span class="sd">            end_bin   ∈ (start_bin, num_bins]</span>
</span><span id="PresenceMap-32"><a href="#PresenceMap-32"><span class="linenos"> 32</span></a><span class="sd">        - The bin range [start_bin, end_bin) contains all and only the bins the presence overlaps</span>
</span><span id="PresenceMap-33"><a href="#PresenceMap-33"><span class="linenos"> 33</span></a><span class="sd">        - start_value ∈ (0.0, 1.0] if partially covers `start_bin`</span>
</span><span id="PresenceMap-34"><a href="#PresenceMap-34"><span class="linenos"> 34</span></a><span class="sd">        - end_value   ∈ (0.0, 1.0] if partially covers `end_bin - 1`</span>
</span><span id="PresenceMap-35"><a href="#PresenceMap-35"><span class="linenos"> 35</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PresenceMap-36"><a href="#PresenceMap-36"><span class="linenos"> 36</span></a>
</span><span id="PresenceMap-37"><a href="#PresenceMap-37"><span class="linenos"> 37</span></a>    <span class="n">presence</span><span class="p">:</span> <span class="n">Presence</span>
</span><span id="PresenceMap-38"><a href="#PresenceMap-38"><span class="linenos"> 38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The presence entry&quot;&quot;&quot;</span>
</span><span id="PresenceMap-39"><a href="#PresenceMap-39"><span class="linenos"> 39</span></a>    <span class="n">time_scale</span><span class="p">:</span> <span class="n">Timescale</span>
</span><span id="PresenceMap-40"><a href="#PresenceMap-40"><span class="linenos"> 40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The time scale that the presence is mapped to&quot;&quot;&quot;</span>
</span><span id="PresenceMap-41"><a href="#PresenceMap-41"><span class="linenos"> 41</span></a>
</span><span id="PresenceMap-42"><a href="#PresenceMap-42"><span class="linenos"> 42</span></a>    <span class="n">is_mapped</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="PresenceMap-43"><a href="#PresenceMap-43"><span class="linenos"> 43</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;True if the presence has a valid mapping. Unmapped presences have value=-1</span>
</span><span id="PresenceMap-44"><a href="#PresenceMap-44"><span class="linenos"> 44</span></a><span class="sd">    for start_slice, end_slice, start_value and end_value. </span>
</span><span id="PresenceMap-45"><a href="#PresenceMap-45"><span class="linenos"> 45</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PresenceMap-46"><a href="#PresenceMap-46"><span class="linenos"> 46</span></a>
</span><span id="PresenceMap-47"><a href="#PresenceMap-47"><span class="linenos"> 47</span></a>    <span class="n">start_bin</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="PresenceMap-48"><a href="#PresenceMap-48"><span class="linenos"> 48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The starting bin in the discrete mapping&quot;&quot;&quot;</span>
</span><span id="PresenceMap-49"><a href="#PresenceMap-49"><span class="linenos"> 49</span></a>    <span class="n">end_bin</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="PresenceMap-50"><a href="#PresenceMap-50"><span class="linenos"> 50</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The ending bin in the discrete mapping` </span>
</span><span id="PresenceMap-51"><a href="#PresenceMap-51"><span class="linenos"> 51</span></a><span class="sd">    of row `row`. </span>
</span><span id="PresenceMap-52"><a href="#PresenceMap-52"><span class="linenos"> 52</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PresenceMap-53"><a href="#PresenceMap-53"><span class="linenos"> 53</span></a>    <span class="n">start_value</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="PresenceMap-54"><a href="#PresenceMap-54"><span class="linenos"> 54</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A presence value 0 &lt; p &lt; 1.0 that represents a potentially partial presence at the start of the mapping&quot;&quot;&quot;</span>
</span><span id="PresenceMap-55"><a href="#PresenceMap-55"><span class="linenos"> 55</span></a>    <span class="n">end_value</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="PresenceMap-56"><a href="#PresenceMap-56"><span class="linenos"> 56</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A presence value 0 &lt; p &lt; 1.0 that represents a potentially partial presence at the end of the mapping&quot;&quot;&quot;</span>
</span><span id="PresenceMap-57"><a href="#PresenceMap-57"><span class="linenos"> 57</span></a>
</span><span id="PresenceMap-58"><a href="#PresenceMap-58"><span class="linenos"> 58</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMap-59"><a href="#PresenceMap-59"><span class="linenos"> 59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_range</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">range</span><span class="p">:</span>
</span><span id="PresenceMap-60"><a href="#PresenceMap-60"><span class="linenos"> 60</span></a>        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_bin</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapped</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PresenceMap-61"><a href="#PresenceMap-61"><span class="linenos"> 61</span></a>
</span><span id="PresenceMap-62"><a href="#PresenceMap-62"><span class="linenos"> 62</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMap-63"><a href="#PresenceMap-63"><span class="linenos"> 63</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceMap-64"><a href="#PresenceMap-64"><span class="linenos"> 64</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span>
</span><span id="PresenceMap-65"><a href="#PresenceMap-65"><span class="linenos"> 65</span></a>
</span><span id="PresenceMap-66"><a href="#PresenceMap-66"><span class="linenos"> 66</span></a>
</span><span id="PresenceMap-67"><a href="#PresenceMap-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="n">Presence</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">:</span> <span class="n">Timescale</span><span class="p">):</span>
</span><span id="PresenceMap-68"><a href="#PresenceMap-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMap-69"><a href="#PresenceMap-69"><span class="linenos"> 69</span></a><span class="sd">        Map a presence interval to matrix slice indices and edge fractional values</span>
</span><span id="PresenceMap-70"><a href="#PresenceMap-70"><span class="linenos"> 70</span></a><span class="sd">        using the provided Timescale object.</span>
</span><span id="PresenceMap-71"><a href="#PresenceMap-71"><span class="linenos"> 71</span></a><span class="sd">         &quot;&quot;&quot;</span>
</span><span id="PresenceMap-72"><a href="#PresenceMap-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span> <span class="o">=</span> <span class="n">presence</span>
</span><span id="PresenceMap-73"><a href="#PresenceMap-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="n">time_scale</span>
</span><span id="PresenceMap-74"><a href="#PresenceMap-74"><span class="linenos"> 74</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceMap-75"><a href="#PresenceMap-75"><span class="linenos"> 75</span></a>        <span class="n">is_mapped</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PresenceMap-76"><a href="#PresenceMap-76"><span class="linenos"> 76</span></a>        <span class="n">start_bin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="PresenceMap-77"><a href="#PresenceMap-77"><span class="linenos"> 77</span></a>        <span class="n">end_bin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="PresenceMap-78"><a href="#PresenceMap-78"><span class="linenos"> 78</span></a>        <span class="n">start_value</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="PresenceMap-79"><a href="#PresenceMap-79"><span class="linenos"> 79</span></a>        <span class="n">end_value</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="PresenceMap-80"><a href="#PresenceMap-80"><span class="linenos"> 80</span></a>
</span><span id="PresenceMap-81"><a href="#PresenceMap-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="n">presence</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">):</span>
</span><span id="PresenceMap-82"><a href="#PresenceMap-82"><span class="linenos"> 82</span></a>            <span class="n">is_mapped</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PresenceMap-83"><a href="#PresenceMap-83"><span class="linenos"> 83</span></a>            <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span>
</span><span id="PresenceMap-84"><a href="#PresenceMap-84"><span class="linenos"> 84</span></a>            <span class="n">start_value</span><span class="p">,</span> <span class="n">end_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fractional_values</span><span class="p">(</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">start_bin</span><span class="p">,</span> <span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceMap-85"><a href="#PresenceMap-85"><span class="linenos"> 85</span></a>
</span><span id="PresenceMap-86"><a href="#PresenceMap-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_mapped</span> <span class="o">=</span> <span class="n">is_mapped</span>
</span><span id="PresenceMap-87"><a href="#PresenceMap-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_bin</span> <span class="o">=</span> <span class="n">start_bin</span>
</span><span id="PresenceMap-88"><a href="#PresenceMap-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_bin</span> <span class="o">=</span> <span class="n">end_bin</span>
</span><span id="PresenceMap-89"><a href="#PresenceMap-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_value</span> <span class="o">=</span> <span class="n">start_value</span>
</span><span id="PresenceMap-90"><a href="#PresenceMap-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_value</span> <span class="o">=</span> <span class="n">end_value</span>
</span><span id="PresenceMap-91"><a href="#PresenceMap-91"><span class="linenos"> 91</span></a>
</span><span id="PresenceMap-92"><a href="#PresenceMap-92"><span class="linenos"> 92</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_fractional_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">start_bin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMap-93"><a href="#PresenceMap-93"><span class="linenos"> 93</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceMap-94"><a href="#PresenceMap-94"><span class="linenos"> 94</span></a>        <span class="c1"># Compute partial overlap at start bin</span>
</span><span id="PresenceMap-95"><a href="#PresenceMap-95"><span class="linenos"> 95</span></a>        <span class="n">start_value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fractional_overlap</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">start_bin</span><span class="p">)</span>
</span><span id="PresenceMap-96"><a href="#PresenceMap-96"><span class="linenos"> 96</span></a>
</span><span id="PresenceMap-97"><a href="#PresenceMap-97"><span class="linenos"> 97</span></a>        <span class="c1"># Compute partial overlap at end bin, if not same as start</span>
</span><span id="PresenceMap-98"><a href="#PresenceMap-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">start_bin</span><span class="p">:</span>
</span><span id="PresenceMap-99"><a href="#PresenceMap-99"><span class="linenos"> 99</span></a>            <span class="n">end_value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fractional_overlap</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PresenceMap-100"><a href="#PresenceMap-100"><span class="linenos">100</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PresenceMap-101"><a href="#PresenceMap-101"><span class="linenos">101</span></a>            <span class="n">end_value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="PresenceMap-102"><a href="#PresenceMap-102"><span class="linenos">102</span></a>
</span><span id="PresenceMap-103"><a href="#PresenceMap-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="n">start_value</span><span class="p">,</span> <span class="n">end_value</span>
</span><span id="PresenceMap-104"><a href="#PresenceMap-104"><span class="linenos">104</span></a>
</span><span id="PresenceMap-105"><a href="#PresenceMap-105"><span class="linenos">105</span></a>
</span><span id="PresenceMap-106"><a href="#PresenceMap-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_bin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMap-107"><a href="#PresenceMap-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="n">end_bin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_bin</span> <span class="ow">and</span> <span class="n">start_bin</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_bin</span>
</span><span id="PresenceMap-108"><a href="#PresenceMap-108"><span class="linenos">108</span></a>
</span><span id="PresenceMap-109"><a href="#PresenceMap-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">presence_value_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceMap-110"><a href="#PresenceMap-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMap-111"><a href="#PresenceMap-111"><span class="linenos">111</span></a><span class="sd">        Computes total presence value (in time) within [start_time, end_time),</span>
</span><span id="PresenceMap-112"><a href="#PresenceMap-112"><span class="linenos">112</span></a><span class="sd">        using bin-based approximation logic, clipped to the given interval.</span>
</span><span id="PresenceMap-113"><a href="#PresenceMap-113"><span class="linenos">113</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMap-114"><a href="#PresenceMap-114"><span class="linenos">114</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceMap-115"><a href="#PresenceMap-115"><span class="linenos">115</span></a>        <span class="n">bin_width</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_width</span>
</span><span id="PresenceMap-116"><a href="#PresenceMap-116"><span class="linenos">116</span></a>
</span><span id="PresenceMap-117"><a href="#PresenceMap-117"><span class="linenos">117</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceMap-118"><a href="#PresenceMap-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapped</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="PresenceMap-119"><a href="#PresenceMap-119"><span class="linenos">119</span></a>            <span class="c1">#  Clip window to actual presence bounds</span>
</span><span id="PresenceMap-120"><a href="#PresenceMap-120"><span class="linenos">120</span></a>            <span class="n">effective_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
</span><span id="PresenceMap-121"><a href="#PresenceMap-121"><span class="linenos">121</span></a>            <span class="n">effective_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceMap-122"><a href="#PresenceMap-122"><span class="linenos">122</span></a>
</span><span id="PresenceMap-123"><a href="#PresenceMap-123"><span class="linenos">123</span></a>            <span class="n">effective_start_bin</span><span class="p">,</span> <span class="n">effective_end_bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">effective_start</span><span class="p">,</span> <span class="n">effective_end</span><span class="p">)</span>
</span><span id="PresenceMap-124"><a href="#PresenceMap-124"><span class="linenos">124</span></a>
</span><span id="PresenceMap-125"><a href="#PresenceMap-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="n">start_time</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">t0</span> <span class="ow">and</span> <span class="n">end_time</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">:</span>
</span><span id="PresenceMap-126"><a href="#PresenceMap-126"><span class="linenos">126</span></a>                <span class="n">start_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_value</span>
</span><span id="PresenceMap-127"><a href="#PresenceMap-127"><span class="linenos">127</span></a>                <span class="n">end_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_value</span>
</span><span id="PresenceMap-128"><a href="#PresenceMap-128"><span class="linenos">128</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PresenceMap-129"><a href="#PresenceMap-129"><span class="linenos">129</span></a>                <span class="n">start_value</span><span class="p">,</span> <span class="n">end_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fractional_values</span><span class="p">(</span><span class="n">effective_start</span><span class="p">,</span> <span class="n">effective_start_bin</span><span class="p">,</span> <span class="n">effective_end</span><span class="p">,</span> <span class="n">effective_end_bin</span><span class="p">)</span>
</span><span id="PresenceMap-130"><a href="#PresenceMap-130"><span class="linenos">130</span></a>
</span><span id="PresenceMap-131"><a href="#PresenceMap-131"><span class="linenos">131</span></a>            <span class="n">full_bin_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">effective_end_bin</span> <span class="o">-</span> <span class="n">effective_start_bin</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PresenceMap-132"><a href="#PresenceMap-132"><span class="linenos">132</span></a>
</span><span id="PresenceMap-133"><a href="#PresenceMap-133"><span class="linenos">133</span></a>            <span class="n">fractional_value</span> <span class="o">=</span> <span class="n">start_value</span> <span class="o">+</span> <span class="n">end_value</span>
</span><span id="PresenceMap-134"><a href="#PresenceMap-134"><span class="linenos">134</span></a>
</span><span id="PresenceMap-135"><a href="#PresenceMap-135"><span class="linenos">135</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">full_bin_value</span> <span class="o">+</span> <span class="n">fractional_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">bin_width</span>
</span><span id="PresenceMap-136"><a href="#PresenceMap-136"><span class="linenos">136</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PresenceMap-137"><a href="#PresenceMap-137"><span class="linenos">137</span></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="PresenceMap-138"><a href="#PresenceMap-138"><span class="linenos">138</span></a>
</span><span id="PresenceMap-139"><a href="#PresenceMap-139"><span class="linenos">139</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMap-140"><a href="#PresenceMap-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">presence_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceMap-141"><a href="#PresenceMap-141"><span class="linenos">141</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A PresenceMap maps a continuous presence interval [start, end)
onto a discrete time grid defined by a Timescale.</p>

<p>The result is a bin-aligned representation:</p>

<ul>
<li><code><a href="#PresenceMap.start_bin">start_bin</a></code> is the index of the first bin touched</li>
<li><code><a href="#PresenceMap.end_bin">end_bin</a></code> is the exclusive upper bound (i.e., first bin not touched)</li>
<li><code><a href="#PresenceMap.start_value">start_value</a></code> and <code><a href="#PresenceMap.end_value">end_value</a></code> represent fractional presence at the edges</li>
<li>Bins between <code><a href="#PresenceMap.start_bin">start_bin</a></code> and <code><a href="#PresenceMap.end_bin">end_bin</a></code> are fully or partially covered</li>
</ul>

<p>Contract:</p>

<ul>
<li>A presence is considered "mapped" if it overlaps the timescale [t0, t1)</li>
<li>Mapped presences always produce:
start_bin ∈ [0, num_bins)
end_bin   ∈ (start_bin, num_bins]</li>
<li>The bin range [start_bin, end_bin) contains all and only the bins the presence overlaps</li>
<li>start_value ∈ (0.0, 1.0] if partially covers <code><a href="#PresenceMap.start_bin">start_bin</a></code></li>
<li>end_value   ∈ (0.0, 1.0] if partially covers <code>end_bin - 1</code></li>
</ul>
</div>


                            <div id="PresenceMap.__init__" class="classattr">
                                        <input id="PresenceMap.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PresenceMap</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">presence</span><span class="p">:</span> <span class="n"><a href="#Presence">Presence</a></span>,</span><span class="param">	<span class="n">time_scale</span><span class="p">:</span> <span class="n"><a href="#Timescale">Timescale</a></span></span>)</span>

                <label class="view-source-button" for="PresenceMap.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap.__init__-67"><a href="#PresenceMap.__init__-67"><span class="linenos">67</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="n">Presence</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">:</span> <span class="n">Timescale</span><span class="p">):</span>
</span><span id="PresenceMap.__init__-68"><a href="#PresenceMap.__init__-68"><span class="linenos">68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMap.__init__-69"><a href="#PresenceMap.__init__-69"><span class="linenos">69</span></a><span class="sd">        Map a presence interval to matrix slice indices and edge fractional values</span>
</span><span id="PresenceMap.__init__-70"><a href="#PresenceMap.__init__-70"><span class="linenos">70</span></a><span class="sd">        using the provided Timescale object.</span>
</span><span id="PresenceMap.__init__-71"><a href="#PresenceMap.__init__-71"><span class="linenos">71</span></a><span class="sd">         &quot;&quot;&quot;</span>
</span><span id="PresenceMap.__init__-72"><a href="#PresenceMap.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span> <span class="o">=</span> <span class="n">presence</span>
</span><span id="PresenceMap.__init__-73"><a href="#PresenceMap.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="n">time_scale</span>
</span><span id="PresenceMap.__init__-74"><a href="#PresenceMap.__init__-74"><span class="linenos">74</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceMap.__init__-75"><a href="#PresenceMap.__init__-75"><span class="linenos">75</span></a>        <span class="n">is_mapped</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PresenceMap.__init__-76"><a href="#PresenceMap.__init__-76"><span class="linenos">76</span></a>        <span class="n">start_bin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="PresenceMap.__init__-77"><a href="#PresenceMap.__init__-77"><span class="linenos">77</span></a>        <span class="n">end_bin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="PresenceMap.__init__-78"><a href="#PresenceMap.__init__-78"><span class="linenos">78</span></a>        <span class="n">start_value</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="PresenceMap.__init__-79"><a href="#PresenceMap.__init__-79"><span class="linenos">79</span></a>        <span class="n">end_value</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
</span><span id="PresenceMap.__init__-80"><a href="#PresenceMap.__init__-80"><span class="linenos">80</span></a>
</span><span id="PresenceMap.__init__-81"><a href="#PresenceMap.__init__-81"><span class="linenos">81</span></a>        <span class="k">if</span> <span class="n">presence</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">):</span>
</span><span id="PresenceMap.__init__-82"><a href="#PresenceMap.__init__-82"><span class="linenos">82</span></a>            <span class="n">is_mapped</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PresenceMap.__init__-83"><a href="#PresenceMap.__init__-83"><span class="linenos">83</span></a>            <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span>
</span><span id="PresenceMap.__init__-84"><a href="#PresenceMap.__init__-84"><span class="linenos">84</span></a>            <span class="n">start_value</span><span class="p">,</span> <span class="n">end_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fractional_values</span><span class="p">(</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">start_bin</span><span class="p">,</span> <span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceMap.__init__-85"><a href="#PresenceMap.__init__-85"><span class="linenos">85</span></a>
</span><span id="PresenceMap.__init__-86"><a href="#PresenceMap.__init__-86"><span class="linenos">86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_mapped</span> <span class="o">=</span> <span class="n">is_mapped</span>
</span><span id="PresenceMap.__init__-87"><a href="#PresenceMap.__init__-87"><span class="linenos">87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_bin</span> <span class="o">=</span> <span class="n">start_bin</span>
</span><span id="PresenceMap.__init__-88"><a href="#PresenceMap.__init__-88"><span class="linenos">88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_bin</span> <span class="o">=</span> <span class="n">end_bin</span>
</span><span id="PresenceMap.__init__-89"><a href="#PresenceMap.__init__-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_value</span> <span class="o">=</span> <span class="n">start_value</span>
</span><span id="PresenceMap.__init__-90"><a href="#PresenceMap.__init__-90"><span class="linenos">90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_value</span> <span class="o">=</span> <span class="n">end_value</span>
</span></pre></div>


            <div class="docstring"><p>Map a presence interval to matrix slice indices and edge fractional values
using the provided Timescale object.</p>
</div>


                            </div>
                            <div id="PresenceMap.presence" class="classattr">
                                <div class="attr variable">
            <span class="name">presence</span><span class="annotation">: <a href="#Presence">Presence</a></span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.presence"></a>
    
            <div class="docstring"><p>The presence entry</p>
</div>


                            </div>
                            <div id="PresenceMap.time_scale" class="classattr">
                                <div class="attr variable">
            <span class="name">time_scale</span><span class="annotation">: <a href="#Timescale">Timescale</a></span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.time_scale"></a>
    
            <div class="docstring"><p>The time scale that the presence is mapped to</p>
</div>


                            </div>
                            <div id="PresenceMap.is_mapped" class="classattr">
                                <div class="attr variable">
            <span class="name">is_mapped</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.is_mapped"></a>
    
            <div class="docstring"><p>True if the presence has a valid mapping. Unmapped presences have value=-1
for start_slice, end_slice, start_value and end_value.</p>
</div>


                            </div>
                            <div id="PresenceMap.start_bin" class="classattr">
                                <div class="attr variable">
            <span class="name">start_bin</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.start_bin"></a>
    
            <div class="docstring"><p>The starting bin in the discrete mapping</p>
</div>


                            </div>
                            <div id="PresenceMap.end_bin" class="classattr">
                                <div class="attr variable">
            <span class="name">end_bin</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.end_bin"></a>
    
            <div class="docstring"><p>The ending bin in the discrete mapping<code>
of row</code>row`.</p>
</div>


                            </div>
                            <div id="PresenceMap.start_value" class="classattr">
                                <div class="attr variable">
            <span class="name">start_value</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.start_value"></a>
    
            <div class="docstring"><p>A presence value 0 &lt; p &lt; 1.0 that represents a potentially partial presence at the start of the mapping</p>
</div>


                            </div>
                            <div id="PresenceMap.end_value" class="classattr">
                                <div class="attr variable">
            <span class="name">end_value</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#PresenceMap.end_value"></a>
    
            <div class="docstring"><p>A presence value 0 &lt; p &lt; 1.0 that represents a potentially partial presence at the end of the mapping</p>
</div>


                            </div>
                            <div id="PresenceMap.bin_range" class="classattr">
                                        <input id="PresenceMap.bin_range-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">bin_range</span><span class="annotation">: range</span>

                <label class="view-source-button" for="PresenceMap.bin_range-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap.bin_range"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap.bin_range-58"><a href="#PresenceMap.bin_range-58"><span class="linenos">58</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMap.bin_range-59"><a href="#PresenceMap.bin_range-59"><span class="linenos">59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bin_range</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">range</span><span class="p">:</span>
</span><span id="PresenceMap.bin_range-60"><a href="#PresenceMap.bin_range-60"><span class="linenos">60</span></a>        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_bin</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapped</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceMap.duration" class="classattr">
                                        <input id="PresenceMap.duration-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">duration</span><span class="annotation">: float</span>

                <label class="view-source-button" for="PresenceMap.duration-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap.duration"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap.duration-62"><a href="#PresenceMap.duration-62"><span class="linenos">62</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMap.duration-63"><a href="#PresenceMap.duration-63"><span class="linenos">63</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceMap.duration-64"><a href="#PresenceMap.duration-64"><span class="linenos">64</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceMap.is_active" class="classattr">
                                        <input id="PresenceMap.is_active-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_active</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_bin</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">end_bin</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PresenceMap.is_active-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap.is_active"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap.is_active-106"><a href="#PresenceMap.is_active-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_bin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMap.is_active-107"><a href="#PresenceMap.is_active-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="n">end_bin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_bin</span> <span class="ow">and</span> <span class="n">start_bin</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_bin</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceMap.presence_value_in" class="classattr">
                                        <input id="PresenceMap.presence_value_in-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">presence_value_in</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceMap.presence_value_in-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap.presence_value_in"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap.presence_value_in-109"><a href="#PresenceMap.presence_value_in-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">presence_value_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceMap.presence_value_in-110"><a href="#PresenceMap.presence_value_in-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMap.presence_value_in-111"><a href="#PresenceMap.presence_value_in-111"><span class="linenos">111</span></a><span class="sd">        Computes total presence value (in time) within [start_time, end_time),</span>
</span><span id="PresenceMap.presence_value_in-112"><a href="#PresenceMap.presence_value_in-112"><span class="linenos">112</span></a><span class="sd">        using bin-based approximation logic, clipped to the given interval.</span>
</span><span id="PresenceMap.presence_value_in-113"><a href="#PresenceMap.presence_value_in-113"><span class="linenos">113</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMap.presence_value_in-114"><a href="#PresenceMap.presence_value_in-114"><span class="linenos">114</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceMap.presence_value_in-115"><a href="#PresenceMap.presence_value_in-115"><span class="linenos">115</span></a>        <span class="n">bin_width</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_width</span>
</span><span id="PresenceMap.presence_value_in-116"><a href="#PresenceMap.presence_value_in-116"><span class="linenos">116</span></a>
</span><span id="PresenceMap.presence_value_in-117"><a href="#PresenceMap.presence_value_in-117"><span class="linenos">117</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceMap.presence_value_in-118"><a href="#PresenceMap.presence_value_in-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapped</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="PresenceMap.presence_value_in-119"><a href="#PresenceMap.presence_value_in-119"><span class="linenos">119</span></a>            <span class="c1">#  Clip window to actual presence bounds</span>
</span><span id="PresenceMap.presence_value_in-120"><a href="#PresenceMap.presence_value_in-120"><span class="linenos">120</span></a>            <span class="n">effective_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
</span><span id="PresenceMap.presence_value_in-121"><a href="#PresenceMap.presence_value_in-121"><span class="linenos">121</span></a>            <span class="n">effective_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceMap.presence_value_in-122"><a href="#PresenceMap.presence_value_in-122"><span class="linenos">122</span></a>
</span><span id="PresenceMap.presence_value_in-123"><a href="#PresenceMap.presence_value_in-123"><span class="linenos">123</span></a>            <span class="n">effective_start_bin</span><span class="p">,</span> <span class="n">effective_end_bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">effective_start</span><span class="p">,</span> <span class="n">effective_end</span><span class="p">)</span>
</span><span id="PresenceMap.presence_value_in-124"><a href="#PresenceMap.presence_value_in-124"><span class="linenos">124</span></a>
</span><span id="PresenceMap.presence_value_in-125"><a href="#PresenceMap.presence_value_in-125"><span class="linenos">125</span></a>            <span class="k">if</span> <span class="n">start_time</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">t0</span> <span class="ow">and</span> <span class="n">end_time</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">:</span>
</span><span id="PresenceMap.presence_value_in-126"><a href="#PresenceMap.presence_value_in-126"><span class="linenos">126</span></a>                <span class="n">start_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_value</span>
</span><span id="PresenceMap.presence_value_in-127"><a href="#PresenceMap.presence_value_in-127"><span class="linenos">127</span></a>                <span class="n">end_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_value</span>
</span><span id="PresenceMap.presence_value_in-128"><a href="#PresenceMap.presence_value_in-128"><span class="linenos">128</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PresenceMap.presence_value_in-129"><a href="#PresenceMap.presence_value_in-129"><span class="linenos">129</span></a>                <span class="n">start_value</span><span class="p">,</span> <span class="n">end_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fractional_values</span><span class="p">(</span><span class="n">effective_start</span><span class="p">,</span> <span class="n">effective_start_bin</span><span class="p">,</span> <span class="n">effective_end</span><span class="p">,</span> <span class="n">effective_end_bin</span><span class="p">)</span>
</span><span id="PresenceMap.presence_value_in-130"><a href="#PresenceMap.presence_value_in-130"><span class="linenos">130</span></a>
</span><span id="PresenceMap.presence_value_in-131"><a href="#PresenceMap.presence_value_in-131"><span class="linenos">131</span></a>            <span class="n">full_bin_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">effective_end_bin</span> <span class="o">-</span> <span class="n">effective_start_bin</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="PresenceMap.presence_value_in-132"><a href="#PresenceMap.presence_value_in-132"><span class="linenos">132</span></a>
</span><span id="PresenceMap.presence_value_in-133"><a href="#PresenceMap.presence_value_in-133"><span class="linenos">133</span></a>            <span class="n">fractional_value</span> <span class="o">=</span> <span class="n">start_value</span> <span class="o">+</span> <span class="n">end_value</span>
</span><span id="PresenceMap.presence_value_in-134"><a href="#PresenceMap.presence_value_in-134"><span class="linenos">134</span></a>
</span><span id="PresenceMap.presence_value_in-135"><a href="#PresenceMap.presence_value_in-135"><span class="linenos">135</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">full_bin_value</span> <span class="o">+</span> <span class="n">fractional_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">bin_width</span>
</span><span id="PresenceMap.presence_value_in-136"><a href="#PresenceMap.presence_value_in-136"><span class="linenos">136</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PresenceMap.presence_value_in-137"><a href="#PresenceMap.presence_value_in-137"><span class="linenos">137</span></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Computes total presence value (in time) within [start_time, end_time),
using bin-based approximation logic, clipped to the given interval.</p>
</div>


                            </div>
                            <div id="PresenceMap.presence_value" class="classattr">
                                        <input id="PresenceMap.presence_value-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">presence_value</span><span class="annotation">: float</span>

                <label class="view-source-button" for="PresenceMap.presence_value-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMap.presence_value"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMap.presence_value-139"><a href="#PresenceMap.presence_value-139"><span class="linenos">139</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMap.presence_value-140"><a href="#PresenceMap.presence_value-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">presence_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceMap.presence_value-141"><a href="#PresenceMap.presence_value-141"><span class="linenos">141</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="PresenceMatrix">
                            <input id="PresenceMatrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PresenceMatrix</span>:

                <label class="view-source-button" for="PresenceMatrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix-18"><a href="#PresenceMatrix-18"><span class="linenos"> 18</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PresenceMatrix</span><span class="p">:</span>
</span><span id="PresenceMatrix-19"><a href="#PresenceMatrix-19"><span class="linenos"> 19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-20"><a href="#PresenceMatrix-20"><span class="linenos"> 20</span></a><span class="sd">    A scale-invariant, optionally lazy matrix representation of element presences over time.</span>
</span><span id="PresenceMatrix-21"><a href="#PresenceMatrix-21"><span class="linenos"> 21</span></a>
</span><span id="PresenceMatrix-22"><a href="#PresenceMatrix-22"><span class="linenos"> 22</span></a><span class="sd">    Each row corresponds to a single `Presence`, and each column represents a discrete time bin defined by a `Timescale`.</span>
</span><span id="PresenceMatrix-23"><a href="#PresenceMatrix-23"><span class="linenos"> 23</span></a><span class="sd">    The matrix records the degree of presence of each element within a given boundary over time, where each value is a real number in [0.0, 1.0]:</span>
</span><span id="PresenceMatrix-24"><a href="#PresenceMatrix-24"><span class="linenos"> 24</span></a><span class="sd">    - 1.0 = full presence for the duration of the time bin</span>
</span><span id="PresenceMatrix-25"><a href="#PresenceMatrix-25"><span class="linenos"> 25</span></a><span class="sd">    - 0.0 = no presence</span>
</span><span id="PresenceMatrix-26"><a href="#PresenceMatrix-26"><span class="linenos"> 26</span></a><span class="sd">    - values in between represent partial presence due to overlap</span>
</span><span id="PresenceMatrix-27"><a href="#PresenceMatrix-27"><span class="linenos"> 27</span></a>
</span><span id="PresenceMatrix-28"><a href="#PresenceMatrix-28"><span class="linenos"> 28</span></a><span class="sd">    The matrix can be computed eagerly via `materialize()` or accessed lazily through NumPy-style slicing.</span>
</span><span id="PresenceMatrix-29"><a href="#PresenceMatrix-29"><span class="linenos"> 29</span></a>
</span><span id="PresenceMatrix-30"><a href="#PresenceMatrix-30"><span class="linenos"> 30</span></a><span class="sd">    ### Structure</span>
</span><span id="PresenceMatrix-31"><a href="#PresenceMatrix-31"><span class="linenos"> 31</span></a>
</span><span id="PresenceMatrix-32"><a href="#PresenceMatrix-32"><span class="linenos"> 32</span></a><span class="sd">    - **Rows:** Each row corresponds to one `Presence` instance.</span>
</span><span id="PresenceMatrix-33"><a href="#PresenceMatrix-33"><span class="linenos"> 33</span></a><span class="sd">    - **Columns:** Each column represents a discrete bin of time defined by the `Timescale` (from `t0` to `t1` using `bin_width`).</span>
</span><span id="PresenceMatrix-34"><a href="#PresenceMatrix-34"><span class="linenos"> 34</span></a><span class="sd">    - The matrix shape is therefore `(len(presences), timescale.num_bins)`.</span>
</span><span id="PresenceMatrix-35"><a href="#PresenceMatrix-35"><span class="linenos"> 35</span></a>
</span><span id="PresenceMatrix-36"><a href="#PresenceMatrix-36"><span class="linenos"> 36</span></a><span class="sd">    ### Usage</span>
</span><span id="PresenceMatrix-37"><a href="#PresenceMatrix-37"><span class="linenos"> 37</span></a>
</span><span id="PresenceMatrix-38"><a href="#PresenceMatrix-38"><span class="linenos"> 38</span></a><span class="sd">    ```python</span>
</span><span id="PresenceMatrix-39"><a href="#PresenceMatrix-39"><span class="linenos"> 39</span></a><span class="sd">    from pcalc import PresenceMatrix</span>
</span><span id="PresenceMatrix-40"><a href="#PresenceMatrix-40"><span class="linenos"> 40</span></a><span class="sd">    from metamodel.timescale import Timescale</span>
</span><span id="PresenceMatrix-41"><a href="#PresenceMatrix-41"><span class="linenos"> 41</span></a>
</span><span id="PresenceMatrix-42"><a href="#PresenceMatrix-42"><span class="linenos"> 42</span></a><span class="sd">    # Define a time window with bin width of 1.0</span>
</span><span id="PresenceMatrix-43"><a href="#PresenceMatrix-43"><span class="linenos"> 43</span></a><span class="sd">    ts = Timescale(t0=0.0, t1=5.0, bin_width=1.0)</span>
</span><span id="PresenceMatrix-44"><a href="#PresenceMatrix-44"><span class="linenos"> 44</span></a>
</span><span id="PresenceMatrix-45"><a href="#PresenceMatrix-45"><span class="linenos"> 45</span></a><span class="sd">    # Construct lazily</span>
</span><span id="PresenceMatrix-46"><a href="#PresenceMatrix-46"><span class="linenos"> 46</span></a><span class="sd">    matrix = PresenceMatrix(presences, time_scale=ts)</span>
</span><span id="PresenceMatrix-47"><a href="#PresenceMatrix-47"><span class="linenos"> 47</span></a>
</span><span id="PresenceMatrix-48"><a href="#PresenceMatrix-48"><span class="linenos"> 48</span></a><span class="sd">    # Access entire row</span>
</span><span id="PresenceMatrix-49"><a href="#PresenceMatrix-49"><span class="linenos"> 49</span></a><span class="sd">    row = matrix[0]  # row 0 as 1D array</span>
</span><span id="PresenceMatrix-50"><a href="#PresenceMatrix-50"><span class="linenos"> 50</span></a>
</span><span id="PresenceMatrix-51"><a href="#PresenceMatrix-51"><span class="linenos"> 51</span></a><span class="sd">    # Access single value</span>
</span><span id="PresenceMatrix-52"><a href="#PresenceMatrix-52"><span class="linenos"> 52</span></a><span class="sd">    value = matrix[2, 3]  # presence at row 2, column 3</span>
</span><span id="PresenceMatrix-53"><a href="#PresenceMatrix-53"><span class="linenos"> 53</span></a>
</span><span id="PresenceMatrix-54"><a href="#PresenceMatrix-54"><span class="linenos"> 54</span></a><span class="sd">    # Access slice of row</span>
</span><span id="PresenceMatrix-55"><a href="#PresenceMatrix-55"><span class="linenos"> 55</span></a><span class="sd">    window = matrix[1, 1:4]  # row 1, columns 1–3</span>
</span><span id="PresenceMatrix-56"><a href="#PresenceMatrix-56"><span class="linenos"> 56</span></a>
</span><span id="PresenceMatrix-57"><a href="#PresenceMatrix-57"><span class="linenos"> 57</span></a><span class="sd">    # Access slice of rows</span>
</span><span id="PresenceMatrix-58"><a href="#PresenceMatrix-58"><span class="linenos"> 58</span></a><span class="sd">    rows = matrix[0:2]  # rows 0 and 1</span>
</span><span id="PresenceMatrix-59"><a href="#PresenceMatrix-59"><span class="linenos"> 59</span></a>
</span><span id="PresenceMatrix-60"><a href="#PresenceMatrix-60"><span class="linenos"> 60</span></a><span class="sd">    # Access single column</span>
</span><span id="PresenceMatrix-61"><a href="#PresenceMatrix-61"><span class="linenos"> 61</span></a><span class="sd">    col = matrix[:, 2]  # all rows at column 2</span>
</span><span id="PresenceMatrix-62"><a href="#PresenceMatrix-62"><span class="linenos"> 62</span></a>
</span><span id="PresenceMatrix-63"><a href="#PresenceMatrix-63"><span class="linenos"> 63</span></a><span class="sd">    # Access column block</span>
</span><span id="PresenceMatrix-64"><a href="#PresenceMatrix-64"><span class="linenos"> 64</span></a><span class="sd">    col_block = matrix[:, 1:4]  # all rows, columns 1–3</span>
</span><span id="PresenceMatrix-65"><a href="#PresenceMatrix-65"><span class="linenos"> 65</span></a>
</span><span id="PresenceMatrix-66"><a href="#PresenceMatrix-66"><span class="linenos"> 66</span></a><span class="sd">    # Materialize full matrix (optional)</span>
</span><span id="PresenceMatrix-67"><a href="#PresenceMatrix-67"><span class="linenos"> 67</span></a><span class="sd">    dense = matrix.materialize()</span>
</span><span id="PresenceMatrix-68"><a href="#PresenceMatrix-68"><span class="linenos"> 68</span></a><span class="sd">    ```</span>
</span><span id="PresenceMatrix-69"><a href="#PresenceMatrix-69"><span class="linenos"> 69</span></a>
</span><span id="PresenceMatrix-70"><a href="#PresenceMatrix-70"><span class="linenos"> 70</span></a><span class="sd">    Features</span>
</span><span id="PresenceMatrix-71"><a href="#PresenceMatrix-71"><span class="linenos"> 71</span></a><span class="sd">    --------</span>
</span><span id="PresenceMatrix-72"><a href="#PresenceMatrix-72"><span class="linenos"> 72</span></a><span class="sd">    - Lazy evaluation by default; full matrix computed only if needed</span>
</span><span id="PresenceMatrix-73"><a href="#PresenceMatrix-73"><span class="linenos"> 73</span></a><span class="sd">    - NumPy-style indexing: supports full rows, row/column slicing, and scalar access</span>
</span><span id="PresenceMatrix-74"><a href="#PresenceMatrix-74"><span class="linenos"> 74</span></a><span class="sd">    - Precision-preserving: partial bin overlaps are retained in the matrix</span>
</span><span id="PresenceMatrix-75"><a href="#PresenceMatrix-75"><span class="linenos"> 75</span></a><span class="sd">    - Compatible with matrix operations and flow metric calculations</span>
</span><span id="PresenceMatrix-76"><a href="#PresenceMatrix-76"><span class="linenos"> 76</span></a><span class="sd">    - Backed by a sparse `PresenceMap`, which stores slice indices and fractional overlaps</span>
</span><span id="PresenceMatrix-77"><a href="#PresenceMatrix-77"><span class="linenos"> 77</span></a>
</span><span id="PresenceMatrix-78"><a href="#PresenceMatrix-78"><span class="linenos"> 78</span></a><span class="sd">    Notes</span>
</span><span id="PresenceMatrix-79"><a href="#PresenceMatrix-79"><span class="linenos"> 79</span></a><span class="sd">    -----</span>
</span><span id="PresenceMatrix-80"><a href="#PresenceMatrix-80"><span class="linenos"> 80</span></a><span class="sd">    - Use `materialize()` if you want to extract or operate on the full dense matrix</span>
</span><span id="PresenceMatrix-81"><a href="#PresenceMatrix-81"><span class="linenos"> 81</span></a><span class="sd">    - Use `matrix[i, j]`, `matrix[i, j:k]`, or `matrix[:, j]` for lightweight slicing without allocating the full matrix</span>
</span><span id="PresenceMatrix-82"><a href="#PresenceMatrix-82"><span class="linenos"> 82</span></a><span class="sd">    - Stepped slicing (e.g., `matrix[::2]`) is not currently supported</span>
</span><span id="PresenceMatrix-83"><a href="#PresenceMatrix-83"><span class="linenos"> 83</span></a>
</span><span id="PresenceMatrix-84"><a href="#PresenceMatrix-84"><span class="linenos"> 84</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-85"><a href="#PresenceMatrix-85"><span class="linenos"> 85</span></a>
</span><span id="PresenceMatrix-86"><a href="#PresenceMatrix-86"><span class="linenos"> 86</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Presence</span><span class="p">],</span> <span class="n">time_scale</span><span class="p">:</span> <span class="n">Timescale</span><span class="p">,</span> <span class="n">materialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PresenceMatrix-87"><a href="#PresenceMatrix-87"><span class="linenos"> 87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-88"><a href="#PresenceMatrix-88"><span class="linenos"> 88</span></a><span class="sd">        Construct a presence matrix from a list of Presences and time window configuration.</span>
</span><span id="PresenceMatrix-89"><a href="#PresenceMatrix-89"><span class="linenos"> 89</span></a>
</span><span id="PresenceMatrix-90"><a href="#PresenceMatrix-90"><span class="linenos"> 90</span></a><span class="sd">        Args:</span>
</span><span id="PresenceMatrix-91"><a href="#PresenceMatrix-91"><span class="linenos"> 91</span></a><span class="sd">            presences: A list of `Presence` instances, one per element of interest.</span>
</span><span id="PresenceMatrix-92"><a href="#PresenceMatrix-92"><span class="linenos"> 92</span></a><span class="sd">            time_scale: The discrete `Timescale` that the matrix will be normalized to.</span>
</span><span id="PresenceMatrix-93"><a href="#PresenceMatrix-93"><span class="linenos"> 93</span></a><span class="sd">            materialize: If True, immediately constructs the full backing matrix.</span>
</span><span id="PresenceMatrix-94"><a href="#PresenceMatrix-94"><span class="linenos"> 94</span></a><span class="sd">                     Otherwise, matrix values will be computed on demand using the sparse presence map.</span>
</span><span id="PresenceMatrix-95"><a href="#PresenceMatrix-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-96"><a href="#PresenceMatrix-96"><span class="linenos"> 96</span></a>
</span><span id="PresenceMatrix-97"><a href="#PresenceMatrix-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PresenceMatrix-98"><a href="#PresenceMatrix-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-99"><a href="#PresenceMatrix-99"><span class="linenos"> 99</span></a><span class="sd">        A real valued matrix with shape (num_Presences, num_bins).</span>
</span><span id="PresenceMatrix-100"><a href="#PresenceMatrix-100"><span class="linenos">100</span></a><span class="sd">        When every presence.start and presence.end are whole numbers every value</span>
</span><span id="PresenceMatrix-101"><a href="#PresenceMatrix-101"><span class="linenos">101</span></a><span class="sd">        in the matrix is either 0.0 or 1.0. If they are not whole numbers, the presence</span>
</span><span id="PresenceMatrix-102"><a href="#PresenceMatrix-102"><span class="linenos">102</span></a><span class="sd">        is mapped to a number between 0.0 and 1.0 at the start and end (or both), with any</span>
</span><span id="PresenceMatrix-103"><a href="#PresenceMatrix-103"><span class="linenos">103</span></a><span class="sd">        intermediate value being 1.0. </span>
</span><span id="PresenceMatrix-104"><a href="#PresenceMatrix-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-105"><a href="#PresenceMatrix-105"><span class="linenos">105</span></a>
</span><span id="PresenceMatrix-106"><a href="#PresenceMatrix-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="n">time_scale</span>
</span><span id="PresenceMatrix-107"><a href="#PresenceMatrix-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-108"><a href="#PresenceMatrix-108"><span class="linenos">108</span></a><span class="sd">        The time scale of the presence matrix.</span>
</span><span id="PresenceMatrix-109"><a href="#PresenceMatrix-109"><span class="linenos">109</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-110"><a href="#PresenceMatrix-110"><span class="linenos">110</span></a>
</span><span id="PresenceMatrix-111"><a href="#PresenceMatrix-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PresenceMatrix-112"><a href="#PresenceMatrix-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PresenceMatrix-113"><a href="#PresenceMatrix-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_presence_map</span><span class="p">(</span><span class="n">presences</span><span class="p">)</span>
</span><span id="PresenceMatrix-114"><a href="#PresenceMatrix-114"><span class="linenos">114</span></a>
</span><span id="PresenceMatrix-115"><a href="#PresenceMatrix-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="n">materialize</span><span class="p">:</span>
</span><span id="PresenceMatrix-116"><a href="#PresenceMatrix-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</span><span id="PresenceMatrix-117"><a href="#PresenceMatrix-117"><span class="linenos">117</span></a>
</span><span id="PresenceMatrix-118"><a href="#PresenceMatrix-118"><span class="linenos">118</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_presence_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Presence</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-119"><a href="#PresenceMatrix-119"><span class="linenos">119</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-120"><a href="#PresenceMatrix-120"><span class="linenos">120</span></a><span class="sd">        Initialize the internal presence matrix based on the Presence intervals and binning scheme.</span>
</span><span id="PresenceMatrix-121"><a href="#PresenceMatrix-121"><span class="linenos">121</span></a><span class="sd">        Only presences that overlap the timescale endpoints [t0, t1) are mapped.</span>
</span><span id="PresenceMatrix-122"><a href="#PresenceMatrix-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-123"><a href="#PresenceMatrix-123"><span class="linenos">123</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>  <span class="c1"># Timescale object: includes t0, t1, bin_width</span>
</span><span id="PresenceMatrix-124"><a href="#PresenceMatrix-124"><span class="linenos">124</span></a>
</span><span id="PresenceMatrix-125"><a href="#PresenceMatrix-125"><span class="linenos">125</span></a>        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">presence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">presences</span><span class="p">):</span>
</span><span id="PresenceMatrix-126"><a href="#PresenceMatrix-126"><span class="linenos">126</span></a>            <span class="n">presence_map</span> <span class="o">=</span> <span class="n">PresenceMap</span><span class="p">(</span><span class="n">presence</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
</span><span id="PresenceMatrix-127"><a href="#PresenceMatrix-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="n">presence_map</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="PresenceMatrix-128"><a href="#PresenceMatrix-128"><span class="linenos">128</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">presence_map</span><span class="p">)</span>
</span><span id="PresenceMatrix-129"><a href="#PresenceMatrix-129"><span class="linenos">129</span></a>
</span><span id="PresenceMatrix-130"><a href="#PresenceMatrix-130"><span class="linenos">130</span></a>        <span class="n">num_bins</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">num_bins</span>
</span><span id="PresenceMatrix-131"><a href="#PresenceMatrix-131"><span class="linenos">131</span></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">)</span>
</span><span id="PresenceMatrix-132"><a href="#PresenceMatrix-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">)</span>
</span><span id="PresenceMatrix-133"><a href="#PresenceMatrix-133"><span class="linenos">133</span></a>
</span><span id="PresenceMatrix-134"><a href="#PresenceMatrix-134"><span class="linenos">134</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_materialized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="PresenceMatrix-135"><a href="#PresenceMatrix-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the backing matrix has been materialized.&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-136"><a href="#PresenceMatrix-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="PresenceMatrix-137"><a href="#PresenceMatrix-137"><span class="linenos">137</span></a>
</span><span id="PresenceMatrix-138"><a href="#PresenceMatrix-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="PresenceMatrix-139"><a href="#PresenceMatrix-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-140"><a href="#PresenceMatrix-140"><span class="linenos">140</span></a><span class="sd">        Materialize and return the full presence matrix from presence maps.</span>
</span><span id="PresenceMatrix-141"><a href="#PresenceMatrix-141"><span class="linenos">141</span></a><span class="sd">        If already materialized, this is a no-op and returns the cached matrix.</span>
</span><span id="PresenceMatrix-142"><a href="#PresenceMatrix-142"><span class="linenos">142</span></a>
</span><span id="PresenceMatrix-143"><a href="#PresenceMatrix-143"><span class="linenos">143</span></a><span class="sd">        Use this only if want the full matrix to operate on. For most cases, you should</span>
</span><span id="PresenceMatrix-144"><a href="#PresenceMatrix-144"><span class="linenos">144</span></a><span class="sd">        be able to work with the sparse representation with the presence map and using</span>
</span><span id="PresenceMatrix-145"><a href="#PresenceMatrix-145"><span class="linenos">145</span></a><span class="sd">        array slicing on the matrix object. So think twice about why you are materializing</span>
</span><span id="PresenceMatrix-146"><a href="#PresenceMatrix-146"><span class="linenos">146</span></a><span class="sd">        a matrix.</span>
</span><span id="PresenceMatrix-147"><a href="#PresenceMatrix-147"><span class="linenos">147</span></a>
</span><span id="PresenceMatrix-148"><a href="#PresenceMatrix-148"><span class="linenos">148</span></a><span class="sd">        Returns:</span>
</span><span id="PresenceMatrix-149"><a href="#PresenceMatrix-149"><span class="linenos">149</span></a><span class="sd">            The dense presence matrix of shape (num_presences, num_bins).</span>
</span><span id="PresenceMatrix-150"><a href="#PresenceMatrix-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-151"><a href="#PresenceMatrix-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_materialized</span><span class="p">():</span>
</span><span id="PresenceMatrix-152"><a href="#PresenceMatrix-152"><span class="linenos">152</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span>
</span><span id="PresenceMatrix-153"><a href="#PresenceMatrix-153"><span class="linenos">153</span></a>
</span><span id="PresenceMatrix-154"><a href="#PresenceMatrix-154"><span class="linenos">154</span></a>        <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PresenceMatrix-155"><a href="#PresenceMatrix-155"><span class="linenos">155</span></a>        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PresenceMatrix-156"><a href="#PresenceMatrix-156"><span class="linenos">156</span></a>
</span><span id="PresenceMatrix-157"><a href="#PresenceMatrix-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">pm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">):</span>
</span><span id="PresenceMatrix-158"><a href="#PresenceMatrix-158"><span class="linenos">158</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="PresenceMatrix-159"><a href="#PresenceMatrix-159"><span class="linenos">159</span></a>                <span class="k">continue</span>
</span><span id="PresenceMatrix-160"><a href="#PresenceMatrix-160"><span class="linenos">160</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_bin</span>
</span><span id="PresenceMatrix-161"><a href="#PresenceMatrix-161"><span class="linenos">161</span></a>            <span class="n">end</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_bin</span>
</span><span id="PresenceMatrix-162"><a href="#PresenceMatrix-162"><span class="linenos">162</span></a>            <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_value</span>
</span><span id="PresenceMatrix-163"><a href="#PresenceMatrix-163"><span class="linenos">163</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
</span><span id="PresenceMatrix-164"><a href="#PresenceMatrix-164"><span class="linenos">164</span></a>                <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_value</span>
</span><span id="PresenceMatrix-165"><a href="#PresenceMatrix-165"><span class="linenos">165</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PresenceMatrix-166"><a href="#PresenceMatrix-166"><span class="linenos">166</span></a>                <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="PresenceMatrix-167"><a href="#PresenceMatrix-167"><span class="linenos">167</span></a>
</span><span id="PresenceMatrix-168"><a href="#PresenceMatrix-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="PresenceMatrix-169"><a href="#PresenceMatrix-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span>
</span><span id="PresenceMatrix-170"><a href="#PresenceMatrix-170"><span class="linenos">170</span></a>
</span><span id="PresenceMatrix-171"><a href="#PresenceMatrix-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">drop_materialization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-172"><a href="#PresenceMatrix-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Discard the cached matrix, returning to sparse-only mode.&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-173"><a href="#PresenceMatrix-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PresenceMatrix-174"><a href="#PresenceMatrix-174"><span class="linenos">174</span></a>
</span><span id="PresenceMatrix-175"><a href="#PresenceMatrix-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_row_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="PresenceMatrix-176"><a href="#PresenceMatrix-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-177"><a href="#PresenceMatrix-177"><span class="linenos">177</span></a><span class="sd">        On-demand computation of a row slice from presence map.</span>
</span><span id="PresenceMatrix-178"><a href="#PresenceMatrix-178"><span class="linenos">178</span></a><span class="sd">        If the presence is not mapped or out of bounds, returns zeroes.</span>
</span><span id="PresenceMatrix-179"><a href="#PresenceMatrix-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-180"><a href="#PresenceMatrix-180"><span class="linenos">180</span></a>        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
</span><span id="PresenceMatrix-181"><a href="#PresenceMatrix-181"><span class="linenos">181</span></a>        <span class="n">width</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="PresenceMatrix-182"><a href="#PresenceMatrix-182"><span class="linenos">182</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PresenceMatrix-183"><a href="#PresenceMatrix-183"><span class="linenos">183</span></a>
</span><span id="PresenceMatrix-184"><a href="#PresenceMatrix-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="PresenceMatrix-185"><a href="#PresenceMatrix-185"><span class="linenos">185</span></a>            <span class="k">return</span> <span class="n">output</span>
</span><span id="PresenceMatrix-186"><a href="#PresenceMatrix-186"><span class="linenos">186</span></a>
</span><span id="PresenceMatrix-187"><a href="#PresenceMatrix-187"><span class="linenos">187</span></a>        <span class="c1"># Slice and overlap window</span>
</span><span id="PresenceMatrix-188"><a href="#PresenceMatrix-188"><span class="linenos">188</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
</span><span id="PresenceMatrix-189"><a href="#PresenceMatrix-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_bin</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">&gt;=</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_bin</span><span class="p">:</span>
</span><span id="PresenceMatrix-190"><a href="#PresenceMatrix-190"><span class="linenos">190</span></a>                <span class="k">continue</span>
</span><span id="PresenceMatrix-191"><a href="#PresenceMatrix-191"><span class="linenos">191</span></a>            <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_bin</span><span class="p">:</span>
</span><span id="PresenceMatrix-192"><a href="#PresenceMatrix-192"><span class="linenos">192</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">col</span> <span class="o">-</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_value</span>
</span><span id="PresenceMatrix-193"><a href="#PresenceMatrix-193"><span class="linenos">193</span></a>            <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_bin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PresenceMatrix-194"><a href="#PresenceMatrix-194"><span class="linenos">194</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">col</span> <span class="o">-</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_value</span>
</span><span id="PresenceMatrix-195"><a href="#PresenceMatrix-195"><span class="linenos">195</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PresenceMatrix-196"><a href="#PresenceMatrix-196"><span class="linenos">196</span></a>                <span class="n">output</span><span class="p">[</span><span class="n">col</span> <span class="o">-</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="PresenceMatrix-197"><a href="#PresenceMatrix-197"><span class="linenos">197</span></a>
</span><span id="PresenceMatrix-198"><a href="#PresenceMatrix-198"><span class="linenos">198</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="PresenceMatrix-199"><a href="#PresenceMatrix-199"><span class="linenos">199</span></a>
</span><span id="PresenceMatrix-200"><a href="#PresenceMatrix-200"><span class="linenos">200</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMatrix-201"><a href="#PresenceMatrix-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">presences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="PresenceMatrix-202"><a href="#PresenceMatrix-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">]</span>
</span><span id="PresenceMatrix-203"><a href="#PresenceMatrix-203"><span class="linenos">203</span></a>
</span><span id="PresenceMatrix-204"><a href="#PresenceMatrix-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="PresenceMatrix-205"><a href="#PresenceMatrix-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-206"><a href="#PresenceMatrix-206"><span class="linenos">206</span></a><span class="sd">        Support NumPy-style indexing:</span>
</span><span id="PresenceMatrix-207"><a href="#PresenceMatrix-207"><span class="linenos">207</span></a><span class="sd">        - matrix[i]           → row i</span>
</span><span id="PresenceMatrix-208"><a href="#PresenceMatrix-208"><span class="linenos">208</span></a><span class="sd">        - matrix[i:j]         → row slice (returns 2D array)</span>
</span><span id="PresenceMatrix-209"><a href="#PresenceMatrix-209"><span class="linenos">209</span></a><span class="sd">        - matrix[i, j]        → scalar</span>
</span><span id="PresenceMatrix-210"><a href="#PresenceMatrix-210"><span class="linenos">210</span></a><span class="sd">        - matrix[i, j:k]      → row[i], column slice</span>
</span><span id="PresenceMatrix-211"><a href="#PresenceMatrix-211"><span class="linenos">211</span></a><span class="sd">        - matrix[:, j]        → column j (all rows)</span>
</span><span id="PresenceMatrix-212"><a href="#PresenceMatrix-212"><span class="linenos">212</span></a><span class="sd">        - matrix[:, j:k]      → column block j:k (all rows)</span>
</span><span id="PresenceMatrix-213"><a href="#PresenceMatrix-213"><span class="linenos">213</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix-214"><a href="#PresenceMatrix-214"><span class="linenos">214</span></a>        <span class="c1"># matrix[i:j] → top-level row slicing</span>
</span><span id="PresenceMatrix-215"><a href="#PresenceMatrix-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="PresenceMatrix-216"><a href="#PresenceMatrix-216"><span class="linenos">216</span></a>            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-217"><a href="#PresenceMatrix-217"><span class="linenos">217</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PresenceMatrix does not support slicing with a step.&quot;</span><span class="p">)</span>
</span><span id="PresenceMatrix-218"><a href="#PresenceMatrix-218"><span class="linenos">218</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PresenceMatrix-219"><a href="#PresenceMatrix-219"><span class="linenos">219</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PresenceMatrix-220"><a href="#PresenceMatrix-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-221"><a href="#PresenceMatrix-221"><span class="linenos">221</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="PresenceMatrix-222"><a href="#PresenceMatrix-222"><span class="linenos">222</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)])</span>
</span><span id="PresenceMatrix-223"><a href="#PresenceMatrix-223"><span class="linenos">223</span></a>
</span><span id="PresenceMatrix-224"><a href="#PresenceMatrix-224"><span class="linenos">224</span></a>        <span class="c1"># matrix[i, j], matrix[i, j:k], matrix[:, j]</span>
</span><span id="PresenceMatrix-225"><a href="#PresenceMatrix-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="PresenceMatrix-226"><a href="#PresenceMatrix-226"><span class="linenos">226</span></a>            <span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">=</span> <span class="n">index</span>
</span><span id="PresenceMatrix-227"><a href="#PresenceMatrix-227"><span class="linenos">227</span></a>
</span><span id="PresenceMatrix-228"><a href="#PresenceMatrix-228"><span class="linenos">228</span></a>            <span class="c1"># matrix[:, j] or matrix[:, j:k]</span>
</span><span id="PresenceMatrix-229"><a href="#PresenceMatrix-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="PresenceMatrix-230"><a href="#PresenceMatrix-230"><span class="linenos">230</span></a>                <span class="k">if</span> <span class="n">row_idx</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-231"><a href="#PresenceMatrix-231"><span class="linenos">231</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PresenceMatrix does not support stepped row slicing.&quot;</span><span class="p">)</span>
</span><span id="PresenceMatrix-232"><a href="#PresenceMatrix-232"><span class="linenos">232</span></a>                <span class="n">row_start</span> <span class="o">=</span> <span class="n">row_idx</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">row_idx</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PresenceMatrix-233"><a href="#PresenceMatrix-233"><span class="linenos">233</span></a>                <span class="n">row_stop</span> <span class="o">=</span> <span class="n">row_idx</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">row_idx</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PresenceMatrix-234"><a href="#PresenceMatrix-234"><span class="linenos">234</span></a>
</span><span id="PresenceMatrix-235"><a href="#PresenceMatrix-235"><span class="linenos">235</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMatrix-236"><a href="#PresenceMatrix-236"><span class="linenos">236</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_stop</span><span class="p">)])</span>
</span><span id="PresenceMatrix-237"><a href="#PresenceMatrix-237"><span class="linenos">237</span></a>
</span><span id="PresenceMatrix-238"><a href="#PresenceMatrix-238"><span class="linenos">238</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="PresenceMatrix-239"><a href="#PresenceMatrix-239"><span class="linenos">239</span></a>                    <span class="k">if</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-240"><a href="#PresenceMatrix-240"><span class="linenos">240</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PresenceMatrix does not support stepped column slicing.&quot;</span><span class="p">)</span>
</span><span id="PresenceMatrix-241"><a href="#PresenceMatrix-241"><span class="linenos">241</span></a>                    <span class="n">col_start</span> <span class="o">=</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PresenceMatrix-242"><a href="#PresenceMatrix-242"><span class="linenos">242</span></a>                    <span class="n">col_stop</span> <span class="o">=</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PresenceMatrix-243"><a href="#PresenceMatrix-243"><span class="linenos">243</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col_start</span><span class="p">:</span><span class="n">col_stop</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_stop</span><span class="p">)])</span>
</span><span id="PresenceMatrix-244"><a href="#PresenceMatrix-244"><span class="linenos">244</span></a>
</span><span id="PresenceMatrix-245"><a href="#PresenceMatrix-245"><span class="linenos">245</span></a>            <span class="c1"># matrix[i, j] or matrix[i, j:k]</span>
</span><span id="PresenceMatrix-246"><a href="#PresenceMatrix-246"><span class="linenos">246</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMatrix-247"><a href="#PresenceMatrix-247"><span class="linenos">247</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMatrix-248"><a href="#PresenceMatrix-248"><span class="linenos">248</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
</span><span id="PresenceMatrix-249"><a href="#PresenceMatrix-249"><span class="linenos">249</span></a>                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_row_slice</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PresenceMatrix-250"><a href="#PresenceMatrix-250"><span class="linenos">250</span></a>
</span><span id="PresenceMatrix-251"><a href="#PresenceMatrix-251"><span class="linenos">251</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="PresenceMatrix-252"><a href="#PresenceMatrix-252"><span class="linenos">252</span></a>                    <span class="k">if</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix-253"><a href="#PresenceMatrix-253"><span class="linenos">253</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PresenceMatrix does not support stepped column slicing.&quot;</span><span class="p">)</span>
</span><span id="PresenceMatrix-254"><a href="#PresenceMatrix-254"><span class="linenos">254</span></a>                    <span class="n">start</span> <span class="o">=</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="PresenceMatrix-255"><a href="#PresenceMatrix-255"><span class="linenos">255</span></a>                    <span class="n">stop</span> <span class="o">=</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">col_idx</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="PresenceMatrix-256"><a href="#PresenceMatrix-256"><span class="linenos">256</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
</span><span id="PresenceMatrix-257"><a href="#PresenceMatrix-257"><span class="linenos">257</span></a>                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_row_slice</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
</span><span id="PresenceMatrix-258"><a href="#PresenceMatrix-258"><span class="linenos">258</span></a>
</span><span id="PresenceMatrix-259"><a href="#PresenceMatrix-259"><span class="linenos">259</span></a>        <span class="c1"># matrix[i] → single row</span>
</span><span id="PresenceMatrix-260"><a href="#PresenceMatrix-260"><span class="linenos">260</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="PresenceMatrix-261"><a href="#PresenceMatrix-261"><span class="linenos">261</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
</span><span id="PresenceMatrix-262"><a href="#PresenceMatrix-262"><span class="linenos">262</span></a>                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_row_slice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="PresenceMatrix-263"><a href="#PresenceMatrix-263"><span class="linenos">263</span></a>
</span><span id="PresenceMatrix-264"><a href="#PresenceMatrix-264"><span class="linenos">264</span></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid index for PresenceMatrix: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A scale-invariant, optionally lazy matrix representation of element presences over time.</p>

<p>Each row corresponds to a single <code><a href="#Presence">Presence</a></code>, and each column represents a discrete time bin defined by a <code><a href="#Timescale">Timescale</a></code>.
The matrix records the degree of presence of each element within a given boundary over time, where each value is a real number in [0.0, 1.0]:</p>

<ul>
<li>1.0 = full presence for the duration of the time bin</li>
<li>0.0 = no presence</li>
<li>values in between represent partial presence due to overlap</li>
</ul>

<p>The matrix can be computed eagerly via <code><a href="#PresenceMatrix.materialize">materialize()</a></code> or accessed lazily through NumPy-style slicing.</p>

<h3 id="structure">Structure</h3>

<ul>
<li><strong>Rows:</strong> Each row corresponds to one <code><a href="#Presence">Presence</a></code> instance.</li>
<li><strong>Columns:</strong> Each column represents a discrete bin of time defined by the <code><a href="#Timescale">Timescale</a></code> (from <code>t0</code> to <code>t1</code> using <code>bin_width</code>).</li>
<li>The matrix shape is therefore <code>(len(presences), timescale.num_bins)</code>.</li>
</ul>

<h3 id="usage">Usage</h3>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pcalc</span><span class="w"> </span><span class="kn">import</span> <span class="n">PresenceMatrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metamodel.timescale</span><span class="w"> </span><span class="kn">import</span> <span class="n">Timescale</span>

<span class="c1"># Define a time window with bin width of 1.0</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">Timescale</span><span class="p">(</span><span class="n">t0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Construct lazily</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">PresenceMatrix</span><span class="p">(</span><span class="n">presences</span><span class="p">,</span> <span class="n">time_scale</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>

<span class="c1"># Access entire row</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># row 0 as 1D array</span>

<span class="c1"># Access single value</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># presence at row 2, column 3</span>

<span class="c1"># Access slice of row</span>
<span class="n">window</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># row 1, columns 1–3</span>

<span class="c1"># Access slice of rows</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># rows 0 and 1</span>

<span class="c1"># Access single column</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># all rows at column 2</span>

<span class="c1"># Access column block</span>
<span class="n">col_block</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># all rows, columns 1–3</span>

<span class="c1"># Materialize full matrix (optional)</span>
<span class="n">dense</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</code></pre>
</div>

<h2 id="features">Features</h2>

<ul>
<li>Lazy evaluation by default; full matrix computed only if needed</li>
<li>NumPy-style indexing: supports full rows, row/column slicing, and scalar access</li>
<li>Precision-preserving: partial bin overlaps are retained in the matrix</li>
<li>Compatible with matrix operations and flow metric calculations</li>
<li>Backed by a sparse <code><a href="#PresenceMap">PresenceMap</a></code>, which stores slice indices and fractional overlaps</li>
</ul>

<h2 id="notes">Notes</h2>

<ul>
<li>Use <code><a href="#PresenceMatrix.materialize">materialize()</a></code> if you want to extract or operate on the full dense matrix</li>
<li>Use <code>matrix[i, j]</code>, <code>matrix[i, j:k]</code>, or <code>matrix[:, j]</code> for lightweight slicing without allocating the full matrix</li>
<li>Stepped slicing (e.g., <code>matrix[::2]</code>) is not currently supported</li>
</ul>
</div>


                            <div id="PresenceMatrix.__init__" class="classattr">
                                        <input id="PresenceMatrix.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PresenceMatrix</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">presences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#Presence">Presence</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">time_scale</span><span class="p">:</span> <span class="n"><a href="#Timescale">Timescale</a></span>,</span><span class="param">	<span class="n">materialize</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="PresenceMatrix.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix.__init__-86"><a href="#PresenceMatrix.__init__-86"><span class="linenos"> 86</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Presence</span><span class="p">],</span> <span class="n">time_scale</span><span class="p">:</span> <span class="n">Timescale</span><span class="p">,</span> <span class="n">materialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PresenceMatrix.__init__-87"><a href="#PresenceMatrix.__init__-87"><span class="linenos"> 87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.__init__-88"><a href="#PresenceMatrix.__init__-88"><span class="linenos"> 88</span></a><span class="sd">        Construct a presence matrix from a list of Presences and time window configuration.</span>
</span><span id="PresenceMatrix.__init__-89"><a href="#PresenceMatrix.__init__-89"><span class="linenos"> 89</span></a>
</span><span id="PresenceMatrix.__init__-90"><a href="#PresenceMatrix.__init__-90"><span class="linenos"> 90</span></a><span class="sd">        Args:</span>
</span><span id="PresenceMatrix.__init__-91"><a href="#PresenceMatrix.__init__-91"><span class="linenos"> 91</span></a><span class="sd">            presences: A list of `Presence` instances, one per element of interest.</span>
</span><span id="PresenceMatrix.__init__-92"><a href="#PresenceMatrix.__init__-92"><span class="linenos"> 92</span></a><span class="sd">            time_scale: The discrete `Timescale` that the matrix will be normalized to.</span>
</span><span id="PresenceMatrix.__init__-93"><a href="#PresenceMatrix.__init__-93"><span class="linenos"> 93</span></a><span class="sd">            materialize: If True, immediately constructs the full backing matrix.</span>
</span><span id="PresenceMatrix.__init__-94"><a href="#PresenceMatrix.__init__-94"><span class="linenos"> 94</span></a><span class="sd">                     Otherwise, matrix values will be computed on demand using the sparse presence map.</span>
</span><span id="PresenceMatrix.__init__-95"><a href="#PresenceMatrix.__init__-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.__init__-96"><a href="#PresenceMatrix.__init__-96"><span class="linenos"> 96</span></a>
</span><span id="PresenceMatrix.__init__-97"><a href="#PresenceMatrix.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PresenceMatrix.__init__-98"><a href="#PresenceMatrix.__init__-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.__init__-99"><a href="#PresenceMatrix.__init__-99"><span class="linenos"> 99</span></a><span class="sd">        A real valued matrix with shape (num_Presences, num_bins).</span>
</span><span id="PresenceMatrix.__init__-100"><a href="#PresenceMatrix.__init__-100"><span class="linenos">100</span></a><span class="sd">        When every presence.start and presence.end are whole numbers every value</span>
</span><span id="PresenceMatrix.__init__-101"><a href="#PresenceMatrix.__init__-101"><span class="linenos">101</span></a><span class="sd">        in the matrix is either 0.0 or 1.0. If they are not whole numbers, the presence</span>
</span><span id="PresenceMatrix.__init__-102"><a href="#PresenceMatrix.__init__-102"><span class="linenos">102</span></a><span class="sd">        is mapped to a number between 0.0 and 1.0 at the start and end (or both), with any</span>
</span><span id="PresenceMatrix.__init__-103"><a href="#PresenceMatrix.__init__-103"><span class="linenos">103</span></a><span class="sd">        intermediate value being 1.0. </span>
</span><span id="PresenceMatrix.__init__-104"><a href="#PresenceMatrix.__init__-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.__init__-105"><a href="#PresenceMatrix.__init__-105"><span class="linenos">105</span></a>
</span><span id="PresenceMatrix.__init__-106"><a href="#PresenceMatrix.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="n">time_scale</span>
</span><span id="PresenceMatrix.__init__-107"><a href="#PresenceMatrix.__init__-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.__init__-108"><a href="#PresenceMatrix.__init__-108"><span class="linenos">108</span></a><span class="sd">        The time scale of the presence matrix.</span>
</span><span id="PresenceMatrix.__init__-109"><a href="#PresenceMatrix.__init__-109"><span class="linenos">109</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.__init__-110"><a href="#PresenceMatrix.__init__-110"><span class="linenos">110</span></a>
</span><span id="PresenceMatrix.__init__-111"><a href="#PresenceMatrix.__init__-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PresenceMatrix.__init__-112"><a href="#PresenceMatrix.__init__-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PresenceMatrix.__init__-113"><a href="#PresenceMatrix.__init__-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_presence_map</span><span class="p">(</span><span class="n">presences</span><span class="p">)</span>
</span><span id="PresenceMatrix.__init__-114"><a href="#PresenceMatrix.__init__-114"><span class="linenos">114</span></a>
</span><span id="PresenceMatrix.__init__-115"><a href="#PresenceMatrix.__init__-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="n">materialize</span><span class="p">:</span>
</span><span id="PresenceMatrix.__init__-116"><a href="#PresenceMatrix.__init__-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Construct a presence matrix from a list of Presences and time window configuration.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>presences:</strong>  A list of <code><a href="#Presence">Presence</a></code> instances, one per element of interest.</li>
<li><strong>time_scale:</strong>  The discrete <code><a href="#Timescale">Timescale</a></code> that the matrix will be normalized to.</li>
<li><strong>materialize:</strong>  If True, immediately constructs the full backing matrix.
Otherwise, matrix values will be computed on demand using the sparse presence map.</li>
</ul>
</div>


                            </div>
                            <div id="PresenceMatrix.presence_matrix" class="classattr">
                                <div class="attr variable">
            <span class="name">presence_matrix</span><span class="annotation">: Optional[numpy.ndarray[Any, numpy.dtype[numpy.float64]]]</span>

        
    </div>
    <a class="headerlink" href="#PresenceMatrix.presence_matrix"></a>
    
            <div class="docstring"><p>A real valued matrix with shape (num_Presences, num_bins).
When every presence.start and presence.end are whole numbers every value
in the matrix is either 0.0 or 1.0. If they are not whole numbers, the presence
is mapped to a number between 0.0 and 1.0 at the start and end (or both), with any
intermediate value being 1.0.</p>
</div>


                            </div>
                            <div id="PresenceMatrix.time_scale" class="classattr">
                                <div class="attr variable">
            <span class="name">time_scale</span>

        
    </div>
    <a class="headerlink" href="#PresenceMatrix.time_scale"></a>
    
            <div class="docstring"><p>The time scale of the presence matrix.</p>
</div>


                            </div>
                            <div id="PresenceMatrix.presence_map" class="classattr">
                                <div class="attr variable">
            <span class="name">presence_map</span><span class="annotation">: List[<a href="#PresenceMap">PresenceMap</a>]</span>

        
    </div>
    <a class="headerlink" href="#PresenceMatrix.presence_map"></a>
    
    

                            </div>
                            <div id="PresenceMatrix.shape" class="classattr">
                                <div class="attr variable">
            <span class="name">shape</span>

        
    </div>
    <a class="headerlink" href="#PresenceMatrix.shape"></a>
    
    

                            </div>
                            <div id="PresenceMatrix.init_presence_map" class="classattr">
                                        <input id="PresenceMatrix.init_presence_map-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_presence_map</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">presences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#Presence">Presence</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="PresenceMatrix.init_presence_map-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix.init_presence_map"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix.init_presence_map-118"><a href="#PresenceMatrix.init_presence_map-118"><span class="linenos">118</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_presence_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Presence</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix.init_presence_map-119"><a href="#PresenceMatrix.init_presence_map-119"><span class="linenos">119</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.init_presence_map-120"><a href="#PresenceMatrix.init_presence_map-120"><span class="linenos">120</span></a><span class="sd">        Initialize the internal presence matrix based on the Presence intervals and binning scheme.</span>
</span><span id="PresenceMatrix.init_presence_map-121"><a href="#PresenceMatrix.init_presence_map-121"><span class="linenos">121</span></a><span class="sd">        Only presences that overlap the timescale endpoints [t0, t1) are mapped.</span>
</span><span id="PresenceMatrix.init_presence_map-122"><a href="#PresenceMatrix.init_presence_map-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.init_presence_map-123"><a href="#PresenceMatrix.init_presence_map-123"><span class="linenos">123</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_scale</span>  <span class="c1"># Timescale object: includes t0, t1, bin_width</span>
</span><span id="PresenceMatrix.init_presence_map-124"><a href="#PresenceMatrix.init_presence_map-124"><span class="linenos">124</span></a>
</span><span id="PresenceMatrix.init_presence_map-125"><a href="#PresenceMatrix.init_presence_map-125"><span class="linenos">125</span></a>        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">presence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">presences</span><span class="p">):</span>
</span><span id="PresenceMatrix.init_presence_map-126"><a href="#PresenceMatrix.init_presence_map-126"><span class="linenos">126</span></a>            <span class="n">presence_map</span> <span class="o">=</span> <span class="n">PresenceMap</span><span class="p">(</span><span class="n">presence</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
</span><span id="PresenceMatrix.init_presence_map-127"><a href="#PresenceMatrix.init_presence_map-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="n">presence_map</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="PresenceMatrix.init_presence_map-128"><a href="#PresenceMatrix.init_presence_map-128"><span class="linenos">128</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">presence_map</span><span class="p">)</span>
</span><span id="PresenceMatrix.init_presence_map-129"><a href="#PresenceMatrix.init_presence_map-129"><span class="linenos">129</span></a>
</span><span id="PresenceMatrix.init_presence_map-130"><a href="#PresenceMatrix.init_presence_map-130"><span class="linenos">130</span></a>        <span class="n">num_bins</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">num_bins</span>
</span><span id="PresenceMatrix.init_presence_map-131"><a href="#PresenceMatrix.init_presence_map-131"><span class="linenos">131</span></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">)</span>
</span><span id="PresenceMatrix.init_presence_map-132"><a href="#PresenceMatrix.init_presence_map-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the internal presence matrix based on the Presence intervals and binning scheme.
Only presences that overlap the timescale endpoints [t0, t1) are mapped.</p>
</div>


                            </div>
                            <div id="PresenceMatrix.is_materialized" class="classattr">
                                        <input id="PresenceMatrix.is_materialized-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_materialized</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="PresenceMatrix.is_materialized-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix.is_materialized"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix.is_materialized-134"><a href="#PresenceMatrix.is_materialized-134"><span class="linenos">134</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_materialized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="PresenceMatrix.is_materialized-135"><a href="#PresenceMatrix.is_materialized-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the backing matrix has been materialized.&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.is_materialized-136"><a href="#PresenceMatrix.is_materialized-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Return True if the backing matrix has been materialized.</p>
</div>


                            </div>
                            <div id="PresenceMatrix.materialize" class="classattr">
                                        <input id="PresenceMatrix.materialize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">materialize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="PresenceMatrix.materialize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix.materialize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix.materialize-138"><a href="#PresenceMatrix.materialize-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">materialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
</span><span id="PresenceMatrix.materialize-139"><a href="#PresenceMatrix.materialize-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.materialize-140"><a href="#PresenceMatrix.materialize-140"><span class="linenos">140</span></a><span class="sd">        Materialize and return the full presence matrix from presence maps.</span>
</span><span id="PresenceMatrix.materialize-141"><a href="#PresenceMatrix.materialize-141"><span class="linenos">141</span></a><span class="sd">        If already materialized, this is a no-op and returns the cached matrix.</span>
</span><span id="PresenceMatrix.materialize-142"><a href="#PresenceMatrix.materialize-142"><span class="linenos">142</span></a>
</span><span id="PresenceMatrix.materialize-143"><a href="#PresenceMatrix.materialize-143"><span class="linenos">143</span></a><span class="sd">        Use this only if want the full matrix to operate on. For most cases, you should</span>
</span><span id="PresenceMatrix.materialize-144"><a href="#PresenceMatrix.materialize-144"><span class="linenos">144</span></a><span class="sd">        be able to work with the sparse representation with the presence map and using</span>
</span><span id="PresenceMatrix.materialize-145"><a href="#PresenceMatrix.materialize-145"><span class="linenos">145</span></a><span class="sd">        array slicing on the matrix object. So think twice about why you are materializing</span>
</span><span id="PresenceMatrix.materialize-146"><a href="#PresenceMatrix.materialize-146"><span class="linenos">146</span></a><span class="sd">        a matrix.</span>
</span><span id="PresenceMatrix.materialize-147"><a href="#PresenceMatrix.materialize-147"><span class="linenos">147</span></a>
</span><span id="PresenceMatrix.materialize-148"><a href="#PresenceMatrix.materialize-148"><span class="linenos">148</span></a><span class="sd">        Returns:</span>
</span><span id="PresenceMatrix.materialize-149"><a href="#PresenceMatrix.materialize-149"><span class="linenos">149</span></a><span class="sd">            The dense presence matrix of shape (num_presences, num_bins).</span>
</span><span id="PresenceMatrix.materialize-150"><a href="#PresenceMatrix.materialize-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.materialize-151"><a href="#PresenceMatrix.materialize-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_materialized</span><span class="p">():</span>
</span><span id="PresenceMatrix.materialize-152"><a href="#PresenceMatrix.materialize-152"><span class="linenos">152</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span>
</span><span id="PresenceMatrix.materialize-153"><a href="#PresenceMatrix.materialize-153"><span class="linenos">153</span></a>
</span><span id="PresenceMatrix.materialize-154"><a href="#PresenceMatrix.materialize-154"><span class="linenos">154</span></a>        <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PresenceMatrix.materialize-155"><a href="#PresenceMatrix.materialize-155"><span class="linenos">155</span></a>        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="PresenceMatrix.materialize-156"><a href="#PresenceMatrix.materialize-156"><span class="linenos">156</span></a>
</span><span id="PresenceMatrix.materialize-157"><a href="#PresenceMatrix.materialize-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">pm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">):</span>
</span><span id="PresenceMatrix.materialize-158"><a href="#PresenceMatrix.materialize-158"><span class="linenos">158</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="PresenceMatrix.materialize-159"><a href="#PresenceMatrix.materialize-159"><span class="linenos">159</span></a>                <span class="k">continue</span>
</span><span id="PresenceMatrix.materialize-160"><a href="#PresenceMatrix.materialize-160"><span class="linenos">160</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_bin</span>
</span><span id="PresenceMatrix.materialize-161"><a href="#PresenceMatrix.materialize-161"><span class="linenos">161</span></a>            <span class="n">end</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_bin</span>
</span><span id="PresenceMatrix.materialize-162"><a href="#PresenceMatrix.materialize-162"><span class="linenos">162</span></a>            <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">start_value</span>
</span><span id="PresenceMatrix.materialize-163"><a href="#PresenceMatrix.materialize-163"><span class="linenos">163</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
</span><span id="PresenceMatrix.materialize-164"><a href="#PresenceMatrix.materialize-164"><span class="linenos">164</span></a>                <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">end_value</span>
</span><span id="PresenceMatrix.materialize-165"><a href="#PresenceMatrix.materialize-165"><span class="linenos">165</span></a>            <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="PresenceMatrix.materialize-166"><a href="#PresenceMatrix.materialize-166"><span class="linenos">166</span></a>                <span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="PresenceMatrix.materialize-167"><a href="#PresenceMatrix.materialize-167"><span class="linenos">167</span></a>
</span><span id="PresenceMatrix.materialize-168"><a href="#PresenceMatrix.materialize-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="PresenceMatrix.materialize-169"><a href="#PresenceMatrix.materialize-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span>
</span></pre></div>


            <div class="docstring"><p>Materialize and return the full presence matrix from presence maps.
If already materialized, this is a no-op and returns the cached matrix.</p>

<p>Use this only if want the full matrix to operate on. For most cases, you should
be able to work with the sparse representation with the presence map and using
array slicing on the matrix object. So think twice about why you are materializing
a matrix.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The dense presence matrix of shape (num_presences, num_bins).</p>
</blockquote>
</div>


                            </div>
                            <div id="PresenceMatrix.drop_materialization" class="classattr">
                                        <input id="PresenceMatrix.drop_materialization-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">drop_materialization</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="PresenceMatrix.drop_materialization-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix.drop_materialization"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix.drop_materialization-171"><a href="#PresenceMatrix.drop_materialization-171"><span class="linenos">171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">drop_materialization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PresenceMatrix.drop_materialization-172"><a href="#PresenceMatrix.drop_materialization-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Discard the cached matrix, returning to sparse-only mode.&quot;&quot;&quot;</span>
</span><span id="PresenceMatrix.drop_materialization-173"><a href="#PresenceMatrix.drop_materialization-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Discard the cached matrix, returning to sparse-only mode.</p>
</div>


                            </div>
                            <div id="PresenceMatrix.presences" class="classattr">
                                        <input id="PresenceMatrix.presences-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">presences</span><span class="annotation">: List[<a href="#Presence">Presence</a>]</span>

                <label class="view-source-button" for="PresenceMatrix.presences-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceMatrix.presences"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceMatrix.presences-200"><a href="#PresenceMatrix.presences-200"><span class="linenos">200</span></a>    <span class="nd">@property</span>
</span><span id="PresenceMatrix.presences-201"><a href="#PresenceMatrix.presences-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">presences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Presence</span><span class="p">]:</span>
</span><span id="PresenceMatrix.presences-202"><a href="#PresenceMatrix.presences-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="PresenceInvariant">
                            <input id="PresenceInvariant-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PresenceInvariant</span>:

                <label class="view-source-button" for="PresenceInvariant-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant-15"><a href="#PresenceInvariant-15"><span class="linenos"> 15</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PresenceInvariant</span><span class="p">:</span>
</span><span id="PresenceInvariant-16"><a href="#PresenceInvariant-16"><span class="linenos"> 16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-17"><a href="#PresenceInvariant-17"><span class="linenos"> 17</span></a><span class="sd">    **A finite, scale-invariant, non-equilibrium version of Little&#39;s Law.**</span>
</span><span id="PresenceInvariant-18"><a href="#PresenceInvariant-18"><span class="linenos"> 18</span></a>
</span><span id="PresenceInvariant-19"><a href="#PresenceInvariant-19"><span class="linenos"> 19</span></a><span class="sd">    This class computes the components of The Presence Invariant of a presence matrix.</span>
</span><span id="PresenceInvariant-20"><a href="#PresenceInvariant-20"><span class="linenos"> 20</span></a>
</span><span id="PresenceInvariant-21"><a href="#PresenceInvariant-21"><span class="linenos"> 21</span></a><span class="sd">    The Presence Invariant states that for any *finite* interval `[start_time, end_time)` over the timescale `[t0, t1)`</span>
</span><span id="PresenceInvariant-22"><a href="#PresenceInvariant-22"><span class="linenos"> 22</span></a><span class="sd">    of a presence matrix, the following invariant condition holds.</span>
</span><span id="PresenceInvariant-23"><a href="#PresenceInvariant-23"><span class="linenos"> 23</span></a>
</span><span id="PresenceInvariant-24"><a href="#PresenceInvariant-24"><span class="linenos"> 24</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-25"><a href="#PresenceInvariant-25"><span class="linenos"> 25</span></a><span class="sd">        L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-26"><a href="#PresenceInvariant-26"><span class="linenos"> 26</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-27"><a href="#PresenceInvariant-27"><span class="linenos"> 27</span></a><span class="sd">    where</span>
</span><span id="PresenceInvariant-28"><a href="#PresenceInvariant-28"><span class="linenos"> 28</span></a>
</span><span id="PresenceInvariant-29"><a href="#PresenceInvariant-29"><span class="linenos"> 29</span></a><span class="sd">    - **$L$**: the average *presence* per unit time in the interval (see `avg_presence_per_unit_time`).</span>
</span><span id="PresenceInvariant-30"><a href="#PresenceInvariant-30"><span class="linenos"> 30</span></a><span class="sd">    - **$\Lambda$**: The *flow rate* - a finite approximation of *presence arrival/departure rate* (see `flow_rate`).</span>
</span><span id="PresenceInvariant-31"><a href="#PresenceInvariant-31"><span class="linenos"> 31</span></a><span class="sd">    - **$w$**: The *residence time* - a finite approximation of *presence duration* (see `metamodel.presence.Presence.duration`).</span>
</span><span id="PresenceInvariant-32"><a href="#PresenceInvariant-32"><span class="linenos"> 32</span></a>
</span><span id="PresenceInvariant-33"><a href="#PresenceInvariant-33"><span class="linenos"> 33</span></a><span class="sd">    This invariant extends the classical formulation of Little’s Law, an equilibrium-based identity, by establishing a</span>
</span><span id="PresenceInvariant-34"><a href="#PresenceInvariant-34"><span class="linenos"> 34</span></a><span class="sd">    conservation law (of presence) that remains valid across arbitrary timescales, and in non-linear, stochastic processes</span>
</span><span id="PresenceInvariant-35"><a href="#PresenceInvariant-35"><span class="linenos"> 35</span></a><span class="sd">    that operate far from equilibrium.</span>
</span><span id="PresenceInvariant-36"><a href="#PresenceInvariant-36"><span class="linenos"> 36</span></a>
</span><span id="PresenceInvariant-37"><a href="#PresenceInvariant-37"><span class="linenos"> 37</span></a><span class="sd">    It holds unconditionally for any presence matrix and finite window, and serves as a foundational</span>
</span><span id="PresenceInvariant-38"><a href="#PresenceInvariant-38"><span class="linenos"> 38</span></a><span class="sd">    construct for reasoning about flow in non-linear systems.</span>
</span><span id="PresenceInvariant-39"><a href="#PresenceInvariant-39"><span class="linenos"> 39</span></a>
</span><span id="PresenceInvariant-40"><a href="#PresenceInvariant-40"><span class="linenos"> 40</span></a><span class="sd">    The proof of this invariant is surprisingly simple and elementary.</span>
</span><span id="PresenceInvariant-41"><a href="#PresenceInvariant-41"><span class="linenos"> 41</span></a>
</span><span id="PresenceInvariant-42"><a href="#PresenceInvariant-42"><span class="linenos"> 42</span></a><span class="sd">    **Derivation:**</span>
</span><span id="PresenceInvariant-43"><a href="#PresenceInvariant-43"><span class="linenos"> 43</span></a>
</span><span id="PresenceInvariant-44"><a href="#PresenceInvariant-44"><span class="linenos"> 44</span></a>
</span><span id="PresenceInvariant-45"><a href="#PresenceInvariant-45"><span class="linenos"> 45</span></a>
</span><span id="PresenceInvariant-46"><a href="#PresenceInvariant-46"><span class="linenos"> 46</span></a><span class="sd">    Let $A$ be the total presence in the matrix over a finite time window `[start_time, end_time)` of $T$ time units.</span>
</span><span id="PresenceInvariant-47"><a href="#PresenceInvariant-47"><span class="linenos"> 47</span></a><span class="sd">    Let $N$ be the number of distinct presences that overlap the window.</span>
</span><span id="PresenceInvariant-48"><a href="#PresenceInvariant-48"><span class="linenos"> 48</span></a>
</span><span id="PresenceInvariant-49"><a href="#PresenceInvariant-49"><span class="linenos"> 49</span></a><span class="sd">    Let $R(p_i)$ be the portion of the duration of $p_i$ that overlaps the window. This is the *residence time* of $p_i$ in the window.</span>
</span><span id="PresenceInvariant-50"><a href="#PresenceInvariant-50"><span class="linenos"> 50</span></a>
</span><span id="PresenceInvariant-51"><a href="#PresenceInvariant-51"><span class="linenos"> 51</span></a><span class="sd">    The following diagram shows these quantities and the derivation.</span>
</span><span id="PresenceInvariant-52"><a href="#PresenceInvariant-52"><span class="linenos"> 52</span></a>
</span><span id="PresenceInvariant-53"><a href="#PresenceInvariant-53"><span class="linenos"> 53</span></a><span class="sd">    ![Presence Invariant](../assets/pcalc/presence_invariant.png)</span>
</span><span id="PresenceInvariant-54"><a href="#PresenceInvariant-54"><span class="linenos"> 54</span></a>
</span><span id="PresenceInvariant-55"><a href="#PresenceInvariant-55"><span class="linenos"> 55</span></a><span class="sd">    Then:</span>
</span><span id="PresenceInvariant-56"><a href="#PresenceInvariant-56"><span class="linenos"> 56</span></a>
</span><span id="PresenceInvariant-57"><a href="#PresenceInvariant-57"><span class="linenos"> 57</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-58"><a href="#PresenceInvariant-58"><span class="linenos"> 58</span></a><span class="sd">    A = \sum_{i=1}^{N} R(p_i)</span>
</span><span id="PresenceInvariant-59"><a href="#PresenceInvariant-59"><span class="linenos"> 59</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-60"><a href="#PresenceInvariant-60"><span class="linenos"> 60</span></a><span class="sd">    represents the sum of the elements in the presence matrix that foll in the time window `[start_time, end_time)`.</span>
</span><span id="PresenceInvariant-61"><a href="#PresenceInvariant-61"><span class="linenos"> 61</span></a>
</span><span id="PresenceInvariant-62"><a href="#PresenceInvariant-62"><span class="linenos"> 62</span></a><span class="sd">    $A = 12$ presence-time-units in our example.</span>
</span><span id="PresenceInvariant-63"><a href="#PresenceInvariant-63"><span class="linenos"> 63</span></a>
</span><span id="PresenceInvariant-64"><a href="#PresenceInvariant-64"><span class="linenos"> 64</span></a><span class="sd">    Average presence per unit time (see `avg_presence_per_unit_time`) is then:</span>
</span><span id="PresenceInvariant-65"><a href="#PresenceInvariant-65"><span class="linenos"> 65</span></a>
</span><span id="PresenceInvariant-66"><a href="#PresenceInvariant-66"><span class="linenos"> 66</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-67"><a href="#PresenceInvariant-67"><span class="linenos"> 67</span></a><span class="sd">    L = A/T</span>
</span><span id="PresenceInvariant-68"><a href="#PresenceInvariant-68"><span class="linenos"> 68</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-69"><a href="#PresenceInvariant-69"><span class="linenos"> 69</span></a>
</span><span id="PresenceInvariant-70"><a href="#PresenceInvariant-70"><span class="linenos"> 70</span></a><span class="sd">    $L = 3$ presences/time-unit in our example.</span>
</span><span id="PresenceInvariant-71"><a href="#PresenceInvariant-71"><span class="linenos"> 71</span></a>
</span><span id="PresenceInvariant-72"><a href="#PresenceInvariant-72"><span class="linenos"> 72</span></a><span class="sd">    $w = $ Average residence time (see `avg_residence_time`) is then:</span>
</span><span id="PresenceInvariant-73"><a href="#PresenceInvariant-73"><span class="linenos"> 73</span></a>
</span><span id="PresenceInvariant-74"><a href="#PresenceInvariant-74"><span class="linenos"> 74</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-75"><a href="#PresenceInvariant-75"><span class="linenos"> 75</span></a><span class="sd">    w = A/N</span>
</span><span id="PresenceInvariant-76"><a href="#PresenceInvariant-76"><span class="linenos"> 76</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-77"><a href="#PresenceInvariant-77"><span class="linenos"> 77</span></a>
</span><span id="PresenceInvariant-78"><a href="#PresenceInvariant-78"><span class="linenos"> 78</span></a><span class="sd">    $w=3 time units per presence in our example.</span>
</span><span id="PresenceInvariant-79"><a href="#PresenceInvariant-79"><span class="linenos"> 79</span></a>
</span><span id="PresenceInvariant-80"><a href="#PresenceInvariant-80"><span class="linenos"> 80</span></a><span class="sd">    We will define the flow rate as (see `flow_rate`):</span>
</span><span id="PresenceInvariant-81"><a href="#PresenceInvariant-81"><span class="linenos"> 81</span></a>
</span><span id="PresenceInvariant-82"><a href="#PresenceInvariant-82"><span class="linenos"> 82</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-83"><a href="#PresenceInvariant-83"><span class="linenos"> 83</span></a><span class="sd">    \Lambda = N/T</span>
</span><span id="PresenceInvariant-84"><a href="#PresenceInvariant-84"><span class="linenos"> 84</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-85"><a href="#PresenceInvariant-85"><span class="linenos"> 85</span></a>
</span><span id="PresenceInvariant-86"><a href="#PresenceInvariant-86"><span class="linenos"> 86</span></a><span class="sd">    $\Lambda = 1$ presence per time unit in our example.</span>
</span><span id="PresenceInvariant-87"><a href="#PresenceInvariant-87"><span class="linenos"> 87</span></a>
</span><span id="PresenceInvariant-88"><a href="#PresenceInvariant-88"><span class="linenos"> 88</span></a><span class="sd">    Combining these:</span>
</span><span id="PresenceInvariant-89"><a href="#PresenceInvariant-89"><span class="linenos"> 89</span></a>
</span><span id="PresenceInvariant-90"><a href="#PresenceInvariant-90"><span class="linenos"> 90</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-91"><a href="#PresenceInvariant-91"><span class="linenos"> 91</span></a><span class="sd">    L = A/T = A/N \cdot N/T = N/T \cdot A/N = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-92"><a href="#PresenceInvariant-92"><span class="linenos"> 92</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-93"><a href="#PresenceInvariant-93"><span class="linenos"> 93</span></a>
</span><span id="PresenceInvariant-94"><a href="#PresenceInvariant-94"><span class="linenos"> 94</span></a><span class="sd">    So we get</span>
</span><span id="PresenceInvariant-95"><a href="#PresenceInvariant-95"><span class="linenos"> 95</span></a>
</span><span id="PresenceInvariant-96"><a href="#PresenceInvariant-96"><span class="linenos"> 96</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-97"><a href="#PresenceInvariant-97"><span class="linenos"> 97</span></a><span class="sd">    L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-98"><a href="#PresenceInvariant-98"><span class="linenos"> 98</span></a><span class="sd">    $$</span>
</span><span id="PresenceInvariant-99"><a href="#PresenceInvariant-99"><span class="linenos"> 99</span></a>
</span><span id="PresenceInvariant-100"><a href="#PresenceInvariant-100"><span class="linenos">100</span></a>
</span><span id="PresenceInvariant-101"><a href="#PresenceInvariant-101"><span class="linenos">101</span></a><span class="sd">    This identity—what we call the *Presence Invariant*—is equivalent to a fundamental construct used in</span>
</span><span id="PresenceInvariant-102"><a href="#PresenceInvariant-102"><span class="linenos">102</span></a><span class="sd">    all proofs of Little’s Law [1], and in particular, to one used by Stidham [2] to give a deterministic</span>
</span><span id="PresenceInvariant-103"><a href="#PresenceInvariant-103"><span class="linenos">103</span></a><span class="sd">    proof of Little&#39;s Law [3] (see `flow_rate`).</span>
</span><span id="PresenceInvariant-104"><a href="#PresenceInvariant-104"><span class="linenos">104</span></a>
</span><span id="PresenceInvariant-105"><a href="#PresenceInvariant-105"><span class="linenos">105</span></a><span class="sd">    Both the classical and the current presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant-106"><a href="#PresenceInvariant-106"><span class="linenos">106</span></a><span class="sd">    (as described by Miyazawa [3]).</span>
</span><span id="PresenceInvariant-107"><a href="#PresenceInvariant-107"><span class="linenos">107</span></a>
</span><span id="PresenceInvariant-108"><a href="#PresenceInvariant-108"><span class="linenos">108</span></a><span class="sd">    However, the conserved quantities differ &lt;sup&gt;[1](#fn1)&lt;/sup&gt;:</span>
</span><span id="PresenceInvariant-109"><a href="#PresenceInvariant-109"><span class="linenos">109</span></a>
</span><span id="PresenceInvariant-110"><a href="#PresenceInvariant-110"><span class="linenos">110</span></a><span class="sd">    - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using long run arrival/departure rate $\lambda$ and</span>
</span><span id="PresenceInvariant-111"><a href="#PresenceInvariant-111"><span class="linenos">111</span></a><span class="sd">    average presence duration $W$.</span>
</span><span id="PresenceInvariant-112"><a href="#PresenceInvariant-112"><span class="linenos">112</span></a><span class="sd">    - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite window</span>
</span><span id="PresenceInvariant-113"><a href="#PresenceInvariant-113"><span class="linenos">113</span></a><span class="sd">    *approximations* of true arrival/departure rate and  presence duration.</span>
</span><span id="PresenceInvariant-114"><a href="#PresenceInvariant-114"><span class="linenos">114</span></a>
</span><span id="PresenceInvariant-115"><a href="#PresenceInvariant-115"><span class="linenos">115</span></a><span class="sd">    Stidham [2] proved the relationship between the quantities in the two versions and showed that</span>
</span><span id="PresenceInvariant-116"><a href="#PresenceInvariant-116"><span class="linenos">116</span></a><span class="sd">    the classical form of Little’s Law emerges as a limiting case of the finite-window identity</span>
</span><span id="PresenceInvariant-117"><a href="#PresenceInvariant-117"><span class="linenos">117</span></a><span class="sd">    *provided* the system approaches equilibrium as the window grows larger - ie the system is *convergent* in the long run.</span>
</span><span id="PresenceInvariant-118"><a href="#PresenceInvariant-118"><span class="linenos">118</span></a>
</span><span id="PresenceInvariant-119"><a href="#PresenceInvariant-119"><span class="linenos">119</span></a><span class="sd">    If the system is *divergent* in the long run, at least one of the three quantities grows without limit and</span>
</span><span id="PresenceInvariant-120"><a href="#PresenceInvariant-120"><span class="linenos">120</span></a><span class="sd">    the conservation law in the classical version does not hold.</span>
</span><span id="PresenceInvariant-121"><a href="#PresenceInvariant-121"><span class="linenos">121</span></a>
</span><span id="PresenceInvariant-122"><a href="#PresenceInvariant-122"><span class="linenos">122</span></a><span class="sd">    However, the presence invariant continues to hold regardless of whether the system is convergent or divergent.</span>
</span><span id="PresenceInvariant-123"><a href="#PresenceInvariant-123"><span class="linenos">123</span></a><span class="sd">    More details can be found under `flow_rate` and `avg_residence_time`.</span>
</span><span id="PresenceInvariant-124"><a href="#PresenceInvariant-124"><span class="linenos">124</span></a>
</span><span id="PresenceInvariant-125"><a href="#PresenceInvariant-125"><span class="linenos">125</span></a><span class="sd">    Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant-126"><a href="#PresenceInvariant-126"><span class="linenos">126</span></a><span class="sd">    and widely applicable conservation construct for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant-127"><a href="#PresenceInvariant-127"><span class="linenos">127</span></a>
</span><span id="PresenceInvariant-128"><a href="#PresenceInvariant-128"><span class="linenos">128</span></a><span class="sd">    &lt;small&gt;</span>
</span><span id="PresenceInvariant-129"><a href="#PresenceInvariant-129"><span class="linenos">129</span></a><span class="sd">        &lt;a name=&quot;fn1&quot;&gt;&lt;strong&gt;[1]&lt;/strong&gt;&lt;/a&gt;</span>
</span><span id="PresenceInvariant-130"><a href="#PresenceInvariant-130"><span class="linenos">130</span></a><span class="sd">        Note that we have lowercase $\lambda$ and uppercase $W$ in the classical law, and uppercase $\Lambda$ and</span>
</span><span id="PresenceInvariant-131"><a href="#PresenceInvariant-131"><span class="linenos">131</span></a><span class="sd">        lowercase $w$ in the finite-window version, whereas $L$ remains the same in both.</span>
</span><span id="PresenceInvariant-132"><a href="#PresenceInvariant-132"><span class="linenos">132</span></a>
</span><span id="PresenceInvariant-133"><a href="#PresenceInvariant-133"><span class="linenos">133</span></a><span class="sd">        This reflects the fact that in the Presence Invariant, $\Lambda$ is an overestimate of $\lambda$, and $w$</span>
</span><span id="PresenceInvariant-134"><a href="#PresenceInvariant-134"><span class="linenos">134</span></a><span class="sd">        is an underestimate of $W$. Both identities refer to the *same* observable construct for $L$.</span>
</span><span id="PresenceInvariant-135"><a href="#PresenceInvariant-135"><span class="linenos">135</span></a><span class="sd">    &lt;/small&gt;</span>
</span><span id="PresenceInvariant-136"><a href="#PresenceInvariant-136"><span class="linenos">136</span></a>
</span><span id="PresenceInvariant-137"><a href="#PresenceInvariant-137"><span class="linenos">137</span></a><span class="sd">    ## References</span>
</span><span id="PresenceInvariant-138"><a href="#PresenceInvariant-138"><span class="linenos">138</span></a>
</span><span id="PresenceInvariant-139"><a href="#PresenceInvariant-139"><span class="linenos">139</span></a><span class="sd">    1. **Little’s Law**</span>
</span><span id="PresenceInvariant-140"><a href="#PresenceInvariant-140"><span class="linenos">140</span></a><span class="sd">       Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant-141"><a href="#PresenceInvariant-141"><span class="linenos">141</span></a><span class="sd">       [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant-142"><a href="#PresenceInvariant-142"><span class="linenos">142</span></a>
</span><span id="PresenceInvariant-143"><a href="#PresenceInvariant-143"><span class="linenos">143</span></a><span class="sd">    2. **Stidham&#39;s Proof of Little&#39;s Law**</span>
</span><span id="PresenceInvariant-144"><a href="#PresenceInvariant-144"><span class="linenos">144</span></a><span class="sd">        Stidham, Shaler. Jr, *A last word on $L = \lambda \cdot W$*.Cornell University. </span>
</span><span id="PresenceInvariant-145"><a href="#PresenceInvariant-145"><span class="linenos">145</span></a><span class="sd">        [https://pubsonline.informs.org/doi/epdf/10.1287/opre.22.2.417]</span>
</span><span id="PresenceInvariant-146"><a href="#PresenceInvariant-146"><span class="linenos">146</span></a>
</span><span id="PresenceInvariant-147"><a href="#PresenceInvariant-147"><span class="linenos">147</span></a><span class="sd">    3. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant-148"><a href="#PresenceInvariant-148"><span class="linenos">148</span></a><span class="sd">       Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant-149"><a href="#PresenceInvariant-149"><span class="linenos">149</span></a><span class="sd">       [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant-150"><a href="#PresenceInvariant-150"><span class="linenos">150</span></a>
</span><span id="PresenceInvariant-151"><a href="#PresenceInvariant-151"><span class="linenos">151</span></a>
</span><span id="PresenceInvariant-152"><a href="#PresenceInvariant-152"><span class="linenos">152</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-153"><a href="#PresenceInvariant-153"><span class="linenos">153</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">PresenceMatrix</span><span class="p">):</span>
</span><span id="PresenceInvariant-154"><a href="#PresenceInvariant-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="PresenceInvariant-155"><a href="#PresenceInvariant-155"><span class="linenos">155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-156"><a href="#PresenceInvariant-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presences</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presences</span>
</span><span id="PresenceInvariant-157"><a href="#PresenceInvariant-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant-158"><a href="#PresenceInvariant-158"><span class="linenos">158</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-159"><a href="#PresenceInvariant-159"><span class="linenos">159</span></a>
</span><span id="PresenceInvariant-160"><a href="#PresenceInvariant-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-161"><a href="#PresenceInvariant-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant-162"><a href="#PresenceInvariant-162"><span class="linenos">162</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-163"><a href="#PresenceInvariant-163"><span class="linenos">163</span></a>
</span><span id="PresenceInvariant-164"><a href="#PresenceInvariant-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceInvariant-165"><a href="#PresenceInvariant-165"><span class="linenos">165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The timescale of the presence matrix. This is the default &#39;window&#39; over which all metrics are computed.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-166"><a href="#PresenceInvariant-166"><span class="linenos">166</span></a>
</span><span id="PresenceInvariant-167"><a href="#PresenceInvariant-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">end_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant-168"><a href="#PresenceInvariant-168"><span class="linenos">168</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span> <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span>
</span><span id="PresenceInvariant-169"><a href="#PresenceInvariant-169"><span class="linenos">169</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="n">end_time</span> <span class="k">if</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span>
</span><span id="PresenceInvariant-170"><a href="#PresenceInvariant-170"><span class="linenos">170</span></a>        <span class="k">if</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span> <span class="ow">or</span> <span class="n">end_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">:</span>
</span><span id="PresenceInvariant-171"><a href="#PresenceInvariant-171"><span class="linenos">171</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PresenceInvariant-172"><a href="#PresenceInvariant-172"><span class="linenos">172</span></a>                <span class="sa">f</span><span class="s2">&quot;Presence metrics are not defined outside the time scale of the presence matrix.&quot;</span>
</span><span id="PresenceInvariant-173"><a href="#PresenceInvariant-173"><span class="linenos">173</span></a>                <span class="sa">f</span><span class="s2">&quot;Time scale = [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="PresenceInvariant-174"><a href="#PresenceInvariant-174"><span class="linenos">174</span></a>                <span class="sa">f</span><span class="s2">&quot;Provided: [</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="PresenceInvariant-175"><a href="#PresenceInvariant-175"><span class="linenos">175</span></a>            <span class="p">)</span>
</span><span id="PresenceInvariant-176"><a href="#PresenceInvariant-176"><span class="linenos">176</span></a>        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
</span><span id="PresenceInvariant-177"><a href="#PresenceInvariant-177"><span class="linenos">177</span></a>
</span><span id="PresenceInvariant-178"><a href="#PresenceInvariant-178"><span class="linenos">178</span></a>
</span><span id="PresenceInvariant-179"><a href="#PresenceInvariant-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flow_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant-180"><a href="#PresenceInvariant-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-181"><a href="#PresenceInvariant-181"><span class="linenos">181</span></a><span class="sd">        The flow rate Λ is defined as:</span>
</span><span id="PresenceInvariant-182"><a href="#PresenceInvariant-182"><span class="linenos">182</span></a><span class="sd">            number of active presences in the matrix slice [:start_bin:end_bin] /</span>
</span><span id="PresenceInvariant-183"><a href="#PresenceInvariant-183"><span class="linenos">183</span></a><span class="sd">            number of time bins in the slice (end_bin - start_bin)</span>
</span><span id="PresenceInvariant-184"><a href="#PresenceInvariant-184"><span class="linenos">184</span></a>
</span><span id="PresenceInvariant-185"><a href="#PresenceInvariant-185"><span class="linenos">185</span></a><span class="sd">        Conceptually:</span>
</span><span id="PresenceInvariant-186"><a href="#PresenceInvariant-186"><span class="linenos">186</span></a><span class="sd">            Let N be the number of presences (rows) that are active (non-zero)</span>
</span><span id="PresenceInvariant-187"><a href="#PresenceInvariant-187"><span class="linenos">187</span></a><span class="sd">            in the matrix between start_time and end_time.</span>
</span><span id="PresenceInvariant-188"><a href="#PresenceInvariant-188"><span class="linenos">188</span></a>
</span><span id="PresenceInvariant-189"><a href="#PresenceInvariant-189"><span class="linenos">189</span></a><span class="sd">            Let T be the number of discrete time bins (columns) in that interval.</span>
</span><span id="PresenceInvariant-190"><a href="#PresenceInvariant-190"><span class="linenos">190</span></a>
</span><span id="PresenceInvariant-191"><a href="#PresenceInvariant-191"><span class="linenos">191</span></a><span class="sd">            Then:</span>
</span><span id="PresenceInvariant-192"><a href="#PresenceInvariant-192"><span class="linenos">192</span></a><span class="sd">                flow_rate = Λ = N / T</span>
</span><span id="PresenceInvariant-193"><a href="#PresenceInvariant-193"><span class="linenos">193</span></a>
</span><span id="PresenceInvariant-194"><a href="#PresenceInvariant-194"><span class="linenos">194</span></a><span class="sd">        Examples:</span>
</span><span id="PresenceInvariant-195"><a href="#PresenceInvariant-195"><span class="linenos">195</span></a><span class="sd">            - If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</span>
</span><span id="PresenceInvariant-196"><a href="#PresenceInvariant-196"><span class="linenos">196</span></a><span class="sd">            - If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</span>
</span><span id="PresenceInvariant-197"><a href="#PresenceInvariant-197"><span class="linenos">197</span></a>
</span><span id="PresenceInvariant-198"><a href="#PresenceInvariant-198"><span class="linenos">198</span></a><span class="sd">        The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.</span>
</span><span id="PresenceInvariant-199"><a href="#PresenceInvariant-199"><span class="linenos">199</span></a><span class="sd">        The precise relationship between flow rate, arrival rate, and departure rate is as follows:</span>
</span><span id="PresenceInvariant-200"><a href="#PresenceInvariant-200"><span class="linenos">200</span></a>
</span><span id="PresenceInvariant-201"><a href="#PresenceInvariant-201"><span class="linenos">201</span></a><span class="sd">            N = number of presences that started *before* start_time (see `starting_presence_count`)</span>
</span><span id="PresenceInvariant-202"><a href="#PresenceInvariant-202"><span class="linenos">202</span></a><span class="sd">                + number that started *in* the interval [start_time, end_time) (see `arrival_count`)</span>
</span><span id="PresenceInvariant-203"><a href="#PresenceInvariant-203"><span class="linenos">203</span></a>
</span><span id="PresenceInvariant-204"><a href="#PresenceInvariant-204"><span class="linenos">204</span></a><span class="sd">              — this is also called the cumulative arrivals into the window</span>
</span><span id="PresenceInvariant-205"><a href="#PresenceInvariant-205"><span class="linenos">205</span></a>
</span><span id="PresenceInvariant-206"><a href="#PresenceInvariant-206"><span class="linenos">206</span></a><span class="sd">            or equivalently:</span>
</span><span id="PresenceInvariant-207"><a href="#PresenceInvariant-207"><span class="linenos">207</span></a>
</span><span id="PresenceInvariant-208"><a href="#PresenceInvariant-208"><span class="linenos">208</span></a><span class="sd">            N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)</span>
</span><span id="PresenceInvariant-209"><a href="#PresenceInvariant-209"><span class="linenos">209</span></a><span class="sd">                + number that ended *after* end_time (see `ending_presence_count`)</span>
</span><span id="PresenceInvariant-210"><a href="#PresenceInvariant-210"><span class="linenos">210</span></a>
</span><span id="PresenceInvariant-211"><a href="#PresenceInvariant-211"><span class="linenos">211</span></a><span class="sd">              — this is the departure contribution from the window</span>
</span><span id="PresenceInvariant-212"><a href="#PresenceInvariant-212"><span class="linenos">212</span></a>
</span><span id="PresenceInvariant-213"><a href="#PresenceInvariant-213"><span class="linenos">213</span></a><span class="sd">            These two decompositions of N are always equal; they just reflect different</span>
</span><span id="PresenceInvariant-214"><a href="#PresenceInvariant-214"><span class="linenos">214</span></a><span class="sd">            ways of expressing the same set of active presences.</span>
</span><span id="PresenceInvariant-215"><a href="#PresenceInvariant-215"><span class="linenos">215</span></a>
</span><span id="PresenceInvariant-216"><a href="#PresenceInvariant-216"><span class="linenos">216</span></a><span class="sd">        Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant-217"><a href="#PresenceInvariant-217"><span class="linenos">217</span></a><span class="sd">        will start and end within the window, with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant-218"><a href="#PresenceInvariant-218"><span class="linenos">218</span></a><span class="sd">        the interval at the beginning and end.</span>
</span><span id="PresenceInvariant-219"><a href="#PresenceInvariant-219"><span class="linenos">219</span></a>
</span><span id="PresenceInvariant-220"><a href="#PresenceInvariant-220"><span class="linenos">220</span></a><span class="sd">        This makes N an (over) estimate of true arrivals or departures over that interval.</span>
</span><span id="PresenceInvariant-221"><a href="#PresenceInvariant-221"><span class="linenos">221</span></a>
</span><span id="PresenceInvariant-222"><a href="#PresenceInvariant-222"><span class="linenos">222</span></a><span class="sd">        In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant-223"><a href="#PresenceInvariant-223"><span class="linenos">223</span></a><span class="sd">        then:</span>
</span><span id="PresenceInvariant-224"><a href="#PresenceInvariant-224"><span class="linenos">224</span></a><span class="sd">            flow_rate → arrival_rate → departure_rate</span>
</span><span id="PresenceInvariant-225"><a href="#PresenceInvariant-225"><span class="linenos">225</span></a>
</span><span id="PresenceInvariant-226"><a href="#PresenceInvariant-226"><span class="linenos">226</span></a><span class="sd">        When flow is fully convergent over the interval, then:</span>
</span><span id="PresenceInvariant-227"><a href="#PresenceInvariant-227"><span class="linenos">227</span></a><span class="sd">            flow_rate = arrival_rate = departure_rate</span>
</span><span id="PresenceInvariant-228"><a href="#PresenceInvariant-228"><span class="linenos">228</span></a>
</span><span id="PresenceInvariant-229"><a href="#PresenceInvariant-229"><span class="linenos">229</span></a><span class="sd">        This equality is one of the key conditions for *stable* flow through the boundary.</span>
</span><span id="PresenceInvariant-230"><a href="#PresenceInvariant-230"><span class="linenos">230</span></a>
</span><span id="PresenceInvariant-231"><a href="#PresenceInvariant-231"><span class="linenos">231</span></a><span class="sd">        On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant-232"><a href="#PresenceInvariant-232"><span class="linenos">232</span></a><span class="sd">        flow rate, arrival rate, and departure rate will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant-233"><a href="#PresenceInvariant-233"><span class="linenos">233</span></a><span class="sd">        or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant-234"><a href="#PresenceInvariant-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-235"><a href="#PresenceInvariant-235"><span class="linenos">235</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-236"><a href="#PresenceInvariant-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">number_of_presences</span><span class="o">/</span><span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-237"><a href="#PresenceInvariant-237"><span class="linenos">237</span></a>
</span><span id="PresenceInvariant-238"><a href="#PresenceInvariant-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_residence_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant-239"><a href="#PresenceInvariant-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-240"><a href="#PresenceInvariant-240"><span class="linenos">240</span></a><span class="sd">            Computes the average residence time over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant-241"><a href="#PresenceInvariant-241"><span class="linenos">241</span></a>
</span><span id="PresenceInvariant-242"><a href="#PresenceInvariant-242"><span class="linenos">242</span></a><span class="sd">            Let \$ P \$ be the set of presences that overlap the interval \$[\\text{start\\_time}, \\text{end\\_time})\$.</span>
</span><span id="PresenceInvariant-243"><a href="#PresenceInvariant-243"><span class="linenos">243</span></a>
</span><span id="PresenceInvariant-244"><a href="#PresenceInvariant-244"><span class="linenos">244</span></a><span class="sd">            The *residence time* \$ R(p) \$ is the time that presence \$ p \\in P \$ is active (overlaps) within that interval.</span>
</span><span id="PresenceInvariant-245"><a href="#PresenceInvariant-245"><span class="linenos">245</span></a>
</span><span id="PresenceInvariant-246"><a href="#PresenceInvariant-246"><span class="linenos">246</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant-247"><a href="#PresenceInvariant-247"><span class="linenos">247</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant-248"><a href="#PresenceInvariant-248"><span class="linenos">248</span></a>
</span><span id="PresenceInvariant-249"><a href="#PresenceInvariant-249"><span class="linenos">249</span></a><span class="sd">            The average residence time \$ w \$ is given by:</span>
</span><span id="PresenceInvariant-250"><a href="#PresenceInvariant-250"><span class="linenos">250</span></a>
</span><span id="PresenceInvariant-251"><a href="#PresenceInvariant-251"><span class="linenos">251</span></a><span class="sd">            \$$</span>
</span><span id="PresenceInvariant-252"><a href="#PresenceInvariant-252"><span class="linenos">252</span></a><span class="sd">            w = \\frac{\\sum_{p \\in P} R(p)}{|P|}</span>
</span><span id="PresenceInvariant-253"><a href="#PresenceInvariant-253"><span class="linenos">253</span></a><span class="sd">            \$$</span>
</span><span id="PresenceInvariant-254"><a href="#PresenceInvariant-254"><span class="linenos">254</span></a>
</span><span id="PresenceInvariant-255"><a href="#PresenceInvariant-255"><span class="linenos">255</span></a><span class="sd">            If no presences are active in the interval, \$ w = 0.0 \$.</span>
</span><span id="PresenceInvariant-256"><a href="#PresenceInvariant-256"><span class="linenos">256</span></a>
</span><span id="PresenceInvariant-257"><a href="#PresenceInvariant-257"><span class="linenos">257</span></a><span class="sd">            Note:</span>
</span><span id="PresenceInvariant-258"><a href="#PresenceInvariant-258"><span class="linenos">258</span></a><span class="sd">                There are four possible ways a presence can overlap a window [start, end):</span>
</span><span id="PresenceInvariant-259"><a href="#PresenceInvariant-259"><span class="linenos">259</span></a>
</span><span id="PresenceInvariant-260"><a href="#PresenceInvariant-260"><span class="linenos">260</span></a><span class="sd">                Ticks:     0   1   2   3   4   5   6   7</span>
</span><span id="PresenceInvariant-261"><a href="#PresenceInvariant-261"><span class="linenos">261</span></a><span class="sd">                           |---|---|---|---|---|---|---|</span>
</span><span id="PresenceInvariant-262"><a href="#PresenceInvariant-262"><span class="linenos">262</span></a><span class="sd">                Window:          |-----------|</span>
</span><span id="PresenceInvariant-263"><a href="#PresenceInvariant-263"><span class="linenos">263</span></a>
</span><span id="PresenceInvariant-264"><a href="#PresenceInvariant-264"><span class="linenos">264</span></a><span class="sd">                Case 1: Fully inside</span>
</span><span id="PresenceInvariant-265"><a href="#PresenceInvariant-265"><span class="linenos">265</span></a><span class="sd">                                     [=======]</span>
</span><span id="PresenceInvariant-266"><a href="#PresenceInvariant-266"><span class="linenos">266</span></a>
</span><span id="PresenceInvariant-267"><a href="#PresenceInvariant-267"><span class="linenos">267</span></a><span class="sd">                Case 2: Starts before, ends inside</span>
</span><span id="PresenceInvariant-268"><a href="#PresenceInvariant-268"><span class="linenos">268</span></a><span class="sd">                              [===========</span>
</span><span id="PresenceInvariant-269"><a href="#PresenceInvariant-269"><span class="linenos">269</span></a>
</span><span id="PresenceInvariant-270"><a href="#PresenceInvariant-270"><span class="linenos">270</span></a><span class="sd">                Case 3: Starts inside, ends after</span>
</span><span id="PresenceInvariant-271"><a href="#PresenceInvariant-271"><span class="linenos">271</span></a><span class="sd">                                     ===========]</span>
</span><span id="PresenceInvariant-272"><a href="#PresenceInvariant-272"><span class="linenos">272</span></a>
</span><span id="PresenceInvariant-273"><a href="#PresenceInvariant-273"><span class="linenos">273</span></a><span class="sd">                Case 4: Fully spans window</span>
</span><span id="PresenceInvariant-274"><a href="#PresenceInvariant-274"><span class="linenos">274</span></a><span class="sd">                              [====================]</span>
</span><span id="PresenceInvariant-275"><a href="#PresenceInvariant-275"><span class="linenos">275</span></a>
</span><span id="PresenceInvariant-276"><a href="#PresenceInvariant-276"><span class="linenos">276</span></a><span class="sd">                In all but Case 1, the window clips the presence, so the residence time</span>
</span><span id="PresenceInvariant-277"><a href="#PresenceInvariant-277"><span class="linenos">277</span></a><span class="sd">                is smaller than the presence duration. In Case 1, residence time equals presence duration.</span>
</span><span id="PresenceInvariant-278"><a href="#PresenceInvariant-278"><span class="linenos">278</span></a>
</span><span id="PresenceInvariant-279"><a href="#PresenceInvariant-279"><span class="linenos">279</span></a><span class="sd">                Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant-280"><a href="#PresenceInvariant-280"><span class="linenos">280</span></a><span class="sd">                will start and end within the window (Case 1), with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant-281"><a href="#PresenceInvariant-281"><span class="linenos">281</span></a><span class="sd">                the interval at the beginning and end or span the window (Cases 2–4).</span>
</span><span id="PresenceInvariant-282"><a href="#PresenceInvariant-282"><span class="linenos">282</span></a>
</span><span id="PresenceInvariant-283"><a href="#PresenceInvariant-283"><span class="linenos">283</span></a><span class="sd">                This makes \$ w \$ an (under)estimate of true presence duration.</span>
</span><span id="PresenceInvariant-284"><a href="#PresenceInvariant-284"><span class="linenos">284</span></a>
</span><span id="PresenceInvariant-285"><a href="#PresenceInvariant-285"><span class="linenos">285</span></a><span class="sd">                In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant-286"><a href="#PresenceInvariant-286"><span class="linenos">286</span></a><span class="sd">                then:</span>
</span><span id="PresenceInvariant-287"><a href="#PresenceInvariant-287"><span class="linenos">287</span></a><span class="sd">                    residence time → presence duration.</span>
</span><span id="PresenceInvariant-288"><a href="#PresenceInvariant-288"><span class="linenos">288</span></a>
</span><span id="PresenceInvariant-289"><a href="#PresenceInvariant-289"><span class="linenos">289</span></a><span class="sd">                When flow is fully convergent over the interval:</span>
</span><span id="PresenceInvariant-290"><a href="#PresenceInvariant-290"><span class="linenos">290</span></a><span class="sd">                    residence time = presence duration.</span>
</span><span id="PresenceInvariant-291"><a href="#PresenceInvariant-291"><span class="linenos">291</span></a>
</span><span id="PresenceInvariant-292"><a href="#PresenceInvariant-292"><span class="linenos">292</span></a><span class="sd">                On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant-293"><a href="#PresenceInvariant-293"><span class="linenos">293</span></a><span class="sd">                residence time and presence duration will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant-294"><a href="#PresenceInvariant-294"><span class="linenos">294</span></a><span class="sd">                or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant-295"><a href="#PresenceInvariant-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-296"><a href="#PresenceInvariant-296"><span class="linenos">296</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-297"><a href="#PresenceInvariant-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-298"><a href="#PresenceInvariant-298"><span class="linenos">298</span></a>
</span><span id="PresenceInvariant-299"><a href="#PresenceInvariant-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_presence_per_unit_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant-300"><a href="#PresenceInvariant-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-301"><a href="#PresenceInvariant-301"><span class="linenos">301</span></a><span class="sd">        Computes the average presence per time bin over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant-302"><a href="#PresenceInvariant-302"><span class="linenos">302</span></a>
</span><span id="PresenceInvariant-303"><a href="#PresenceInvariant-303"><span class="linenos">303</span></a><span class="sd">        Let \$ B \$ be the set of discrete time bins that cover the interval \$[\\text{start\\_time}, \\text{end\\_time})\$,</span>
</span><span id="PresenceInvariant-304"><a href="#PresenceInvariant-304"><span class="linenos">304</span></a><span class="sd">        and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \\in B \$.</span>
</span><span id="PresenceInvariant-305"><a href="#PresenceInvariant-305"><span class="linenos">305</span></a>
</span><span id="PresenceInvariant-306"><a href="#PresenceInvariant-306"><span class="linenos">306</span></a><span class="sd">        The average presence \$ L \$ is given by:</span>
</span><span id="PresenceInvariant-307"><a href="#PresenceInvariant-307"><span class="linenos">307</span></a>
</span><span id="PresenceInvariant-308"><a href="#PresenceInvariant-308"><span class="linenos">308</span></a><span class="sd">        \$$</span>
</span><span id="PresenceInvariant-309"><a href="#PresenceInvariant-309"><span class="linenos">309</span></a><span class="sd">        L = \\frac{\\sum_{b \\in B} P(b)}{|B|}</span>
</span><span id="PresenceInvariant-310"><a href="#PresenceInvariant-310"><span class="linenos">310</span></a><span class="sd">        \$$</span>
</span><span id="PresenceInvariant-311"><a href="#PresenceInvariant-311"><span class="linenos">311</span></a>
</span><span id="PresenceInvariant-312"><a href="#PresenceInvariant-312"><span class="linenos">312</span></a><span class="sd">        If the interval spans no bins, \$ L = 0.0 \$.</span>
</span><span id="PresenceInvariant-313"><a href="#PresenceInvariant-313"><span class="linenos">313</span></a>
</span><span id="PresenceInvariant-314"><a href="#PresenceInvariant-314"><span class="linenos">314</span></a><span class="sd">        Note:</span>
</span><span id="PresenceInvariant-315"><a href="#PresenceInvariant-315"><span class="linenos">315</span></a><span class="sd">            This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence</span>
</span><span id="PresenceInvariant-316"><a href="#PresenceInvariant-316"><span class="linenos">316</span></a><span class="sd">            durations we used to compute residence time) divided by the number of bins in the interval.</span>
</span><span id="PresenceInvariant-317"><a href="#PresenceInvariant-317"><span class="linenos">317</span></a>
</span><span id="PresenceInvariant-318"><a href="#PresenceInvariant-318"><span class="linenos">318</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant-319"><a href="#PresenceInvariant-319"><span class="linenos">319</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant-320"><a href="#PresenceInvariant-320"><span class="linenos">320</span></a>
</span><span id="PresenceInvariant-321"><a href="#PresenceInvariant-321"><span class="linenos">321</span></a><span class="sd">            Visually, this corresponds to summing presence *vertically* across bins:</span>
</span><span id="PresenceInvariant-322"><a href="#PresenceInvariant-322"><span class="linenos">322</span></a>
</span><span id="PresenceInvariant-323"><a href="#PresenceInvariant-323"><span class="linenos">323</span></a><span class="sd">            Example: presences over time bins</span>
</span><span id="PresenceInvariant-324"><a href="#PresenceInvariant-324"><span class="linenos">324</span></a>
</span><span id="PresenceInvariant-325"><a href="#PresenceInvariant-325"><span class="linenos">325</span></a><span class="sd">            Ticks:     0   1   2   3   4</span>
</span><span id="PresenceInvariant-326"><a href="#PresenceInvariant-326"><span class="linenos">326</span></a><span class="sd">                       |---|---|---|---|</span>
</span><span id="PresenceInvariant-327"><a href="#PresenceInvariant-327"><span class="linenos">327</span></a><span class="sd">            P1:         [=======]</span>
</span><span id="PresenceInvariant-328"><a href="#PresenceInvariant-328"><span class="linenos">328</span></a><span class="sd">            P2:             [=======]</span>
</span><span id="PresenceInvariant-329"><a href="#PresenceInvariant-329"><span class="linenos">329</span></a><span class="sd">            P3:                 [=======]</span>
</span><span id="PresenceInvariant-330"><a href="#PresenceInvariant-330"><span class="linenos">330</span></a>
</span><span id="PresenceInvariant-331"><a href="#PresenceInvariant-331"><span class="linenos">331</span></a><span class="sd">            Time bin 1:</span>
</span><span id="PresenceInvariant-332"><a href="#PresenceInvariant-332"><span class="linenos">332</span></a><span class="sd">                          ↑   (bin index 1 = [1, 2))</span>
</span><span id="PresenceInvariant-333"><a href="#PresenceInvariant-333"><span class="linenos">333</span></a><span class="sd">                          |---|</span>
</span><span id="PresenceInvariant-334"><a href="#PresenceInvariant-334"><span class="linenos">334</span></a><span class="sd">                      P1:   +</span>
</span><span id="PresenceInvariant-335"><a href="#PresenceInvariant-335"><span class="linenos">335</span></a><span class="sd">                      P2:   +</span>
</span><span id="PresenceInvariant-336"><a href="#PresenceInvariant-336"><span class="linenos">336</span></a><span class="sd">                      P3:   -</span>
</span><span id="PresenceInvariant-337"><a href="#PresenceInvariant-337"><span class="linenos">337</span></a><span class="sd">                    ---------</span>
</span><span id="PresenceInvariant-338"><a href="#PresenceInvariant-338"><span class="linenos">338</span></a><span class="sd">                    Sum:     2</span>
</span><span id="PresenceInvariant-339"><a href="#PresenceInvariant-339"><span class="linenos">339</span></a>
</span><span id="PresenceInvariant-340"><a href="#PresenceInvariant-340"><span class="linenos">340</span></a><span class="sd">            So:</span>
</span><span id="PresenceInvariant-341"><a href="#PresenceInvariant-341"><span class="linenos">341</span></a><span class="sd">                - Bin 1 has total presence = 2</span>
</span><span id="PresenceInvariant-342"><a href="#PresenceInvariant-342"><span class="linenos">342</span></a><span class="sd">                - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5</span>
</span><span id="PresenceInvariant-343"><a href="#PresenceInvariant-343"><span class="linenos">343</span></a><span class="sd">                - Then \$ L = 5.5 / 3 = 1.833... \$</span>
</span><span id="PresenceInvariant-344"><a href="#PresenceInvariant-344"><span class="linenos">344</span></a>
</span><span id="PresenceInvariant-345"><a href="#PresenceInvariant-345"><span class="linenos">345</span></a><span class="sd">            Conceptually, \$ L \$ reflects the average &quot;load&quot; or concurrency of presence in the system during the interval.</span>
</span><span id="PresenceInvariant-346"><a href="#PresenceInvariant-346"><span class="linenos">346</span></a>
</span><span id="PresenceInvariant-347"><a href="#PresenceInvariant-347"><span class="linenos">347</span></a><span class="sd">            This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</span>
</span><span id="PresenceInvariant-348"><a href="#PresenceInvariant-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-349"><a href="#PresenceInvariant-349"><span class="linenos">349</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-350"><a href="#PresenceInvariant-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-351"><a href="#PresenceInvariant-351"><span class="linenos">351</span></a>
</span><span id="PresenceInvariant-352"><a href="#PresenceInvariant-352"><span class="linenos">352</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant-353"><a href="#PresenceInvariant-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-354"><a href="#PresenceInvariant-354"><span class="linenos">354</span></a><span class="sd">            Computes the three core quantities from which all presence-based metrics are derived:</span>
</span><span id="PresenceInvariant-355"><a href="#PresenceInvariant-355"><span class="linenos">355</span></a>
</span><span id="PresenceInvariant-356"><a href="#PresenceInvariant-356"><span class="linenos">356</span></a><span class="sd">            - Total presence time \$ A \$ over the interval \$[\\text{start\\_time}, \\text{end\\_time})\$</span>
</span><span id="PresenceInvariant-357"><a href="#PresenceInvariant-357"><span class="linenos">357</span></a><span class="sd">            - Number of active presences \$ N \$ (i.e., rows overlapping the interval)</span>
</span><span id="PresenceInvariant-358"><a href="#PresenceInvariant-358"><span class="linenos">358</span></a><span class="sd">            - Number of time bins \$ T \$ covering the interval</span>
</span><span id="PresenceInvariant-359"><a href="#PresenceInvariant-359"><span class="linenos">359</span></a>
</span><span id="PresenceInvariant-360"><a href="#PresenceInvariant-360"><span class="linenos">360</span></a><span class="sd">            These three values form the basis for computing:</span>
</span><span id="PresenceInvariant-361"><a href="#PresenceInvariant-361"><span class="linenos">361</span></a>
</span><span id="PresenceInvariant-362"><a href="#PresenceInvariant-362"><span class="linenos">362</span></a><span class="sd">            - Average presence per time bin: \$ L = A / T \$</span>
</span><span id="PresenceInvariant-363"><a href="#PresenceInvariant-363"><span class="linenos">363</span></a><span class="sd">            - Average residence time per presence: \$ w = A / N \$</span>
</span><span id="PresenceInvariant-364"><a href="#PresenceInvariant-364"><span class="linenos">364</span></a><span class="sd">            - Flow rate: \$ \\Lambda = N / T \$</span>
</span><span id="PresenceInvariant-365"><a href="#PresenceInvariant-365"><span class="linenos">365</span></a>
</span><span id="PresenceInvariant-366"><a href="#PresenceInvariant-366"><span class="linenos">366</span></a><span class="sd">            This method is the common workhorse that underlies `avg_presence_per_time_bin`,</span>
</span><span id="PresenceInvariant-367"><a href="#PresenceInvariant-367"><span class="linenos">367</span></a><span class="sd">            `avg_residence_time_per_presence`, and `flow_rate`.</span>
</span><span id="PresenceInvariant-368"><a href="#PresenceInvariant-368"><span class="linenos">368</span></a>
</span><span id="PresenceInvariant-369"><a href="#PresenceInvariant-369"><span class="linenos">369</span></a><span class="sd">            ... and much of this work lives in `PresenceMap.presence_value_in`</span>
</span><span id="PresenceInvariant-370"><a href="#PresenceInvariant-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-371"><a href="#PresenceInvariant-371"><span class="linenos">371</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-372"><a href="#PresenceInvariant-372"><span class="linenos">372</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-373"><a href="#PresenceInvariant-373"><span class="linenos">373</span></a>        <span class="n">total_presence_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant-374"><a href="#PresenceInvariant-374"><span class="linenos">374</span></a>        <span class="n">number_of_presences</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant-375"><a href="#PresenceInvariant-375"><span class="linenos">375</span></a>        <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span>
</span><span id="PresenceInvariant-376"><a href="#PresenceInvariant-376"><span class="linenos">376</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="PresenceInvariant-377"><a href="#PresenceInvariant-377"><span class="linenos">377</span></a>                <span class="n">total_presence_value</span> <span class="o">+=</span> <span class="n">pm</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-378"><a href="#PresenceInvariant-378"><span class="linenos">378</span></a>                <span class="n">number_of_presences</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PresenceInvariant-379"><a href="#PresenceInvariant-379"><span class="linenos">379</span></a>
</span><span id="PresenceInvariant-380"><a href="#PresenceInvariant-380"><span class="linenos">380</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="n">start_bin</span>
</span><span id="PresenceInvariant-381"><a href="#PresenceInvariant-381"><span class="linenos">381</span></a>
</span><span id="PresenceInvariant-382"><a href="#PresenceInvariant-382"><span class="linenos">382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant-383"><a href="#PresenceInvariant-383"><span class="linenos">383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-384"><a href="#PresenceInvariant-384"><span class="linenos">384</span></a><span class="sd">        Computes all three components of the *Presence Invariant* for a finite window</span>
</span><span id="PresenceInvariant-385"><a href="#PresenceInvariant-385"><span class="linenos">385</span></a><span class="sd">        $[ \text{start\_time}, \text{end\_time} )$ within the timescale $[ t_0, t_1 )$</span>
</span><span id="PresenceInvariant-386"><a href="#PresenceInvariant-386"><span class="linenos">386</span></a><span class="sd">        of the PresenceMatrix.</span>
</span><span id="PresenceInvariant-387"><a href="#PresenceInvariant-387"><span class="linenos">387</span></a>
</span><span id="PresenceInvariant-388"><a href="#PresenceInvariant-388"><span class="linenos">388</span></a><span class="sd">        The Presence Invariant states that for *any* such interval:</span>
</span><span id="PresenceInvariant-389"><a href="#PresenceInvariant-389"><span class="linenos">389</span></a>
</span><span id="PresenceInvariant-390"><a href="#PresenceInvariant-390"><span class="linenos">390</span></a><span class="sd">            $$</span>
</span><span id="PresenceInvariant-391"><a href="#PresenceInvariant-391"><span class="linenos">391</span></a><span class="sd">            L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-392"><a href="#PresenceInvariant-392"><span class="linenos">392</span></a><span class="sd">            $$</span>
</span><span id="PresenceInvariant-393"><a href="#PresenceInvariant-393"><span class="linenos">393</span></a>
</span><span id="PresenceInvariant-394"><a href="#PresenceInvariant-394"><span class="linenos">394</span></a><span class="sd">        This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant-395"><a href="#PresenceInvariant-395"><span class="linenos">395</span></a><span class="sd">        in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant-396"><a href="#PresenceInvariant-396"><span class="linenos">396</span></a><span class="sd">        the more familiar equilibrium-based Little’s Law by expressing a conservation law</span>
</span><span id="PresenceInvariant-397"><a href="#PresenceInvariant-397"><span class="linenos">397</span></a><span class="sd">        that applies across all time scales.</span>
</span><span id="PresenceInvariant-398"><a href="#PresenceInvariant-398"><span class="linenos">398</span></a>
</span><span id="PresenceInvariant-399"><a href="#PresenceInvariant-399"><span class="linenos">399</span></a><span class="sd">        - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant-400"><a href="#PresenceInvariant-400"><span class="linenos">400</span></a><span class="sd">        - $\Lambda$: the *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant-401"><a href="#PresenceInvariant-401"><span class="linenos">401</span></a><span class="sd">        - $w$: the *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant-402"><a href="#PresenceInvariant-402"><span class="linenos">402</span></a>
</span><span id="PresenceInvariant-403"><a href="#PresenceInvariant-403"><span class="linenos">403</span></a><span class="sd">        **Derivation:**</span>
</span><span id="PresenceInvariant-404"><a href="#PresenceInvariant-404"><span class="linenos">404</span></a>
</span><span id="PresenceInvariant-405"><a href="#PresenceInvariant-405"><span class="linenos">405</span></a><span class="sd">        Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant-406"><a href="#PresenceInvariant-406"><span class="linenos">406</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant-407"><a href="#PresenceInvariant-407"><span class="linenos">407</span></a>
</span><span id="PresenceInvariant-408"><a href="#PresenceInvariant-408"><span class="linenos">408</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant-409"><a href="#PresenceInvariant-409"><span class="linenos">409</span></a><span class="sd">        A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant-410"><a href="#PresenceInvariant-410"><span class="linenos">410</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant-411"><a href="#PresenceInvariant-411"><span class="linenos">411</span></a>
</span><span id="PresenceInvariant-412"><a href="#PresenceInvariant-412"><span class="linenos">412</span></a><span class="sd">        Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant-413"><a href="#PresenceInvariant-413"><span class="linenos">413</span></a>
</span><span id="PresenceInvariant-414"><a href="#PresenceInvariant-414"><span class="linenos">414</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant-415"><a href="#PresenceInvariant-415"><span class="linenos">415</span></a>
</span><span id="PresenceInvariant-416"><a href="#PresenceInvariant-416"><span class="linenos">416</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant-417"><a href="#PresenceInvariant-417"><span class="linenos">417</span></a><span class="sd">        L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant-418"><a href="#PresenceInvariant-418"><span class="linenos">418</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant-419"><a href="#PresenceInvariant-419"><span class="linenos">419</span></a>
</span><span id="PresenceInvariant-420"><a href="#PresenceInvariant-420"><span class="linenos">420</span></a><span class="sd">        Hence:</span>
</span><span id="PresenceInvariant-421"><a href="#PresenceInvariant-421"><span class="linenos">421</span></a>
</span><span id="PresenceInvariant-422"><a href="#PresenceInvariant-422"><span class="linenos">422</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant-423"><a href="#PresenceInvariant-423"><span class="linenos">423</span></a><span class="sd">        L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-424"><a href="#PresenceInvariant-424"><span class="linenos">424</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant-425"><a href="#PresenceInvariant-425"><span class="linenos">425</span></a>
</span><span id="PresenceInvariant-426"><a href="#PresenceInvariant-426"><span class="linenos">426</span></a><span class="sd">        This identity—what we call the *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant-427"><a href="#PresenceInvariant-427"><span class="linenos">427</span></a><span class="sd">        all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</span>
</span><span id="PresenceInvariant-428"><a href="#PresenceInvariant-428"><span class="linenos">428</span></a>
</span><span id="PresenceInvariant-429"><a href="#PresenceInvariant-429"><span class="linenos">429</span></a><span class="sd">        Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant-430"><a href="#PresenceInvariant-430"><span class="linenos">430</span></a><span class="sd">        (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant-431"><a href="#PresenceInvariant-431"><span class="linenos">431</span></a>
</span><span id="PresenceInvariant-432"><a href="#PresenceInvariant-432"><span class="linenos">432</span></a><span class="sd">        - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$ and average duration $W$.</span>
</span><span id="PresenceInvariant-433"><a href="#PresenceInvariant-433"><span class="linenos">433</span></a><span class="sd">        - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite approximations.</span>
</span><span id="PresenceInvariant-434"><a href="#PresenceInvariant-434"><span class="linenos">434</span></a>
</span><span id="PresenceInvariant-435"><a href="#PresenceInvariant-435"><span class="linenos">435</span></a><span class="sd">        Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant-436"><a href="#PresenceInvariant-436"><span class="linenos">436</span></a><span class="sd">        and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant-437"><a href="#PresenceInvariant-437"><span class="linenos">437</span></a>
</span><span id="PresenceInvariant-438"><a href="#PresenceInvariant-438"><span class="linenos">438</span></a><span class="sd">        ## References</span>
</span><span id="PresenceInvariant-439"><a href="#PresenceInvariant-439"><span class="linenos">439</span></a>
</span><span id="PresenceInvariant-440"><a href="#PresenceInvariant-440"><span class="linenos">440</span></a><span class="sd">            1. **Little’s Law**</span>
</span><span id="PresenceInvariant-441"><a href="#PresenceInvariant-441"><span class="linenos">441</span></a><span class="sd">               Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant-442"><a href="#PresenceInvariant-442"><span class="linenos">442</span></a><span class="sd">               [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant-443"><a href="#PresenceInvariant-443"><span class="linenos">443</span></a>
</span><span id="PresenceInvariant-444"><a href="#PresenceInvariant-444"><span class="linenos">444</span></a><span class="sd">            2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant-445"><a href="#PresenceInvariant-445"><span class="linenos">445</span></a><span class="sd">               Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant-446"><a href="#PresenceInvariant-446"><span class="linenos">446</span></a><span class="sd">               [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant-447"><a href="#PresenceInvariant-447"><span class="linenos">447</span></a>
</span><span id="PresenceInvariant-448"><a href="#PresenceInvariant-448"><span class="linenos">448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-449"><a href="#PresenceInvariant-449"><span class="linenos">449</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-450"><a href="#PresenceInvariant-450"><span class="linenos">450</span></a>
</span><span id="PresenceInvariant-451"><a href="#PresenceInvariant-451"><span class="linenos">451</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-452"><a href="#PresenceInvariant-452"><span class="linenos">452</span></a>        <span class="n">Λ</span> <span class="o">=</span> <span class="n">number_of_presences</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-453"><a href="#PresenceInvariant-453"><span class="linenos">453</span></a>        <span class="n">W</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-454"><a href="#PresenceInvariant-454"><span class="linenos">454</span></a>
</span><span id="PresenceInvariant-455"><a href="#PresenceInvariant-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">W</span>
</span><span id="PresenceInvariant-456"><a href="#PresenceInvariant-456"><span class="linenos">456</span></a>
</span><span id="PresenceInvariant-457"><a href="#PresenceInvariant-457"><span class="linenos">457</span></a>
</span><span id="PresenceInvariant-458"><a href="#PresenceInvariant-458"><span class="linenos">458</span></a>
</span><span id="PresenceInvariant-459"><a href="#PresenceInvariant-459"><span class="linenos">459</span></a>
</span><span id="PresenceInvariant-460"><a href="#PresenceInvariant-460"><span class="linenos">460</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">starting_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-461"><a href="#PresenceInvariant-461"><span class="linenos">461</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-462"><a href="#PresenceInvariant-462"><span class="linenos">462</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-463"><a href="#PresenceInvariant-463"><span class="linenos">463</span></a>
</span><span id="PresenceInvariant-464"><a href="#PresenceInvariant-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-465"><a href="#PresenceInvariant-465"><span class="linenos">465</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-466"><a href="#PresenceInvariant-466"><span class="linenos">466</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-467"><a href="#PresenceInvariant-467"><span class="linenos">467</span></a>            <span class="c1">#Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant-468"><a href="#PresenceInvariant-468"><span class="linenos">468</span></a>            <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant-469"><a href="#PresenceInvariant-469"><span class="linenos">469</span></a>            <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant-470"><a href="#PresenceInvariant-470"><span class="linenos">470</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start_bin</span>
</span><span id="PresenceInvariant-471"><a href="#PresenceInvariant-471"><span class="linenos">471</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-472"><a href="#PresenceInvariant-472"><span class="linenos">472</span></a>
</span><span id="PresenceInvariant-473"><a href="#PresenceInvariant-473"><span class="linenos">473</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ending_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-474"><a href="#PresenceInvariant-474"><span class="linenos">474</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-475"><a href="#PresenceInvariant-475"><span class="linenos">475</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-476"><a href="#PresenceInvariant-476"><span class="linenos">476</span></a>
</span><span id="PresenceInvariant-477"><a href="#PresenceInvariant-477"><span class="linenos">477</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-478"><a href="#PresenceInvariant-478"><span class="linenos">478</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-479"><a href="#PresenceInvariant-479"><span class="linenos">479</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-480"><a href="#PresenceInvariant-480"><span class="linenos">480</span></a>            <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="PresenceInvariant-481"><a href="#PresenceInvariant-481"><span class="linenos">481</span></a>                 <span class="c1"># Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant-482"><a href="#PresenceInvariant-482"><span class="linenos">482</span></a>                 <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant-483"><a href="#PresenceInvariant-483"><span class="linenos">483</span></a>                 <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant-484"><a href="#PresenceInvariant-484"><span class="linenos">484</span></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-485"><a href="#PresenceInvariant-485"><span class="linenos">485</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-486"><a href="#PresenceInvariant-486"><span class="linenos">486</span></a>
</span><span id="PresenceInvariant-487"><a href="#PresenceInvariant-487"><span class="linenos">487</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arrival_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-488"><a href="#PresenceInvariant-488"><span class="linenos">488</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of presences that started within the window&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-489"><a href="#PresenceInvariant-489"><span class="linenos">489</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-490"><a href="#PresenceInvariant-490"><span class="linenos">490</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-491"><a href="#PresenceInvariant-491"><span class="linenos">491</span></a>
</span><span id="PresenceInvariant-492"><a href="#PresenceInvariant-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-493"><a href="#PresenceInvariant-493"><span class="linenos">493</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-494"><a href="#PresenceInvariant-494"><span class="linenos">494</span></a>            <span class="k">if</span> <span class="n">start_bin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_bin</span>
</span><span id="PresenceInvariant-495"><a href="#PresenceInvariant-495"><span class="linenos">495</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-496"><a href="#PresenceInvariant-496"><span class="linenos">496</span></a>
</span><span id="PresenceInvariant-497"><a href="#PresenceInvariant-497"><span class="linenos">497</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">departure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-498"><a href="#PresenceInvariant-498"><span class="linenos">498</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-499"><a href="#PresenceInvariant-499"><span class="linenos">499</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-500"><a href="#PresenceInvariant-500"><span class="linenos">500</span></a>
</span><span id="PresenceInvariant-501"><a href="#PresenceInvariant-501"><span class="linenos">501</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-502"><a href="#PresenceInvariant-502"><span class="linenos">502</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-503"><a href="#PresenceInvariant-503"><span class="linenos">503</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-504"><a href="#PresenceInvariant-504"><span class="linenos">504</span></a>            <span class="ow">and</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-505"><a href="#PresenceInvariant-505"><span class="linenos">505</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-506"><a href="#PresenceInvariant-506"><span class="linenos">506</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-507"><a href="#PresenceInvariant-507"><span class="linenos">507</span></a>
</span><span id="PresenceInvariant-508"><a href="#PresenceInvariant-508"><span class="linenos">508</span></a>
</span><span id="PresenceInvariant-509"><a href="#PresenceInvariant-509"><span class="linenos">509</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PresenceInvariant-510"><a href="#PresenceInvariant-510"><span class="linenos">510</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-511"><a href="#PresenceInvariant-511"><span class="linenos">511</span></a><span class="sd">            The key function of this class is to precisely compute the components of key rate conserved quantities</span>
</span><span id="PresenceInvariant-512"><a href="#PresenceInvariant-512"><span class="linenos">512</span></a><span class="sd">            tied to Presence under both equilibrium and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant-513"><a href="#PresenceInvariant-513"><span class="linenos">513</span></a>
</span><span id="PresenceInvariant-514"><a href="#PresenceInvariant-514"><span class="linenos">514</span></a><span class="sd">            The key relationship that matters here is the Presence Invariant, which is rate conservation law</span>
</span><span id="PresenceInvariant-515"><a href="#PresenceInvariant-515"><span class="linenos">515</span></a><span class="sd">            for a PresenceMatrix under non-equilibrium condition.</span>
</span><span id="PresenceInvariant-516"><a href="#PresenceInvariant-516"><span class="linenos">516</span></a>
</span><span id="PresenceInvariant-517"><a href="#PresenceInvariant-517"><span class="linenos">517</span></a><span class="sd">            The Presence Invariant states that for *any* finite interval [start_time, end_time) over the timescale [t0, t1)</span>
</span><span id="PresenceInvariant-518"><a href="#PresenceInvariant-518"><span class="linenos">518</span></a><span class="sd">            of a Presence Matrix:</span>
</span><span id="PresenceInvariant-519"><a href="#PresenceInvariant-519"><span class="linenos">519</span></a>
</span><span id="PresenceInvariant-520"><a href="#PresenceInvariant-520"><span class="linenos">520</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant-521"><a href="#PresenceInvariant-521"><span class="linenos">521</span></a><span class="sd">                    L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-522"><a href="#PresenceInvariant-522"><span class="linenos">522</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant-523"><a href="#PresenceInvariant-523"><span class="linenos">523</span></a>
</span><span id="PresenceInvariant-524"><a href="#PresenceInvariant-524"><span class="linenos">524</span></a><span class="sd">                - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant-525"><a href="#PresenceInvariant-525"><span class="linenos">525</span></a><span class="sd">                - $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant-526"><a href="#PresenceInvariant-526"><span class="linenos">526</span></a><span class="sd">                - $w$: a *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant-527"><a href="#PresenceInvariant-527"><span class="linenos">527</span></a>
</span><span id="PresenceInvariant-528"><a href="#PresenceInvariant-528"><span class="linenos">528</span></a><span class="sd">                This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant-529"><a href="#PresenceInvariant-529"><span class="linenos">529</span></a><span class="sd">                in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant-530"><a href="#PresenceInvariant-530"><span class="linenos">530</span></a><span class="sd">                the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law</span>
</span><span id="PresenceInvariant-531"><a href="#PresenceInvariant-531"><span class="linenos">531</span></a><span class="sd">                that applies across all time scales and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant-532"><a href="#PresenceInvariant-532"><span class="linenos">532</span></a>
</span><span id="PresenceInvariant-533"><a href="#PresenceInvariant-533"><span class="linenos">533</span></a><span class="sd">                The proof of this invariant is surprisingly simple and elementary.</span>
</span><span id="PresenceInvariant-534"><a href="#PresenceInvariant-534"><span class="linenos">534</span></a>
</span><span id="PresenceInvariant-535"><a href="#PresenceInvariant-535"><span class="linenos">535</span></a><span class="sd">                **Derivation:**</span>
</span><span id="PresenceInvariant-536"><a href="#PresenceInvariant-536"><span class="linenos">536</span></a>
</span><span id="PresenceInvariant-537"><a href="#PresenceInvariant-537"><span class="linenos">537</span></a><span class="sd">                Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant-538"><a href="#PresenceInvariant-538"><span class="linenos">538</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant-539"><a href="#PresenceInvariant-539"><span class="linenos">539</span></a>
</span><span id="PresenceInvariant-540"><a href="#PresenceInvariant-540"><span class="linenos">540</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-541"><a href="#PresenceInvariant-541"><span class="linenos">541</span></a><span class="sd">                A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant-542"><a href="#PresenceInvariant-542"><span class="linenos">542</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-543"><a href="#PresenceInvariant-543"><span class="linenos">543</span></a>
</span><span id="PresenceInvariant-544"><a href="#PresenceInvariant-544"><span class="linenos">544</span></a><span class="sd">                Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant-545"><a href="#PresenceInvariant-545"><span class="linenos">545</span></a>
</span><span id="PresenceInvariant-546"><a href="#PresenceInvariant-546"><span class="linenos">546</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant-547"><a href="#PresenceInvariant-547"><span class="linenos">547</span></a>
</span><span id="PresenceInvariant-548"><a href="#PresenceInvariant-548"><span class="linenos">548</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-549"><a href="#PresenceInvariant-549"><span class="linenos">549</span></a>
</span><span id="PresenceInvariant-550"><a href="#PresenceInvariant-550"><span class="linenos">550</span></a><span class="sd">                L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant-551"><a href="#PresenceInvariant-551"><span class="linenos">551</span></a>
</span><span id="PresenceInvariant-552"><a href="#PresenceInvariant-552"><span class="linenos">552</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-553"><a href="#PresenceInvariant-553"><span class="linenos">553</span></a>
</span><span id="PresenceInvariant-554"><a href="#PresenceInvariant-554"><span class="linenos">554</span></a><span class="sd">                Hence:</span>
</span><span id="PresenceInvariant-555"><a href="#PresenceInvariant-555"><span class="linenos">555</span></a>
</span><span id="PresenceInvariant-556"><a href="#PresenceInvariant-556"><span class="linenos">556</span></a><span class="sd">                $$ L = \Lambda \cdot w $$</span>
</span><span id="PresenceInvariant-557"><a href="#PresenceInvariant-557"><span class="linenos">557</span></a>
</span><span id="PresenceInvariant-558"><a href="#PresenceInvariant-558"><span class="linenos">558</span></a><span class="sd">                The *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant-559"><a href="#PresenceInvariant-559"><span class="linenos">559</span></a><span class="sd">                all proofs of Little’s Law [1], and can be seen as its finite-window version.</span>
</span><span id="PresenceInvariant-560"><a href="#PresenceInvariant-560"><span class="linenos">560</span></a>
</span><span id="PresenceInvariant-561"><a href="#PresenceInvariant-561"><span class="linenos">561</span></a><span class="sd">                Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant-562"><a href="#PresenceInvariant-562"><span class="linenos">562</span></a><span class="sd">                (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant-563"><a href="#PresenceInvariant-563"><span class="linenos">563</span></a>
</span><span id="PresenceInvariant-564"><a href="#PresenceInvariant-564"><span class="linenos">564</span></a><span class="sd">                - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$</span>
</span><span id="PresenceInvariant-565"><a href="#PresenceInvariant-565"><span class="linenos">565</span></a><span class="sd">                and average duration $W$.</span>
</span><span id="PresenceInvariant-566"><a href="#PresenceInvariant-566"><span class="linenos">566</span></a><span class="sd">                - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite</span>
</span><span id="PresenceInvariant-567"><a href="#PresenceInvariant-567"><span class="linenos">567</span></a><span class="sd">                window approximations.</span>
</span><span id="PresenceInvariant-568"><a href="#PresenceInvariant-568"><span class="linenos">568</span></a>
</span><span id="PresenceInvariant-569"><a href="#PresenceInvariant-569"><span class="linenos">569</span></a><span class="sd">                Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant-570"><a href="#PresenceInvariant-570"><span class="linenos">570</span></a><span class="sd">                and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant-571"><a href="#PresenceInvariant-571"><span class="linenos">571</span></a>
</span><span id="PresenceInvariant-572"><a href="#PresenceInvariant-572"><span class="linenos">572</span></a><span class="sd">                References:</span>
</span><span id="PresenceInvariant-573"><a href="#PresenceInvariant-573"><span class="linenos">573</span></a>
</span><span id="PresenceInvariant-574"><a href="#PresenceInvariant-574"><span class="linenos">574</span></a><span class="sd">                1. **Little’s Law**</span>
</span><span id="PresenceInvariant-575"><a href="#PresenceInvariant-575"><span class="linenos">575</span></a><span class="sd">                   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant-576"><a href="#PresenceInvariant-576"><span class="linenos">576</span></a><span class="sd">                   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant-577"><a href="#PresenceInvariant-577"><span class="linenos">577</span></a>
</span><span id="PresenceInvariant-578"><a href="#PresenceInvariant-578"><span class="linenos">578</span></a><span class="sd">                2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant-579"><a href="#PresenceInvariant-579"><span class="linenos">579</span></a><span class="sd">                   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant-580"><a href="#PresenceInvariant-580"><span class="linenos">580</span></a><span class="sd">                   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant-581"><a href="#PresenceInvariant-581"><span class="linenos">581</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p><strong>A finite, scale-invariant, non-equilibrium version of Little's Law.</strong></p>

<p>This class computes the components of The Presence Invariant of a presence matrix.</p>

<p>The Presence Invariant states that for any <em>finite</em> interval <code>[start_time, end_time)</code> over the timescale <code>[t0, t1)</code>
of a presence matrix, the following invariant condition holds.</p>

<p>$$
    L = \Lambda \cdot w
$$
where</p>

<ul>
<li><strong>$L$</strong>: the average <em>presence</em> per unit time in the interval (see <code><a href="#PresenceInvariant.avg_presence_per_unit_time">avg_presence_per_unit_time</a></code>).</li>
<li><strong>$\Lambda$</strong>: The <em>flow rate</em> - a finite approximation of <em>presence arrival/departure rate</em> (see <code><a href="#PresenceInvariant.flow_rate">flow_rate</a></code>).</li>
<li><strong>$w$</strong>: The <em>residence time</em> - a finite approximation of <em>presence duration</em> (see <code>metamodel.presence.Presence.duration</code>).</li>
</ul>

<p>This invariant extends the classical formulation of Little’s Law, an equilibrium-based identity, by establishing a
conservation law (of presence) that remains valid across arbitrary timescales, and in non-linear, stochastic processes
that operate far from equilibrium.</p>

<p>It holds unconditionally for any presence matrix and finite window, and serves as a foundational
construct for reasoning about flow in non-linear systems.</p>

<p>The proof of this invariant is surprisingly simple and elementary.</p>

<p><strong>Derivation:</strong></p>

<p>Let $A$ be the total presence in the matrix over a finite time window <code>[start_time, end_time)</code> of $T$ time units.
Let $N$ be the number of distinct presences that overlap the window.</p>

<p>Let $R(p_i)$ be the portion of the duration of $p_i$ that overlaps the window. This is the <em>residence time</em> of $p_i$ in the window.</p>

<p>The following diagram shows these quantities and the derivation.</p>

<p><img src="../assets/pcalc/presence_invariant.png" alt="Presence Invariant" /></p>

<p>Then:</p>

<p>$$
A = \sum_{i=1}^{N} R(p_i)
$$
represents the sum of the elements in the presence matrix that foll in the time window <code>[start_time, end_time)</code>.</p>

<p>$A = 12$ presence-time-units in our example.</p>

<p>Average presence per unit time (see <code><a href="#PresenceInvariant.avg_presence_per_unit_time">avg_presence_per_unit_time</a></code>) is then:</p>

<p>$$
L = A/T
$$</p>

<p>$L = 3$ presences/time-unit in our example.</p>

<p>$w = $ Average residence time (see <code><a href="#PresenceInvariant.avg_residence_time">avg_residence_time</a></code>) is then:</p>

<p>$$
w = A/N
$$</p>

<p>$w=3 time units per presence in our example.</p>

<p>We will define the flow rate as (see <code><a href="#PresenceInvariant.flow_rate">flow_rate</a></code>):</p>

<p>$$
\Lambda = N/T
$$</p>

<p>$\Lambda = 1$ presence per time unit in our example.</p>

<p>Combining these:</p>

<p>$$
L = A/T = A/N \cdot N/T = N/T \cdot A/N = \Lambda \cdot w
$$</p>

<p>So we get</p>

<p>$$
L = \Lambda \cdot w
$$</p>

<p>This identity—what we call the <em>Presence Invariant</em>—is equivalent to a fundamental construct used in
all proofs of Little’s Law [1], and in particular, to one used by Stidham [2] to give a deterministic
proof of Little's Law [3] (see <code><a href="#PresenceInvariant.flow_rate">flow_rate</a></code>).</p>

<p>Both the classical and the current presence-based versions are instances of <em>Rate Conservation Laws</em>
(as described by Miyazawa [3]).</p>

<p>However, the conserved quantities differ <sup><a href="#fn1">1</a></sup>:</p>

<ul>
<li>In classical Little’s Law, $L = \lambda \cdot W$ holds <em>at equilibrium</em>, using long run arrival/departure rate $\lambda$ and
average presence duration $W$.</li>
<li>In the Presence Invariant, $L = \Lambda \cdot w$ holds <em>universally</em>, where $\Lambda$ and $w$ are finite window
<em>approximations</em> of true arrival/departure rate and  presence duration.</li>
</ul>

<p>Stidham [2] proved the relationship between the quantities in the two versions and showed that
the classical form of Little’s Law emerges as a limiting case of the finite-window identity
<em>provided</em> the system approaches equilibrium as the window grows larger - ie the system is <em>convergent</em> in the long run.</p>

<p>If the system is <em>divergent</em> in the long run, at least one of the three quantities grows without limit and
the conservation law in the classical version does not hold.</p>

<p>However, the presence invariant continues to hold regardless of whether the system is convergent or divergent.
More details can be found under <code><a href="#PresenceInvariant.flow_rate">flow_rate</a></code> and <code><a href="#PresenceInvariant.avg_residence_time">avg_residence_time</a></code>.</p>

<p>Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust
and widely applicable conservation construct for causal reasoning about flow in such systems.</p>

<small>
    <a name="fn1"><strong>[1]</strong></a>
    Note that we have lowercase $\lambda$ and uppercase $W$ in the classical law, and uppercase $\Lambda$ and
    lowercase $w$ in the finite-window version, whereas $L$ remains the same in both.

    This reflects the fact that in the Presence Invariant, $\Lambda$ is an overestimate of $\lambda$, and $w$
    is an underestimate of $W$. Both identities refer to the <em>same</em> observable construct for $L$.
</small>

<h2 id="references">References</h2>

<ol>
<li><p><strong>Little’s Law</strong>
Little, J. D. C. (2011). <em>Little’s Law as viewed on its 50th anniversary</em>. MIT.
<a href="https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf">https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf</a></p></li>
<li><p><strong>Stidham's Proof of Little's Law</strong>
Stidham, Shaler. Jr, <em>A last word on $L = \lambda \cdot W$</em>.Cornell University. 
[<a href="https://pubsonline.informs.org/doi/epdf/10.1287/opre.22.2.417]">https://pubsonline.informs.org/doi/epdf/10.1287/opre.22.2.417]</a></p></li>
<li><p><strong>Miyazawa on Rate Conservation Laws</strong>
Miyazawa, M. (1994). <em>Rate conservation laws: a survey</em>. Science University of Tokyo.
<a href="https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf">https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf</a></p></li>
</ol>
</div>


                            <div id="PresenceInvariant.__init__" class="classattr">
                                        <input id="PresenceInvariant.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PresenceInvariant</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">matrix</span><span class="p">:</span> <span class="n"><a href="#PresenceMatrix">PresenceMatrix</a></span></span>)</span>

                <label class="view-source-button" for="PresenceInvariant.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.__init__-153"><a href="#PresenceInvariant.__init__-153"><span class="linenos">153</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">PresenceMatrix</span><span class="p">):</span>
</span><span id="PresenceInvariant.__init__-154"><a href="#PresenceInvariant.__init__-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="PresenceInvariant.__init__-155"><a href="#PresenceInvariant.__init__-155"><span class="linenos">155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.__init__-156"><a href="#PresenceInvariant.__init__-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presences</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presences</span>
</span><span id="PresenceInvariant.__init__-157"><a href="#PresenceInvariant.__init__-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant.__init__-158"><a href="#PresenceInvariant.__init__-158"><span class="linenos">158</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.__init__-159"><a href="#PresenceInvariant.__init__-159"><span class="linenos">159</span></a>
</span><span id="PresenceInvariant.__init__-160"><a href="#PresenceInvariant.__init__-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.__init__-161"><a href="#PresenceInvariant.__init__-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant.__init__-162"><a href="#PresenceInvariant.__init__-162"><span class="linenos">162</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.__init__-163"><a href="#PresenceInvariant.__init__-163"><span class="linenos">163</span></a>
</span><span id="PresenceInvariant.__init__-164"><a href="#PresenceInvariant.__init__-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceInvariant.__init__-165"><a href="#PresenceInvariant.__init__-165"><span class="linenos">165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The timescale of the presence matrix. This is the default &#39;window&#39; over which all metrics are computed.&quot;&quot;&quot;</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.matrix" class="classattr">
                                <div class="attr variable">
            <span class="name">matrix</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.matrix"></a>
    
    

                            </div>
                            <div id="PresenceInvariant.presences" class="classattr">
                                <div class="attr variable">
            <span class="name">presences</span><span class="annotation">: list[<a href="#Presence">Presence</a>]</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.presences"></a>
    
            <div class="docstring"><p>Only presences that overlap the interval [t0, t1) are included in Presence Metrics.
Note however that this may include presences that started before the interval or ended after the interval.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.presence_map" class="classattr">
                                <div class="attr variable">
            <span class="name">presence_map</span><span class="annotation">: list[<a href="#PresenceMap">PresenceMap</a>]</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.presence_map"></a>
    
            <div class="docstring"><p>Only presences that overlap the interval [t0, t1) are included in Presence Metrics.
Note however that this may include presences that started before the interval or ended after the interval.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.ts" class="classattr">
                                <div class="attr variable">
            <span class="name">ts</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.ts"></a>
    
            <div class="docstring"><p>The timescale of the presence matrix. This is the default 'window' over which all metrics are computed.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.flow_rate" class="classattr">
                                        <input id="PresenceInvariant.flow_rate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">flow_rate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.flow_rate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.flow_rate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.flow_rate-179"><a href="#PresenceInvariant.flow_rate-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flow_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant.flow_rate-180"><a href="#PresenceInvariant.flow_rate-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.flow_rate-181"><a href="#PresenceInvariant.flow_rate-181"><span class="linenos">181</span></a><span class="sd">        The flow rate Λ is defined as:</span>
</span><span id="PresenceInvariant.flow_rate-182"><a href="#PresenceInvariant.flow_rate-182"><span class="linenos">182</span></a><span class="sd">            number of active presences in the matrix slice [:start_bin:end_bin] /</span>
</span><span id="PresenceInvariant.flow_rate-183"><a href="#PresenceInvariant.flow_rate-183"><span class="linenos">183</span></a><span class="sd">            number of time bins in the slice (end_bin - start_bin)</span>
</span><span id="PresenceInvariant.flow_rate-184"><a href="#PresenceInvariant.flow_rate-184"><span class="linenos">184</span></a>
</span><span id="PresenceInvariant.flow_rate-185"><a href="#PresenceInvariant.flow_rate-185"><span class="linenos">185</span></a><span class="sd">        Conceptually:</span>
</span><span id="PresenceInvariant.flow_rate-186"><a href="#PresenceInvariant.flow_rate-186"><span class="linenos">186</span></a><span class="sd">            Let N be the number of presences (rows) that are active (non-zero)</span>
</span><span id="PresenceInvariant.flow_rate-187"><a href="#PresenceInvariant.flow_rate-187"><span class="linenos">187</span></a><span class="sd">            in the matrix between start_time and end_time.</span>
</span><span id="PresenceInvariant.flow_rate-188"><a href="#PresenceInvariant.flow_rate-188"><span class="linenos">188</span></a>
</span><span id="PresenceInvariant.flow_rate-189"><a href="#PresenceInvariant.flow_rate-189"><span class="linenos">189</span></a><span class="sd">            Let T be the number of discrete time bins (columns) in that interval.</span>
</span><span id="PresenceInvariant.flow_rate-190"><a href="#PresenceInvariant.flow_rate-190"><span class="linenos">190</span></a>
</span><span id="PresenceInvariant.flow_rate-191"><a href="#PresenceInvariant.flow_rate-191"><span class="linenos">191</span></a><span class="sd">            Then:</span>
</span><span id="PresenceInvariant.flow_rate-192"><a href="#PresenceInvariant.flow_rate-192"><span class="linenos">192</span></a><span class="sd">                flow_rate = Λ = N / T</span>
</span><span id="PresenceInvariant.flow_rate-193"><a href="#PresenceInvariant.flow_rate-193"><span class="linenos">193</span></a>
</span><span id="PresenceInvariant.flow_rate-194"><a href="#PresenceInvariant.flow_rate-194"><span class="linenos">194</span></a><span class="sd">        Examples:</span>
</span><span id="PresenceInvariant.flow_rate-195"><a href="#PresenceInvariant.flow_rate-195"><span class="linenos">195</span></a><span class="sd">            - If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</span>
</span><span id="PresenceInvariant.flow_rate-196"><a href="#PresenceInvariant.flow_rate-196"><span class="linenos">196</span></a><span class="sd">            - If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</span>
</span><span id="PresenceInvariant.flow_rate-197"><a href="#PresenceInvariant.flow_rate-197"><span class="linenos">197</span></a>
</span><span id="PresenceInvariant.flow_rate-198"><a href="#PresenceInvariant.flow_rate-198"><span class="linenos">198</span></a><span class="sd">        The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.</span>
</span><span id="PresenceInvariant.flow_rate-199"><a href="#PresenceInvariant.flow_rate-199"><span class="linenos">199</span></a><span class="sd">        The precise relationship between flow rate, arrival rate, and departure rate is as follows:</span>
</span><span id="PresenceInvariant.flow_rate-200"><a href="#PresenceInvariant.flow_rate-200"><span class="linenos">200</span></a>
</span><span id="PresenceInvariant.flow_rate-201"><a href="#PresenceInvariant.flow_rate-201"><span class="linenos">201</span></a><span class="sd">            N = number of presences that started *before* start_time (see `starting_presence_count`)</span>
</span><span id="PresenceInvariant.flow_rate-202"><a href="#PresenceInvariant.flow_rate-202"><span class="linenos">202</span></a><span class="sd">                + number that started *in* the interval [start_time, end_time) (see `arrival_count`)</span>
</span><span id="PresenceInvariant.flow_rate-203"><a href="#PresenceInvariant.flow_rate-203"><span class="linenos">203</span></a>
</span><span id="PresenceInvariant.flow_rate-204"><a href="#PresenceInvariant.flow_rate-204"><span class="linenos">204</span></a><span class="sd">              — this is also called the cumulative arrivals into the window</span>
</span><span id="PresenceInvariant.flow_rate-205"><a href="#PresenceInvariant.flow_rate-205"><span class="linenos">205</span></a>
</span><span id="PresenceInvariant.flow_rate-206"><a href="#PresenceInvariant.flow_rate-206"><span class="linenos">206</span></a><span class="sd">            or equivalently:</span>
</span><span id="PresenceInvariant.flow_rate-207"><a href="#PresenceInvariant.flow_rate-207"><span class="linenos">207</span></a>
</span><span id="PresenceInvariant.flow_rate-208"><a href="#PresenceInvariant.flow_rate-208"><span class="linenos">208</span></a><span class="sd">            N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)</span>
</span><span id="PresenceInvariant.flow_rate-209"><a href="#PresenceInvariant.flow_rate-209"><span class="linenos">209</span></a><span class="sd">                + number that ended *after* end_time (see `ending_presence_count`)</span>
</span><span id="PresenceInvariant.flow_rate-210"><a href="#PresenceInvariant.flow_rate-210"><span class="linenos">210</span></a>
</span><span id="PresenceInvariant.flow_rate-211"><a href="#PresenceInvariant.flow_rate-211"><span class="linenos">211</span></a><span class="sd">              — this is the departure contribution from the window</span>
</span><span id="PresenceInvariant.flow_rate-212"><a href="#PresenceInvariant.flow_rate-212"><span class="linenos">212</span></a>
</span><span id="PresenceInvariant.flow_rate-213"><a href="#PresenceInvariant.flow_rate-213"><span class="linenos">213</span></a><span class="sd">            These two decompositions of N are always equal; they just reflect different</span>
</span><span id="PresenceInvariant.flow_rate-214"><a href="#PresenceInvariant.flow_rate-214"><span class="linenos">214</span></a><span class="sd">            ways of expressing the same set of active presences.</span>
</span><span id="PresenceInvariant.flow_rate-215"><a href="#PresenceInvariant.flow_rate-215"><span class="linenos">215</span></a>
</span><span id="PresenceInvariant.flow_rate-216"><a href="#PresenceInvariant.flow_rate-216"><span class="linenos">216</span></a><span class="sd">        Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant.flow_rate-217"><a href="#PresenceInvariant.flow_rate-217"><span class="linenos">217</span></a><span class="sd">        will start and end within the window, with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant.flow_rate-218"><a href="#PresenceInvariant.flow_rate-218"><span class="linenos">218</span></a><span class="sd">        the interval at the beginning and end.</span>
</span><span id="PresenceInvariant.flow_rate-219"><a href="#PresenceInvariant.flow_rate-219"><span class="linenos">219</span></a>
</span><span id="PresenceInvariant.flow_rate-220"><a href="#PresenceInvariant.flow_rate-220"><span class="linenos">220</span></a><span class="sd">        This makes N an (over) estimate of true arrivals or departures over that interval.</span>
</span><span id="PresenceInvariant.flow_rate-221"><a href="#PresenceInvariant.flow_rate-221"><span class="linenos">221</span></a>
</span><span id="PresenceInvariant.flow_rate-222"><a href="#PresenceInvariant.flow_rate-222"><span class="linenos">222</span></a><span class="sd">        In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant.flow_rate-223"><a href="#PresenceInvariant.flow_rate-223"><span class="linenos">223</span></a><span class="sd">        then:</span>
</span><span id="PresenceInvariant.flow_rate-224"><a href="#PresenceInvariant.flow_rate-224"><span class="linenos">224</span></a><span class="sd">            flow_rate → arrival_rate → departure_rate</span>
</span><span id="PresenceInvariant.flow_rate-225"><a href="#PresenceInvariant.flow_rate-225"><span class="linenos">225</span></a>
</span><span id="PresenceInvariant.flow_rate-226"><a href="#PresenceInvariant.flow_rate-226"><span class="linenos">226</span></a><span class="sd">        When flow is fully convergent over the interval, then:</span>
</span><span id="PresenceInvariant.flow_rate-227"><a href="#PresenceInvariant.flow_rate-227"><span class="linenos">227</span></a><span class="sd">            flow_rate = arrival_rate = departure_rate</span>
</span><span id="PresenceInvariant.flow_rate-228"><a href="#PresenceInvariant.flow_rate-228"><span class="linenos">228</span></a>
</span><span id="PresenceInvariant.flow_rate-229"><a href="#PresenceInvariant.flow_rate-229"><span class="linenos">229</span></a><span class="sd">        This equality is one of the key conditions for *stable* flow through the boundary.</span>
</span><span id="PresenceInvariant.flow_rate-230"><a href="#PresenceInvariant.flow_rate-230"><span class="linenos">230</span></a>
</span><span id="PresenceInvariant.flow_rate-231"><a href="#PresenceInvariant.flow_rate-231"><span class="linenos">231</span></a><span class="sd">        On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant.flow_rate-232"><a href="#PresenceInvariant.flow_rate-232"><span class="linenos">232</span></a><span class="sd">        flow rate, arrival rate, and departure rate will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant.flow_rate-233"><a href="#PresenceInvariant.flow_rate-233"><span class="linenos">233</span></a><span class="sd">        or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant.flow_rate-234"><a href="#PresenceInvariant.flow_rate-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.flow_rate-235"><a href="#PresenceInvariant.flow_rate-235"><span class="linenos">235</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.flow_rate-236"><a href="#PresenceInvariant.flow_rate-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">number_of_presences</span><span class="o">/</span><span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>The flow rate Λ is defined as:
    number of active presences in the matrix slice [:start_bin:end_bin] /
    number of time bins in the slice (end_bin - start_bin)</p>

<h6 id="conceptually">Conceptually:</h6>

<blockquote>
  <p>Let N be the number of presences (rows) that are active (non-zero)
  in the matrix between start_time and end_time.</p>
  
  <p>Let T be the number of discrete time bins (columns) in that interval.</p>
  
  <p>Then:
      flow_rate = Λ = N / T</p>
</blockquote>

<h6 id="examples">Examples:</h6>

<blockquote>
  <ul>
  <li>If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</li>
  <li>If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</li>
  </ul>
</blockquote>

<p>The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.
The precise relationship between flow rate, arrival rate, and departure rate is as follows:</p>

<pre><code>N = number of presences that started *before* start_time (see `starting_presence_count`)
    + number that started *in* the interval [start_time, end_time) (see `arrival_count`)

  — this is also called the cumulative arrivals into the window

or equivalently:

N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)
    + number that ended *after* end_time (see `ending_presence_count`)

  — this is the departure contribution from the window

These two decompositions of N are always equal; they just reflect different
ways of expressing the same set of active presences.
</code></pre>

<p>Intuitively, over a long enough window, if flow converges, most presences
will start and end within the window, with fewer presences that partially overlap
the interval at the beginning and end.</p>

<p>This makes N an (over) estimate of true arrivals or departures over that interval.</p>

<p>In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),
then:
    flow_rate → arrival_rate → departure_rate</p>

<p>When flow is fully convergent over the interval, then:
    flow_rate = arrival_rate = departure_rate</p>

<p>This equality is one of the key conditions for <em>stable</em> flow through the boundary.</p>

<p>On the other hand, if flow is not convergent over the interval, the delta between
flow rate, arrival rate, and departure rate will be large — either increasing (divergent)
or decreasing (convergent) over time.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.avg_residence_time" class="classattr">
                                        <input id="PresenceInvariant.avg_residence_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avg_residence_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.avg_residence_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.avg_residence_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.avg_residence_time-238"><a href="#PresenceInvariant.avg_residence_time-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_residence_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant.avg_residence_time-239"><a href="#PresenceInvariant.avg_residence_time-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_residence_time-240"><a href="#PresenceInvariant.avg_residence_time-240"><span class="linenos">240</span></a><span class="sd">            Computes the average residence time over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant.avg_residence_time-241"><a href="#PresenceInvariant.avg_residence_time-241"><span class="linenos">241</span></a>
</span><span id="PresenceInvariant.avg_residence_time-242"><a href="#PresenceInvariant.avg_residence_time-242"><span class="linenos">242</span></a><span class="sd">            Let \$ P \$ be the set of presences that overlap the interval \$[\\text{start\\_time}, \\text{end\\_time})\$.</span>
</span><span id="PresenceInvariant.avg_residence_time-243"><a href="#PresenceInvariant.avg_residence_time-243"><span class="linenos">243</span></a>
</span><span id="PresenceInvariant.avg_residence_time-244"><a href="#PresenceInvariant.avg_residence_time-244"><span class="linenos">244</span></a><span class="sd">            The *residence time* \$ R(p) \$ is the time that presence \$ p \\in P \$ is active (overlaps) within that interval.</span>
</span><span id="PresenceInvariant.avg_residence_time-245"><a href="#PresenceInvariant.avg_residence_time-245"><span class="linenos">245</span></a>
</span><span id="PresenceInvariant.avg_residence_time-246"><a href="#PresenceInvariant.avg_residence_time-246"><span class="linenos">246</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant.avg_residence_time-247"><a href="#PresenceInvariant.avg_residence_time-247"><span class="linenos">247</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant.avg_residence_time-248"><a href="#PresenceInvariant.avg_residence_time-248"><span class="linenos">248</span></a>
</span><span id="PresenceInvariant.avg_residence_time-249"><a href="#PresenceInvariant.avg_residence_time-249"><span class="linenos">249</span></a><span class="sd">            The average residence time \$ w \$ is given by:</span>
</span><span id="PresenceInvariant.avg_residence_time-250"><a href="#PresenceInvariant.avg_residence_time-250"><span class="linenos">250</span></a>
</span><span id="PresenceInvariant.avg_residence_time-251"><a href="#PresenceInvariant.avg_residence_time-251"><span class="linenos">251</span></a><span class="sd">            \$$</span>
</span><span id="PresenceInvariant.avg_residence_time-252"><a href="#PresenceInvariant.avg_residence_time-252"><span class="linenos">252</span></a><span class="sd">            w = \\frac{\\sum_{p \\in P} R(p)}{|P|}</span>
</span><span id="PresenceInvariant.avg_residence_time-253"><a href="#PresenceInvariant.avg_residence_time-253"><span class="linenos">253</span></a><span class="sd">            \$$</span>
</span><span id="PresenceInvariant.avg_residence_time-254"><a href="#PresenceInvariant.avg_residence_time-254"><span class="linenos">254</span></a>
</span><span id="PresenceInvariant.avg_residence_time-255"><a href="#PresenceInvariant.avg_residence_time-255"><span class="linenos">255</span></a><span class="sd">            If no presences are active in the interval, \$ w = 0.0 \$.</span>
</span><span id="PresenceInvariant.avg_residence_time-256"><a href="#PresenceInvariant.avg_residence_time-256"><span class="linenos">256</span></a>
</span><span id="PresenceInvariant.avg_residence_time-257"><a href="#PresenceInvariant.avg_residence_time-257"><span class="linenos">257</span></a><span class="sd">            Note:</span>
</span><span id="PresenceInvariant.avg_residence_time-258"><a href="#PresenceInvariant.avg_residence_time-258"><span class="linenos">258</span></a><span class="sd">                There are four possible ways a presence can overlap a window [start, end):</span>
</span><span id="PresenceInvariant.avg_residence_time-259"><a href="#PresenceInvariant.avg_residence_time-259"><span class="linenos">259</span></a>
</span><span id="PresenceInvariant.avg_residence_time-260"><a href="#PresenceInvariant.avg_residence_time-260"><span class="linenos">260</span></a><span class="sd">                Ticks:     0   1   2   3   4   5   6   7</span>
</span><span id="PresenceInvariant.avg_residence_time-261"><a href="#PresenceInvariant.avg_residence_time-261"><span class="linenos">261</span></a><span class="sd">                           |---|---|---|---|---|---|---|</span>
</span><span id="PresenceInvariant.avg_residence_time-262"><a href="#PresenceInvariant.avg_residence_time-262"><span class="linenos">262</span></a><span class="sd">                Window:          |-----------|</span>
</span><span id="PresenceInvariant.avg_residence_time-263"><a href="#PresenceInvariant.avg_residence_time-263"><span class="linenos">263</span></a>
</span><span id="PresenceInvariant.avg_residence_time-264"><a href="#PresenceInvariant.avg_residence_time-264"><span class="linenos">264</span></a><span class="sd">                Case 1: Fully inside</span>
</span><span id="PresenceInvariant.avg_residence_time-265"><a href="#PresenceInvariant.avg_residence_time-265"><span class="linenos">265</span></a><span class="sd">                                     [=======]</span>
</span><span id="PresenceInvariant.avg_residence_time-266"><a href="#PresenceInvariant.avg_residence_time-266"><span class="linenos">266</span></a>
</span><span id="PresenceInvariant.avg_residence_time-267"><a href="#PresenceInvariant.avg_residence_time-267"><span class="linenos">267</span></a><span class="sd">                Case 2: Starts before, ends inside</span>
</span><span id="PresenceInvariant.avg_residence_time-268"><a href="#PresenceInvariant.avg_residence_time-268"><span class="linenos">268</span></a><span class="sd">                              [===========</span>
</span><span id="PresenceInvariant.avg_residence_time-269"><a href="#PresenceInvariant.avg_residence_time-269"><span class="linenos">269</span></a>
</span><span id="PresenceInvariant.avg_residence_time-270"><a href="#PresenceInvariant.avg_residence_time-270"><span class="linenos">270</span></a><span class="sd">                Case 3: Starts inside, ends after</span>
</span><span id="PresenceInvariant.avg_residence_time-271"><a href="#PresenceInvariant.avg_residence_time-271"><span class="linenos">271</span></a><span class="sd">                                     ===========]</span>
</span><span id="PresenceInvariant.avg_residence_time-272"><a href="#PresenceInvariant.avg_residence_time-272"><span class="linenos">272</span></a>
</span><span id="PresenceInvariant.avg_residence_time-273"><a href="#PresenceInvariant.avg_residence_time-273"><span class="linenos">273</span></a><span class="sd">                Case 4: Fully spans window</span>
</span><span id="PresenceInvariant.avg_residence_time-274"><a href="#PresenceInvariant.avg_residence_time-274"><span class="linenos">274</span></a><span class="sd">                              [====================]</span>
</span><span id="PresenceInvariant.avg_residence_time-275"><a href="#PresenceInvariant.avg_residence_time-275"><span class="linenos">275</span></a>
</span><span id="PresenceInvariant.avg_residence_time-276"><a href="#PresenceInvariant.avg_residence_time-276"><span class="linenos">276</span></a><span class="sd">                In all but Case 1, the window clips the presence, so the residence time</span>
</span><span id="PresenceInvariant.avg_residence_time-277"><a href="#PresenceInvariant.avg_residence_time-277"><span class="linenos">277</span></a><span class="sd">                is smaller than the presence duration. In Case 1, residence time equals presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time-278"><a href="#PresenceInvariant.avg_residence_time-278"><span class="linenos">278</span></a>
</span><span id="PresenceInvariant.avg_residence_time-279"><a href="#PresenceInvariant.avg_residence_time-279"><span class="linenos">279</span></a><span class="sd">                Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant.avg_residence_time-280"><a href="#PresenceInvariant.avg_residence_time-280"><span class="linenos">280</span></a><span class="sd">                will start and end within the window (Case 1), with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant.avg_residence_time-281"><a href="#PresenceInvariant.avg_residence_time-281"><span class="linenos">281</span></a><span class="sd">                the interval at the beginning and end or span the window (Cases 2–4).</span>
</span><span id="PresenceInvariant.avg_residence_time-282"><a href="#PresenceInvariant.avg_residence_time-282"><span class="linenos">282</span></a>
</span><span id="PresenceInvariant.avg_residence_time-283"><a href="#PresenceInvariant.avg_residence_time-283"><span class="linenos">283</span></a><span class="sd">                This makes \$ w \$ an (under)estimate of true presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time-284"><a href="#PresenceInvariant.avg_residence_time-284"><span class="linenos">284</span></a>
</span><span id="PresenceInvariant.avg_residence_time-285"><a href="#PresenceInvariant.avg_residence_time-285"><span class="linenos">285</span></a><span class="sd">                In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant.avg_residence_time-286"><a href="#PresenceInvariant.avg_residence_time-286"><span class="linenos">286</span></a><span class="sd">                then:</span>
</span><span id="PresenceInvariant.avg_residence_time-287"><a href="#PresenceInvariant.avg_residence_time-287"><span class="linenos">287</span></a><span class="sd">                    residence time → presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time-288"><a href="#PresenceInvariant.avg_residence_time-288"><span class="linenos">288</span></a>
</span><span id="PresenceInvariant.avg_residence_time-289"><a href="#PresenceInvariant.avg_residence_time-289"><span class="linenos">289</span></a><span class="sd">                When flow is fully convergent over the interval:</span>
</span><span id="PresenceInvariant.avg_residence_time-290"><a href="#PresenceInvariant.avg_residence_time-290"><span class="linenos">290</span></a><span class="sd">                    residence time = presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time-291"><a href="#PresenceInvariant.avg_residence_time-291"><span class="linenos">291</span></a>
</span><span id="PresenceInvariant.avg_residence_time-292"><a href="#PresenceInvariant.avg_residence_time-292"><span class="linenos">292</span></a><span class="sd">                On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant.avg_residence_time-293"><a href="#PresenceInvariant.avg_residence_time-293"><span class="linenos">293</span></a><span class="sd">                residence time and presence duration will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant.avg_residence_time-294"><a href="#PresenceInvariant.avg_residence_time-294"><span class="linenos">294</span></a><span class="sd">                or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant.avg_residence_time-295"><a href="#PresenceInvariant.avg_residence_time-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_residence_time-296"><a href="#PresenceInvariant.avg_residence_time-296"><span class="linenos">296</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.avg_residence_time-297"><a href="#PresenceInvariant.avg_residence_time-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Computes the average residence time over the interval [start_time, end_time).</p>

<p>Let \$ P \$ be the set of presences that overlap the interval \$[\text{start_time}, \text{end_time})\$.</p>

<p>The <em>residence time</em> \$ R(p) \$ is the time that presence \$ p \in P \$ is active (overlaps) within that interval.</p>

<p>Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only
partially cover a bin.</p>

<p>The average residence time \$ w \$ is given by:</p>

<p>\$$
w = \frac{\sum_{p \in P} R(p)}{|P|}
\$$</p>

<p>If no presences are active in the interval, \$ w = 0.0 \$.</p>

<h6 id="note">Note:</h6>

<blockquote>
  <p>There are four possible ways a presence can overlap a window [start, end):</p>
  
  <p>Ticks:     0   1   2   3   4   5   6   7
             |---|---|---|---|---|---|---|
  Window:          |-----------|</p>
  
  <p>Case 1: Fully inside
                       [=======]</p>
  
  <p>Case 2: Starts before, ends inside
                [===========</p>
  
  <p>Case 3: Starts inside, ends after
                       ===========]</p>
  
  <p>Case 4: Fully spans window
                [====================]</p>
  
  <p>In all but Case 1, the window clips the presence, so the residence time
  is smaller than the presence duration. In Case 1, residence time equals presence duration.</p>
  
  <p>Intuitively, over a long enough window, if flow converges, most presences
  will start and end within the window (Case 1), with fewer presences that partially overlap
  the interval at the beginning and end or span the window (Cases 2–4).</p>
  
  <p>This makes \$ w \$ an (under)estimate of true presence duration.</p>
  
  <p>In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),
  then:
      residence time → presence duration.</p>
  
  <p>When flow is fully convergent over the interval:
      residence time = presence duration.</p>
  
  <p>On the other hand, if flow is not convergent over the interval, the delta between
  residence time and presence duration will be large — either increasing (divergent)
  or decreasing (convergent) over time.</p>
</blockquote>
</div>


                            </div>
                            <div id="PresenceInvariant.avg_presence_per_unit_time" class="classattr">
                                        <input id="PresenceInvariant.avg_presence_per_unit_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avg_presence_per_unit_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.avg_presence_per_unit_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.avg_presence_per_unit_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.avg_presence_per_unit_time-299"><a href="#PresenceInvariant.avg_presence_per_unit_time-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_presence_per_unit_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-300"><a href="#PresenceInvariant.avg_presence_per_unit_time-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-301"><a href="#PresenceInvariant.avg_presence_per_unit_time-301"><span class="linenos">301</span></a><span class="sd">        Computes the average presence per time bin over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-302"><a href="#PresenceInvariant.avg_presence_per_unit_time-302"><span class="linenos">302</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-303"><a href="#PresenceInvariant.avg_presence_per_unit_time-303"><span class="linenos">303</span></a><span class="sd">        Let \$ B \$ be the set of discrete time bins that cover the interval \$[\\text{start\\_time}, \\text{end\\_time})\$,</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-304"><a href="#PresenceInvariant.avg_presence_per_unit_time-304"><span class="linenos">304</span></a><span class="sd">        and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \\in B \$.</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-305"><a href="#PresenceInvariant.avg_presence_per_unit_time-305"><span class="linenos">305</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-306"><a href="#PresenceInvariant.avg_presence_per_unit_time-306"><span class="linenos">306</span></a><span class="sd">        The average presence \$ L \$ is given by:</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-307"><a href="#PresenceInvariant.avg_presence_per_unit_time-307"><span class="linenos">307</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-308"><a href="#PresenceInvariant.avg_presence_per_unit_time-308"><span class="linenos">308</span></a><span class="sd">        \$$</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-309"><a href="#PresenceInvariant.avg_presence_per_unit_time-309"><span class="linenos">309</span></a><span class="sd">        L = \\frac{\\sum_{b \\in B} P(b)}{|B|}</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-310"><a href="#PresenceInvariant.avg_presence_per_unit_time-310"><span class="linenos">310</span></a><span class="sd">        \$$</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-311"><a href="#PresenceInvariant.avg_presence_per_unit_time-311"><span class="linenos">311</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-312"><a href="#PresenceInvariant.avg_presence_per_unit_time-312"><span class="linenos">312</span></a><span class="sd">        If the interval spans no bins, \$ L = 0.0 \$.</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-313"><a href="#PresenceInvariant.avg_presence_per_unit_time-313"><span class="linenos">313</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-314"><a href="#PresenceInvariant.avg_presence_per_unit_time-314"><span class="linenos">314</span></a><span class="sd">        Note:</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-315"><a href="#PresenceInvariant.avg_presence_per_unit_time-315"><span class="linenos">315</span></a><span class="sd">            This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-316"><a href="#PresenceInvariant.avg_presence_per_unit_time-316"><span class="linenos">316</span></a><span class="sd">            durations we used to compute residence time) divided by the number of bins in the interval.</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-317"><a href="#PresenceInvariant.avg_presence_per_unit_time-317"><span class="linenos">317</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-318"><a href="#PresenceInvariant.avg_presence_per_unit_time-318"><span class="linenos">318</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-319"><a href="#PresenceInvariant.avg_presence_per_unit_time-319"><span class="linenos">319</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-320"><a href="#PresenceInvariant.avg_presence_per_unit_time-320"><span class="linenos">320</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-321"><a href="#PresenceInvariant.avg_presence_per_unit_time-321"><span class="linenos">321</span></a><span class="sd">            Visually, this corresponds to summing presence *vertically* across bins:</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-322"><a href="#PresenceInvariant.avg_presence_per_unit_time-322"><span class="linenos">322</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-323"><a href="#PresenceInvariant.avg_presence_per_unit_time-323"><span class="linenos">323</span></a><span class="sd">            Example: presences over time bins</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-324"><a href="#PresenceInvariant.avg_presence_per_unit_time-324"><span class="linenos">324</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-325"><a href="#PresenceInvariant.avg_presence_per_unit_time-325"><span class="linenos">325</span></a><span class="sd">            Ticks:     0   1   2   3   4</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-326"><a href="#PresenceInvariant.avg_presence_per_unit_time-326"><span class="linenos">326</span></a><span class="sd">                       |---|---|---|---|</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-327"><a href="#PresenceInvariant.avg_presence_per_unit_time-327"><span class="linenos">327</span></a><span class="sd">            P1:         [=======]</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-328"><a href="#PresenceInvariant.avg_presence_per_unit_time-328"><span class="linenos">328</span></a><span class="sd">            P2:             [=======]</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-329"><a href="#PresenceInvariant.avg_presence_per_unit_time-329"><span class="linenos">329</span></a><span class="sd">            P3:                 [=======]</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-330"><a href="#PresenceInvariant.avg_presence_per_unit_time-330"><span class="linenos">330</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-331"><a href="#PresenceInvariant.avg_presence_per_unit_time-331"><span class="linenos">331</span></a><span class="sd">            Time bin 1:</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-332"><a href="#PresenceInvariant.avg_presence_per_unit_time-332"><span class="linenos">332</span></a><span class="sd">                          ↑   (bin index 1 = [1, 2))</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-333"><a href="#PresenceInvariant.avg_presence_per_unit_time-333"><span class="linenos">333</span></a><span class="sd">                          |---|</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-334"><a href="#PresenceInvariant.avg_presence_per_unit_time-334"><span class="linenos">334</span></a><span class="sd">                      P1:   +</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-335"><a href="#PresenceInvariant.avg_presence_per_unit_time-335"><span class="linenos">335</span></a><span class="sd">                      P2:   +</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-336"><a href="#PresenceInvariant.avg_presence_per_unit_time-336"><span class="linenos">336</span></a><span class="sd">                      P3:   -</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-337"><a href="#PresenceInvariant.avg_presence_per_unit_time-337"><span class="linenos">337</span></a><span class="sd">                    ---------</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-338"><a href="#PresenceInvariant.avg_presence_per_unit_time-338"><span class="linenos">338</span></a><span class="sd">                    Sum:     2</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-339"><a href="#PresenceInvariant.avg_presence_per_unit_time-339"><span class="linenos">339</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-340"><a href="#PresenceInvariant.avg_presence_per_unit_time-340"><span class="linenos">340</span></a><span class="sd">            So:</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-341"><a href="#PresenceInvariant.avg_presence_per_unit_time-341"><span class="linenos">341</span></a><span class="sd">                - Bin 1 has total presence = 2</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-342"><a href="#PresenceInvariant.avg_presence_per_unit_time-342"><span class="linenos">342</span></a><span class="sd">                - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-343"><a href="#PresenceInvariant.avg_presence_per_unit_time-343"><span class="linenos">343</span></a><span class="sd">                - Then \$ L = 5.5 / 3 = 1.833... \$</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-344"><a href="#PresenceInvariant.avg_presence_per_unit_time-344"><span class="linenos">344</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-345"><a href="#PresenceInvariant.avg_presence_per_unit_time-345"><span class="linenos">345</span></a><span class="sd">            Conceptually, \$ L \$ reflects the average &quot;load&quot; or concurrency of presence in the system during the interval.</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-346"><a href="#PresenceInvariant.avg_presence_per_unit_time-346"><span class="linenos">346</span></a>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-347"><a href="#PresenceInvariant.avg_presence_per_unit_time-347"><span class="linenos">347</span></a><span class="sd">            This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-348"><a href="#PresenceInvariant.avg_presence_per_unit_time-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-349"><a href="#PresenceInvariant.avg_presence_per_unit_time-349"><span class="linenos">349</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.avg_presence_per_unit_time-350"><a href="#PresenceInvariant.avg_presence_per_unit_time-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Computes the average presence per time bin over the interval [start_time, end_time).</p>

<p>Let \$ B \$ be the set of discrete time bins that cover the interval \$[\text{start_time}, \text{end_time})\$,
and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \in B \$.</p>

<p>The average presence \$ L \$ is given by:</p>

<p>\$$
L = \frac{\sum_{b \in B} P(b)}{|B|}
\$$</p>

<p>If the interval spans no bins, \$ L = 0.0 \$.</p>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence
  durations we used to compute residence time) divided by the number of bins in the interval.</p>
  
  <p>Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only
  partially cover a bin.</p>
  
  <p>Visually, this corresponds to summing presence <em>vertically</em> across bins:</p>
  
  <p>Example: presences over time bins</p>
  
  <p>Ticks:     0   1   2   3   4
             |---|---|---|---|
  P1:         [=======]
  P2:             [=======]
  P3:                 [=======]</p>
  
  <p>Time bin 1:
                ↑   (bin index 1 = [1, 2))
                |---|
            P1:   +
            P2:   +
            P3:   -
          ---------
          Sum:     2</p>
  
  <p>So:
      - Bin 1 has total presence = 2
      - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5
      - Then \$ L = 5.5 / 3 = 1.833... \$</p>
  
  <p>Conceptually, \$ L \$ reflects the average "load" or concurrency of presence in the system during the interval.</p>
  
  <p>This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</p>
</blockquote>
</div>


                            </div>
                            <div id="PresenceInvariant.get_presence_summary" class="classattr">
                                        <input id="PresenceInvariant.get_presence_summary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_presence_summary</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.get_presence_summary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.get_presence_summary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.get_presence_summary-352"><a href="#PresenceInvariant.get_presence_summary-352"><span class="linenos">352</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant.get_presence_summary-353"><a href="#PresenceInvariant.get_presence_summary-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_summary-354"><a href="#PresenceInvariant.get_presence_summary-354"><span class="linenos">354</span></a><span class="sd">            Computes the three core quantities from which all presence-based metrics are derived:</span>
</span><span id="PresenceInvariant.get_presence_summary-355"><a href="#PresenceInvariant.get_presence_summary-355"><span class="linenos">355</span></a>
</span><span id="PresenceInvariant.get_presence_summary-356"><a href="#PresenceInvariant.get_presence_summary-356"><span class="linenos">356</span></a><span class="sd">            - Total presence time \$ A \$ over the interval \$[\\text{start\\_time}, \\text{end\\_time})\$</span>
</span><span id="PresenceInvariant.get_presence_summary-357"><a href="#PresenceInvariant.get_presence_summary-357"><span class="linenos">357</span></a><span class="sd">            - Number of active presences \$ N \$ (i.e., rows overlapping the interval)</span>
</span><span id="PresenceInvariant.get_presence_summary-358"><a href="#PresenceInvariant.get_presence_summary-358"><span class="linenos">358</span></a><span class="sd">            - Number of time bins \$ T \$ covering the interval</span>
</span><span id="PresenceInvariant.get_presence_summary-359"><a href="#PresenceInvariant.get_presence_summary-359"><span class="linenos">359</span></a>
</span><span id="PresenceInvariant.get_presence_summary-360"><a href="#PresenceInvariant.get_presence_summary-360"><span class="linenos">360</span></a><span class="sd">            These three values form the basis for computing:</span>
</span><span id="PresenceInvariant.get_presence_summary-361"><a href="#PresenceInvariant.get_presence_summary-361"><span class="linenos">361</span></a>
</span><span id="PresenceInvariant.get_presence_summary-362"><a href="#PresenceInvariant.get_presence_summary-362"><span class="linenos">362</span></a><span class="sd">            - Average presence per time bin: \$ L = A / T \$</span>
</span><span id="PresenceInvariant.get_presence_summary-363"><a href="#PresenceInvariant.get_presence_summary-363"><span class="linenos">363</span></a><span class="sd">            - Average residence time per presence: \$ w = A / N \$</span>
</span><span id="PresenceInvariant.get_presence_summary-364"><a href="#PresenceInvariant.get_presence_summary-364"><span class="linenos">364</span></a><span class="sd">            - Flow rate: \$ \\Lambda = N / T \$</span>
</span><span id="PresenceInvariant.get_presence_summary-365"><a href="#PresenceInvariant.get_presence_summary-365"><span class="linenos">365</span></a>
</span><span id="PresenceInvariant.get_presence_summary-366"><a href="#PresenceInvariant.get_presence_summary-366"><span class="linenos">366</span></a><span class="sd">            This method is the common workhorse that underlies `avg_presence_per_time_bin`,</span>
</span><span id="PresenceInvariant.get_presence_summary-367"><a href="#PresenceInvariant.get_presence_summary-367"><span class="linenos">367</span></a><span class="sd">            `avg_residence_time_per_presence`, and `flow_rate`.</span>
</span><span id="PresenceInvariant.get_presence_summary-368"><a href="#PresenceInvariant.get_presence_summary-368"><span class="linenos">368</span></a>
</span><span id="PresenceInvariant.get_presence_summary-369"><a href="#PresenceInvariant.get_presence_summary-369"><span class="linenos">369</span></a><span class="sd">            ... and much of this work lives in `PresenceMap.presence_value_in`</span>
</span><span id="PresenceInvariant.get_presence_summary-370"><a href="#PresenceInvariant.get_presence_summary-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_summary-371"><a href="#PresenceInvariant.get_presence_summary-371"><span class="linenos">371</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_summary-372"><a href="#PresenceInvariant.get_presence_summary-372"><span class="linenos">372</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_summary-373"><a href="#PresenceInvariant.get_presence_summary-373"><span class="linenos">373</span></a>        <span class="n">total_presence_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant.get_presence_summary-374"><a href="#PresenceInvariant.get_presence_summary-374"><span class="linenos">374</span></a>        <span class="n">number_of_presences</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant.get_presence_summary-375"><a href="#PresenceInvariant.get_presence_summary-375"><span class="linenos">375</span></a>        <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span>
</span><span id="PresenceInvariant.get_presence_summary-376"><a href="#PresenceInvariant.get_presence_summary-376"><span class="linenos">376</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="PresenceInvariant.get_presence_summary-377"><a href="#PresenceInvariant.get_presence_summary-377"><span class="linenos">377</span></a>                <span class="n">total_presence_value</span> <span class="o">+=</span> <span class="n">pm</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_summary-378"><a href="#PresenceInvariant.get_presence_summary-378"><span class="linenos">378</span></a>                <span class="n">number_of_presences</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PresenceInvariant.get_presence_summary-379"><a href="#PresenceInvariant.get_presence_summary-379"><span class="linenos">379</span></a>
</span><span id="PresenceInvariant.get_presence_summary-380"><a href="#PresenceInvariant.get_presence_summary-380"><span class="linenos">380</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="n">start_bin</span>
</span></pre></div>


            <div class="docstring"><p>Computes the three core quantities from which all presence-based metrics are derived:</p>

<ul>
<li>Total presence time \$ A \$ over the interval \$[\text{start_time}, \text{end_time})\$</li>
<li>Number of active presences \$ N \$ (i.e., rows overlapping the interval)</li>
<li>Number of time bins \$ T \$ covering the interval</li>
</ul>

<p>These three values form the basis for computing:</p>

<ul>
<li>Average presence per time bin: \$ L = A / T \$</li>
<li>Average residence time per presence: \$ w = A / N \$</li>
<li>Flow rate: \$ \Lambda = N / T \$</li>
</ul>

<p>This method is the common workhorse that underlies <code>avg_presence_per_time_bin</code>,
<code>avg_residence_time_per_presence</code>, and <code><a href="#PresenceInvariant.flow_rate">flow_rate</a></code>.</p>

<p>... and much of this work lives in <code><a href="#PresenceMap.presence_value_in">PresenceMap.presence_value_in</a></code></p>
</div>


                            </div>
                            <div id="PresenceInvariant.get_presence_metrics" class="classattr">
                                        <input id="PresenceInvariant.get_presence_metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_presence_metrics</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.get_presence_metrics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.get_presence_metrics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.get_presence_metrics-382"><a href="#PresenceInvariant.get_presence_metrics-382"><span class="linenos">382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant.get_presence_metrics-383"><a href="#PresenceInvariant.get_presence_metrics-383"><span class="linenos">383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_metrics-384"><a href="#PresenceInvariant.get_presence_metrics-384"><span class="linenos">384</span></a><span class="sd">        Computes all three components of the *Presence Invariant* for a finite window</span>
</span><span id="PresenceInvariant.get_presence_metrics-385"><a href="#PresenceInvariant.get_presence_metrics-385"><span class="linenos">385</span></a><span class="sd">        $[ \text{start\_time}, \text{end\_time} )$ within the timescale $[ t_0, t_1 )$</span>
</span><span id="PresenceInvariant.get_presence_metrics-386"><a href="#PresenceInvariant.get_presence_metrics-386"><span class="linenos">386</span></a><span class="sd">        of the PresenceMatrix.</span>
</span><span id="PresenceInvariant.get_presence_metrics-387"><a href="#PresenceInvariant.get_presence_metrics-387"><span class="linenos">387</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-388"><a href="#PresenceInvariant.get_presence_metrics-388"><span class="linenos">388</span></a><span class="sd">        The Presence Invariant states that for *any* such interval:</span>
</span><span id="PresenceInvariant.get_presence_metrics-389"><a href="#PresenceInvariant.get_presence_metrics-389"><span class="linenos">389</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-390"><a href="#PresenceInvariant.get_presence_metrics-390"><span class="linenos">390</span></a><span class="sd">            $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-391"><a href="#PresenceInvariant.get_presence_metrics-391"><span class="linenos">391</span></a><span class="sd">            L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant.get_presence_metrics-392"><a href="#PresenceInvariant.get_presence_metrics-392"><span class="linenos">392</span></a><span class="sd">            $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-393"><a href="#PresenceInvariant.get_presence_metrics-393"><span class="linenos">393</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-394"><a href="#PresenceInvariant.get_presence_metrics-394"><span class="linenos">394</span></a><span class="sd">        This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant.get_presence_metrics-395"><a href="#PresenceInvariant.get_presence_metrics-395"><span class="linenos">395</span></a><span class="sd">        in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant.get_presence_metrics-396"><a href="#PresenceInvariant.get_presence_metrics-396"><span class="linenos">396</span></a><span class="sd">        the more familiar equilibrium-based Little’s Law by expressing a conservation law</span>
</span><span id="PresenceInvariant.get_presence_metrics-397"><a href="#PresenceInvariant.get_presence_metrics-397"><span class="linenos">397</span></a><span class="sd">        that applies across all time scales.</span>
</span><span id="PresenceInvariant.get_presence_metrics-398"><a href="#PresenceInvariant.get_presence_metrics-398"><span class="linenos">398</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-399"><a href="#PresenceInvariant.get_presence_metrics-399"><span class="linenos">399</span></a><span class="sd">        - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant.get_presence_metrics-400"><a href="#PresenceInvariant.get_presence_metrics-400"><span class="linenos">400</span></a><span class="sd">        - $\Lambda$: the *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant.get_presence_metrics-401"><a href="#PresenceInvariant.get_presence_metrics-401"><span class="linenos">401</span></a><span class="sd">        - $w$: the *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant.get_presence_metrics-402"><a href="#PresenceInvariant.get_presence_metrics-402"><span class="linenos">402</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-403"><a href="#PresenceInvariant.get_presence_metrics-403"><span class="linenos">403</span></a><span class="sd">        **Derivation:**</span>
</span><span id="PresenceInvariant.get_presence_metrics-404"><a href="#PresenceInvariant.get_presence_metrics-404"><span class="linenos">404</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-405"><a href="#PresenceInvariant.get_presence_metrics-405"><span class="linenos">405</span></a><span class="sd">        Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant.get_presence_metrics-406"><a href="#PresenceInvariant.get_presence_metrics-406"><span class="linenos">406</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant.get_presence_metrics-407"><a href="#PresenceInvariant.get_presence_metrics-407"><span class="linenos">407</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-408"><a href="#PresenceInvariant.get_presence_metrics-408"><span class="linenos">408</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-409"><a href="#PresenceInvariant.get_presence_metrics-409"><span class="linenos">409</span></a><span class="sd">        A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant.get_presence_metrics-410"><a href="#PresenceInvariant.get_presence_metrics-410"><span class="linenos">410</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-411"><a href="#PresenceInvariant.get_presence_metrics-411"><span class="linenos">411</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-412"><a href="#PresenceInvariant.get_presence_metrics-412"><span class="linenos">412</span></a><span class="sd">        Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant.get_presence_metrics-413"><a href="#PresenceInvariant.get_presence_metrics-413"><span class="linenos">413</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-414"><a href="#PresenceInvariant.get_presence_metrics-414"><span class="linenos">414</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant.get_presence_metrics-415"><a href="#PresenceInvariant.get_presence_metrics-415"><span class="linenos">415</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-416"><a href="#PresenceInvariant.get_presence_metrics-416"><span class="linenos">416</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-417"><a href="#PresenceInvariant.get_presence_metrics-417"><span class="linenos">417</span></a><span class="sd">        L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant.get_presence_metrics-418"><a href="#PresenceInvariant.get_presence_metrics-418"><span class="linenos">418</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-419"><a href="#PresenceInvariant.get_presence_metrics-419"><span class="linenos">419</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-420"><a href="#PresenceInvariant.get_presence_metrics-420"><span class="linenos">420</span></a><span class="sd">        Hence:</span>
</span><span id="PresenceInvariant.get_presence_metrics-421"><a href="#PresenceInvariant.get_presence_metrics-421"><span class="linenos">421</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-422"><a href="#PresenceInvariant.get_presence_metrics-422"><span class="linenos">422</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-423"><a href="#PresenceInvariant.get_presence_metrics-423"><span class="linenos">423</span></a><span class="sd">        L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant.get_presence_metrics-424"><a href="#PresenceInvariant.get_presence_metrics-424"><span class="linenos">424</span></a><span class="sd">        $$</span>
</span><span id="PresenceInvariant.get_presence_metrics-425"><a href="#PresenceInvariant.get_presence_metrics-425"><span class="linenos">425</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-426"><a href="#PresenceInvariant.get_presence_metrics-426"><span class="linenos">426</span></a><span class="sd">        This identity—what we call the *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant.get_presence_metrics-427"><a href="#PresenceInvariant.get_presence_metrics-427"><span class="linenos">427</span></a><span class="sd">        all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</span>
</span><span id="PresenceInvariant.get_presence_metrics-428"><a href="#PresenceInvariant.get_presence_metrics-428"><span class="linenos">428</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-429"><a href="#PresenceInvariant.get_presence_metrics-429"><span class="linenos">429</span></a><span class="sd">        Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant.get_presence_metrics-430"><a href="#PresenceInvariant.get_presence_metrics-430"><span class="linenos">430</span></a><span class="sd">        (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant.get_presence_metrics-431"><a href="#PresenceInvariant.get_presence_metrics-431"><span class="linenos">431</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-432"><a href="#PresenceInvariant.get_presence_metrics-432"><span class="linenos">432</span></a><span class="sd">        - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$ and average duration $W$.</span>
</span><span id="PresenceInvariant.get_presence_metrics-433"><a href="#PresenceInvariant.get_presence_metrics-433"><span class="linenos">433</span></a><span class="sd">        - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite approximations.</span>
</span><span id="PresenceInvariant.get_presence_metrics-434"><a href="#PresenceInvariant.get_presence_metrics-434"><span class="linenos">434</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-435"><a href="#PresenceInvariant.get_presence_metrics-435"><span class="linenos">435</span></a><span class="sd">        Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant.get_presence_metrics-436"><a href="#PresenceInvariant.get_presence_metrics-436"><span class="linenos">436</span></a><span class="sd">        and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant.get_presence_metrics-437"><a href="#PresenceInvariant.get_presence_metrics-437"><span class="linenos">437</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-438"><a href="#PresenceInvariant.get_presence_metrics-438"><span class="linenos">438</span></a><span class="sd">        ## References</span>
</span><span id="PresenceInvariant.get_presence_metrics-439"><a href="#PresenceInvariant.get_presence_metrics-439"><span class="linenos">439</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-440"><a href="#PresenceInvariant.get_presence_metrics-440"><span class="linenos">440</span></a><span class="sd">            1. **Little’s Law**</span>
</span><span id="PresenceInvariant.get_presence_metrics-441"><a href="#PresenceInvariant.get_presence_metrics-441"><span class="linenos">441</span></a><span class="sd">               Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant.get_presence_metrics-442"><a href="#PresenceInvariant.get_presence_metrics-442"><span class="linenos">442</span></a><span class="sd">               [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant.get_presence_metrics-443"><a href="#PresenceInvariant.get_presence_metrics-443"><span class="linenos">443</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-444"><a href="#PresenceInvariant.get_presence_metrics-444"><span class="linenos">444</span></a><span class="sd">            2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant.get_presence_metrics-445"><a href="#PresenceInvariant.get_presence_metrics-445"><span class="linenos">445</span></a><span class="sd">               Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant.get_presence_metrics-446"><a href="#PresenceInvariant.get_presence_metrics-446"><span class="linenos">446</span></a><span class="sd">               [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant.get_presence_metrics-447"><a href="#PresenceInvariant.get_presence_metrics-447"><span class="linenos">447</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-448"><a href="#PresenceInvariant.get_presence_metrics-448"><span class="linenos">448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_metrics-449"><a href="#PresenceInvariant.get_presence_metrics-449"><span class="linenos">449</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_metrics-450"><a href="#PresenceInvariant.get_presence_metrics-450"><span class="linenos">450</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-451"><a href="#PresenceInvariant.get_presence_metrics-451"><span class="linenos">451</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant.get_presence_metrics-452"><a href="#PresenceInvariant.get_presence_metrics-452"><span class="linenos">452</span></a>        <span class="n">Λ</span> <span class="o">=</span> <span class="n">number_of_presences</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant.get_presence_metrics-453"><a href="#PresenceInvariant.get_presence_metrics-453"><span class="linenos">453</span></a>        <span class="n">W</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant.get_presence_metrics-454"><a href="#PresenceInvariant.get_presence_metrics-454"><span class="linenos">454</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-455"><a href="#PresenceInvariant.get_presence_metrics-455"><span class="linenos">455</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">W</span>
</span></pre></div>


            <div class="docstring"><p>Computes all three components of the <em>Presence Invariant</em> for a finite window
$[      ext{start_time},       ext{end_time} )$ within the timescale $[ t_0, t_1 )$
of the PresenceMatrix.</p>

<p>The Presence Invariant states that for <em>any</em> such interval:</p>

<pre><code>$$
L = \Lambda \cdot w
$$
</code></pre>

<p>This invariant holds unconditionally and forms the foundation for reasoning about flow
in non-linear systems—systems that often operate far from equilibrium. It generalizes
the more familiar equilibrium-based Little’s Law by expressing a conservation law
that applies across all time scales.</p>

<ul>
<li>$L$: the <em>actual</em> average presence per unit time in the interval (this is not an approximation)</li>
<li>$\Lambda$: the <em>finite approximation</em> of presence arrival rate (flow rate)</li>
<li>$w$: the <em>finite approximation</em> of presence duration (residence time)</li>
</ul>

<p><strong>Derivation:</strong></p>

<p>Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.
Then:</p>

<p>$$
A = \sum_{      ext{rows}}      ext{row totals} = \sum_{        ext{columns}}   ext{column totals}
$$</p>

<p>Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</p>

<p>Then:</p>

<p>$$
L = rac{A}{T} = rac{A}{N} \cdot rac{N}{T} = w \cdot \Lambda
$$</p>

<p>Hence:</p>

<p>$$
L = \Lambda \cdot w
$$</p>

<p>This identity—what we call the <em>Presence Invariant</em>—is a fundamental lemma used in
all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</p>

<p>Both the classical and presence-based versions are instances of <em>Rate Conservation Laws</em>
(as described by Miyazawa [2]). However, the conserved parameters differ:</p>

<ul>
<li>In classical Little’s Law, $L = \lambda \cdot W$ holds <em>at equilibrium</em>, using true arrival rate $\lambda$ and average duration $W$.</li>
<li>In the Presence Invariant, $L = \Lambda \cdot w$ holds <em>universally</em>, where $\Lambda$ and $w$ are finite approximations.</li>
</ul>

<p>Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust
and widely applicable conservation principle for causal reasoning about flow in such systems.</p>

<h2 id="references">References</h2>

<pre><code>1. **Little’s Law**
   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.
   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)

2. **Miyazawa on Rate Conservation Laws**
   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.
   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)
</code></pre>
</div>


                            </div>
                            <div id="PresenceInvariant.starting_presence_count" class="classattr">
                                        <input id="PresenceInvariant.starting_presence_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">starting_presence_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.starting_presence_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.starting_presence_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.starting_presence_count-460"><a href="#PresenceInvariant.starting_presence_count-460"><span class="linenos">460</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">starting_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.starting_presence_count-461"><a href="#PresenceInvariant.starting_presence_count-461"><span class="linenos">461</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.starting_presence_count-462"><a href="#PresenceInvariant.starting_presence_count-462"><span class="linenos">462</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.starting_presence_count-463"><a href="#PresenceInvariant.starting_presence_count-463"><span class="linenos">463</span></a>
</span><span id="PresenceInvariant.starting_presence_count-464"><a href="#PresenceInvariant.starting_presence_count-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.starting_presence_count-465"><a href="#PresenceInvariant.starting_presence_count-465"><span class="linenos">465</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.starting_presence_count-466"><a href="#PresenceInvariant.starting_presence_count-466"><span class="linenos">466</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.starting_presence_count-467"><a href="#PresenceInvariant.starting_presence_count-467"><span class="linenos">467</span></a>            <span class="c1">#Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant.starting_presence_count-468"><a href="#PresenceInvariant.starting_presence_count-468"><span class="linenos">468</span></a>            <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant.starting_presence_count-469"><a href="#PresenceInvariant.starting_presence_count-469"><span class="linenos">469</span></a>            <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant.starting_presence_count-470"><a href="#PresenceInvariant.starting_presence_count-470"><span class="linenos">470</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start_bin</span>
</span><span id="PresenceInvariant.starting_presence_count-471"><a href="#PresenceInvariant.starting_presence_count-471"><span class="linenos">471</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.ending_presence_count" class="classattr">
                                        <input id="PresenceInvariant.ending_presence_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ending_presence_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.ending_presence_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.ending_presence_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.ending_presence_count-473"><a href="#PresenceInvariant.ending_presence_count-473"><span class="linenos">473</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ending_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.ending_presence_count-474"><a href="#PresenceInvariant.ending_presence_count-474"><span class="linenos">474</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-475"><a href="#PresenceInvariant.ending_presence_count-475"><span class="linenos">475</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-476"><a href="#PresenceInvariant.ending_presence_count-476"><span class="linenos">476</span></a>
</span><span id="PresenceInvariant.ending_presence_count-477"><a href="#PresenceInvariant.ending_presence_count-477"><span class="linenos">477</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.ending_presence_count-478"><a href="#PresenceInvariant.ending_presence_count-478"><span class="linenos">478</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.ending_presence_count-479"><a href="#PresenceInvariant.ending_presence_count-479"><span class="linenos">479</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-480"><a href="#PresenceInvariant.ending_presence_count-480"><span class="linenos">480</span></a>            <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="PresenceInvariant.ending_presence_count-481"><a href="#PresenceInvariant.ending_presence_count-481"><span class="linenos">481</span></a>                 <span class="c1"># Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant.ending_presence_count-482"><a href="#PresenceInvariant.ending_presence_count-482"><span class="linenos">482</span></a>                 <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant.ending_presence_count-483"><a href="#PresenceInvariant.ending_presence_count-483"><span class="linenos">483</span></a>                 <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant.ending_presence_count-484"><a href="#PresenceInvariant.ending_presence_count-484"><span class="linenos">484</span></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-485"><a href="#PresenceInvariant.ending_presence_count-485"><span class="linenos">485</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.arrival_count" class="classattr">
                                        <input id="PresenceInvariant.arrival_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">arrival_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.arrival_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.arrival_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.arrival_count-487"><a href="#PresenceInvariant.arrival_count-487"><span class="linenos">487</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arrival_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.arrival_count-488"><a href="#PresenceInvariant.arrival_count-488"><span class="linenos">488</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of presences that started within the window&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.arrival_count-489"><a href="#PresenceInvariant.arrival_count-489"><span class="linenos">489</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.arrival_count-490"><a href="#PresenceInvariant.arrival_count-490"><span class="linenos">490</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.arrival_count-491"><a href="#PresenceInvariant.arrival_count-491"><span class="linenos">491</span></a>
</span><span id="PresenceInvariant.arrival_count-492"><a href="#PresenceInvariant.arrival_count-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.arrival_count-493"><a href="#PresenceInvariant.arrival_count-493"><span class="linenos">493</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.arrival_count-494"><a href="#PresenceInvariant.arrival_count-494"><span class="linenos">494</span></a>            <span class="k">if</span> <span class="n">start_bin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">onset_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_bin</span>
</span><span id="PresenceInvariant.arrival_count-495"><a href="#PresenceInvariant.arrival_count-495"><span class="linenos">495</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The number of presences that started within the window</p>
</div>


                            </div>
                            <div id="PresenceInvariant.departure_count" class="classattr">
                                        <input id="PresenceInvariant.departure_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">departure_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.departure_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.departure_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.departure_count-497"><a href="#PresenceInvariant.departure_count-497"><span class="linenos">497</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">departure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.departure_count-498"><a href="#PresenceInvariant.departure_count-498"><span class="linenos">498</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-499"><a href="#PresenceInvariant.departure_count-499"><span class="linenos">499</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-500"><a href="#PresenceInvariant.departure_count-500"><span class="linenos">500</span></a>
</span><span id="PresenceInvariant.departure_count-501"><a href="#PresenceInvariant.departure_count-501"><span class="linenos">501</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.departure_count-502"><a href="#PresenceInvariant.departure_count-502"><span class="linenos">502</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.departure_count-503"><a href="#PresenceInvariant.departure_count-503"><span class="linenos">503</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-504"><a href="#PresenceInvariant.departure_count-504"><span class="linenos">504</span></a>            <span class="ow">and</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-505"><a href="#PresenceInvariant.departure_count-505"><span class="linenos">505</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">reset_time</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-506"><a href="#PresenceInvariant.departure_count-506"><span class="linenos">506</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.foo" class="classattr">
                                        <input id="PresenceInvariant.foo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">foo</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PresenceInvariant.foo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.foo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.foo-509"><a href="#PresenceInvariant.foo-509"><span class="linenos">509</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PresenceInvariant.foo-510"><a href="#PresenceInvariant.foo-510"><span class="linenos">510</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.foo-511"><a href="#PresenceInvariant.foo-511"><span class="linenos">511</span></a><span class="sd">            The key function of this class is to precisely compute the components of key rate conserved quantities</span>
</span><span id="PresenceInvariant.foo-512"><a href="#PresenceInvariant.foo-512"><span class="linenos">512</span></a><span class="sd">            tied to Presence under both equilibrium and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant.foo-513"><a href="#PresenceInvariant.foo-513"><span class="linenos">513</span></a>
</span><span id="PresenceInvariant.foo-514"><a href="#PresenceInvariant.foo-514"><span class="linenos">514</span></a><span class="sd">            The key relationship that matters here is the Presence Invariant, which is rate conservation law</span>
</span><span id="PresenceInvariant.foo-515"><a href="#PresenceInvariant.foo-515"><span class="linenos">515</span></a><span class="sd">            for a PresenceMatrix under non-equilibrium condition.</span>
</span><span id="PresenceInvariant.foo-516"><a href="#PresenceInvariant.foo-516"><span class="linenos">516</span></a>
</span><span id="PresenceInvariant.foo-517"><a href="#PresenceInvariant.foo-517"><span class="linenos">517</span></a><span class="sd">            The Presence Invariant states that for *any* finite interval [start_time, end_time) over the timescale [t0, t1)</span>
</span><span id="PresenceInvariant.foo-518"><a href="#PresenceInvariant.foo-518"><span class="linenos">518</span></a><span class="sd">            of a Presence Matrix:</span>
</span><span id="PresenceInvariant.foo-519"><a href="#PresenceInvariant.foo-519"><span class="linenos">519</span></a>
</span><span id="PresenceInvariant.foo-520"><a href="#PresenceInvariant.foo-520"><span class="linenos">520</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant.foo-521"><a href="#PresenceInvariant.foo-521"><span class="linenos">521</span></a><span class="sd">                    L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant.foo-522"><a href="#PresenceInvariant.foo-522"><span class="linenos">522</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant.foo-523"><a href="#PresenceInvariant.foo-523"><span class="linenos">523</span></a>
</span><span id="PresenceInvariant.foo-524"><a href="#PresenceInvariant.foo-524"><span class="linenos">524</span></a><span class="sd">                - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant.foo-525"><a href="#PresenceInvariant.foo-525"><span class="linenos">525</span></a><span class="sd">                - $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant.foo-526"><a href="#PresenceInvariant.foo-526"><span class="linenos">526</span></a><span class="sd">                - $w$: a *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant.foo-527"><a href="#PresenceInvariant.foo-527"><span class="linenos">527</span></a>
</span><span id="PresenceInvariant.foo-528"><a href="#PresenceInvariant.foo-528"><span class="linenos">528</span></a><span class="sd">                This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant.foo-529"><a href="#PresenceInvariant.foo-529"><span class="linenos">529</span></a><span class="sd">                in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant.foo-530"><a href="#PresenceInvariant.foo-530"><span class="linenos">530</span></a><span class="sd">                the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law</span>
</span><span id="PresenceInvariant.foo-531"><a href="#PresenceInvariant.foo-531"><span class="linenos">531</span></a><span class="sd">                that applies across all time scales and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant.foo-532"><a href="#PresenceInvariant.foo-532"><span class="linenos">532</span></a>
</span><span id="PresenceInvariant.foo-533"><a href="#PresenceInvariant.foo-533"><span class="linenos">533</span></a><span class="sd">                The proof of this invariant is surprisingly simple and elementary.</span>
</span><span id="PresenceInvariant.foo-534"><a href="#PresenceInvariant.foo-534"><span class="linenos">534</span></a>
</span><span id="PresenceInvariant.foo-535"><a href="#PresenceInvariant.foo-535"><span class="linenos">535</span></a><span class="sd">                **Derivation:**</span>
</span><span id="PresenceInvariant.foo-536"><a href="#PresenceInvariant.foo-536"><span class="linenos">536</span></a>
</span><span id="PresenceInvariant.foo-537"><a href="#PresenceInvariant.foo-537"><span class="linenos">537</span></a><span class="sd">                Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant.foo-538"><a href="#PresenceInvariant.foo-538"><span class="linenos">538</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant.foo-539"><a href="#PresenceInvariant.foo-539"><span class="linenos">539</span></a>
</span><span id="PresenceInvariant.foo-540"><a href="#PresenceInvariant.foo-540"><span class="linenos">540</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-541"><a href="#PresenceInvariant.foo-541"><span class="linenos">541</span></a><span class="sd">                A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant.foo-542"><a href="#PresenceInvariant.foo-542"><span class="linenos">542</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-543"><a href="#PresenceInvariant.foo-543"><span class="linenos">543</span></a>
</span><span id="PresenceInvariant.foo-544"><a href="#PresenceInvariant.foo-544"><span class="linenos">544</span></a><span class="sd">                Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant.foo-545"><a href="#PresenceInvariant.foo-545"><span class="linenos">545</span></a>
</span><span id="PresenceInvariant.foo-546"><a href="#PresenceInvariant.foo-546"><span class="linenos">546</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant.foo-547"><a href="#PresenceInvariant.foo-547"><span class="linenos">547</span></a>
</span><span id="PresenceInvariant.foo-548"><a href="#PresenceInvariant.foo-548"><span class="linenos">548</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-549"><a href="#PresenceInvariant.foo-549"><span class="linenos">549</span></a>
</span><span id="PresenceInvariant.foo-550"><a href="#PresenceInvariant.foo-550"><span class="linenos">550</span></a><span class="sd">                L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant.foo-551"><a href="#PresenceInvariant.foo-551"><span class="linenos">551</span></a>
</span><span id="PresenceInvariant.foo-552"><a href="#PresenceInvariant.foo-552"><span class="linenos">552</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-553"><a href="#PresenceInvariant.foo-553"><span class="linenos">553</span></a>
</span><span id="PresenceInvariant.foo-554"><a href="#PresenceInvariant.foo-554"><span class="linenos">554</span></a><span class="sd">                Hence:</span>
</span><span id="PresenceInvariant.foo-555"><a href="#PresenceInvariant.foo-555"><span class="linenos">555</span></a>
</span><span id="PresenceInvariant.foo-556"><a href="#PresenceInvariant.foo-556"><span class="linenos">556</span></a><span class="sd">                $$ L = \Lambda \cdot w $$</span>
</span><span id="PresenceInvariant.foo-557"><a href="#PresenceInvariant.foo-557"><span class="linenos">557</span></a>
</span><span id="PresenceInvariant.foo-558"><a href="#PresenceInvariant.foo-558"><span class="linenos">558</span></a><span class="sd">                The *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant.foo-559"><a href="#PresenceInvariant.foo-559"><span class="linenos">559</span></a><span class="sd">                all proofs of Little’s Law [1], and can be seen as its finite-window version.</span>
</span><span id="PresenceInvariant.foo-560"><a href="#PresenceInvariant.foo-560"><span class="linenos">560</span></a>
</span><span id="PresenceInvariant.foo-561"><a href="#PresenceInvariant.foo-561"><span class="linenos">561</span></a><span class="sd">                Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant.foo-562"><a href="#PresenceInvariant.foo-562"><span class="linenos">562</span></a><span class="sd">                (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant.foo-563"><a href="#PresenceInvariant.foo-563"><span class="linenos">563</span></a>
</span><span id="PresenceInvariant.foo-564"><a href="#PresenceInvariant.foo-564"><span class="linenos">564</span></a><span class="sd">                - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$</span>
</span><span id="PresenceInvariant.foo-565"><a href="#PresenceInvariant.foo-565"><span class="linenos">565</span></a><span class="sd">                and average duration $W$.</span>
</span><span id="PresenceInvariant.foo-566"><a href="#PresenceInvariant.foo-566"><span class="linenos">566</span></a><span class="sd">                - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite</span>
</span><span id="PresenceInvariant.foo-567"><a href="#PresenceInvariant.foo-567"><span class="linenos">567</span></a><span class="sd">                window approximations.</span>
</span><span id="PresenceInvariant.foo-568"><a href="#PresenceInvariant.foo-568"><span class="linenos">568</span></a>
</span><span id="PresenceInvariant.foo-569"><a href="#PresenceInvariant.foo-569"><span class="linenos">569</span></a><span class="sd">                Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant.foo-570"><a href="#PresenceInvariant.foo-570"><span class="linenos">570</span></a><span class="sd">                and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant.foo-571"><a href="#PresenceInvariant.foo-571"><span class="linenos">571</span></a>
</span><span id="PresenceInvariant.foo-572"><a href="#PresenceInvariant.foo-572"><span class="linenos">572</span></a><span class="sd">                References:</span>
</span><span id="PresenceInvariant.foo-573"><a href="#PresenceInvariant.foo-573"><span class="linenos">573</span></a>
</span><span id="PresenceInvariant.foo-574"><a href="#PresenceInvariant.foo-574"><span class="linenos">574</span></a><span class="sd">                1. **Little’s Law**</span>
</span><span id="PresenceInvariant.foo-575"><a href="#PresenceInvariant.foo-575"><span class="linenos">575</span></a><span class="sd">                   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant.foo-576"><a href="#PresenceInvariant.foo-576"><span class="linenos">576</span></a><span class="sd">                   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant.foo-577"><a href="#PresenceInvariant.foo-577"><span class="linenos">577</span></a>
</span><span id="PresenceInvariant.foo-578"><a href="#PresenceInvariant.foo-578"><span class="linenos">578</span></a><span class="sd">                2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant.foo-579"><a href="#PresenceInvariant.foo-579"><span class="linenos">579</span></a><span class="sd">                   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant.foo-580"><a href="#PresenceInvariant.foo-580"><span class="linenos">580</span></a><span class="sd">                   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant.foo-581"><a href="#PresenceInvariant.foo-581"><span class="linenos">581</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>The key function of this class is to precisely compute the components of key rate conserved quantities
tied to Presence under both equilibrium and non-equilibrium conditions.</p>

<p>The key relationship that matters here is the Presence Invariant, which is rate conservation law
for a PresenceMatrix under non-equilibrium condition.</p>

<p>The Presence Invariant states that for <em>any</em> finite interval [start_time, end_time) over the timescale [t0, t1)
of a Presence Matrix:</p>

<pre><code>    $$
    L = \Lambda \cdot w
    $$

- $L$: the *actual* average presence per unit time in the interval (this is not an approximation)
- $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)
- $w$: a *finite approximation* of presence duration (residence time)

This invariant holds unconditionally and forms the foundation for reasoning about flow
in non-linear systems—systems that often operate far from equilibrium. It generalizes
the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law
that applies across all time scales and non-equilibrium conditions.

The proof of this invariant is surprisingly simple and elementary.

**Derivation:**

Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.
Then:

$$
A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}
$$

Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.

Then:

$$

L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda

$$

Hence:

$$ L = \Lambda \cdot w $$

The *Presence Invariant*—is a fundamental lemma used in
all proofs of Little’s Law [1], and can be seen as its finite-window version.

Both the classical and presence-based versions are instances of *Rate Conservation Laws*
(as described by Miyazawa [2]). However, the conserved parameters differ:

- In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$
and average duration $W$.
- In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite
window approximations.

Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust
and widely applicable conservation principle for causal reasoning about flow in such systems.

References:

1. **Little’s Law**
   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.
   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)

2. **Miyazawa on Rate Conservation Laws**
   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.
   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)
</code></pre>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>