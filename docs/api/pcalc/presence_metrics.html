<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>pcalc.presence_metrics API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pcalc.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pcalc</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#PresenceInvariant">PresenceInvariant</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PresenceInvariant.__init__">PresenceInvariant</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.matrix">matrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.presences">presences</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.presence_map">presence_map</a>
                        </li>
                        <li>
                                <a class="variable" href="#PresenceInvariant.ts">ts</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.flow_rate">flow_rate</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.avg_residence_time_per_presence">avg_residence_time_per_presence</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.avg_presence_per_time_bin">avg_presence_per_time_bin</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.get_presence_summary">get_presence_summary</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.get_presence_metrics">get_presence_metrics</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.starting_presence_count">starting_presence_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.ending_presence_count">ending_presence_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.arrival_count">arrival_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.departure_count">departure_count</a>
                        </li>
                        <li>
                                <a class="function" href="#PresenceInvariant.foo">foo</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="../pcalc.html">pcalc</a><wbr>.presence_metrics    </h1>

                
                        <input id="mod-presence_metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-presence_metrics-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1"># Copyright: © Exathink, LLC 2016-2015-${today.year} All Rights Reserved</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="c1"># Unauthorized use or copying of this file and its contents, via any medium</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="c1"># is strictly prohibited. The work product in this file is proprietary and</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="c1"># confidential.</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="c1"># Author: Krishna Kumar</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">metamodel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Presence</span><span class="p">,</span> <span class="n">T_Element</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pcalc</span><span class="w"> </span><span class="kn">import</span> <span class="n">PresenceMatrix</span><span class="p">,</span> <span class="n">PresenceMap</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PresenceInvariant</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T_Element</span><span class="p">]):</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    Computes the components of the *Presence Invariant* for a finite window</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">        `[start_time, end_time)` over the timescale `[t0, t1)` of the PresenceMatrix.</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    The Presence Invariant states that for *any* such interval:</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">            $$</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">                L = \Lambda \cdot w</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">            $$</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    where</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    - **$L$**: the average *presence* per unit time in the interval</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    - **$\Lambda$**: The *flow rate* - a finite approximation of *presence arrival/departure rate*.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    - **$w$**: The *residence time* - a finite approximation of *presence duration*.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    This invariant extends the classical formulation of Little’s Law—an equilibrium-based identity—by establishing a</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    conservation law (of presence) that remains valid across arbitrary timescales, including in stochastic processes</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    that operate far from equilibrium.</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    It holds unconditionally for any PresenceMatrix and finite window, and serves as a foundational</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    construct for reasoning about flow in non-linear systems.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">PresenceMatrix</span><span class="p">[</span><span class="n">T_Element</span><span class="p">]):</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presences</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presences</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The timescale of the presence matrix. This is the default &#39;window&#39; over which all metrics are computed.&quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">end_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span> <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="n">end_time</span> <span class="k">if</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="k">if</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span> <span class="ow">or</span> <span class="n">end_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>                <span class="sa">f</span><span class="s2">&quot;Presence metrics are not defined outside the time scale of the presence matrix.&quot;</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>                <span class="sa">f</span><span class="s2">&quot;Time scale = [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>                <span class="sa">f</span><span class="s2">&quot;Provided: [</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>            <span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flow_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        The flow rate Λ is defined as:</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">            number of active presences in the matrix slice [:start_bin:end_bin] /</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">            number of time bins in the slice (end_bin - start_bin)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">        Conceptually:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">            Let N be the number of presences (rows) that are active (non-zero)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">            in the matrix between start_time and end_time.</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">            Let T be the number of discrete time bins (columns) in that interval.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">            Then:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">                flow_rate = Λ = N / T</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">        Examples:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">            - If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">            - If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        The precise relationship between flow rate, arrival rate, and departure rate is as follows:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">            N = number of presences that started *before* start_time (see `starting_presence_count`)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">                + number that started *in* the interval [start_time, end_time) (see `arrival_count`)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">              — this is also called the cumulative arrivals into the window</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">            or equivalently:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">            N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">                + number that ended *after* end_time (see `ending_presence_count`)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">              — this is the departure contribution from the window</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">            These two decompositions of N are always equal; they just reflect different</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">            ways of expressing the same set of active presences.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        will start and end within the window, with fewer presences that partially overlap</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        the interval at the beginning and end.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        This makes N an (over) estimate of true arrivals or departures over that interval.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        then:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">            flow_rate → arrival_rate → departure_rate</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        When flow is fully convergent over the interval, then:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">            flow_rate = arrival_rate = departure_rate</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        This equality is one of the key conditions for *stable* flow through the boundary.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        flow rate, arrival rate, and departure rate will be large — either increasing (divergent)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        or decreasing (convergent) over time.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="k">return</span> <span class="n">number_of_presences</span><span class="o">/</span><span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_residence_time_per_presence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">            Computes the average residence time over the interval [start_time, end_time).</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">            Let \$ P \$ be the set of presences that overlap the interval \$[\\text{start\\_time}, \\text{end\\_time})\$.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">            The *residence time* \$ R(p) \$ is the time that presence \$ p \\in P \$ is active (overlaps) within that interval.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">            The average residence time \$ w \$ is given by:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">            \\[</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">            w = \\frac{\\sum_{p \\in P} R(p)}{|P|}</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">            \\]</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">            If no presences are active in the interval, \$ w = 0.0 \$.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">            Note:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">                There are four possible ways a presence can overlap a window [start, end):</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">                Ticks:     0   1   2   3   4   5   6   7</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">                           |---|---|---|---|---|---|---|</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">                Window:          |-----------|</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">                Case 1: Fully inside</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">                                     [=======]</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">                Case 2: Starts before, ends inside</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">                              [===========</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">                Case 3: Starts inside, ends after</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">                                     ===========]</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">                Case 4: Fully spans window</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">                              [====================]</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">                In all but Case 1, the window clips the presence, so the residence time</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">                is smaller than the presence duration. In Case 1, residence time equals presence duration.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">                Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">                will start and end within the window (Case 1), with fewer presences that partially overlap</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">                the interval at the beginning and end or span the window (Cases 2–4).</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">                This makes \$ w \$ an (under)estimate of true presence duration.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">                In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">                then:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">                    residence time → presence duration.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">                When flow is fully convergent over the interval:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">                    residence time = presence duration.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">                On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">                residence time and presence duration will be large — either increasing (divergent)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">                or decreasing (convergent) over time.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_presence_per_time_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">        Computes the average presence per time bin over the interval [start_time, end_time).</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">        Let \$ B \$ be the set of discrete time bins that cover the interval \$[\\text{start\\_time}, \\text{end\\_time})\$,</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \\in B \$.</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        The average presence \$ L \$ is given by:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        \\[</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">        L = \\frac{\\sum_{b \\in B} P(b)}{|B|}</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        \\]</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">        If the interval spans no bins, \$ L = 0.0 \$.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        Note:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">            This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">            durations we used to compute residence time) divided by the number of bins in the interval.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">            Visually, this corresponds to summing presence *vertically* across bins:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">            Example: presences over time bins</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">            Ticks:     0   1   2   3   4</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">                       |---|---|---|---|</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">            P1:         [=======]</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">            P2:             [=======]</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">            P3:                 [=======]</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">            Time bin 1:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">                          ↑   (bin index 1 = [1, 2))</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">                          |---|</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">                      P1:   +</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">                      P2:   +</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">                      P3:   -</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">                    ---------</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">                    Sum:     2</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">            So:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">                - Bin 1 has total presence = 2</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">                - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">                - Then \$ L = 5.5 / 3 = 1.833... \$</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">            Conceptually, \$ L \$ reflects the average &quot;load&quot; or concurrency of presence in the system during the interval.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">            This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">            Computes the three core quantities from which all presence-based metrics are derived:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">            - Total presence time \$ A \$ over the interval \$[\\text{start\\_time}, \\text{end\\_time})\$</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">            - Number of active presences \$ N \$ (i.e., rows overlapping the interval)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">            - Number of time bins \$ T \$ covering the interval</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">            These three values form the basis for computing:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">            - Average presence per time bin: \$ L = A / T \$</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">            - Average residence time per presence: \$ w = A / N \$</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">            - Flow rate: \$ \\Lambda = N / T \$</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            This method is the common workhorse that underlies `avg_presence_per_time_bin`,</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">            `avg_residence_time_per_presence`, and `flow_rate`.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">            ... and much of this work lives in `PresenceMap.presence_value_in`</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="n">total_presence_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">number_of_presences</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="n">total_presence_value</span> <span class="o">+=</span> <span class="n">pm</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="n">number_of_presences</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="n">start_bin</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">        Computes all three components of the *Presence Invariant* for a finite window</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        $[ \text{start\_time}, \text{end\_time} )$ within the timescale $[ t_0, t_1 )$</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        of the PresenceMatrix.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        The Presence Invariant states that for *any* such interval:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">            \[</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">            L = \Lambda \cdot w</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">            \]</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">        in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        the more familiar equilibrium-based Little’s Law by expressing a conservation law</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        that applies across all time scales.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">        - $\Lambda$: the *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        - $w$: the *finite approximation* of presence duration (residence time)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        **Derivation:**</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">        Then:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        \[</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">        A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">        \]</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">        Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        Then:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        \[</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        \]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        Hence:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">        \[</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">        L = \Lambda \cdot w</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        \]</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        This identity—what we call the *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">        - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$ and average duration $W$.</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">        - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite approximations.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">        Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">        and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">        ## References</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">            1. **Little’s Law**</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">               Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">               [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">            2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">               Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">               [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="n">Λ</span> <span class="o">=</span> <span class="n">number_of_presences</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="n">W</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">W</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">starting_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="c1">#Note: here we must explicitly check the un-clipped</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start_bin</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ending_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                 <span class="c1"># Note: here we must explicitly check the un-clipped</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                 <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                 <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arrival_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of presences that started within the window&quot;&quot;&quot;</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="k">if</span> <span class="n">start_bin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_bin</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">departure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="ow">and</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">            The key function of this class is to precisely compute the components of key rate conserved quantities</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">            tied to Presence under both equilibrium and non-equilibrium conditions.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">            The key relationship that matters here is the Presence Invariant, which is rate conservation law</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">            for a PresenceMatrix under non-equilibrium condition.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">            The Presence Invariant states that for *any* finite interval [start_time, end_time) over the timescale [t0, t1)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">            of a Presence Matrix:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">                    $$</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">                    L = \Lambda \cdot w</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">                    $$</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">                - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">                - $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">                - $w$: a *finite approximation* of presence duration (residence time)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">                This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">                in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">                the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">                that applies across all time scales and non-equilibrium conditions.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">                The proof of this invariant is surprisingly simple and elementary.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">                **Derivation:**</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">                Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">                Then:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">                $$</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">                A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">                $$</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">                Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">                Then:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">                $$</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">                L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">                $$</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">                Hence:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">                $$ L = \Lambda \cdot w $$</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">                The *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">                all proofs of Little’s Law [1], and can be seen as its finite-window version.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">                Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">                (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">                - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">                and average duration $W$.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">                - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">                window approximations.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">                Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">                and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">                References:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">                1. **Little’s Law**</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">                   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">                   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">                2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">                   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">                   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span></pre></div>


            </section>
                <section id="PresenceInvariant">
                            <input id="PresenceInvariant-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PresenceInvariant</span><wbr>(<span class="base">typing.Generic[~T_Element]</span>):

                <label class="view-source-button" for="PresenceInvariant-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant-15"><a href="#PresenceInvariant-15"><span class="linenos"> 15</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PresenceInvariant</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T_Element</span><span class="p">]):</span>
</span><span id="PresenceInvariant-16"><a href="#PresenceInvariant-16"><span class="linenos"> 16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-17"><a href="#PresenceInvariant-17"><span class="linenos"> 17</span></a><span class="sd">    Computes the components of the *Presence Invariant* for a finite window</span>
</span><span id="PresenceInvariant-18"><a href="#PresenceInvariant-18"><span class="linenos"> 18</span></a><span class="sd">        `[start_time, end_time)` over the timescale `[t0, t1)` of the PresenceMatrix.</span>
</span><span id="PresenceInvariant-19"><a href="#PresenceInvariant-19"><span class="linenos"> 19</span></a>
</span><span id="PresenceInvariant-20"><a href="#PresenceInvariant-20"><span class="linenos"> 20</span></a><span class="sd">    The Presence Invariant states that for *any* such interval:</span>
</span><span id="PresenceInvariant-21"><a href="#PresenceInvariant-21"><span class="linenos"> 21</span></a><span class="sd">            $$</span>
</span><span id="PresenceInvariant-22"><a href="#PresenceInvariant-22"><span class="linenos"> 22</span></a><span class="sd">                L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-23"><a href="#PresenceInvariant-23"><span class="linenos"> 23</span></a><span class="sd">            $$</span>
</span><span id="PresenceInvariant-24"><a href="#PresenceInvariant-24"><span class="linenos"> 24</span></a><span class="sd">    where</span>
</span><span id="PresenceInvariant-25"><a href="#PresenceInvariant-25"><span class="linenos"> 25</span></a>
</span><span id="PresenceInvariant-26"><a href="#PresenceInvariant-26"><span class="linenos"> 26</span></a><span class="sd">    - **$L$**: the average *presence* per unit time in the interval</span>
</span><span id="PresenceInvariant-27"><a href="#PresenceInvariant-27"><span class="linenos"> 27</span></a><span class="sd">    - **$\Lambda$**: The *flow rate* - a finite approximation of *presence arrival/departure rate*.</span>
</span><span id="PresenceInvariant-28"><a href="#PresenceInvariant-28"><span class="linenos"> 28</span></a><span class="sd">    - **$w$**: The *residence time* - a finite approximation of *presence duration*.</span>
</span><span id="PresenceInvariant-29"><a href="#PresenceInvariant-29"><span class="linenos"> 29</span></a>
</span><span id="PresenceInvariant-30"><a href="#PresenceInvariant-30"><span class="linenos"> 30</span></a><span class="sd">    This invariant extends the classical formulation of Little’s Law—an equilibrium-based identity—by establishing a</span>
</span><span id="PresenceInvariant-31"><a href="#PresenceInvariant-31"><span class="linenos"> 31</span></a><span class="sd">    conservation law (of presence) that remains valid across arbitrary timescales, including in stochastic processes</span>
</span><span id="PresenceInvariant-32"><a href="#PresenceInvariant-32"><span class="linenos"> 32</span></a><span class="sd">    that operate far from equilibrium.</span>
</span><span id="PresenceInvariant-33"><a href="#PresenceInvariant-33"><span class="linenos"> 33</span></a>
</span><span id="PresenceInvariant-34"><a href="#PresenceInvariant-34"><span class="linenos"> 34</span></a><span class="sd">    It holds unconditionally for any PresenceMatrix and finite window, and serves as a foundational</span>
</span><span id="PresenceInvariant-35"><a href="#PresenceInvariant-35"><span class="linenos"> 35</span></a><span class="sd">    construct for reasoning about flow in non-linear systems.</span>
</span><span id="PresenceInvariant-36"><a href="#PresenceInvariant-36"><span class="linenos"> 36</span></a>
</span><span id="PresenceInvariant-37"><a href="#PresenceInvariant-37"><span class="linenos"> 37</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-38"><a href="#PresenceInvariant-38"><span class="linenos"> 38</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">PresenceMatrix</span><span class="p">[</span><span class="n">T_Element</span><span class="p">]):</span>
</span><span id="PresenceInvariant-39"><a href="#PresenceInvariant-39"><span class="linenos"> 39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="PresenceInvariant-40"><a href="#PresenceInvariant-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-41"><a href="#PresenceInvariant-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presences</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presences</span>
</span><span id="PresenceInvariant-42"><a href="#PresenceInvariant-42"><span class="linenos"> 42</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant-43"><a href="#PresenceInvariant-43"><span class="linenos"> 43</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-44"><a href="#PresenceInvariant-44"><span class="linenos"> 44</span></a>
</span><span id="PresenceInvariant-45"><a href="#PresenceInvariant-45"><span class="linenos"> 45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-46"><a href="#PresenceInvariant-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant-47"><a href="#PresenceInvariant-47"><span class="linenos"> 47</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-48"><a href="#PresenceInvariant-48"><span class="linenos"> 48</span></a>
</span><span id="PresenceInvariant-49"><a href="#PresenceInvariant-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceInvariant-50"><a href="#PresenceInvariant-50"><span class="linenos"> 50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The timescale of the presence matrix. This is the default &#39;window&#39; over which all metrics are computed.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-51"><a href="#PresenceInvariant-51"><span class="linenos"> 51</span></a>
</span><span id="PresenceInvariant-52"><a href="#PresenceInvariant-52"><span class="linenos"> 52</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">end_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant-53"><a href="#PresenceInvariant-53"><span class="linenos"> 53</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span> <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span>
</span><span id="PresenceInvariant-54"><a href="#PresenceInvariant-54"><span class="linenos"> 54</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="n">end_time</span> <span class="k">if</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span>
</span><span id="PresenceInvariant-55"><a href="#PresenceInvariant-55"><span class="linenos"> 55</span></a>        <span class="k">if</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span> <span class="ow">or</span> <span class="n">end_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="p">:</span>
</span><span id="PresenceInvariant-56"><a href="#PresenceInvariant-56"><span class="linenos"> 56</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PresenceInvariant-57"><a href="#PresenceInvariant-57"><span class="linenos"> 57</span></a>                <span class="sa">f</span><span class="s2">&quot;Presence metrics are not defined outside the time scale of the presence matrix.&quot;</span>
</span><span id="PresenceInvariant-58"><a href="#PresenceInvariant-58"><span class="linenos"> 58</span></a>                <span class="sa">f</span><span class="s2">&quot;Time scale = [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">t1</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="PresenceInvariant-59"><a href="#PresenceInvariant-59"><span class="linenos"> 59</span></a>                <span class="sa">f</span><span class="s2">&quot;Provided: [</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="PresenceInvariant-60"><a href="#PresenceInvariant-60"><span class="linenos"> 60</span></a>            <span class="p">)</span>
</span><span id="PresenceInvariant-61"><a href="#PresenceInvariant-61"><span class="linenos"> 61</span></a>        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
</span><span id="PresenceInvariant-62"><a href="#PresenceInvariant-62"><span class="linenos"> 62</span></a>
</span><span id="PresenceInvariant-63"><a href="#PresenceInvariant-63"><span class="linenos"> 63</span></a>
</span><span id="PresenceInvariant-64"><a href="#PresenceInvariant-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flow_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant-65"><a href="#PresenceInvariant-65"><span class="linenos"> 65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-66"><a href="#PresenceInvariant-66"><span class="linenos"> 66</span></a><span class="sd">        The flow rate Λ is defined as:</span>
</span><span id="PresenceInvariant-67"><a href="#PresenceInvariant-67"><span class="linenos"> 67</span></a><span class="sd">            number of active presences in the matrix slice [:start_bin:end_bin] /</span>
</span><span id="PresenceInvariant-68"><a href="#PresenceInvariant-68"><span class="linenos"> 68</span></a><span class="sd">            number of time bins in the slice (end_bin - start_bin)</span>
</span><span id="PresenceInvariant-69"><a href="#PresenceInvariant-69"><span class="linenos"> 69</span></a>
</span><span id="PresenceInvariant-70"><a href="#PresenceInvariant-70"><span class="linenos"> 70</span></a><span class="sd">        Conceptually:</span>
</span><span id="PresenceInvariant-71"><a href="#PresenceInvariant-71"><span class="linenos"> 71</span></a><span class="sd">            Let N be the number of presences (rows) that are active (non-zero)</span>
</span><span id="PresenceInvariant-72"><a href="#PresenceInvariant-72"><span class="linenos"> 72</span></a><span class="sd">            in the matrix between start_time and end_time.</span>
</span><span id="PresenceInvariant-73"><a href="#PresenceInvariant-73"><span class="linenos"> 73</span></a>
</span><span id="PresenceInvariant-74"><a href="#PresenceInvariant-74"><span class="linenos"> 74</span></a><span class="sd">            Let T be the number of discrete time bins (columns) in that interval.</span>
</span><span id="PresenceInvariant-75"><a href="#PresenceInvariant-75"><span class="linenos"> 75</span></a>
</span><span id="PresenceInvariant-76"><a href="#PresenceInvariant-76"><span class="linenos"> 76</span></a><span class="sd">            Then:</span>
</span><span id="PresenceInvariant-77"><a href="#PresenceInvariant-77"><span class="linenos"> 77</span></a><span class="sd">                flow_rate = Λ = N / T</span>
</span><span id="PresenceInvariant-78"><a href="#PresenceInvariant-78"><span class="linenos"> 78</span></a>
</span><span id="PresenceInvariant-79"><a href="#PresenceInvariant-79"><span class="linenos"> 79</span></a><span class="sd">        Examples:</span>
</span><span id="PresenceInvariant-80"><a href="#PresenceInvariant-80"><span class="linenos"> 80</span></a><span class="sd">            - If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</span>
</span><span id="PresenceInvariant-81"><a href="#PresenceInvariant-81"><span class="linenos"> 81</span></a><span class="sd">            - If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</span>
</span><span id="PresenceInvariant-82"><a href="#PresenceInvariant-82"><span class="linenos"> 82</span></a>
</span><span id="PresenceInvariant-83"><a href="#PresenceInvariant-83"><span class="linenos"> 83</span></a><span class="sd">        The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.</span>
</span><span id="PresenceInvariant-84"><a href="#PresenceInvariant-84"><span class="linenos"> 84</span></a><span class="sd">        The precise relationship between flow rate, arrival rate, and departure rate is as follows:</span>
</span><span id="PresenceInvariant-85"><a href="#PresenceInvariant-85"><span class="linenos"> 85</span></a>
</span><span id="PresenceInvariant-86"><a href="#PresenceInvariant-86"><span class="linenos"> 86</span></a><span class="sd">            N = number of presences that started *before* start_time (see `starting_presence_count`)</span>
</span><span id="PresenceInvariant-87"><a href="#PresenceInvariant-87"><span class="linenos"> 87</span></a><span class="sd">                + number that started *in* the interval [start_time, end_time) (see `arrival_count`)</span>
</span><span id="PresenceInvariant-88"><a href="#PresenceInvariant-88"><span class="linenos"> 88</span></a>
</span><span id="PresenceInvariant-89"><a href="#PresenceInvariant-89"><span class="linenos"> 89</span></a><span class="sd">              — this is also called the cumulative arrivals into the window</span>
</span><span id="PresenceInvariant-90"><a href="#PresenceInvariant-90"><span class="linenos"> 90</span></a>
</span><span id="PresenceInvariant-91"><a href="#PresenceInvariant-91"><span class="linenos"> 91</span></a><span class="sd">            or equivalently:</span>
</span><span id="PresenceInvariant-92"><a href="#PresenceInvariant-92"><span class="linenos"> 92</span></a>
</span><span id="PresenceInvariant-93"><a href="#PresenceInvariant-93"><span class="linenos"> 93</span></a><span class="sd">            N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)</span>
</span><span id="PresenceInvariant-94"><a href="#PresenceInvariant-94"><span class="linenos"> 94</span></a><span class="sd">                + number that ended *after* end_time (see `ending_presence_count`)</span>
</span><span id="PresenceInvariant-95"><a href="#PresenceInvariant-95"><span class="linenos"> 95</span></a>
</span><span id="PresenceInvariant-96"><a href="#PresenceInvariant-96"><span class="linenos"> 96</span></a><span class="sd">              — this is the departure contribution from the window</span>
</span><span id="PresenceInvariant-97"><a href="#PresenceInvariant-97"><span class="linenos"> 97</span></a>
</span><span id="PresenceInvariant-98"><a href="#PresenceInvariant-98"><span class="linenos"> 98</span></a><span class="sd">            These two decompositions of N are always equal; they just reflect different</span>
</span><span id="PresenceInvariant-99"><a href="#PresenceInvariant-99"><span class="linenos"> 99</span></a><span class="sd">            ways of expressing the same set of active presences.</span>
</span><span id="PresenceInvariant-100"><a href="#PresenceInvariant-100"><span class="linenos">100</span></a>
</span><span id="PresenceInvariant-101"><a href="#PresenceInvariant-101"><span class="linenos">101</span></a><span class="sd">        Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant-102"><a href="#PresenceInvariant-102"><span class="linenos">102</span></a><span class="sd">        will start and end within the window, with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant-103"><a href="#PresenceInvariant-103"><span class="linenos">103</span></a><span class="sd">        the interval at the beginning and end.</span>
</span><span id="PresenceInvariant-104"><a href="#PresenceInvariant-104"><span class="linenos">104</span></a>
</span><span id="PresenceInvariant-105"><a href="#PresenceInvariant-105"><span class="linenos">105</span></a><span class="sd">        This makes N an (over) estimate of true arrivals or departures over that interval.</span>
</span><span id="PresenceInvariant-106"><a href="#PresenceInvariant-106"><span class="linenos">106</span></a>
</span><span id="PresenceInvariant-107"><a href="#PresenceInvariant-107"><span class="linenos">107</span></a><span class="sd">        In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant-108"><a href="#PresenceInvariant-108"><span class="linenos">108</span></a><span class="sd">        then:</span>
</span><span id="PresenceInvariant-109"><a href="#PresenceInvariant-109"><span class="linenos">109</span></a><span class="sd">            flow_rate → arrival_rate → departure_rate</span>
</span><span id="PresenceInvariant-110"><a href="#PresenceInvariant-110"><span class="linenos">110</span></a>
</span><span id="PresenceInvariant-111"><a href="#PresenceInvariant-111"><span class="linenos">111</span></a><span class="sd">        When flow is fully convergent over the interval, then:</span>
</span><span id="PresenceInvariant-112"><a href="#PresenceInvariant-112"><span class="linenos">112</span></a><span class="sd">            flow_rate = arrival_rate = departure_rate</span>
</span><span id="PresenceInvariant-113"><a href="#PresenceInvariant-113"><span class="linenos">113</span></a>
</span><span id="PresenceInvariant-114"><a href="#PresenceInvariant-114"><span class="linenos">114</span></a><span class="sd">        This equality is one of the key conditions for *stable* flow through the boundary.</span>
</span><span id="PresenceInvariant-115"><a href="#PresenceInvariant-115"><span class="linenos">115</span></a>
</span><span id="PresenceInvariant-116"><a href="#PresenceInvariant-116"><span class="linenos">116</span></a><span class="sd">        On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant-117"><a href="#PresenceInvariant-117"><span class="linenos">117</span></a><span class="sd">        flow rate, arrival rate, and departure rate will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant-118"><a href="#PresenceInvariant-118"><span class="linenos">118</span></a><span class="sd">        or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant-119"><a href="#PresenceInvariant-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-120"><a href="#PresenceInvariant-120"><span class="linenos">120</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-121"><a href="#PresenceInvariant-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="n">number_of_presences</span><span class="o">/</span><span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-122"><a href="#PresenceInvariant-122"><span class="linenos">122</span></a>
</span><span id="PresenceInvariant-123"><a href="#PresenceInvariant-123"><span class="linenos">123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_residence_time_per_presence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant-124"><a href="#PresenceInvariant-124"><span class="linenos">124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-125"><a href="#PresenceInvariant-125"><span class="linenos">125</span></a><span class="sd">            Computes the average residence time over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant-126"><a href="#PresenceInvariant-126"><span class="linenos">126</span></a>
</span><span id="PresenceInvariant-127"><a href="#PresenceInvariant-127"><span class="linenos">127</span></a><span class="sd">            Let \$ P \$ be the set of presences that overlap the interval \$[\\text{start\\_time}, \\text{end\\_time})\$.</span>
</span><span id="PresenceInvariant-128"><a href="#PresenceInvariant-128"><span class="linenos">128</span></a>
</span><span id="PresenceInvariant-129"><a href="#PresenceInvariant-129"><span class="linenos">129</span></a><span class="sd">            The *residence time* \$ R(p) \$ is the time that presence \$ p \\in P \$ is active (overlaps) within that interval.</span>
</span><span id="PresenceInvariant-130"><a href="#PresenceInvariant-130"><span class="linenos">130</span></a>
</span><span id="PresenceInvariant-131"><a href="#PresenceInvariant-131"><span class="linenos">131</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant-132"><a href="#PresenceInvariant-132"><span class="linenos">132</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant-133"><a href="#PresenceInvariant-133"><span class="linenos">133</span></a>
</span><span id="PresenceInvariant-134"><a href="#PresenceInvariant-134"><span class="linenos">134</span></a><span class="sd">            The average residence time \$ w \$ is given by:</span>
</span><span id="PresenceInvariant-135"><a href="#PresenceInvariant-135"><span class="linenos">135</span></a>
</span><span id="PresenceInvariant-136"><a href="#PresenceInvariant-136"><span class="linenos">136</span></a><span class="sd">            \\[</span>
</span><span id="PresenceInvariant-137"><a href="#PresenceInvariant-137"><span class="linenos">137</span></a><span class="sd">            w = \\frac{\\sum_{p \\in P} R(p)}{|P|}</span>
</span><span id="PresenceInvariant-138"><a href="#PresenceInvariant-138"><span class="linenos">138</span></a><span class="sd">            \\]</span>
</span><span id="PresenceInvariant-139"><a href="#PresenceInvariant-139"><span class="linenos">139</span></a>
</span><span id="PresenceInvariant-140"><a href="#PresenceInvariant-140"><span class="linenos">140</span></a><span class="sd">            If no presences are active in the interval, \$ w = 0.0 \$.</span>
</span><span id="PresenceInvariant-141"><a href="#PresenceInvariant-141"><span class="linenos">141</span></a>
</span><span id="PresenceInvariant-142"><a href="#PresenceInvariant-142"><span class="linenos">142</span></a><span class="sd">            Note:</span>
</span><span id="PresenceInvariant-143"><a href="#PresenceInvariant-143"><span class="linenos">143</span></a><span class="sd">                There are four possible ways a presence can overlap a window [start, end):</span>
</span><span id="PresenceInvariant-144"><a href="#PresenceInvariant-144"><span class="linenos">144</span></a>
</span><span id="PresenceInvariant-145"><a href="#PresenceInvariant-145"><span class="linenos">145</span></a><span class="sd">                Ticks:     0   1   2   3   4   5   6   7</span>
</span><span id="PresenceInvariant-146"><a href="#PresenceInvariant-146"><span class="linenos">146</span></a><span class="sd">                           |---|---|---|---|---|---|---|</span>
</span><span id="PresenceInvariant-147"><a href="#PresenceInvariant-147"><span class="linenos">147</span></a><span class="sd">                Window:          |-----------|</span>
</span><span id="PresenceInvariant-148"><a href="#PresenceInvariant-148"><span class="linenos">148</span></a>
</span><span id="PresenceInvariant-149"><a href="#PresenceInvariant-149"><span class="linenos">149</span></a><span class="sd">                Case 1: Fully inside</span>
</span><span id="PresenceInvariant-150"><a href="#PresenceInvariant-150"><span class="linenos">150</span></a><span class="sd">                                     [=======]</span>
</span><span id="PresenceInvariant-151"><a href="#PresenceInvariant-151"><span class="linenos">151</span></a>
</span><span id="PresenceInvariant-152"><a href="#PresenceInvariant-152"><span class="linenos">152</span></a><span class="sd">                Case 2: Starts before, ends inside</span>
</span><span id="PresenceInvariant-153"><a href="#PresenceInvariant-153"><span class="linenos">153</span></a><span class="sd">                              [===========</span>
</span><span id="PresenceInvariant-154"><a href="#PresenceInvariant-154"><span class="linenos">154</span></a>
</span><span id="PresenceInvariant-155"><a href="#PresenceInvariant-155"><span class="linenos">155</span></a><span class="sd">                Case 3: Starts inside, ends after</span>
</span><span id="PresenceInvariant-156"><a href="#PresenceInvariant-156"><span class="linenos">156</span></a><span class="sd">                                     ===========]</span>
</span><span id="PresenceInvariant-157"><a href="#PresenceInvariant-157"><span class="linenos">157</span></a>
</span><span id="PresenceInvariant-158"><a href="#PresenceInvariant-158"><span class="linenos">158</span></a><span class="sd">                Case 4: Fully spans window</span>
</span><span id="PresenceInvariant-159"><a href="#PresenceInvariant-159"><span class="linenos">159</span></a><span class="sd">                              [====================]</span>
</span><span id="PresenceInvariant-160"><a href="#PresenceInvariant-160"><span class="linenos">160</span></a>
</span><span id="PresenceInvariant-161"><a href="#PresenceInvariant-161"><span class="linenos">161</span></a><span class="sd">                In all but Case 1, the window clips the presence, so the residence time</span>
</span><span id="PresenceInvariant-162"><a href="#PresenceInvariant-162"><span class="linenos">162</span></a><span class="sd">                is smaller than the presence duration. In Case 1, residence time equals presence duration.</span>
</span><span id="PresenceInvariant-163"><a href="#PresenceInvariant-163"><span class="linenos">163</span></a>
</span><span id="PresenceInvariant-164"><a href="#PresenceInvariant-164"><span class="linenos">164</span></a><span class="sd">                Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant-165"><a href="#PresenceInvariant-165"><span class="linenos">165</span></a><span class="sd">                will start and end within the window (Case 1), with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant-166"><a href="#PresenceInvariant-166"><span class="linenos">166</span></a><span class="sd">                the interval at the beginning and end or span the window (Cases 2–4).</span>
</span><span id="PresenceInvariant-167"><a href="#PresenceInvariant-167"><span class="linenos">167</span></a>
</span><span id="PresenceInvariant-168"><a href="#PresenceInvariant-168"><span class="linenos">168</span></a><span class="sd">                This makes \$ w \$ an (under)estimate of true presence duration.</span>
</span><span id="PresenceInvariant-169"><a href="#PresenceInvariant-169"><span class="linenos">169</span></a>
</span><span id="PresenceInvariant-170"><a href="#PresenceInvariant-170"><span class="linenos">170</span></a><span class="sd">                In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant-171"><a href="#PresenceInvariant-171"><span class="linenos">171</span></a><span class="sd">                then:</span>
</span><span id="PresenceInvariant-172"><a href="#PresenceInvariant-172"><span class="linenos">172</span></a><span class="sd">                    residence time → presence duration.</span>
</span><span id="PresenceInvariant-173"><a href="#PresenceInvariant-173"><span class="linenos">173</span></a>
</span><span id="PresenceInvariant-174"><a href="#PresenceInvariant-174"><span class="linenos">174</span></a><span class="sd">                When flow is fully convergent over the interval:</span>
</span><span id="PresenceInvariant-175"><a href="#PresenceInvariant-175"><span class="linenos">175</span></a><span class="sd">                    residence time = presence duration.</span>
</span><span id="PresenceInvariant-176"><a href="#PresenceInvariant-176"><span class="linenos">176</span></a>
</span><span id="PresenceInvariant-177"><a href="#PresenceInvariant-177"><span class="linenos">177</span></a><span class="sd">                On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant-178"><a href="#PresenceInvariant-178"><span class="linenos">178</span></a><span class="sd">                residence time and presence duration will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant-179"><a href="#PresenceInvariant-179"><span class="linenos">179</span></a><span class="sd">                or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant-180"><a href="#PresenceInvariant-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-181"><a href="#PresenceInvariant-181"><span class="linenos">181</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-182"><a href="#PresenceInvariant-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-183"><a href="#PresenceInvariant-183"><span class="linenos">183</span></a>
</span><span id="PresenceInvariant-184"><a href="#PresenceInvariant-184"><span class="linenos">184</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_presence_per_time_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant-185"><a href="#PresenceInvariant-185"><span class="linenos">185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-186"><a href="#PresenceInvariant-186"><span class="linenos">186</span></a><span class="sd">        Computes the average presence per time bin over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant-187"><a href="#PresenceInvariant-187"><span class="linenos">187</span></a>
</span><span id="PresenceInvariant-188"><a href="#PresenceInvariant-188"><span class="linenos">188</span></a><span class="sd">        Let \$ B \$ be the set of discrete time bins that cover the interval \$[\\text{start\\_time}, \\text{end\\_time})\$,</span>
</span><span id="PresenceInvariant-189"><a href="#PresenceInvariant-189"><span class="linenos">189</span></a><span class="sd">        and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \\in B \$.</span>
</span><span id="PresenceInvariant-190"><a href="#PresenceInvariant-190"><span class="linenos">190</span></a>
</span><span id="PresenceInvariant-191"><a href="#PresenceInvariant-191"><span class="linenos">191</span></a><span class="sd">        The average presence \$ L \$ is given by:</span>
</span><span id="PresenceInvariant-192"><a href="#PresenceInvariant-192"><span class="linenos">192</span></a>
</span><span id="PresenceInvariant-193"><a href="#PresenceInvariant-193"><span class="linenos">193</span></a><span class="sd">        \\[</span>
</span><span id="PresenceInvariant-194"><a href="#PresenceInvariant-194"><span class="linenos">194</span></a><span class="sd">        L = \\frac{\\sum_{b \\in B} P(b)}{|B|}</span>
</span><span id="PresenceInvariant-195"><a href="#PresenceInvariant-195"><span class="linenos">195</span></a><span class="sd">        \\]</span>
</span><span id="PresenceInvariant-196"><a href="#PresenceInvariant-196"><span class="linenos">196</span></a>
</span><span id="PresenceInvariant-197"><a href="#PresenceInvariant-197"><span class="linenos">197</span></a><span class="sd">        If the interval spans no bins, \$ L = 0.0 \$.</span>
</span><span id="PresenceInvariant-198"><a href="#PresenceInvariant-198"><span class="linenos">198</span></a>
</span><span id="PresenceInvariant-199"><a href="#PresenceInvariant-199"><span class="linenos">199</span></a><span class="sd">        Note:</span>
</span><span id="PresenceInvariant-200"><a href="#PresenceInvariant-200"><span class="linenos">200</span></a><span class="sd">            This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence</span>
</span><span id="PresenceInvariant-201"><a href="#PresenceInvariant-201"><span class="linenos">201</span></a><span class="sd">            durations we used to compute residence time) divided by the number of bins in the interval.</span>
</span><span id="PresenceInvariant-202"><a href="#PresenceInvariant-202"><span class="linenos">202</span></a>
</span><span id="PresenceInvariant-203"><a href="#PresenceInvariant-203"><span class="linenos">203</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant-204"><a href="#PresenceInvariant-204"><span class="linenos">204</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant-205"><a href="#PresenceInvariant-205"><span class="linenos">205</span></a>
</span><span id="PresenceInvariant-206"><a href="#PresenceInvariant-206"><span class="linenos">206</span></a><span class="sd">            Visually, this corresponds to summing presence *vertically* across bins:</span>
</span><span id="PresenceInvariant-207"><a href="#PresenceInvariant-207"><span class="linenos">207</span></a>
</span><span id="PresenceInvariant-208"><a href="#PresenceInvariant-208"><span class="linenos">208</span></a><span class="sd">            Example: presences over time bins</span>
</span><span id="PresenceInvariant-209"><a href="#PresenceInvariant-209"><span class="linenos">209</span></a>
</span><span id="PresenceInvariant-210"><a href="#PresenceInvariant-210"><span class="linenos">210</span></a><span class="sd">            Ticks:     0   1   2   3   4</span>
</span><span id="PresenceInvariant-211"><a href="#PresenceInvariant-211"><span class="linenos">211</span></a><span class="sd">                       |---|---|---|---|</span>
</span><span id="PresenceInvariant-212"><a href="#PresenceInvariant-212"><span class="linenos">212</span></a><span class="sd">            P1:         [=======]</span>
</span><span id="PresenceInvariant-213"><a href="#PresenceInvariant-213"><span class="linenos">213</span></a><span class="sd">            P2:             [=======]</span>
</span><span id="PresenceInvariant-214"><a href="#PresenceInvariant-214"><span class="linenos">214</span></a><span class="sd">            P3:                 [=======]</span>
</span><span id="PresenceInvariant-215"><a href="#PresenceInvariant-215"><span class="linenos">215</span></a>
</span><span id="PresenceInvariant-216"><a href="#PresenceInvariant-216"><span class="linenos">216</span></a><span class="sd">            Time bin 1:</span>
</span><span id="PresenceInvariant-217"><a href="#PresenceInvariant-217"><span class="linenos">217</span></a><span class="sd">                          ↑   (bin index 1 = [1, 2))</span>
</span><span id="PresenceInvariant-218"><a href="#PresenceInvariant-218"><span class="linenos">218</span></a><span class="sd">                          |---|</span>
</span><span id="PresenceInvariant-219"><a href="#PresenceInvariant-219"><span class="linenos">219</span></a><span class="sd">                      P1:   +</span>
</span><span id="PresenceInvariant-220"><a href="#PresenceInvariant-220"><span class="linenos">220</span></a><span class="sd">                      P2:   +</span>
</span><span id="PresenceInvariant-221"><a href="#PresenceInvariant-221"><span class="linenos">221</span></a><span class="sd">                      P3:   -</span>
</span><span id="PresenceInvariant-222"><a href="#PresenceInvariant-222"><span class="linenos">222</span></a><span class="sd">                    ---------</span>
</span><span id="PresenceInvariant-223"><a href="#PresenceInvariant-223"><span class="linenos">223</span></a><span class="sd">                    Sum:     2</span>
</span><span id="PresenceInvariant-224"><a href="#PresenceInvariant-224"><span class="linenos">224</span></a>
</span><span id="PresenceInvariant-225"><a href="#PresenceInvariant-225"><span class="linenos">225</span></a><span class="sd">            So:</span>
</span><span id="PresenceInvariant-226"><a href="#PresenceInvariant-226"><span class="linenos">226</span></a><span class="sd">                - Bin 1 has total presence = 2</span>
</span><span id="PresenceInvariant-227"><a href="#PresenceInvariant-227"><span class="linenos">227</span></a><span class="sd">                - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5</span>
</span><span id="PresenceInvariant-228"><a href="#PresenceInvariant-228"><span class="linenos">228</span></a><span class="sd">                - Then \$ L = 5.5 / 3 = 1.833... \$</span>
</span><span id="PresenceInvariant-229"><a href="#PresenceInvariant-229"><span class="linenos">229</span></a>
</span><span id="PresenceInvariant-230"><a href="#PresenceInvariant-230"><span class="linenos">230</span></a><span class="sd">            Conceptually, \$ L \$ reflects the average &quot;load&quot; or concurrency of presence in the system during the interval.</span>
</span><span id="PresenceInvariant-231"><a href="#PresenceInvariant-231"><span class="linenos">231</span></a>
</span><span id="PresenceInvariant-232"><a href="#PresenceInvariant-232"><span class="linenos">232</span></a><span class="sd">            This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</span>
</span><span id="PresenceInvariant-233"><a href="#PresenceInvariant-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-234"><a href="#PresenceInvariant-234"><span class="linenos">234</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-235"><a href="#PresenceInvariant-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-236"><a href="#PresenceInvariant-236"><span class="linenos">236</span></a>
</span><span id="PresenceInvariant-237"><a href="#PresenceInvariant-237"><span class="linenos">237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant-238"><a href="#PresenceInvariant-238"><span class="linenos">238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-239"><a href="#PresenceInvariant-239"><span class="linenos">239</span></a><span class="sd">            Computes the three core quantities from which all presence-based metrics are derived:</span>
</span><span id="PresenceInvariant-240"><a href="#PresenceInvariant-240"><span class="linenos">240</span></a>
</span><span id="PresenceInvariant-241"><a href="#PresenceInvariant-241"><span class="linenos">241</span></a><span class="sd">            - Total presence time \$ A \$ over the interval \$[\\text{start\\_time}, \\text{end\\_time})\$</span>
</span><span id="PresenceInvariant-242"><a href="#PresenceInvariant-242"><span class="linenos">242</span></a><span class="sd">            - Number of active presences \$ N \$ (i.e., rows overlapping the interval)</span>
</span><span id="PresenceInvariant-243"><a href="#PresenceInvariant-243"><span class="linenos">243</span></a><span class="sd">            - Number of time bins \$ T \$ covering the interval</span>
</span><span id="PresenceInvariant-244"><a href="#PresenceInvariant-244"><span class="linenos">244</span></a>
</span><span id="PresenceInvariant-245"><a href="#PresenceInvariant-245"><span class="linenos">245</span></a><span class="sd">            These three values form the basis for computing:</span>
</span><span id="PresenceInvariant-246"><a href="#PresenceInvariant-246"><span class="linenos">246</span></a>
</span><span id="PresenceInvariant-247"><a href="#PresenceInvariant-247"><span class="linenos">247</span></a><span class="sd">            - Average presence per time bin: \$ L = A / T \$</span>
</span><span id="PresenceInvariant-248"><a href="#PresenceInvariant-248"><span class="linenos">248</span></a><span class="sd">            - Average residence time per presence: \$ w = A / N \$</span>
</span><span id="PresenceInvariant-249"><a href="#PresenceInvariant-249"><span class="linenos">249</span></a><span class="sd">            - Flow rate: \$ \\Lambda = N / T \$</span>
</span><span id="PresenceInvariant-250"><a href="#PresenceInvariant-250"><span class="linenos">250</span></a>
</span><span id="PresenceInvariant-251"><a href="#PresenceInvariant-251"><span class="linenos">251</span></a><span class="sd">            This method is the common workhorse that underlies `avg_presence_per_time_bin`,</span>
</span><span id="PresenceInvariant-252"><a href="#PresenceInvariant-252"><span class="linenos">252</span></a><span class="sd">            `avg_residence_time_per_presence`, and `flow_rate`.</span>
</span><span id="PresenceInvariant-253"><a href="#PresenceInvariant-253"><span class="linenos">253</span></a>
</span><span id="PresenceInvariant-254"><a href="#PresenceInvariant-254"><span class="linenos">254</span></a><span class="sd">            ... and much of this work lives in `PresenceMap.presence_value_in`</span>
</span><span id="PresenceInvariant-255"><a href="#PresenceInvariant-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-256"><a href="#PresenceInvariant-256"><span class="linenos">256</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-257"><a href="#PresenceInvariant-257"><span class="linenos">257</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-258"><a href="#PresenceInvariant-258"><span class="linenos">258</span></a>        <span class="n">total_presence_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant-259"><a href="#PresenceInvariant-259"><span class="linenos">259</span></a>        <span class="n">number_of_presences</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant-260"><a href="#PresenceInvariant-260"><span class="linenos">260</span></a>        <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span>
</span><span id="PresenceInvariant-261"><a href="#PresenceInvariant-261"><span class="linenos">261</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="PresenceInvariant-262"><a href="#PresenceInvariant-262"><span class="linenos">262</span></a>                <span class="n">total_presence_value</span> <span class="o">+=</span> <span class="n">pm</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-263"><a href="#PresenceInvariant-263"><span class="linenos">263</span></a>                <span class="n">number_of_presences</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PresenceInvariant-264"><a href="#PresenceInvariant-264"><span class="linenos">264</span></a>
</span><span id="PresenceInvariant-265"><a href="#PresenceInvariant-265"><span class="linenos">265</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="n">start_bin</span>
</span><span id="PresenceInvariant-266"><a href="#PresenceInvariant-266"><span class="linenos">266</span></a>
</span><span id="PresenceInvariant-267"><a href="#PresenceInvariant-267"><span class="linenos">267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant-268"><a href="#PresenceInvariant-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-269"><a href="#PresenceInvariant-269"><span class="linenos">269</span></a><span class="sd">        Computes all three components of the *Presence Invariant* for a finite window</span>
</span><span id="PresenceInvariant-270"><a href="#PresenceInvariant-270"><span class="linenos">270</span></a><span class="sd">        $[ \text{start\_time}, \text{end\_time} )$ within the timescale $[ t_0, t_1 )$</span>
</span><span id="PresenceInvariant-271"><a href="#PresenceInvariant-271"><span class="linenos">271</span></a><span class="sd">        of the PresenceMatrix.</span>
</span><span id="PresenceInvariant-272"><a href="#PresenceInvariant-272"><span class="linenos">272</span></a>
</span><span id="PresenceInvariant-273"><a href="#PresenceInvariant-273"><span class="linenos">273</span></a><span class="sd">        The Presence Invariant states that for *any* such interval:</span>
</span><span id="PresenceInvariant-274"><a href="#PresenceInvariant-274"><span class="linenos">274</span></a>
</span><span id="PresenceInvariant-275"><a href="#PresenceInvariant-275"><span class="linenos">275</span></a><span class="sd">            \[</span>
</span><span id="PresenceInvariant-276"><a href="#PresenceInvariant-276"><span class="linenos">276</span></a><span class="sd">            L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-277"><a href="#PresenceInvariant-277"><span class="linenos">277</span></a><span class="sd">            \]</span>
</span><span id="PresenceInvariant-278"><a href="#PresenceInvariant-278"><span class="linenos">278</span></a>
</span><span id="PresenceInvariant-279"><a href="#PresenceInvariant-279"><span class="linenos">279</span></a><span class="sd">        This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant-280"><a href="#PresenceInvariant-280"><span class="linenos">280</span></a><span class="sd">        in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant-281"><a href="#PresenceInvariant-281"><span class="linenos">281</span></a><span class="sd">        the more familiar equilibrium-based Little’s Law by expressing a conservation law</span>
</span><span id="PresenceInvariant-282"><a href="#PresenceInvariant-282"><span class="linenos">282</span></a><span class="sd">        that applies across all time scales.</span>
</span><span id="PresenceInvariant-283"><a href="#PresenceInvariant-283"><span class="linenos">283</span></a>
</span><span id="PresenceInvariant-284"><a href="#PresenceInvariant-284"><span class="linenos">284</span></a><span class="sd">        - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant-285"><a href="#PresenceInvariant-285"><span class="linenos">285</span></a><span class="sd">        - $\Lambda$: the *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant-286"><a href="#PresenceInvariant-286"><span class="linenos">286</span></a><span class="sd">        - $w$: the *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant-287"><a href="#PresenceInvariant-287"><span class="linenos">287</span></a>
</span><span id="PresenceInvariant-288"><a href="#PresenceInvariant-288"><span class="linenos">288</span></a><span class="sd">        **Derivation:**</span>
</span><span id="PresenceInvariant-289"><a href="#PresenceInvariant-289"><span class="linenos">289</span></a>
</span><span id="PresenceInvariant-290"><a href="#PresenceInvariant-290"><span class="linenos">290</span></a><span class="sd">        Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant-291"><a href="#PresenceInvariant-291"><span class="linenos">291</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant-292"><a href="#PresenceInvariant-292"><span class="linenos">292</span></a>
</span><span id="PresenceInvariant-293"><a href="#PresenceInvariant-293"><span class="linenos">293</span></a><span class="sd">        \[</span>
</span><span id="PresenceInvariant-294"><a href="#PresenceInvariant-294"><span class="linenos">294</span></a><span class="sd">        A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant-295"><a href="#PresenceInvariant-295"><span class="linenos">295</span></a><span class="sd">        \]</span>
</span><span id="PresenceInvariant-296"><a href="#PresenceInvariant-296"><span class="linenos">296</span></a>
</span><span id="PresenceInvariant-297"><a href="#PresenceInvariant-297"><span class="linenos">297</span></a><span class="sd">        Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant-298"><a href="#PresenceInvariant-298"><span class="linenos">298</span></a>
</span><span id="PresenceInvariant-299"><a href="#PresenceInvariant-299"><span class="linenos">299</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant-300"><a href="#PresenceInvariant-300"><span class="linenos">300</span></a>
</span><span id="PresenceInvariant-301"><a href="#PresenceInvariant-301"><span class="linenos">301</span></a><span class="sd">        \[</span>
</span><span id="PresenceInvariant-302"><a href="#PresenceInvariant-302"><span class="linenos">302</span></a><span class="sd">        L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant-303"><a href="#PresenceInvariant-303"><span class="linenos">303</span></a><span class="sd">        \]</span>
</span><span id="PresenceInvariant-304"><a href="#PresenceInvariant-304"><span class="linenos">304</span></a>
</span><span id="PresenceInvariant-305"><a href="#PresenceInvariant-305"><span class="linenos">305</span></a><span class="sd">        Hence:</span>
</span><span id="PresenceInvariant-306"><a href="#PresenceInvariant-306"><span class="linenos">306</span></a>
</span><span id="PresenceInvariant-307"><a href="#PresenceInvariant-307"><span class="linenos">307</span></a><span class="sd">        \[</span>
</span><span id="PresenceInvariant-308"><a href="#PresenceInvariant-308"><span class="linenos">308</span></a><span class="sd">        L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-309"><a href="#PresenceInvariant-309"><span class="linenos">309</span></a><span class="sd">        \]</span>
</span><span id="PresenceInvariant-310"><a href="#PresenceInvariant-310"><span class="linenos">310</span></a>
</span><span id="PresenceInvariant-311"><a href="#PresenceInvariant-311"><span class="linenos">311</span></a><span class="sd">        This identity—what we call the *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant-312"><a href="#PresenceInvariant-312"><span class="linenos">312</span></a><span class="sd">        all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</span>
</span><span id="PresenceInvariant-313"><a href="#PresenceInvariant-313"><span class="linenos">313</span></a>
</span><span id="PresenceInvariant-314"><a href="#PresenceInvariant-314"><span class="linenos">314</span></a><span class="sd">        Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant-315"><a href="#PresenceInvariant-315"><span class="linenos">315</span></a><span class="sd">        (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant-316"><a href="#PresenceInvariant-316"><span class="linenos">316</span></a>
</span><span id="PresenceInvariant-317"><a href="#PresenceInvariant-317"><span class="linenos">317</span></a><span class="sd">        - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$ and average duration $W$.</span>
</span><span id="PresenceInvariant-318"><a href="#PresenceInvariant-318"><span class="linenos">318</span></a><span class="sd">        - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite approximations.</span>
</span><span id="PresenceInvariant-319"><a href="#PresenceInvariant-319"><span class="linenos">319</span></a>
</span><span id="PresenceInvariant-320"><a href="#PresenceInvariant-320"><span class="linenos">320</span></a><span class="sd">        Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant-321"><a href="#PresenceInvariant-321"><span class="linenos">321</span></a><span class="sd">        and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant-322"><a href="#PresenceInvariant-322"><span class="linenos">322</span></a>
</span><span id="PresenceInvariant-323"><a href="#PresenceInvariant-323"><span class="linenos">323</span></a><span class="sd">        ## References</span>
</span><span id="PresenceInvariant-324"><a href="#PresenceInvariant-324"><span class="linenos">324</span></a>
</span><span id="PresenceInvariant-325"><a href="#PresenceInvariant-325"><span class="linenos">325</span></a><span class="sd">            1. **Little’s Law**</span>
</span><span id="PresenceInvariant-326"><a href="#PresenceInvariant-326"><span class="linenos">326</span></a><span class="sd">               Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant-327"><a href="#PresenceInvariant-327"><span class="linenos">327</span></a><span class="sd">               [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant-328"><a href="#PresenceInvariant-328"><span class="linenos">328</span></a>
</span><span id="PresenceInvariant-329"><a href="#PresenceInvariant-329"><span class="linenos">329</span></a><span class="sd">            2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant-330"><a href="#PresenceInvariant-330"><span class="linenos">330</span></a><span class="sd">               Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant-331"><a href="#PresenceInvariant-331"><span class="linenos">331</span></a><span class="sd">               [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant-332"><a href="#PresenceInvariant-332"><span class="linenos">332</span></a>
</span><span id="PresenceInvariant-333"><a href="#PresenceInvariant-333"><span class="linenos">333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-334"><a href="#PresenceInvariant-334"><span class="linenos">334</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-335"><a href="#PresenceInvariant-335"><span class="linenos">335</span></a>
</span><span id="PresenceInvariant-336"><a href="#PresenceInvariant-336"><span class="linenos">336</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-337"><a href="#PresenceInvariant-337"><span class="linenos">337</span></a>        <span class="n">Λ</span> <span class="o">=</span> <span class="n">number_of_presences</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-338"><a href="#PresenceInvariant-338"><span class="linenos">338</span></a>        <span class="n">W</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant-339"><a href="#PresenceInvariant-339"><span class="linenos">339</span></a>
</span><span id="PresenceInvariant-340"><a href="#PresenceInvariant-340"><span class="linenos">340</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">W</span>
</span><span id="PresenceInvariant-341"><a href="#PresenceInvariant-341"><span class="linenos">341</span></a>
</span><span id="PresenceInvariant-342"><a href="#PresenceInvariant-342"><span class="linenos">342</span></a>
</span><span id="PresenceInvariant-343"><a href="#PresenceInvariant-343"><span class="linenos">343</span></a>
</span><span id="PresenceInvariant-344"><a href="#PresenceInvariant-344"><span class="linenos">344</span></a>
</span><span id="PresenceInvariant-345"><a href="#PresenceInvariant-345"><span class="linenos">345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">starting_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-346"><a href="#PresenceInvariant-346"><span class="linenos">346</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-347"><a href="#PresenceInvariant-347"><span class="linenos">347</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-348"><a href="#PresenceInvariant-348"><span class="linenos">348</span></a>
</span><span id="PresenceInvariant-349"><a href="#PresenceInvariant-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-350"><a href="#PresenceInvariant-350"><span class="linenos">350</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-351"><a href="#PresenceInvariant-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-352"><a href="#PresenceInvariant-352"><span class="linenos">352</span></a>            <span class="c1">#Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant-353"><a href="#PresenceInvariant-353"><span class="linenos">353</span></a>            <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant-354"><a href="#PresenceInvariant-354"><span class="linenos">354</span></a>            <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant-355"><a href="#PresenceInvariant-355"><span class="linenos">355</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start_bin</span>
</span><span id="PresenceInvariant-356"><a href="#PresenceInvariant-356"><span class="linenos">356</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-357"><a href="#PresenceInvariant-357"><span class="linenos">357</span></a>
</span><span id="PresenceInvariant-358"><a href="#PresenceInvariant-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ending_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-359"><a href="#PresenceInvariant-359"><span class="linenos">359</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-360"><a href="#PresenceInvariant-360"><span class="linenos">360</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-361"><a href="#PresenceInvariant-361"><span class="linenos">361</span></a>
</span><span id="PresenceInvariant-362"><a href="#PresenceInvariant-362"><span class="linenos">362</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-363"><a href="#PresenceInvariant-363"><span class="linenos">363</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-364"><a href="#PresenceInvariant-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-365"><a href="#PresenceInvariant-365"><span class="linenos">365</span></a>            <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="PresenceInvariant-366"><a href="#PresenceInvariant-366"><span class="linenos">366</span></a>                 <span class="c1"># Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant-367"><a href="#PresenceInvariant-367"><span class="linenos">367</span></a>                 <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant-368"><a href="#PresenceInvariant-368"><span class="linenos">368</span></a>                 <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant-369"><a href="#PresenceInvariant-369"><span class="linenos">369</span></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-370"><a href="#PresenceInvariant-370"><span class="linenos">370</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-371"><a href="#PresenceInvariant-371"><span class="linenos">371</span></a>
</span><span id="PresenceInvariant-372"><a href="#PresenceInvariant-372"><span class="linenos">372</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arrival_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-373"><a href="#PresenceInvariant-373"><span class="linenos">373</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of presences that started within the window&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-374"><a href="#PresenceInvariant-374"><span class="linenos">374</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-375"><a href="#PresenceInvariant-375"><span class="linenos">375</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-376"><a href="#PresenceInvariant-376"><span class="linenos">376</span></a>
</span><span id="PresenceInvariant-377"><a href="#PresenceInvariant-377"><span class="linenos">377</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-378"><a href="#PresenceInvariant-378"><span class="linenos">378</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-379"><a href="#PresenceInvariant-379"><span class="linenos">379</span></a>            <span class="k">if</span> <span class="n">start_bin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_bin</span>
</span><span id="PresenceInvariant-380"><a href="#PresenceInvariant-380"><span class="linenos">380</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-381"><a href="#PresenceInvariant-381"><span class="linenos">381</span></a>
</span><span id="PresenceInvariant-382"><a href="#PresenceInvariant-382"><span class="linenos">382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">departure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant-383"><a href="#PresenceInvariant-383"><span class="linenos">383</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant-384"><a href="#PresenceInvariant-384"><span class="linenos">384</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-385"><a href="#PresenceInvariant-385"><span class="linenos">385</span></a>
</span><span id="PresenceInvariant-386"><a href="#PresenceInvariant-386"><span class="linenos">386</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant-387"><a href="#PresenceInvariant-387"><span class="linenos">387</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant-388"><a href="#PresenceInvariant-388"><span class="linenos">388</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant-389"><a href="#PresenceInvariant-389"><span class="linenos">389</span></a>            <span class="ow">and</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-390"><a href="#PresenceInvariant-390"><span class="linenos">390</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant-391"><a href="#PresenceInvariant-391"><span class="linenos">391</span></a>        <span class="p">)</span>
</span><span id="PresenceInvariant-392"><a href="#PresenceInvariant-392"><span class="linenos">392</span></a>
</span><span id="PresenceInvariant-393"><a href="#PresenceInvariant-393"><span class="linenos">393</span></a>
</span><span id="PresenceInvariant-394"><a href="#PresenceInvariant-394"><span class="linenos">394</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PresenceInvariant-395"><a href="#PresenceInvariant-395"><span class="linenos">395</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant-396"><a href="#PresenceInvariant-396"><span class="linenos">396</span></a><span class="sd">            The key function of this class is to precisely compute the components of key rate conserved quantities</span>
</span><span id="PresenceInvariant-397"><a href="#PresenceInvariant-397"><span class="linenos">397</span></a><span class="sd">            tied to Presence under both equilibrium and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant-398"><a href="#PresenceInvariant-398"><span class="linenos">398</span></a>
</span><span id="PresenceInvariant-399"><a href="#PresenceInvariant-399"><span class="linenos">399</span></a><span class="sd">            The key relationship that matters here is the Presence Invariant, which is rate conservation law</span>
</span><span id="PresenceInvariant-400"><a href="#PresenceInvariant-400"><span class="linenos">400</span></a><span class="sd">            for a PresenceMatrix under non-equilibrium condition.</span>
</span><span id="PresenceInvariant-401"><a href="#PresenceInvariant-401"><span class="linenos">401</span></a>
</span><span id="PresenceInvariant-402"><a href="#PresenceInvariant-402"><span class="linenos">402</span></a><span class="sd">            The Presence Invariant states that for *any* finite interval [start_time, end_time) over the timescale [t0, t1)</span>
</span><span id="PresenceInvariant-403"><a href="#PresenceInvariant-403"><span class="linenos">403</span></a><span class="sd">            of a Presence Matrix:</span>
</span><span id="PresenceInvariant-404"><a href="#PresenceInvariant-404"><span class="linenos">404</span></a>
</span><span id="PresenceInvariant-405"><a href="#PresenceInvariant-405"><span class="linenos">405</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant-406"><a href="#PresenceInvariant-406"><span class="linenos">406</span></a><span class="sd">                    L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant-407"><a href="#PresenceInvariant-407"><span class="linenos">407</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant-408"><a href="#PresenceInvariant-408"><span class="linenos">408</span></a>
</span><span id="PresenceInvariant-409"><a href="#PresenceInvariant-409"><span class="linenos">409</span></a><span class="sd">                - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant-410"><a href="#PresenceInvariant-410"><span class="linenos">410</span></a><span class="sd">                - $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant-411"><a href="#PresenceInvariant-411"><span class="linenos">411</span></a><span class="sd">                - $w$: a *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant-412"><a href="#PresenceInvariant-412"><span class="linenos">412</span></a>
</span><span id="PresenceInvariant-413"><a href="#PresenceInvariant-413"><span class="linenos">413</span></a><span class="sd">                This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant-414"><a href="#PresenceInvariant-414"><span class="linenos">414</span></a><span class="sd">                in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant-415"><a href="#PresenceInvariant-415"><span class="linenos">415</span></a><span class="sd">                the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law</span>
</span><span id="PresenceInvariant-416"><a href="#PresenceInvariant-416"><span class="linenos">416</span></a><span class="sd">                that applies across all time scales and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant-417"><a href="#PresenceInvariant-417"><span class="linenos">417</span></a>
</span><span id="PresenceInvariant-418"><a href="#PresenceInvariant-418"><span class="linenos">418</span></a><span class="sd">                The proof of this invariant is surprisingly simple and elementary.</span>
</span><span id="PresenceInvariant-419"><a href="#PresenceInvariant-419"><span class="linenos">419</span></a>
</span><span id="PresenceInvariant-420"><a href="#PresenceInvariant-420"><span class="linenos">420</span></a><span class="sd">                **Derivation:**</span>
</span><span id="PresenceInvariant-421"><a href="#PresenceInvariant-421"><span class="linenos">421</span></a>
</span><span id="PresenceInvariant-422"><a href="#PresenceInvariant-422"><span class="linenos">422</span></a><span class="sd">                Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant-423"><a href="#PresenceInvariant-423"><span class="linenos">423</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant-424"><a href="#PresenceInvariant-424"><span class="linenos">424</span></a>
</span><span id="PresenceInvariant-425"><a href="#PresenceInvariant-425"><span class="linenos">425</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-426"><a href="#PresenceInvariant-426"><span class="linenos">426</span></a><span class="sd">                A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant-427"><a href="#PresenceInvariant-427"><span class="linenos">427</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-428"><a href="#PresenceInvariant-428"><span class="linenos">428</span></a>
</span><span id="PresenceInvariant-429"><a href="#PresenceInvariant-429"><span class="linenos">429</span></a><span class="sd">                Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant-430"><a href="#PresenceInvariant-430"><span class="linenos">430</span></a>
</span><span id="PresenceInvariant-431"><a href="#PresenceInvariant-431"><span class="linenos">431</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant-432"><a href="#PresenceInvariant-432"><span class="linenos">432</span></a>
</span><span id="PresenceInvariant-433"><a href="#PresenceInvariant-433"><span class="linenos">433</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-434"><a href="#PresenceInvariant-434"><span class="linenos">434</span></a>
</span><span id="PresenceInvariant-435"><a href="#PresenceInvariant-435"><span class="linenos">435</span></a><span class="sd">                L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant-436"><a href="#PresenceInvariant-436"><span class="linenos">436</span></a>
</span><span id="PresenceInvariant-437"><a href="#PresenceInvariant-437"><span class="linenos">437</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant-438"><a href="#PresenceInvariant-438"><span class="linenos">438</span></a>
</span><span id="PresenceInvariant-439"><a href="#PresenceInvariant-439"><span class="linenos">439</span></a><span class="sd">                Hence:</span>
</span><span id="PresenceInvariant-440"><a href="#PresenceInvariant-440"><span class="linenos">440</span></a>
</span><span id="PresenceInvariant-441"><a href="#PresenceInvariant-441"><span class="linenos">441</span></a><span class="sd">                $$ L = \Lambda \cdot w $$</span>
</span><span id="PresenceInvariant-442"><a href="#PresenceInvariant-442"><span class="linenos">442</span></a>
</span><span id="PresenceInvariant-443"><a href="#PresenceInvariant-443"><span class="linenos">443</span></a><span class="sd">                The *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant-444"><a href="#PresenceInvariant-444"><span class="linenos">444</span></a><span class="sd">                all proofs of Little’s Law [1], and can be seen as its finite-window version.</span>
</span><span id="PresenceInvariant-445"><a href="#PresenceInvariant-445"><span class="linenos">445</span></a>
</span><span id="PresenceInvariant-446"><a href="#PresenceInvariant-446"><span class="linenos">446</span></a><span class="sd">                Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant-447"><a href="#PresenceInvariant-447"><span class="linenos">447</span></a><span class="sd">                (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant-448"><a href="#PresenceInvariant-448"><span class="linenos">448</span></a>
</span><span id="PresenceInvariant-449"><a href="#PresenceInvariant-449"><span class="linenos">449</span></a><span class="sd">                - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$</span>
</span><span id="PresenceInvariant-450"><a href="#PresenceInvariant-450"><span class="linenos">450</span></a><span class="sd">                and average duration $W$.</span>
</span><span id="PresenceInvariant-451"><a href="#PresenceInvariant-451"><span class="linenos">451</span></a><span class="sd">                - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite</span>
</span><span id="PresenceInvariant-452"><a href="#PresenceInvariant-452"><span class="linenos">452</span></a><span class="sd">                window approximations.</span>
</span><span id="PresenceInvariant-453"><a href="#PresenceInvariant-453"><span class="linenos">453</span></a>
</span><span id="PresenceInvariant-454"><a href="#PresenceInvariant-454"><span class="linenos">454</span></a><span class="sd">                Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant-455"><a href="#PresenceInvariant-455"><span class="linenos">455</span></a><span class="sd">                and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant-456"><a href="#PresenceInvariant-456"><span class="linenos">456</span></a>
</span><span id="PresenceInvariant-457"><a href="#PresenceInvariant-457"><span class="linenos">457</span></a><span class="sd">                References:</span>
</span><span id="PresenceInvariant-458"><a href="#PresenceInvariant-458"><span class="linenos">458</span></a>
</span><span id="PresenceInvariant-459"><a href="#PresenceInvariant-459"><span class="linenos">459</span></a><span class="sd">                1. **Little’s Law**</span>
</span><span id="PresenceInvariant-460"><a href="#PresenceInvariant-460"><span class="linenos">460</span></a><span class="sd">                   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant-461"><a href="#PresenceInvariant-461"><span class="linenos">461</span></a><span class="sd">                   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant-462"><a href="#PresenceInvariant-462"><span class="linenos">462</span></a>
</span><span id="PresenceInvariant-463"><a href="#PresenceInvariant-463"><span class="linenos">463</span></a><span class="sd">                2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant-464"><a href="#PresenceInvariant-464"><span class="linenos">464</span></a><span class="sd">                   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant-465"><a href="#PresenceInvariant-465"><span class="linenos">465</span></a><span class="sd">                   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant-466"><a href="#PresenceInvariant-466"><span class="linenos">466</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Computes the components of the <em>Presence Invariant</em> for a finite window
    <code>[start_time, end_time)</code> over the timescale <code>[t0, t1)</code> of the PresenceMatrix.</p>

<p>The Presence Invariant states that for <em>any</em> such interval:
        $$
            L = \Lambda \cdot w
        $$
where</p>

<ul>
<li><strong>$L$</strong>: the average <em>presence</em> per unit time in the interval</li>
<li><strong>$\Lambda$</strong>: The <em>flow rate</em> - a finite approximation of <em>presence arrival/departure rate</em>.</li>
<li><strong>$w$</strong>: The <em>residence time</em> - a finite approximation of <em>presence duration</em>.</li>
</ul>

<p>This invariant extends the classical formulation of Little’s Law—an equilibrium-based identity—by establishing a
conservation law (of presence) that remains valid across arbitrary timescales, including in stochastic processes
that operate far from equilibrium.</p>

<p>It holds unconditionally for any PresenceMatrix and finite window, and serves as a foundational
construct for reasoning about flow in non-linear systems.</p>
</div>


                            <div id="PresenceInvariant.__init__" class="classattr">
                                        <input id="PresenceInvariant.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">PresenceInvariant</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">matrix</span><span class="p">:</span> <span class="n"><a href="presence_matrix.html#PresenceMatrix">pcalc.presence_matrix.PresenceMatrix</a></span><span class="p">[</span><span class="o">~</span><span class="n">T_Element</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="PresenceInvariant.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.__init__-38"><a href="#PresenceInvariant.__init__-38"><span class="linenos">38</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">PresenceMatrix</span><span class="p">[</span><span class="n">T_Element</span><span class="p">]):</span>
</span><span id="PresenceInvariant.__init__-39"><a href="#PresenceInvariant.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
</span><span id="PresenceInvariant.__init__-40"><a href="#PresenceInvariant.__init__-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.__init__-41"><a href="#PresenceInvariant.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presences</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Presence</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presences</span>
</span><span id="PresenceInvariant.__init__-42"><a href="#PresenceInvariant.__init__-42"><span class="linenos">42</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant.__init__-43"><a href="#PresenceInvariant.__init__-43"><span class="linenos">43</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.__init__-44"><a href="#PresenceInvariant.__init__-44"><span class="linenos">44</span></a>
</span><span id="PresenceInvariant.__init__-45"><a href="#PresenceInvariant.__init__-45"><span class="linenos">45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PresenceMap</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.__init__-46"><a href="#PresenceInvariant.__init__-46"><span class="linenos">46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Only presences that overlap the interval [t0, t1) are included in Presence Metrics.</span>
</span><span id="PresenceInvariant.__init__-47"><a href="#PresenceInvariant.__init__-47"><span class="linenos">47</span></a><span class="sd">        Note however that this may include presences that started before the interval or ended after the interval.&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.__init__-48"><a href="#PresenceInvariant.__init__-48"><span class="linenos">48</span></a>
</span><span id="PresenceInvariant.__init__-49"><a href="#PresenceInvariant.__init__-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">time_scale</span>
</span><span id="PresenceInvariant.__init__-50"><a href="#PresenceInvariant.__init__-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The timescale of the presence matrix. This is the default &#39;window&#39; over which all metrics are computed.&quot;&quot;&quot;</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.matrix" class="classattr">
                                <div class="attr variable">
            <span class="name">matrix</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.matrix"></a>
    
    

                            </div>
                            <div id="PresenceInvariant.presences" class="classattr">
                                <div class="attr variable">
            <span class="name">presences</span><span class="annotation">: list[metamodel.presence.Presence]</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.presences"></a>
    
            <div class="docstring"><p>Only presences that overlap the interval [t0, t1) are included in Presence Metrics.
Note however that this may include presences that started before the interval or ended after the interval.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.presence_map" class="classattr">
                                <div class="attr variable">
            <span class="name">presence_map</span><span class="annotation">: list[<a href="presence_map.html#PresenceMap">pcalc.presence_map.PresenceMap</a>]</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.presence_map"></a>
    
            <div class="docstring"><p>Only presences that overlap the interval [t0, t1) are included in Presence Metrics.
Note however that this may include presences that started before the interval or ended after the interval.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.ts" class="classattr">
                                <div class="attr variable">
            <span class="name">ts</span>

        
    </div>
    <a class="headerlink" href="#PresenceInvariant.ts"></a>
    
            <div class="docstring"><p>The timescale of the presence matrix. This is the default 'window' over which all metrics are computed.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.flow_rate" class="classattr">
                                        <input id="PresenceInvariant.flow_rate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">flow_rate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.flow_rate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.flow_rate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.flow_rate-64"><a href="#PresenceInvariant.flow_rate-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flow_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant.flow_rate-65"><a href="#PresenceInvariant.flow_rate-65"><span class="linenos"> 65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.flow_rate-66"><a href="#PresenceInvariant.flow_rate-66"><span class="linenos"> 66</span></a><span class="sd">        The flow rate Λ is defined as:</span>
</span><span id="PresenceInvariant.flow_rate-67"><a href="#PresenceInvariant.flow_rate-67"><span class="linenos"> 67</span></a><span class="sd">            number of active presences in the matrix slice [:start_bin:end_bin] /</span>
</span><span id="PresenceInvariant.flow_rate-68"><a href="#PresenceInvariant.flow_rate-68"><span class="linenos"> 68</span></a><span class="sd">            number of time bins in the slice (end_bin - start_bin)</span>
</span><span id="PresenceInvariant.flow_rate-69"><a href="#PresenceInvariant.flow_rate-69"><span class="linenos"> 69</span></a>
</span><span id="PresenceInvariant.flow_rate-70"><a href="#PresenceInvariant.flow_rate-70"><span class="linenos"> 70</span></a><span class="sd">        Conceptually:</span>
</span><span id="PresenceInvariant.flow_rate-71"><a href="#PresenceInvariant.flow_rate-71"><span class="linenos"> 71</span></a><span class="sd">            Let N be the number of presences (rows) that are active (non-zero)</span>
</span><span id="PresenceInvariant.flow_rate-72"><a href="#PresenceInvariant.flow_rate-72"><span class="linenos"> 72</span></a><span class="sd">            in the matrix between start_time and end_time.</span>
</span><span id="PresenceInvariant.flow_rate-73"><a href="#PresenceInvariant.flow_rate-73"><span class="linenos"> 73</span></a>
</span><span id="PresenceInvariant.flow_rate-74"><a href="#PresenceInvariant.flow_rate-74"><span class="linenos"> 74</span></a><span class="sd">            Let T be the number of discrete time bins (columns) in that interval.</span>
</span><span id="PresenceInvariant.flow_rate-75"><a href="#PresenceInvariant.flow_rate-75"><span class="linenos"> 75</span></a>
</span><span id="PresenceInvariant.flow_rate-76"><a href="#PresenceInvariant.flow_rate-76"><span class="linenos"> 76</span></a><span class="sd">            Then:</span>
</span><span id="PresenceInvariant.flow_rate-77"><a href="#PresenceInvariant.flow_rate-77"><span class="linenos"> 77</span></a><span class="sd">                flow_rate = Λ = N / T</span>
</span><span id="PresenceInvariant.flow_rate-78"><a href="#PresenceInvariant.flow_rate-78"><span class="linenos"> 78</span></a>
</span><span id="PresenceInvariant.flow_rate-79"><a href="#PresenceInvariant.flow_rate-79"><span class="linenos"> 79</span></a><span class="sd">        Examples:</span>
</span><span id="PresenceInvariant.flow_rate-80"><a href="#PresenceInvariant.flow_rate-80"><span class="linenos"> 80</span></a><span class="sd">            - If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</span>
</span><span id="PresenceInvariant.flow_rate-81"><a href="#PresenceInvariant.flow_rate-81"><span class="linenos"> 81</span></a><span class="sd">            - If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</span>
</span><span id="PresenceInvariant.flow_rate-82"><a href="#PresenceInvariant.flow_rate-82"><span class="linenos"> 82</span></a>
</span><span id="PresenceInvariant.flow_rate-83"><a href="#PresenceInvariant.flow_rate-83"><span class="linenos"> 83</span></a><span class="sd">        The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.</span>
</span><span id="PresenceInvariant.flow_rate-84"><a href="#PresenceInvariant.flow_rate-84"><span class="linenos"> 84</span></a><span class="sd">        The precise relationship between flow rate, arrival rate, and departure rate is as follows:</span>
</span><span id="PresenceInvariant.flow_rate-85"><a href="#PresenceInvariant.flow_rate-85"><span class="linenos"> 85</span></a>
</span><span id="PresenceInvariant.flow_rate-86"><a href="#PresenceInvariant.flow_rate-86"><span class="linenos"> 86</span></a><span class="sd">            N = number of presences that started *before* start_time (see `starting_presence_count`)</span>
</span><span id="PresenceInvariant.flow_rate-87"><a href="#PresenceInvariant.flow_rate-87"><span class="linenos"> 87</span></a><span class="sd">                + number that started *in* the interval [start_time, end_time) (see `arrival_count`)</span>
</span><span id="PresenceInvariant.flow_rate-88"><a href="#PresenceInvariant.flow_rate-88"><span class="linenos"> 88</span></a>
</span><span id="PresenceInvariant.flow_rate-89"><a href="#PresenceInvariant.flow_rate-89"><span class="linenos"> 89</span></a><span class="sd">              — this is also called the cumulative arrivals into the window</span>
</span><span id="PresenceInvariant.flow_rate-90"><a href="#PresenceInvariant.flow_rate-90"><span class="linenos"> 90</span></a>
</span><span id="PresenceInvariant.flow_rate-91"><a href="#PresenceInvariant.flow_rate-91"><span class="linenos"> 91</span></a><span class="sd">            or equivalently:</span>
</span><span id="PresenceInvariant.flow_rate-92"><a href="#PresenceInvariant.flow_rate-92"><span class="linenos"> 92</span></a>
</span><span id="PresenceInvariant.flow_rate-93"><a href="#PresenceInvariant.flow_rate-93"><span class="linenos"> 93</span></a><span class="sd">            N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)</span>
</span><span id="PresenceInvariant.flow_rate-94"><a href="#PresenceInvariant.flow_rate-94"><span class="linenos"> 94</span></a><span class="sd">                + number that ended *after* end_time (see `ending_presence_count`)</span>
</span><span id="PresenceInvariant.flow_rate-95"><a href="#PresenceInvariant.flow_rate-95"><span class="linenos"> 95</span></a>
</span><span id="PresenceInvariant.flow_rate-96"><a href="#PresenceInvariant.flow_rate-96"><span class="linenos"> 96</span></a><span class="sd">              — this is the departure contribution from the window</span>
</span><span id="PresenceInvariant.flow_rate-97"><a href="#PresenceInvariant.flow_rate-97"><span class="linenos"> 97</span></a>
</span><span id="PresenceInvariant.flow_rate-98"><a href="#PresenceInvariant.flow_rate-98"><span class="linenos"> 98</span></a><span class="sd">            These two decompositions of N are always equal; they just reflect different</span>
</span><span id="PresenceInvariant.flow_rate-99"><a href="#PresenceInvariant.flow_rate-99"><span class="linenos"> 99</span></a><span class="sd">            ways of expressing the same set of active presences.</span>
</span><span id="PresenceInvariant.flow_rate-100"><a href="#PresenceInvariant.flow_rate-100"><span class="linenos">100</span></a>
</span><span id="PresenceInvariant.flow_rate-101"><a href="#PresenceInvariant.flow_rate-101"><span class="linenos">101</span></a><span class="sd">        Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant.flow_rate-102"><a href="#PresenceInvariant.flow_rate-102"><span class="linenos">102</span></a><span class="sd">        will start and end within the window, with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant.flow_rate-103"><a href="#PresenceInvariant.flow_rate-103"><span class="linenos">103</span></a><span class="sd">        the interval at the beginning and end.</span>
</span><span id="PresenceInvariant.flow_rate-104"><a href="#PresenceInvariant.flow_rate-104"><span class="linenos">104</span></a>
</span><span id="PresenceInvariant.flow_rate-105"><a href="#PresenceInvariant.flow_rate-105"><span class="linenos">105</span></a><span class="sd">        This makes N an (over) estimate of true arrivals or departures over that interval.</span>
</span><span id="PresenceInvariant.flow_rate-106"><a href="#PresenceInvariant.flow_rate-106"><span class="linenos">106</span></a>
</span><span id="PresenceInvariant.flow_rate-107"><a href="#PresenceInvariant.flow_rate-107"><span class="linenos">107</span></a><span class="sd">        In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant.flow_rate-108"><a href="#PresenceInvariant.flow_rate-108"><span class="linenos">108</span></a><span class="sd">        then:</span>
</span><span id="PresenceInvariant.flow_rate-109"><a href="#PresenceInvariant.flow_rate-109"><span class="linenos">109</span></a><span class="sd">            flow_rate → arrival_rate → departure_rate</span>
</span><span id="PresenceInvariant.flow_rate-110"><a href="#PresenceInvariant.flow_rate-110"><span class="linenos">110</span></a>
</span><span id="PresenceInvariant.flow_rate-111"><a href="#PresenceInvariant.flow_rate-111"><span class="linenos">111</span></a><span class="sd">        When flow is fully convergent over the interval, then:</span>
</span><span id="PresenceInvariant.flow_rate-112"><a href="#PresenceInvariant.flow_rate-112"><span class="linenos">112</span></a><span class="sd">            flow_rate = arrival_rate = departure_rate</span>
</span><span id="PresenceInvariant.flow_rate-113"><a href="#PresenceInvariant.flow_rate-113"><span class="linenos">113</span></a>
</span><span id="PresenceInvariant.flow_rate-114"><a href="#PresenceInvariant.flow_rate-114"><span class="linenos">114</span></a><span class="sd">        This equality is one of the key conditions for *stable* flow through the boundary.</span>
</span><span id="PresenceInvariant.flow_rate-115"><a href="#PresenceInvariant.flow_rate-115"><span class="linenos">115</span></a>
</span><span id="PresenceInvariant.flow_rate-116"><a href="#PresenceInvariant.flow_rate-116"><span class="linenos">116</span></a><span class="sd">        On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant.flow_rate-117"><a href="#PresenceInvariant.flow_rate-117"><span class="linenos">117</span></a><span class="sd">        flow rate, arrival rate, and departure rate will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant.flow_rate-118"><a href="#PresenceInvariant.flow_rate-118"><span class="linenos">118</span></a><span class="sd">        or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant.flow_rate-119"><a href="#PresenceInvariant.flow_rate-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.flow_rate-120"><a href="#PresenceInvariant.flow_rate-120"><span class="linenos">120</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.flow_rate-121"><a href="#PresenceInvariant.flow_rate-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="n">number_of_presences</span><span class="o">/</span><span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>The flow rate Λ is defined as:
    number of active presences in the matrix slice [:start_bin:end_bin] /
    number of time bins in the slice (end_bin - start_bin)</p>

<h6 id="conceptually">Conceptually:</h6>

<blockquote>
  <p>Let N be the number of presences (rows) that are active (non-zero)
  in the matrix between start_time and end_time.</p>
  
  <p>Let T be the number of discrete time bins (columns) in that interval.</p>
  
  <p>Then:
      flow_rate = Λ = N / T</p>
</blockquote>

<h6 id="examples">Examples:</h6>

<blockquote>
  <ul>
  <li>If 4 presences span a 6-bin window, flow_rate = 4 / 6 = 0.666...</li>
  <li>If only one open-ended presence remains active over a 4-bin window, flow_rate = 1 / 4 = 0.25</li>
  </ul>
</blockquote>

<p>The flow rate is a finite-window estimate of both long-run arrival rate and departure rate.
The precise relationship between flow rate, arrival rate, and departure rate is as follows:</p>

<pre><code>N = number of presences that started *before* start_time (see `starting_presence_count`)
    + number that started *in* the interval [start_time, end_time) (see `arrival_count`)

  — this is also called the cumulative arrivals into the window

or equivalently:

N = number of presences that *ended* in [start_time, end_time) (see `departure_count`)
    + number that ended *after* end_time (see `ending_presence_count`)

  — this is the departure contribution from the window

These two decompositions of N are always equal; they just reflect different
ways of expressing the same set of active presences.
</code></pre>

<p>Intuitively, over a long enough window, if flow converges, most presences
will start and end within the window, with fewer presences that partially overlap
the interval at the beginning and end.</p>

<p>This makes N an (over) estimate of true arrivals or departures over that interval.</p>

<p>In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),
then:
    flow_rate → arrival_rate → departure_rate</p>

<p>When flow is fully convergent over the interval, then:
    flow_rate = arrival_rate = departure_rate</p>

<p>This equality is one of the key conditions for <em>stable</em> flow through the boundary.</p>

<p>On the other hand, if flow is not convergent over the interval, the delta between
flow rate, arrival rate, and departure rate will be large — either increasing (divergent)
or decreasing (convergent) over time.</p>
</div>


                            </div>
                            <div id="PresenceInvariant.avg_residence_time_per_presence" class="classattr">
                                        <input id="PresenceInvariant.avg_residence_time_per_presence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avg_residence_time_per_presence</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.avg_residence_time_per_presence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.avg_residence_time_per_presence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.avg_residence_time_per_presence-123"><a href="#PresenceInvariant.avg_residence_time_per_presence-123"><span class="linenos">123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_residence_time_per_presence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-124"><a href="#PresenceInvariant.avg_residence_time_per_presence-124"><span class="linenos">124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-125"><a href="#PresenceInvariant.avg_residence_time_per_presence-125"><span class="linenos">125</span></a><span class="sd">            Computes the average residence time over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-126"><a href="#PresenceInvariant.avg_residence_time_per_presence-126"><span class="linenos">126</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-127"><a href="#PresenceInvariant.avg_residence_time_per_presence-127"><span class="linenos">127</span></a><span class="sd">            Let \$ P \$ be the set of presences that overlap the interval \$[\\text{start\\_time}, \\text{end\\_time})\$.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-128"><a href="#PresenceInvariant.avg_residence_time_per_presence-128"><span class="linenos">128</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-129"><a href="#PresenceInvariant.avg_residence_time_per_presence-129"><span class="linenos">129</span></a><span class="sd">            The *residence time* \$ R(p) \$ is the time that presence \$ p \\in P \$ is active (overlaps) within that interval.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-130"><a href="#PresenceInvariant.avg_residence_time_per_presence-130"><span class="linenos">130</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-131"><a href="#PresenceInvariant.avg_residence_time_per_presence-131"><span class="linenos">131</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-132"><a href="#PresenceInvariant.avg_residence_time_per_presence-132"><span class="linenos">132</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-133"><a href="#PresenceInvariant.avg_residence_time_per_presence-133"><span class="linenos">133</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-134"><a href="#PresenceInvariant.avg_residence_time_per_presence-134"><span class="linenos">134</span></a><span class="sd">            The average residence time \$ w \$ is given by:</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-135"><a href="#PresenceInvariant.avg_residence_time_per_presence-135"><span class="linenos">135</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-136"><a href="#PresenceInvariant.avg_residence_time_per_presence-136"><span class="linenos">136</span></a><span class="sd">            \\[</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-137"><a href="#PresenceInvariant.avg_residence_time_per_presence-137"><span class="linenos">137</span></a><span class="sd">            w = \\frac{\\sum_{p \\in P} R(p)}{|P|}</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-138"><a href="#PresenceInvariant.avg_residence_time_per_presence-138"><span class="linenos">138</span></a><span class="sd">            \\]</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-139"><a href="#PresenceInvariant.avg_residence_time_per_presence-139"><span class="linenos">139</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-140"><a href="#PresenceInvariant.avg_residence_time_per_presence-140"><span class="linenos">140</span></a><span class="sd">            If no presences are active in the interval, \$ w = 0.0 \$.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-141"><a href="#PresenceInvariant.avg_residence_time_per_presence-141"><span class="linenos">141</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-142"><a href="#PresenceInvariant.avg_residence_time_per_presence-142"><span class="linenos">142</span></a><span class="sd">            Note:</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-143"><a href="#PresenceInvariant.avg_residence_time_per_presence-143"><span class="linenos">143</span></a><span class="sd">                There are four possible ways a presence can overlap a window [start, end):</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-144"><a href="#PresenceInvariant.avg_residence_time_per_presence-144"><span class="linenos">144</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-145"><a href="#PresenceInvariant.avg_residence_time_per_presence-145"><span class="linenos">145</span></a><span class="sd">                Ticks:     0   1   2   3   4   5   6   7</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-146"><a href="#PresenceInvariant.avg_residence_time_per_presence-146"><span class="linenos">146</span></a><span class="sd">                           |---|---|---|---|---|---|---|</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-147"><a href="#PresenceInvariant.avg_residence_time_per_presence-147"><span class="linenos">147</span></a><span class="sd">                Window:          |-----------|</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-148"><a href="#PresenceInvariant.avg_residence_time_per_presence-148"><span class="linenos">148</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-149"><a href="#PresenceInvariant.avg_residence_time_per_presence-149"><span class="linenos">149</span></a><span class="sd">                Case 1: Fully inside</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-150"><a href="#PresenceInvariant.avg_residence_time_per_presence-150"><span class="linenos">150</span></a><span class="sd">                                     [=======]</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-151"><a href="#PresenceInvariant.avg_residence_time_per_presence-151"><span class="linenos">151</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-152"><a href="#PresenceInvariant.avg_residence_time_per_presence-152"><span class="linenos">152</span></a><span class="sd">                Case 2: Starts before, ends inside</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-153"><a href="#PresenceInvariant.avg_residence_time_per_presence-153"><span class="linenos">153</span></a><span class="sd">                              [===========</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-154"><a href="#PresenceInvariant.avg_residence_time_per_presence-154"><span class="linenos">154</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-155"><a href="#PresenceInvariant.avg_residence_time_per_presence-155"><span class="linenos">155</span></a><span class="sd">                Case 3: Starts inside, ends after</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-156"><a href="#PresenceInvariant.avg_residence_time_per_presence-156"><span class="linenos">156</span></a><span class="sd">                                     ===========]</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-157"><a href="#PresenceInvariant.avg_residence_time_per_presence-157"><span class="linenos">157</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-158"><a href="#PresenceInvariant.avg_residence_time_per_presence-158"><span class="linenos">158</span></a><span class="sd">                Case 4: Fully spans window</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-159"><a href="#PresenceInvariant.avg_residence_time_per_presence-159"><span class="linenos">159</span></a><span class="sd">                              [====================]</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-160"><a href="#PresenceInvariant.avg_residence_time_per_presence-160"><span class="linenos">160</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-161"><a href="#PresenceInvariant.avg_residence_time_per_presence-161"><span class="linenos">161</span></a><span class="sd">                In all but Case 1, the window clips the presence, so the residence time</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-162"><a href="#PresenceInvariant.avg_residence_time_per_presence-162"><span class="linenos">162</span></a><span class="sd">                is smaller than the presence duration. In Case 1, residence time equals presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-163"><a href="#PresenceInvariant.avg_residence_time_per_presence-163"><span class="linenos">163</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-164"><a href="#PresenceInvariant.avg_residence_time_per_presence-164"><span class="linenos">164</span></a><span class="sd">                Intuitively, over a long enough window, if flow converges, most presences</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-165"><a href="#PresenceInvariant.avg_residence_time_per_presence-165"><span class="linenos">165</span></a><span class="sd">                will start and end within the window (Case 1), with fewer presences that partially overlap</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-166"><a href="#PresenceInvariant.avg_residence_time_per_presence-166"><span class="linenos">166</span></a><span class="sd">                the interval at the beginning and end or span the window (Cases 2–4).</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-167"><a href="#PresenceInvariant.avg_residence_time_per_presence-167"><span class="linenos">167</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-168"><a href="#PresenceInvariant.avg_residence_time_per_presence-168"><span class="linenos">168</span></a><span class="sd">                This makes \$ w \$ an (under)estimate of true presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-169"><a href="#PresenceInvariant.avg_residence_time_per_presence-169"><span class="linenos">169</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-170"><a href="#PresenceInvariant.avg_residence_time_per_presence-170"><span class="linenos">170</span></a><span class="sd">                In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-171"><a href="#PresenceInvariant.avg_residence_time_per_presence-171"><span class="linenos">171</span></a><span class="sd">                then:</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-172"><a href="#PresenceInvariant.avg_residence_time_per_presence-172"><span class="linenos">172</span></a><span class="sd">                    residence time → presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-173"><a href="#PresenceInvariant.avg_residence_time_per_presence-173"><span class="linenos">173</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-174"><a href="#PresenceInvariant.avg_residence_time_per_presence-174"><span class="linenos">174</span></a><span class="sd">                When flow is fully convergent over the interval:</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-175"><a href="#PresenceInvariant.avg_residence_time_per_presence-175"><span class="linenos">175</span></a><span class="sd">                    residence time = presence duration.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-176"><a href="#PresenceInvariant.avg_residence_time_per_presence-176"><span class="linenos">176</span></a>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-177"><a href="#PresenceInvariant.avg_residence_time_per_presence-177"><span class="linenos">177</span></a><span class="sd">                On the other hand, if flow is not convergent over the interval, the delta between</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-178"><a href="#PresenceInvariant.avg_residence_time_per_presence-178"><span class="linenos">178</span></a><span class="sd">                residence time and presence duration will be large — either increasing (divergent)</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-179"><a href="#PresenceInvariant.avg_residence_time_per_presence-179"><span class="linenos">179</span></a><span class="sd">                or decreasing (convergent) over time.</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-180"><a href="#PresenceInvariant.avg_residence_time_per_presence-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-181"><a href="#PresenceInvariant.avg_residence_time_per_presence-181"><span class="linenos">181</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.avg_residence_time_per_presence-182"><a href="#PresenceInvariant.avg_residence_time_per_presence-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Computes the average residence time over the interval [start_time, end_time).</p>

<p>Let \$ P \$ be the set of presences that overlap the interval \$[\text{start_time}, \text{end_time})\$.</p>

<p>The <em>residence time</em> \$ R(p) \$ is the time that presence \$ p \in P \$ is active (overlaps) within that interval.</p>

<p>Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only
partially cover a bin.</p>

<p>The average residence time \$ w \$ is given by:</p>

<p>[
w = \frac{\sum_{p \in P} R(p)}{|P|}
]</p>

<p>If no presences are active in the interval, \$ w = 0.0 \$.</p>

<h6 id="note">Note:</h6>

<blockquote>
  <p>There are four possible ways a presence can overlap a window [start, end):</p>
  
  <p>Ticks:     0   1   2   3   4   5   6   7
             |---|---|---|---|---|---|---|
  Window:          |-----------|</p>
  
  <p>Case 1: Fully inside
                       [=======]</p>
  
  <p>Case 2: Starts before, ends inside
                [===========</p>
  
  <p>Case 3: Starts inside, ends after
                       ===========]</p>
  
  <p>Case 4: Fully spans window
                [====================]</p>
  
  <p>In all but Case 1, the window clips the presence, so the residence time
  is smaller than the presence duration. In Case 1, residence time equals presence duration.</p>
  
  <p>Intuitively, over a long enough window, if flow converges, most presences
  will start and end within the window (Case 1), with fewer presences that partially overlap
  the interval at the beginning and end or span the window (Cases 2–4).</p>
  
  <p>This makes \$ w \$ an (under)estimate of true presence duration.</p>
  
  <p>In other words, if flow through the boundary is asymptotically convergent over [start_time, end_time),
  then:
      residence time → presence duration.</p>
  
  <p>When flow is fully convergent over the interval:
      residence time = presence duration.</p>
  
  <p>On the other hand, if flow is not convergent over the interval, the delta between
  residence time and presence duration will be large — either increasing (divergent)
  or decreasing (convergent) over time.</p>
</blockquote>
</div>


                            </div>
                            <div id="PresenceInvariant.avg_presence_per_time_bin" class="classattr">
                                        <input id="PresenceInvariant.avg_presence_per_time_bin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avg_presence_per_time_bin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.avg_presence_per_time_bin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.avg_presence_per_time_bin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.avg_presence_per_time_bin-184"><a href="#PresenceInvariant.avg_presence_per_time_bin-184"><span class="linenos">184</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">avg_presence_per_time_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-185"><a href="#PresenceInvariant.avg_presence_per_time_bin-185"><span class="linenos">185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-186"><a href="#PresenceInvariant.avg_presence_per_time_bin-186"><span class="linenos">186</span></a><span class="sd">        Computes the average presence per time bin over the interval [start_time, end_time).</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-187"><a href="#PresenceInvariant.avg_presence_per_time_bin-187"><span class="linenos">187</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-188"><a href="#PresenceInvariant.avg_presence_per_time_bin-188"><span class="linenos">188</span></a><span class="sd">        Let \$ B \$ be the set of discrete time bins that cover the interval \$[\\text{start\\_time}, \\text{end\\_time})\$,</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-189"><a href="#PresenceInvariant.avg_presence_per_time_bin-189"><span class="linenos">189</span></a><span class="sd">        and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \\in B \$.</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-190"><a href="#PresenceInvariant.avg_presence_per_time_bin-190"><span class="linenos">190</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-191"><a href="#PresenceInvariant.avg_presence_per_time_bin-191"><span class="linenos">191</span></a><span class="sd">        The average presence \$ L \$ is given by:</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-192"><a href="#PresenceInvariant.avg_presence_per_time_bin-192"><span class="linenos">192</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-193"><a href="#PresenceInvariant.avg_presence_per_time_bin-193"><span class="linenos">193</span></a><span class="sd">        \\[</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-194"><a href="#PresenceInvariant.avg_presence_per_time_bin-194"><span class="linenos">194</span></a><span class="sd">        L = \\frac{\\sum_{b \\in B} P(b)}{|B|}</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-195"><a href="#PresenceInvariant.avg_presence_per_time_bin-195"><span class="linenos">195</span></a><span class="sd">        \\]</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-196"><a href="#PresenceInvariant.avg_presence_per_time_bin-196"><span class="linenos">196</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-197"><a href="#PresenceInvariant.avg_presence_per_time_bin-197"><span class="linenos">197</span></a><span class="sd">        If the interval spans no bins, \$ L = 0.0 \$.</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-198"><a href="#PresenceInvariant.avg_presence_per_time_bin-198"><span class="linenos">198</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-199"><a href="#PresenceInvariant.avg_presence_per_time_bin-199"><span class="linenos">199</span></a><span class="sd">        Note:</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-200"><a href="#PresenceInvariant.avg_presence_per_time_bin-200"><span class="linenos">200</span></a><span class="sd">            This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-201"><a href="#PresenceInvariant.avg_presence_per_time_bin-201"><span class="linenos">201</span></a><span class="sd">            durations we used to compute residence time) divided by the number of bins in the interval.</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-202"><a href="#PresenceInvariant.avg_presence_per_time_bin-202"><span class="linenos">202</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-203"><a href="#PresenceInvariant.avg_presence_per_time_bin-203"><span class="linenos">203</span></a><span class="sd">            Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-204"><a href="#PresenceInvariant.avg_presence_per_time_bin-204"><span class="linenos">204</span></a><span class="sd">            partially cover a bin.</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-205"><a href="#PresenceInvariant.avg_presence_per_time_bin-205"><span class="linenos">205</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-206"><a href="#PresenceInvariant.avg_presence_per_time_bin-206"><span class="linenos">206</span></a><span class="sd">            Visually, this corresponds to summing presence *vertically* across bins:</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-207"><a href="#PresenceInvariant.avg_presence_per_time_bin-207"><span class="linenos">207</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-208"><a href="#PresenceInvariant.avg_presence_per_time_bin-208"><span class="linenos">208</span></a><span class="sd">            Example: presences over time bins</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-209"><a href="#PresenceInvariant.avg_presence_per_time_bin-209"><span class="linenos">209</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-210"><a href="#PresenceInvariant.avg_presence_per_time_bin-210"><span class="linenos">210</span></a><span class="sd">            Ticks:     0   1   2   3   4</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-211"><a href="#PresenceInvariant.avg_presence_per_time_bin-211"><span class="linenos">211</span></a><span class="sd">                       |---|---|---|---|</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-212"><a href="#PresenceInvariant.avg_presence_per_time_bin-212"><span class="linenos">212</span></a><span class="sd">            P1:         [=======]</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-213"><a href="#PresenceInvariant.avg_presence_per_time_bin-213"><span class="linenos">213</span></a><span class="sd">            P2:             [=======]</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-214"><a href="#PresenceInvariant.avg_presence_per_time_bin-214"><span class="linenos">214</span></a><span class="sd">            P3:                 [=======]</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-215"><a href="#PresenceInvariant.avg_presence_per_time_bin-215"><span class="linenos">215</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-216"><a href="#PresenceInvariant.avg_presence_per_time_bin-216"><span class="linenos">216</span></a><span class="sd">            Time bin 1:</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-217"><a href="#PresenceInvariant.avg_presence_per_time_bin-217"><span class="linenos">217</span></a><span class="sd">                          ↑   (bin index 1 = [1, 2))</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-218"><a href="#PresenceInvariant.avg_presence_per_time_bin-218"><span class="linenos">218</span></a><span class="sd">                          |---|</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-219"><a href="#PresenceInvariant.avg_presence_per_time_bin-219"><span class="linenos">219</span></a><span class="sd">                      P1:   +</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-220"><a href="#PresenceInvariant.avg_presence_per_time_bin-220"><span class="linenos">220</span></a><span class="sd">                      P2:   +</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-221"><a href="#PresenceInvariant.avg_presence_per_time_bin-221"><span class="linenos">221</span></a><span class="sd">                      P3:   -</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-222"><a href="#PresenceInvariant.avg_presence_per_time_bin-222"><span class="linenos">222</span></a><span class="sd">                    ---------</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-223"><a href="#PresenceInvariant.avg_presence_per_time_bin-223"><span class="linenos">223</span></a><span class="sd">                    Sum:     2</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-224"><a href="#PresenceInvariant.avg_presence_per_time_bin-224"><span class="linenos">224</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-225"><a href="#PresenceInvariant.avg_presence_per_time_bin-225"><span class="linenos">225</span></a><span class="sd">            So:</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-226"><a href="#PresenceInvariant.avg_presence_per_time_bin-226"><span class="linenos">226</span></a><span class="sd">                - Bin 1 has total presence = 2</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-227"><a href="#PresenceInvariant.avg_presence_per_time_bin-227"><span class="linenos">227</span></a><span class="sd">                - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-228"><a href="#PresenceInvariant.avg_presence_per_time_bin-228"><span class="linenos">228</span></a><span class="sd">                - Then \$ L = 5.5 / 3 = 1.833... \$</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-229"><a href="#PresenceInvariant.avg_presence_per_time_bin-229"><span class="linenos">229</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-230"><a href="#PresenceInvariant.avg_presence_per_time_bin-230"><span class="linenos">230</span></a><span class="sd">            Conceptually, \$ L \$ reflects the average &quot;load&quot; or concurrency of presence in the system during the interval.</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-231"><a href="#PresenceInvariant.avg_presence_per_time_bin-231"><span class="linenos">231</span></a>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-232"><a href="#PresenceInvariant.avg_presence_per_time_bin-232"><span class="linenos">232</span></a><span class="sd">            This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-233"><a href="#PresenceInvariant.avg_presence_per_time_bin-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-234"><a href="#PresenceInvariant.avg_presence_per_time_bin-234"><span class="linenos">234</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.avg_presence_per_time_bin-235"><a href="#PresenceInvariant.avg_presence_per_time_bin-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Computes the average presence per time bin over the interval [start_time, end_time).</p>

<p>Let \$ B \$ be the set of discrete time bins that cover the interval \$[\text{start_time}, \text{end_time})\$,
and let \$ P(b) \$ denote the total presence across all presences within each bin \$ b \in B \$.</p>

<p>The average presence \$ L \$ is given by:</p>

<p>[
L = \frac{\sum_{b \in B} P(b)}{|B|}
]</p>

<p>If the interval spans no bins, \$ L = 0.0 \$.</p>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This is equivalent to computing the total presence by summing across rows (i.e., sum of all active presence
  durations we used to compute residence time) divided by the number of bins in the interval.</p>
  
  <p>Presence is computed using bin-weighted overlap, so contributions may be fractional if presences only
  partially cover a bin.</p>
  
  <p>Visually, this corresponds to summing presence <em>vertically</em> across bins:</p>
  
  <p>Example: presences over time bins</p>
  
  <p>Ticks:     0   1   2   3   4
             |---|---|---|---|
  P1:         [=======]
  P2:             [=======]
  P3:                 [=======]</p>
  
  <p>Time bin 1:
                ↑   (bin index 1 = [1, 2))
                |---|
            P1:   +
            P2:   +
            P3:   -
          ---------
          Sum:     2</p>
  
  <p>So:
      - Bin 1 has total presence = 2
      - If we consider bins 1 to 3 (i.e., [1, 4)), and total presence = 5.5
      - Then \$ L = 5.5 / 3 = 1.833... \$</p>
  
  <p>Conceptually, \$ L \$ reflects the average "load" or concurrency of presence in the system during the interval.</p>
  
  <p>This metric is the time-relative (per unit time) complements the element-relative residence time \$ w \$.</p>
</blockquote>
</div>


                            </div>
                            <div id="PresenceInvariant.get_presence_summary" class="classattr">
                                        <input id="PresenceInvariant.get_presence_summary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_presence_summary</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.get_presence_summary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.get_presence_summary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.get_presence_summary-237"><a href="#PresenceInvariant.get_presence_summary-237"><span class="linenos">237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant.get_presence_summary-238"><a href="#PresenceInvariant.get_presence_summary-238"><span class="linenos">238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_summary-239"><a href="#PresenceInvariant.get_presence_summary-239"><span class="linenos">239</span></a><span class="sd">            Computes the three core quantities from which all presence-based metrics are derived:</span>
</span><span id="PresenceInvariant.get_presence_summary-240"><a href="#PresenceInvariant.get_presence_summary-240"><span class="linenos">240</span></a>
</span><span id="PresenceInvariant.get_presence_summary-241"><a href="#PresenceInvariant.get_presence_summary-241"><span class="linenos">241</span></a><span class="sd">            - Total presence time \$ A \$ over the interval \$[\\text{start\\_time}, \\text{end\\_time})\$</span>
</span><span id="PresenceInvariant.get_presence_summary-242"><a href="#PresenceInvariant.get_presence_summary-242"><span class="linenos">242</span></a><span class="sd">            - Number of active presences \$ N \$ (i.e., rows overlapping the interval)</span>
</span><span id="PresenceInvariant.get_presence_summary-243"><a href="#PresenceInvariant.get_presence_summary-243"><span class="linenos">243</span></a><span class="sd">            - Number of time bins \$ T \$ covering the interval</span>
</span><span id="PresenceInvariant.get_presence_summary-244"><a href="#PresenceInvariant.get_presence_summary-244"><span class="linenos">244</span></a>
</span><span id="PresenceInvariant.get_presence_summary-245"><a href="#PresenceInvariant.get_presence_summary-245"><span class="linenos">245</span></a><span class="sd">            These three values form the basis for computing:</span>
</span><span id="PresenceInvariant.get_presence_summary-246"><a href="#PresenceInvariant.get_presence_summary-246"><span class="linenos">246</span></a>
</span><span id="PresenceInvariant.get_presence_summary-247"><a href="#PresenceInvariant.get_presence_summary-247"><span class="linenos">247</span></a><span class="sd">            - Average presence per time bin: \$ L = A / T \$</span>
</span><span id="PresenceInvariant.get_presence_summary-248"><a href="#PresenceInvariant.get_presence_summary-248"><span class="linenos">248</span></a><span class="sd">            - Average residence time per presence: \$ w = A / N \$</span>
</span><span id="PresenceInvariant.get_presence_summary-249"><a href="#PresenceInvariant.get_presence_summary-249"><span class="linenos">249</span></a><span class="sd">            - Flow rate: \$ \\Lambda = N / T \$</span>
</span><span id="PresenceInvariant.get_presence_summary-250"><a href="#PresenceInvariant.get_presence_summary-250"><span class="linenos">250</span></a>
</span><span id="PresenceInvariant.get_presence_summary-251"><a href="#PresenceInvariant.get_presence_summary-251"><span class="linenos">251</span></a><span class="sd">            This method is the common workhorse that underlies `avg_presence_per_time_bin`,</span>
</span><span id="PresenceInvariant.get_presence_summary-252"><a href="#PresenceInvariant.get_presence_summary-252"><span class="linenos">252</span></a><span class="sd">            `avg_residence_time_per_presence`, and `flow_rate`.</span>
</span><span id="PresenceInvariant.get_presence_summary-253"><a href="#PresenceInvariant.get_presence_summary-253"><span class="linenos">253</span></a>
</span><span id="PresenceInvariant.get_presence_summary-254"><a href="#PresenceInvariant.get_presence_summary-254"><span class="linenos">254</span></a><span class="sd">            ... and much of this work lives in `PresenceMap.presence_value_in`</span>
</span><span id="PresenceInvariant.get_presence_summary-255"><a href="#PresenceInvariant.get_presence_summary-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_summary-256"><a href="#PresenceInvariant.get_presence_summary-256"><span class="linenos">256</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_summary-257"><a href="#PresenceInvariant.get_presence_summary-257"><span class="linenos">257</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_summary-258"><a href="#PresenceInvariant.get_presence_summary-258"><span class="linenos">258</span></a>        <span class="n">total_presence_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant.get_presence_summary-259"><a href="#PresenceInvariant.get_presence_summary-259"><span class="linenos">259</span></a>        <span class="n">number_of_presences</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="PresenceInvariant.get_presence_summary-260"><a href="#PresenceInvariant.get_presence_summary-260"><span class="linenos">260</span></a>        <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span><span class="p">:</span>
</span><span id="PresenceInvariant.get_presence_summary-261"><a href="#PresenceInvariant.get_presence_summary-261"><span class="linenos">261</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">):</span>
</span><span id="PresenceInvariant.get_presence_summary-262"><a href="#PresenceInvariant.get_presence_summary-262"><span class="linenos">262</span></a>                <span class="n">total_presence_value</span> <span class="o">+=</span> <span class="n">pm</span><span class="o">.</span><span class="n">presence_value_in</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_summary-263"><a href="#PresenceInvariant.get_presence_summary-263"><span class="linenos">263</span></a>                <span class="n">number_of_presences</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="PresenceInvariant.get_presence_summary-264"><a href="#PresenceInvariant.get_presence_summary-264"><span class="linenos">264</span></a>
</span><span id="PresenceInvariant.get_presence_summary-265"><a href="#PresenceInvariant.get_presence_summary-265"><span class="linenos">265</span></a>        <span class="k">return</span> <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">-</span> <span class="n">start_bin</span>
</span></pre></div>


            <div class="docstring"><p>Computes the three core quantities from which all presence-based metrics are derived:</p>

<ul>
<li>Total presence time \$ A \$ over the interval \$[\text{start_time}, \text{end_time})\$</li>
<li>Number of active presences \$ N \$ (i.e., rows overlapping the interval)</li>
<li>Number of time bins \$ T \$ covering the interval</li>
</ul>

<p>These three values form the basis for computing:</p>

<ul>
<li>Average presence per time bin: \$ L = A / T \$</li>
<li>Average residence time per presence: \$ w = A / N \$</li>
<li>Flow rate: \$ \Lambda = N / T \$</li>
</ul>

<p>This method is the common workhorse that underlies <code><a href="#PresenceInvariant.avg_presence_per_time_bin">avg_presence_per_time_bin</a></code>,
<code><a href="#PresenceInvariant.avg_residence_time_per_presence">avg_residence_time_per_presence</a></code>, and <code><a href="#PresenceInvariant.flow_rate">flow_rate</a></code>.</p>

<p>... and much of this work lives in <code>PresenceMap.presence_value_in</code></p>
</div>


                            </div>
                            <div id="PresenceInvariant.get_presence_metrics" class="classattr">
                                        <input id="PresenceInvariant.get_presence_metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_presence_metrics</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.get_presence_metrics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.get_presence_metrics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.get_presence_metrics-267"><a href="#PresenceInvariant.get_presence_metrics-267"><span class="linenos">267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_presence_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="PresenceInvariant.get_presence_metrics-268"><a href="#PresenceInvariant.get_presence_metrics-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_metrics-269"><a href="#PresenceInvariant.get_presence_metrics-269"><span class="linenos">269</span></a><span class="sd">        Computes all three components of the *Presence Invariant* for a finite window</span>
</span><span id="PresenceInvariant.get_presence_metrics-270"><a href="#PresenceInvariant.get_presence_metrics-270"><span class="linenos">270</span></a><span class="sd">        $[ \text{start\_time}, \text{end\_time} )$ within the timescale $[ t_0, t_1 )$</span>
</span><span id="PresenceInvariant.get_presence_metrics-271"><a href="#PresenceInvariant.get_presence_metrics-271"><span class="linenos">271</span></a><span class="sd">        of the PresenceMatrix.</span>
</span><span id="PresenceInvariant.get_presence_metrics-272"><a href="#PresenceInvariant.get_presence_metrics-272"><span class="linenos">272</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-273"><a href="#PresenceInvariant.get_presence_metrics-273"><span class="linenos">273</span></a><span class="sd">        The Presence Invariant states that for *any* such interval:</span>
</span><span id="PresenceInvariant.get_presence_metrics-274"><a href="#PresenceInvariant.get_presence_metrics-274"><span class="linenos">274</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-275"><a href="#PresenceInvariant.get_presence_metrics-275"><span class="linenos">275</span></a><span class="sd">            \[</span>
</span><span id="PresenceInvariant.get_presence_metrics-276"><a href="#PresenceInvariant.get_presence_metrics-276"><span class="linenos">276</span></a><span class="sd">            L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant.get_presence_metrics-277"><a href="#PresenceInvariant.get_presence_metrics-277"><span class="linenos">277</span></a><span class="sd">            \]</span>
</span><span id="PresenceInvariant.get_presence_metrics-278"><a href="#PresenceInvariant.get_presence_metrics-278"><span class="linenos">278</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-279"><a href="#PresenceInvariant.get_presence_metrics-279"><span class="linenos">279</span></a><span class="sd">        This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant.get_presence_metrics-280"><a href="#PresenceInvariant.get_presence_metrics-280"><span class="linenos">280</span></a><span class="sd">        in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant.get_presence_metrics-281"><a href="#PresenceInvariant.get_presence_metrics-281"><span class="linenos">281</span></a><span class="sd">        the more familiar equilibrium-based Little’s Law by expressing a conservation law</span>
</span><span id="PresenceInvariant.get_presence_metrics-282"><a href="#PresenceInvariant.get_presence_metrics-282"><span class="linenos">282</span></a><span class="sd">        that applies across all time scales.</span>
</span><span id="PresenceInvariant.get_presence_metrics-283"><a href="#PresenceInvariant.get_presence_metrics-283"><span class="linenos">283</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-284"><a href="#PresenceInvariant.get_presence_metrics-284"><span class="linenos">284</span></a><span class="sd">        - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant.get_presence_metrics-285"><a href="#PresenceInvariant.get_presence_metrics-285"><span class="linenos">285</span></a><span class="sd">        - $\Lambda$: the *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant.get_presence_metrics-286"><a href="#PresenceInvariant.get_presence_metrics-286"><span class="linenos">286</span></a><span class="sd">        - $w$: the *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant.get_presence_metrics-287"><a href="#PresenceInvariant.get_presence_metrics-287"><span class="linenos">287</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-288"><a href="#PresenceInvariant.get_presence_metrics-288"><span class="linenos">288</span></a><span class="sd">        **Derivation:**</span>
</span><span id="PresenceInvariant.get_presence_metrics-289"><a href="#PresenceInvariant.get_presence_metrics-289"><span class="linenos">289</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-290"><a href="#PresenceInvariant.get_presence_metrics-290"><span class="linenos">290</span></a><span class="sd">        Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant.get_presence_metrics-291"><a href="#PresenceInvariant.get_presence_metrics-291"><span class="linenos">291</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant.get_presence_metrics-292"><a href="#PresenceInvariant.get_presence_metrics-292"><span class="linenos">292</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-293"><a href="#PresenceInvariant.get_presence_metrics-293"><span class="linenos">293</span></a><span class="sd">        \[</span>
</span><span id="PresenceInvariant.get_presence_metrics-294"><a href="#PresenceInvariant.get_presence_metrics-294"><span class="linenos">294</span></a><span class="sd">        A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant.get_presence_metrics-295"><a href="#PresenceInvariant.get_presence_metrics-295"><span class="linenos">295</span></a><span class="sd">        \]</span>
</span><span id="PresenceInvariant.get_presence_metrics-296"><a href="#PresenceInvariant.get_presence_metrics-296"><span class="linenos">296</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-297"><a href="#PresenceInvariant.get_presence_metrics-297"><span class="linenos">297</span></a><span class="sd">        Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant.get_presence_metrics-298"><a href="#PresenceInvariant.get_presence_metrics-298"><span class="linenos">298</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-299"><a href="#PresenceInvariant.get_presence_metrics-299"><span class="linenos">299</span></a><span class="sd">        Then:</span>
</span><span id="PresenceInvariant.get_presence_metrics-300"><a href="#PresenceInvariant.get_presence_metrics-300"><span class="linenos">300</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-301"><a href="#PresenceInvariant.get_presence_metrics-301"><span class="linenos">301</span></a><span class="sd">        \[</span>
</span><span id="PresenceInvariant.get_presence_metrics-302"><a href="#PresenceInvariant.get_presence_metrics-302"><span class="linenos">302</span></a><span class="sd">        L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant.get_presence_metrics-303"><a href="#PresenceInvariant.get_presence_metrics-303"><span class="linenos">303</span></a><span class="sd">        \]</span>
</span><span id="PresenceInvariant.get_presence_metrics-304"><a href="#PresenceInvariant.get_presence_metrics-304"><span class="linenos">304</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-305"><a href="#PresenceInvariant.get_presence_metrics-305"><span class="linenos">305</span></a><span class="sd">        Hence:</span>
</span><span id="PresenceInvariant.get_presence_metrics-306"><a href="#PresenceInvariant.get_presence_metrics-306"><span class="linenos">306</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-307"><a href="#PresenceInvariant.get_presence_metrics-307"><span class="linenos">307</span></a><span class="sd">        \[</span>
</span><span id="PresenceInvariant.get_presence_metrics-308"><a href="#PresenceInvariant.get_presence_metrics-308"><span class="linenos">308</span></a><span class="sd">        L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant.get_presence_metrics-309"><a href="#PresenceInvariant.get_presence_metrics-309"><span class="linenos">309</span></a><span class="sd">        \]</span>
</span><span id="PresenceInvariant.get_presence_metrics-310"><a href="#PresenceInvariant.get_presence_metrics-310"><span class="linenos">310</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-311"><a href="#PresenceInvariant.get_presence_metrics-311"><span class="linenos">311</span></a><span class="sd">        This identity—what we call the *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant.get_presence_metrics-312"><a href="#PresenceInvariant.get_presence_metrics-312"><span class="linenos">312</span></a><span class="sd">        all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</span>
</span><span id="PresenceInvariant.get_presence_metrics-313"><a href="#PresenceInvariant.get_presence_metrics-313"><span class="linenos">313</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-314"><a href="#PresenceInvariant.get_presence_metrics-314"><span class="linenos">314</span></a><span class="sd">        Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant.get_presence_metrics-315"><a href="#PresenceInvariant.get_presence_metrics-315"><span class="linenos">315</span></a><span class="sd">        (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant.get_presence_metrics-316"><a href="#PresenceInvariant.get_presence_metrics-316"><span class="linenos">316</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-317"><a href="#PresenceInvariant.get_presence_metrics-317"><span class="linenos">317</span></a><span class="sd">        - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$ and average duration $W$.</span>
</span><span id="PresenceInvariant.get_presence_metrics-318"><a href="#PresenceInvariant.get_presence_metrics-318"><span class="linenos">318</span></a><span class="sd">        - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite approximations.</span>
</span><span id="PresenceInvariant.get_presence_metrics-319"><a href="#PresenceInvariant.get_presence_metrics-319"><span class="linenos">319</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-320"><a href="#PresenceInvariant.get_presence_metrics-320"><span class="linenos">320</span></a><span class="sd">        Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant.get_presence_metrics-321"><a href="#PresenceInvariant.get_presence_metrics-321"><span class="linenos">321</span></a><span class="sd">        and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant.get_presence_metrics-322"><a href="#PresenceInvariant.get_presence_metrics-322"><span class="linenos">322</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-323"><a href="#PresenceInvariant.get_presence_metrics-323"><span class="linenos">323</span></a><span class="sd">        ## References</span>
</span><span id="PresenceInvariant.get_presence_metrics-324"><a href="#PresenceInvariant.get_presence_metrics-324"><span class="linenos">324</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-325"><a href="#PresenceInvariant.get_presence_metrics-325"><span class="linenos">325</span></a><span class="sd">            1. **Little’s Law**</span>
</span><span id="PresenceInvariant.get_presence_metrics-326"><a href="#PresenceInvariant.get_presence_metrics-326"><span class="linenos">326</span></a><span class="sd">               Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant.get_presence_metrics-327"><a href="#PresenceInvariant.get_presence_metrics-327"><span class="linenos">327</span></a><span class="sd">               [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant.get_presence_metrics-328"><a href="#PresenceInvariant.get_presence_metrics-328"><span class="linenos">328</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-329"><a href="#PresenceInvariant.get_presence_metrics-329"><span class="linenos">329</span></a><span class="sd">            2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant.get_presence_metrics-330"><a href="#PresenceInvariant.get_presence_metrics-330"><span class="linenos">330</span></a><span class="sd">               Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant.get_presence_metrics-331"><a href="#PresenceInvariant.get_presence_metrics-331"><span class="linenos">331</span></a><span class="sd">               [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant.get_presence_metrics-332"><a href="#PresenceInvariant.get_presence_metrics-332"><span class="linenos">332</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-333"><a href="#PresenceInvariant.get_presence_metrics-333"><span class="linenos">333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.get_presence_metrics-334"><a href="#PresenceInvariant.get_presence_metrics-334"><span class="linenos">334</span></a>        <span class="n">total_presence_value</span><span class="p">,</span> <span class="n">number_of_presences</span><span class="p">,</span> <span class="n">num_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_presence_summary</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.get_presence_metrics-335"><a href="#PresenceInvariant.get_presence_metrics-335"><span class="linenos">335</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-336"><a href="#PresenceInvariant.get_presence_metrics-336"><span class="linenos">336</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant.get_presence_metrics-337"><a href="#PresenceInvariant.get_presence_metrics-337"><span class="linenos">337</span></a>        <span class="n">Λ</span> <span class="o">=</span> <span class="n">number_of_presences</span> <span class="o">/</span> <span class="n">num_bins</span> <span class="k">if</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant.get_presence_metrics-338"><a href="#PresenceInvariant.get_presence_metrics-338"><span class="linenos">338</span></a>        <span class="n">W</span> <span class="o">=</span> <span class="n">total_presence_value</span> <span class="o">/</span> <span class="n">number_of_presences</span> <span class="k">if</span> <span class="n">number_of_presences</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span id="PresenceInvariant.get_presence_metrics-339"><a href="#PresenceInvariant.get_presence_metrics-339"><span class="linenos">339</span></a>
</span><span id="PresenceInvariant.get_presence_metrics-340"><a href="#PresenceInvariant.get_presence_metrics-340"><span class="linenos">340</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">W</span>
</span></pre></div>


            <div class="docstring"><p>Computes all three components of the <em>Presence Invariant</em> for a finite window
$[      ext{start_time},       ext{end_time} )$ within the timescale $[ t_0, t_1 )$
of the PresenceMatrix.</p>

<p>The Presence Invariant states that for <em>any</em> such interval:</p>

<pre><code>\[
L = \Lambda \cdot w
\]
</code></pre>

<p>This invariant holds unconditionally and forms the foundation for reasoning about flow
in non-linear systems—systems that often operate far from equilibrium. It generalizes
the more familiar equilibrium-based Little’s Law by expressing a conservation law
that applies across all time scales.</p>

<ul>
<li>$L$: the <em>actual</em> average presence per unit time in the interval (this is not an approximation)</li>
<li>$\Lambda$: the <em>finite approximation</em> of presence arrival rate (flow rate)</li>
<li>$w$: the <em>finite approximation</em> of presence duration (residence time)</li>
</ul>

<p><strong>Derivation:</strong></p>

<p>Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.
Then:</p>

<p>[
A = \sum_{      ext{rows}}      ext{row totals} = \sum_{        ext{columns}}   ext{column totals}
]</p>

<p>Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</p>

<p>Then:</p>

<p>[
L = rac{A}{T} = rac{A}{N} \cdot rac{N}{T} = w \cdot \Lambda
]</p>

<p>Hence:</p>

<p>[
L = \Lambda \cdot w
]</p>

<p>This identity—what we call the <em>Presence Invariant</em>—is a fundamental lemma used in
all proofs of Little’s Law [1], and can be seen as its finite-window specialization.</p>

<p>Both the classical and presence-based versions are instances of <em>Rate Conservation Laws</em>
(as described by Miyazawa [2]). However, the conserved parameters differ:</p>

<ul>
<li>In classical Little’s Law, $L = \lambda \cdot W$ holds <em>at equilibrium</em>, using true arrival rate $\lambda$ and average duration $W$.</li>
<li>In the Presence Invariant, $L = \Lambda \cdot w$ holds <em>universally</em>, where $\Lambda$ and $w$ are finite approximations.</li>
</ul>

<p>Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust
and widely applicable conservation principle for causal reasoning about flow in such systems.</p>

<h2 id="references">References</h2>

<pre><code>1. **Little’s Law**
   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.
   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)

2. **Miyazawa on Rate Conservation Laws**
   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.
   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)
</code></pre>
</div>


                            </div>
                            <div id="PresenceInvariant.starting_presence_count" class="classattr">
                                        <input id="PresenceInvariant.starting_presence_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">starting_presence_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.starting_presence_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.starting_presence_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.starting_presence_count-345"><a href="#PresenceInvariant.starting_presence_count-345"><span class="linenos">345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">starting_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.starting_presence_count-346"><a href="#PresenceInvariant.starting_presence_count-346"><span class="linenos">346</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.starting_presence_count-347"><a href="#PresenceInvariant.starting_presence_count-347"><span class="linenos">347</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.starting_presence_count-348"><a href="#PresenceInvariant.starting_presence_count-348"><span class="linenos">348</span></a>
</span><span id="PresenceInvariant.starting_presence_count-349"><a href="#PresenceInvariant.starting_presence_count-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.starting_presence_count-350"><a href="#PresenceInvariant.starting_presence_count-350"><span class="linenos">350</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.starting_presence_count-351"><a href="#PresenceInvariant.starting_presence_count-351"><span class="linenos">351</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.starting_presence_count-352"><a href="#PresenceInvariant.starting_presence_count-352"><span class="linenos">352</span></a>            <span class="c1">#Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant.starting_presence_count-353"><a href="#PresenceInvariant.starting_presence_count-353"><span class="linenos">353</span></a>            <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant.starting_presence_count-354"><a href="#PresenceInvariant.starting_presence_count-354"><span class="linenos">354</span></a>            <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant.starting_presence_count-355"><a href="#PresenceInvariant.starting_presence_count-355"><span class="linenos">355</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start_bin</span>
</span><span id="PresenceInvariant.starting_presence_count-356"><a href="#PresenceInvariant.starting_presence_count-356"><span class="linenos">356</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.ending_presence_count" class="classattr">
                                        <input id="PresenceInvariant.ending_presence_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ending_presence_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.ending_presence_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.ending_presence_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.ending_presence_count-358"><a href="#PresenceInvariant.ending_presence_count-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ending_presence_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.ending_presence_count-359"><a href="#PresenceInvariant.ending_presence_count-359"><span class="linenos">359</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-360"><a href="#PresenceInvariant.ending_presence_count-360"><span class="linenos">360</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-361"><a href="#PresenceInvariant.ending_presence_count-361"><span class="linenos">361</span></a>
</span><span id="PresenceInvariant.ending_presence_count-362"><a href="#PresenceInvariant.ending_presence_count-362"><span class="linenos">362</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.ending_presence_count-363"><a href="#PresenceInvariant.ending_presence_count-363"><span class="linenos">363</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.ending_presence_count-364"><a href="#PresenceInvariant.ending_presence_count-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-365"><a href="#PresenceInvariant.ending_presence_count-365"><span class="linenos">365</span></a>            <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="PresenceInvariant.ending_presence_count-366"><a href="#PresenceInvariant.ending_presence_count-366"><span class="linenos">366</span></a>                 <span class="c1"># Note: here we must explicitly check the un-clipped</span>
</span><span id="PresenceInvariant.ending_presence_count-367"><a href="#PresenceInvariant.ending_presence_count-367"><span class="linenos">367</span></a>                 <span class="c1"># bin indices, since we are looking for end indices that fall outside the</span>
</span><span id="PresenceInvariant.ending_presence_count-368"><a href="#PresenceInvariant.ending_presence_count-368"><span class="linenos">368</span></a>                 <span class="c1"># window and even the matrix. So pm.end_bin is not the right test here.</span>
</span><span id="PresenceInvariant.ending_presence_count-369"><a href="#PresenceInvariant.ending_presence_count-369"><span class="linenos">369</span></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.ending_presence_count-370"><a href="#PresenceInvariant.ending_presence_count-370"><span class="linenos">370</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.arrival_count" class="classattr">
                                        <input id="PresenceInvariant.arrival_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">arrival_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.arrival_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.arrival_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.arrival_count-372"><a href="#PresenceInvariant.arrival_count-372"><span class="linenos">372</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arrival_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.arrival_count-373"><a href="#PresenceInvariant.arrival_count-373"><span class="linenos">373</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of presences that started within the window&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.arrival_count-374"><a href="#PresenceInvariant.arrival_count-374"><span class="linenos">374</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.arrival_count-375"><a href="#PresenceInvariant.arrival_count-375"><span class="linenos">375</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.arrival_count-376"><a href="#PresenceInvariant.arrival_count-376"><span class="linenos">376</span></a>
</span><span id="PresenceInvariant.arrival_count-377"><a href="#PresenceInvariant.arrival_count-377"><span class="linenos">377</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.arrival_count-378"><a href="#PresenceInvariant.arrival_count-378"><span class="linenos">378</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.arrival_count-379"><a href="#PresenceInvariant.arrival_count-379"><span class="linenos">379</span></a>            <span class="k">if</span> <span class="n">start_bin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_bin</span>
</span><span id="PresenceInvariant.arrival_count-380"><a href="#PresenceInvariant.arrival_count-380"><span class="linenos">380</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The number of presences that started within the window</p>
</div>


                            </div>
                            <div id="PresenceInvariant.departure_count" class="classattr">
                                        <input id="PresenceInvariant.departure_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">departure_count</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="PresenceInvariant.departure_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.departure_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.departure_count-382"><a href="#PresenceInvariant.departure_count-382"><span class="linenos">382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">departure_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="PresenceInvariant.departure_count-383"><a href="#PresenceInvariant.departure_count-383"><span class="linenos">383</span></a>        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_range</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-384"><a href="#PresenceInvariant.departure_count-384"><span class="linenos">384</span></a>        <span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-385"><a href="#PresenceInvariant.departure_count-385"><span class="linenos">385</span></a>
</span><span id="PresenceInvariant.departure_count-386"><a href="#PresenceInvariant.departure_count-386"><span class="linenos">386</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="PresenceInvariant.departure_count-387"><a href="#PresenceInvariant.departure_count-387"><span class="linenos">387</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence_map</span>
</span><span id="PresenceInvariant.departure_count-388"><a href="#PresenceInvariant.departure_count-388"><span class="linenos">388</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-389"><a href="#PresenceInvariant.departure_count-389"><span class="linenos">389</span></a>            <span class="ow">and</span> <span class="n">pm</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-390"><a href="#PresenceInvariant.departure_count-390"><span class="linenos">390</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">bin_index</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_bin</span><span class="p">,</span> <span class="n">end_bin</span><span class="p">)</span>
</span><span id="PresenceInvariant.departure_count-391"><a href="#PresenceInvariant.departure_count-391"><span class="linenos">391</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PresenceInvariant.foo" class="classattr">
                                        <input id="PresenceInvariant.foo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">foo</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PresenceInvariant.foo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PresenceInvariant.foo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PresenceInvariant.foo-394"><a href="#PresenceInvariant.foo-394"><span class="linenos">394</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="PresenceInvariant.foo-395"><a href="#PresenceInvariant.foo-395"><span class="linenos">395</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PresenceInvariant.foo-396"><a href="#PresenceInvariant.foo-396"><span class="linenos">396</span></a><span class="sd">            The key function of this class is to precisely compute the components of key rate conserved quantities</span>
</span><span id="PresenceInvariant.foo-397"><a href="#PresenceInvariant.foo-397"><span class="linenos">397</span></a><span class="sd">            tied to Presence under both equilibrium and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant.foo-398"><a href="#PresenceInvariant.foo-398"><span class="linenos">398</span></a>
</span><span id="PresenceInvariant.foo-399"><a href="#PresenceInvariant.foo-399"><span class="linenos">399</span></a><span class="sd">            The key relationship that matters here is the Presence Invariant, which is rate conservation law</span>
</span><span id="PresenceInvariant.foo-400"><a href="#PresenceInvariant.foo-400"><span class="linenos">400</span></a><span class="sd">            for a PresenceMatrix under non-equilibrium condition.</span>
</span><span id="PresenceInvariant.foo-401"><a href="#PresenceInvariant.foo-401"><span class="linenos">401</span></a>
</span><span id="PresenceInvariant.foo-402"><a href="#PresenceInvariant.foo-402"><span class="linenos">402</span></a><span class="sd">            The Presence Invariant states that for *any* finite interval [start_time, end_time) over the timescale [t0, t1)</span>
</span><span id="PresenceInvariant.foo-403"><a href="#PresenceInvariant.foo-403"><span class="linenos">403</span></a><span class="sd">            of a Presence Matrix:</span>
</span><span id="PresenceInvariant.foo-404"><a href="#PresenceInvariant.foo-404"><span class="linenos">404</span></a>
</span><span id="PresenceInvariant.foo-405"><a href="#PresenceInvariant.foo-405"><span class="linenos">405</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant.foo-406"><a href="#PresenceInvariant.foo-406"><span class="linenos">406</span></a><span class="sd">                    L = \Lambda \cdot w</span>
</span><span id="PresenceInvariant.foo-407"><a href="#PresenceInvariant.foo-407"><span class="linenos">407</span></a><span class="sd">                    $$</span>
</span><span id="PresenceInvariant.foo-408"><a href="#PresenceInvariant.foo-408"><span class="linenos">408</span></a>
</span><span id="PresenceInvariant.foo-409"><a href="#PresenceInvariant.foo-409"><span class="linenos">409</span></a><span class="sd">                - $L$: the *actual* average presence per unit time in the interval (this is not an approximation)</span>
</span><span id="PresenceInvariant.foo-410"><a href="#PresenceInvariant.foo-410"><span class="linenos">410</span></a><span class="sd">                - $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)</span>
</span><span id="PresenceInvariant.foo-411"><a href="#PresenceInvariant.foo-411"><span class="linenos">411</span></a><span class="sd">                - $w$: a *finite approximation* of presence duration (residence time)</span>
</span><span id="PresenceInvariant.foo-412"><a href="#PresenceInvariant.foo-412"><span class="linenos">412</span></a>
</span><span id="PresenceInvariant.foo-413"><a href="#PresenceInvariant.foo-413"><span class="linenos">413</span></a><span class="sd">                This invariant holds unconditionally and forms the foundation for reasoning about flow</span>
</span><span id="PresenceInvariant.foo-414"><a href="#PresenceInvariant.foo-414"><span class="linenos">414</span></a><span class="sd">                in non-linear systems—systems that often operate far from equilibrium. It generalizes</span>
</span><span id="PresenceInvariant.foo-415"><a href="#PresenceInvariant.foo-415"><span class="linenos">415</span></a><span class="sd">                the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law</span>
</span><span id="PresenceInvariant.foo-416"><a href="#PresenceInvariant.foo-416"><span class="linenos">416</span></a><span class="sd">                that applies across all time scales and non-equilibrium conditions.</span>
</span><span id="PresenceInvariant.foo-417"><a href="#PresenceInvariant.foo-417"><span class="linenos">417</span></a>
</span><span id="PresenceInvariant.foo-418"><a href="#PresenceInvariant.foo-418"><span class="linenos">418</span></a><span class="sd">                The proof of this invariant is surprisingly simple and elementary.</span>
</span><span id="PresenceInvariant.foo-419"><a href="#PresenceInvariant.foo-419"><span class="linenos">419</span></a>
</span><span id="PresenceInvariant.foo-420"><a href="#PresenceInvariant.foo-420"><span class="linenos">420</span></a><span class="sd">                **Derivation:**</span>
</span><span id="PresenceInvariant.foo-421"><a href="#PresenceInvariant.foo-421"><span class="linenos">421</span></a>
</span><span id="PresenceInvariant.foo-422"><a href="#PresenceInvariant.foo-422"><span class="linenos">422</span></a><span class="sd">                Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.</span>
</span><span id="PresenceInvariant.foo-423"><a href="#PresenceInvariant.foo-423"><span class="linenos">423</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant.foo-424"><a href="#PresenceInvariant.foo-424"><span class="linenos">424</span></a>
</span><span id="PresenceInvariant.foo-425"><a href="#PresenceInvariant.foo-425"><span class="linenos">425</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-426"><a href="#PresenceInvariant.foo-426"><span class="linenos">426</span></a><span class="sd">                A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}</span>
</span><span id="PresenceInvariant.foo-427"><a href="#PresenceInvariant.foo-427"><span class="linenos">427</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-428"><a href="#PresenceInvariant.foo-428"><span class="linenos">428</span></a>
</span><span id="PresenceInvariant.foo-429"><a href="#PresenceInvariant.foo-429"><span class="linenos">429</span></a><span class="sd">                Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.</span>
</span><span id="PresenceInvariant.foo-430"><a href="#PresenceInvariant.foo-430"><span class="linenos">430</span></a>
</span><span id="PresenceInvariant.foo-431"><a href="#PresenceInvariant.foo-431"><span class="linenos">431</span></a><span class="sd">                Then:</span>
</span><span id="PresenceInvariant.foo-432"><a href="#PresenceInvariant.foo-432"><span class="linenos">432</span></a>
</span><span id="PresenceInvariant.foo-433"><a href="#PresenceInvariant.foo-433"><span class="linenos">433</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-434"><a href="#PresenceInvariant.foo-434"><span class="linenos">434</span></a>
</span><span id="PresenceInvariant.foo-435"><a href="#PresenceInvariant.foo-435"><span class="linenos">435</span></a><span class="sd">                L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda</span>
</span><span id="PresenceInvariant.foo-436"><a href="#PresenceInvariant.foo-436"><span class="linenos">436</span></a>
</span><span id="PresenceInvariant.foo-437"><a href="#PresenceInvariant.foo-437"><span class="linenos">437</span></a><span class="sd">                $$</span>
</span><span id="PresenceInvariant.foo-438"><a href="#PresenceInvariant.foo-438"><span class="linenos">438</span></a>
</span><span id="PresenceInvariant.foo-439"><a href="#PresenceInvariant.foo-439"><span class="linenos">439</span></a><span class="sd">                Hence:</span>
</span><span id="PresenceInvariant.foo-440"><a href="#PresenceInvariant.foo-440"><span class="linenos">440</span></a>
</span><span id="PresenceInvariant.foo-441"><a href="#PresenceInvariant.foo-441"><span class="linenos">441</span></a><span class="sd">                $$ L = \Lambda \cdot w $$</span>
</span><span id="PresenceInvariant.foo-442"><a href="#PresenceInvariant.foo-442"><span class="linenos">442</span></a>
</span><span id="PresenceInvariant.foo-443"><a href="#PresenceInvariant.foo-443"><span class="linenos">443</span></a><span class="sd">                The *Presence Invariant*—is a fundamental lemma used in</span>
</span><span id="PresenceInvariant.foo-444"><a href="#PresenceInvariant.foo-444"><span class="linenos">444</span></a><span class="sd">                all proofs of Little’s Law [1], and can be seen as its finite-window version.</span>
</span><span id="PresenceInvariant.foo-445"><a href="#PresenceInvariant.foo-445"><span class="linenos">445</span></a>
</span><span id="PresenceInvariant.foo-446"><a href="#PresenceInvariant.foo-446"><span class="linenos">446</span></a><span class="sd">                Both the classical and presence-based versions are instances of *Rate Conservation Laws*</span>
</span><span id="PresenceInvariant.foo-447"><a href="#PresenceInvariant.foo-447"><span class="linenos">447</span></a><span class="sd">                (as described by Miyazawa [2]). However, the conserved parameters differ:</span>
</span><span id="PresenceInvariant.foo-448"><a href="#PresenceInvariant.foo-448"><span class="linenos">448</span></a>
</span><span id="PresenceInvariant.foo-449"><a href="#PresenceInvariant.foo-449"><span class="linenos">449</span></a><span class="sd">                - In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$</span>
</span><span id="PresenceInvariant.foo-450"><a href="#PresenceInvariant.foo-450"><span class="linenos">450</span></a><span class="sd">                and average duration $W$.</span>
</span><span id="PresenceInvariant.foo-451"><a href="#PresenceInvariant.foo-451"><span class="linenos">451</span></a><span class="sd">                - In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite</span>
</span><span id="PresenceInvariant.foo-452"><a href="#PresenceInvariant.foo-452"><span class="linenos">452</span></a><span class="sd">                window approximations.</span>
</span><span id="PresenceInvariant.foo-453"><a href="#PresenceInvariant.foo-453"><span class="linenos">453</span></a>
</span><span id="PresenceInvariant.foo-454"><a href="#PresenceInvariant.foo-454"><span class="linenos">454</span></a><span class="sd">                Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust</span>
</span><span id="PresenceInvariant.foo-455"><a href="#PresenceInvariant.foo-455"><span class="linenos">455</span></a><span class="sd">                and widely applicable conservation principle for causal reasoning about flow in such systems.</span>
</span><span id="PresenceInvariant.foo-456"><a href="#PresenceInvariant.foo-456"><span class="linenos">456</span></a>
</span><span id="PresenceInvariant.foo-457"><a href="#PresenceInvariant.foo-457"><span class="linenos">457</span></a><span class="sd">                References:</span>
</span><span id="PresenceInvariant.foo-458"><a href="#PresenceInvariant.foo-458"><span class="linenos">458</span></a>
</span><span id="PresenceInvariant.foo-459"><a href="#PresenceInvariant.foo-459"><span class="linenos">459</span></a><span class="sd">                1. **Little’s Law**</span>
</span><span id="PresenceInvariant.foo-460"><a href="#PresenceInvariant.foo-460"><span class="linenos">460</span></a><span class="sd">                   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.</span>
</span><span id="PresenceInvariant.foo-461"><a href="#PresenceInvariant.foo-461"><span class="linenos">461</span></a><span class="sd">                   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)</span>
</span><span id="PresenceInvariant.foo-462"><a href="#PresenceInvariant.foo-462"><span class="linenos">462</span></a>
</span><span id="PresenceInvariant.foo-463"><a href="#PresenceInvariant.foo-463"><span class="linenos">463</span></a><span class="sd">                2. **Miyazawa on Rate Conservation Laws**</span>
</span><span id="PresenceInvariant.foo-464"><a href="#PresenceInvariant.foo-464"><span class="linenos">464</span></a><span class="sd">                   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.</span>
</span><span id="PresenceInvariant.foo-465"><a href="#PresenceInvariant.foo-465"><span class="linenos">465</span></a><span class="sd">                   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)</span>
</span><span id="PresenceInvariant.foo-466"><a href="#PresenceInvariant.foo-466"><span class="linenos">466</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>The key function of this class is to precisely compute the components of key rate conserved quantities
tied to Presence under both equilibrium and non-equilibrium conditions.</p>

<p>The key relationship that matters here is the Presence Invariant, which is rate conservation law
for a PresenceMatrix under non-equilibrium condition.</p>

<p>The Presence Invariant states that for <em>any</em> finite interval [start_time, end_time) over the timescale [t0, t1)
of a Presence Matrix:</p>

<pre><code>    $$
    L = \Lambda \cdot w
    $$

- $L$: the *actual* average presence per unit time in the interval (this is not an approximation)
- $\Lambda$: a *finite approximation* of presence arrival rate (flow rate)
- $w$: a *finite approximation* of presence duration (residence time)

This invariant holds unconditionally and forms the foundation for reasoning about flow
in non-linear systems—systems that often operate far from equilibrium. It generalizes
the more familiar Little’s Law that holds under certain equilibrium conditions as a conservation law
that applies across all time scales and non-equilibrium conditions.

The proof of this invariant is surprisingly simple and elementary.

**Derivation:**

Let $ A $ be the total presence (i.e., the sum of active elements) in the matrix over the window.
Then:

$$
A = \sum_{\text{rows}} \text{row totals} = \sum_{\text{columns}} \text{column totals}
$$

Let $ N $ be the number of distinct presences in the window, and $ T $ the window length.

Then:

$$

L = \frac{A}{T} = \frac{A}{N} \cdot \frac{N}{T} = w \cdot \Lambda

$$

Hence:

$$ L = \Lambda \cdot w $$

The *Presence Invariant*—is a fundamental lemma used in
all proofs of Little’s Law [1], and can be seen as its finite-window version.

Both the classical and presence-based versions are instances of *Rate Conservation Laws*
(as described by Miyazawa [2]). However, the conserved parameters differ:

- In classical Little’s Law, $L = \lambda \cdot W$ holds *at equilibrium*, using true arrival rate $\lambda$
and average duration $W$.
- In the Presence Invariant, $L = \Lambda \cdot w$ holds *universally*, where $\Lambda$ and $w$ are finite
window approximations.

Since non-linear systems rarely reach or maintain equilibrium, the Presence Invariant provides a more robust
and widely applicable conservation principle for causal reasoning about flow in such systems.

References:

1. **Little’s Law**
   Little, J. D. C. (2011). *Little’s Law as viewed on its 50th anniversary*. MIT.
   [https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf](https://people.cs.umass.edu/~emery/classes/cmpsci691st/readings/OS/Littles-Law-50-Years-Later.pdf)

2. **Miyazawa on Rate Conservation Laws**
   Miyazawa, M. (1994). *Rate conservation laws: a survey*. Science University of Tokyo.
   [https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf](https://www.rs.tus.ac.jp/miyazawa/pdf-file/Miya1994-QS-RCL.pdf)
</code></pre>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>